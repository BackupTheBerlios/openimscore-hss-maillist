<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [OpenIMSCore-HSS] [SVN-FHoSS] r119 - in FHoSS/trunk: . config lib	src src/de/fhg/fokus/cx src/de/fhg/fokus/hss	src/de/fhg/fokus/hss/action src/de/fhg/fokus/hss/diam	src/de/fhg/fokus/hss/diam/cx src/de/fhg/fokus/hss/diam/sh	src/de/fhg/fokus/hss/diam/zh src/de/fhg/fokus/hss/form	src/de/fhg/fokus/hss/main src/de/fhg/fokus/hss/model	src/de/fhg/fokus/hss/server/cx src/de/fhg/fokus/hss/server/cx/op	src/de/fhg/fokus/hss/server/sh src/de/fhg/fokus/hss/server/sh/op	src/de/fhg/fokus/hss/server/zh src/de/fhg/fokus/hss/servlet	src/de/fhg/fokus/hss/util src/de/fhg/fokus/security/auth	src/de/fhg/fokus/zh src-web/WEB-INF src-web/pages/ifc	src-web/pages/info src-web/pages/profiles src-web/pages/tiles	tomcat/webapps/ROOT
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/openimscore-hss/2007-February/index.html" >
   <LINK REL="made" HREF="mailto:openimscore-hss%40lists.berlios.de?Subject=Re%3A%20%5BOpenIMSCore-HSS%5D%20%5BSVN-FHoSS%5D%20r119%20-%20in%20FHoSS/trunk%3A%20.%20config%20lib%0A%09src%20src/de/fhg/fokus/cx%20src/de/fhg/fokus/hss%0A%09src/de/fhg/fokus/hss/action%20src/de/fhg/fokus/hss/diam%0A%09src/de/fhg/fokus/hss/diam/cx%20src/de/fhg/fokus/hss/diam/sh%0A%09src/de/fhg/fokus/hss/diam/zh%20src/de/fhg/fokus/hss/form%0A%09src/de/fhg/fokus/hss/main%20src/de/fhg/fokus/hss/model%0A%09src/de/fhg/fokus/hss/server/cx%20src/de/fhg/fokus/hss/server/cx/op%0A%09src/de/fhg/fokus/hss/server/sh%20src/de/fhg/fokus/hss/server/sh/op%0A%09src/de/fhg/fokus/hss/server/zh%20src/de/fhg/fokus/hss/servlet%0A%09src/de/fhg/fokus/hss/util%20src/de/fhg/fokus/security/auth%0A%09src/de/fhg/fokus/zh%20src-web/WEB-INF%20src-web/pages/ifc%0A%09src-web/pages/info%20src-web/pages/profiles%20src-web/pages/tiles%0A%09tomcat/webapps/ROOT&In-Reply-To=%3C200702061649.l16GnAs2027937%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000195.html">
   <LINK REL="Next"  HREF="000198.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[OpenIMSCore-HSS] [SVN-FHoSS] r119 - in FHoSS/trunk: . config lib	src src/de/fhg/fokus/cx src/de/fhg/fokus/hss	src/de/fhg/fokus/hss/action src/de/fhg/fokus/hss/diam	src/de/fhg/fokus/hss/diam/cx src/de/fhg/fokus/hss/diam/sh	src/de/fhg/fokus/hss/diam/zh src/de/fhg/fokus/hss/form	src/de/fhg/fokus/hss/main src/de/fhg/fokus/hss/model	src/de/fhg/fokus/hss/server/cx src/de/fhg/fokus/hss/server/cx/op	src/de/fhg/fokus/hss/server/sh src/de/fhg/fokus/hss/server/sh/op	src/de/fhg/fokus/hss/server/zh src/de/fhg/fokus/hss/servlet	src/de/fhg/fokus/hss/util src/de/fhg/fokus/security/auth	src/de/fhg/fokus/zh src-web/WEB-INF src-web/pages/ifc	src-web/pages/info src-web/pages/profiles src-web/pages/tiles	tomcat/webapps/ROOT</H1>
    <B>adp at users.berlios.de</B> 
    <A HREF="mailto:openimscore-hss%40lists.berlios.de?Subject=Re%3A%20%5BOpenIMSCore-HSS%5D%20%5BSVN-FHoSS%5D%20r119%20-%20in%20FHoSS/trunk%3A%20.%20config%20lib%0A%09src%20src/de/fhg/fokus/cx%20src/de/fhg/fokus/hss%0A%09src/de/fhg/fokus/hss/action%20src/de/fhg/fokus/hss/diam%0A%09src/de/fhg/fokus/hss/diam/cx%20src/de/fhg/fokus/hss/diam/sh%0A%09src/de/fhg/fokus/hss/diam/zh%20src/de/fhg/fokus/hss/form%0A%09src/de/fhg/fokus/hss/main%20src/de/fhg/fokus/hss/model%0A%09src/de/fhg/fokus/hss/server/cx%20src/de/fhg/fokus/hss/server/cx/op%0A%09src/de/fhg/fokus/hss/server/sh%20src/de/fhg/fokus/hss/server/sh/op%0A%09src/de/fhg/fokus/hss/server/zh%20src/de/fhg/fokus/hss/servlet%0A%09src/de/fhg/fokus/hss/util%20src/de/fhg/fokus/security/auth%0A%09src/de/fhg/fokus/zh%20src-web/WEB-INF%20src-web/pages/ifc%0A%09src-web/pages/info%20src-web/pages/profiles%20src-web/pages/tiles%0A%09tomcat/webapps/ROOT&In-Reply-To=%3C200702061649.l16GnAs2027937%40sheep.berlios.de%3E"
       TITLE="[OpenIMSCore-HSS] [SVN-FHoSS] r119 - in FHoSS/trunk: . config lib	src src/de/fhg/fokus/cx src/de/fhg/fokus/hss	src/de/fhg/fokus/hss/action src/de/fhg/fokus/hss/diam	src/de/fhg/fokus/hss/diam/cx src/de/fhg/fokus/hss/diam/sh	src/de/fhg/fokus/hss/diam/zh src/de/fhg/fokus/hss/form	src/de/fhg/fokus/hss/main src/de/fhg/fokus/hss/model	src/de/fhg/fokus/hss/server/cx src/de/fhg/fokus/hss/server/cx/op	src/de/fhg/fokus/hss/server/sh src/de/fhg/fokus/hss/server/sh/op	src/de/fhg/fokus/hss/server/zh src/de/fhg/fokus/hss/servlet	src/de/fhg/fokus/hss/util src/de/fhg/fokus/security/auth	src/de/fhg/fokus/zh src-web/WEB-INF src-web/pages/ifc	src-web/pages/info src-web/pages/profiles src-web/pages/tiles	tomcat/webapps/ROOT">adp at users.berlios.de
       </A><BR>
    <I>Tue Feb  6 17:49:10 CET 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="000195.html">[OpenIMSCore-HSS] 403 Forbidden : HSS user unknown Error.
</A></li>
        <LI>Next message: <A HREF="000198.html">[OpenIMSCore-HSS] password
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#196">[ date ]</a>
              <a href="thread.html#196">[ thread ]</a>
              <a href="subject.html#196">[ subject ]</a>
              <a href="author.html#196">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: adp
Date: 2007-02-06 17:48:35 +0100 (Tue, 06 Feb 2007)
New Revision: 119

Added:
   FHoSS/trunk/config/c3p0.properties
   FHoSS/trunk/lib/c3p0-0.9.1.jar
   FHoSS/trunk/src/de/fhg/fokus/hss/Log4jInit.java
   FHoSS/trunk/src/de/fhg/fokus/hss/action/PsiTemplDeleteAction.java
   FHoSS/trunk/src/de/fhg/fokus/hss/servlet/
   FHoSS/trunk/src/de/fhg/fokus/hss/servlet/ResponseFilter.java
   FHoSS/trunk/src/de/fhg/fokus/hss/util/InfrastructureException.java
Removed:
   FHoSS/trunk/lib/c3p0-0.9.0.2.jar
   FHoSS/trunk/lib/c3p0-oracle-thin-extras-0.9.0.2.jar
   FHoSS/trunk/src-web/pages/tiles/navgiator.jsp
   FHoSS/trunk/src/de/fhg/fokus/hss/Log4jInit.java
   FHoSS/trunk/src/de/fhg/fokus/hss/StartUp.java
   FHoSS/trunk/src/de/fhg/fokus/hss/model/AuthSchemeBO.java
   FHoSS/trunk/src/de/fhg/fokus/hss/model/HssBO.java
   FHoSS/trunk/src/de/fhg/fokus/hss/server/cx/TestSubscibtion.java
   FHoSS/trunk/src/ehcache.tmp
   FHoSS/trunk/src/mapping.xml
Modified:
   FHoSS/trunk/.classpath
   FHoSS/trunk/config/DiameterPeerHSS.xml
   FHoSS/trunk/config/hibernate.properties
   FHoSS/trunk/install.txt
   FHoSS/trunk/src-web/WEB-INF/struts-config.xml
   FHoSS/trunk/src-web/WEB-INF/web.xml
   FHoSS/trunk/src-web/pages/ifc/psi.jsp
   FHoSS/trunk/src-web/pages/ifc/psiResult.jsp
   FHoSS/trunk/src-web/pages/ifc/psiTempl.jsp
   FHoSS/trunk/src-web/pages/ifc/psiTemplResult.jsp
   FHoSS/trunk/src-web/pages/info/commands.jsp
   FHoSS/trunk/src-web/pages/info/data.jsp
   FHoSS/trunk/src-web/pages/info/logging.jsp
   FHoSS/trunk/src-web/pages/info/overview.jsp
   FHoSS/trunk/src-web/pages/profiles/dStruct.jsp
   FHoSS/trunk/src-web/pages/profiles/impi.jsp
   FHoSS/trunk/src-web/pages/profiles/impuResult.jsp
   FHoSS/trunk/src-web/pages/tiles/impuSelect.jsp
   FHoSS/trunk/src-web/pages/tiles/success.jsp
   FHoSS/trunk/src/MessageResources.properties
   FHoSS/trunk/src/de/fhg/fokus/cx/AuthenticationVector.java
   FHoSS/trunk/src/de/fhg/fokus/hss/action/AsDeleteAction.java
   FHoSS/trunk/src/de/fhg/fokus/hss/action/AsSearchAction.java
   FHoSS/trunk/src/de/fhg/fokus/hss/action/AsShowAction.java
   FHoSS/trunk/src/de/fhg/fokus/hss/action/AsSubmitAction.java
   FHoSS/trunk/src/de/fhg/fokus/hss/action/ChargingSetsShowAction.java
   FHoSS/trunk/src/de/fhg/fokus/hss/action/GussShowAction.java
   FHoSS/trunk/src/de/fhg/fokus/hss/action/GussSubmitAction.java
   FHoSS/trunk/src/de/fhg/fokus/hss/action/HssAction.java
   FHoSS/trunk/src/de/fhg/fokus/hss/action/Ifc2svpEditAction.java
   FHoSS/trunk/src/de/fhg/fokus/hss/action/Ifc2svpSubmitAction.java
   FHoSS/trunk/src/de/fhg/fokus/hss/action/IfcDeleteAction.java
   FHoSS/trunk/src/de/fhg/fokus/hss/action/IfcSearchAction.java
   FHoSS/trunk/src/de/fhg/fokus/hss/action/IfcShowAction.java
   FHoSS/trunk/src/de/fhg/fokus/hss/action/IfcSubmitAction.java
   FHoSS/trunk/src/de/fhg/fokus/hss/action/ImpiDeleteAction.java
   FHoSS/trunk/src/de/fhg/fokus/hss/action/ImpiSearchAction.java
   FHoSS/trunk/src/de/fhg/fokus/hss/action/ImpiShowAction.java
   FHoSS/trunk/src/de/fhg/fokus/hss/action/ImpiSubmitAction.java
   FHoSS/trunk/src/de/fhg/fokus/hss/action/Impu2ImpiAction.java
   FHoSS/trunk/src/de/fhg/fokus/hss/action/Impu2PsiAction.java
   FHoSS/trunk/src/de/fhg/fokus/hss/action/ImpuDeleteAction.java
   FHoSS/trunk/src/de/fhg/fokus/hss/action/ImpuSearchAction.java
   FHoSS/trunk/src/de/fhg/fokus/hss/action/ImpuShowAction.java
   FHoSS/trunk/src/de/fhg/fokus/hss/action/ImpuSubmitAction.java
   FHoSS/trunk/src/de/fhg/fokus/hss/action/ImsuRemoveAction.java
   FHoSS/trunk/src/de/fhg/fokus/hss/action/ImsuSearchAction.java
   FHoSS/trunk/src/de/fhg/fokus/hss/action/ImsuShowAction.java
   FHoSS/trunk/src/de/fhg/fokus/hss/action/ImsuSubmitAction.java
   FHoSS/trunk/src/de/fhg/fokus/hss/action/NetworksShowAction.java
   FHoSS/trunk/src/de/fhg/fokus/hss/action/NetworksSubmitAction.java
   FHoSS/trunk/src/de/fhg/fokus/hss/action/PsiDeleteAction.java
   FHoSS/trunk/src/de/fhg/fokus/hss/action/PsiSearchAction.java
   FHoSS/trunk/src/de/fhg/fokus/hss/action/PsiShowAction.java
   FHoSS/trunk/src/de/fhg/fokus/hss/action/PsiSubmitAction.java
   FHoSS/trunk/src/de/fhg/fokus/hss/action/PsiTemplSearchAction.java
   FHoSS/trunk/src/de/fhg/fokus/hss/action/PsiTemplShowAction.java
   FHoSS/trunk/src/de/fhg/fokus/hss/action/PsiTemplSubmitAction.java
   FHoSS/trunk/src/de/fhg/fokus/hss/action/RoamEditAction.java
   FHoSS/trunk/src/de/fhg/fokus/hss/action/RoamSubmitAction.java
   FHoSS/trunk/src/de/fhg/fokus/hss/action/SvpDeleteAction.java
   FHoSS/trunk/src/de/fhg/fokus/hss/action/SvpSearchAction.java
   FHoSS/trunk/src/de/fhg/fokus/hss/action/SvpShowAction.java
   FHoSS/trunk/src/de/fhg/fokus/hss/action/SvpSubmitAction.java
   FHoSS/trunk/src/de/fhg/fokus/hss/action/TriggerPointDeleteAction.java
   FHoSS/trunk/src/de/fhg/fokus/hss/action/TriggerPointSearchAction.java
   FHoSS/trunk/src/de/fhg/fokus/hss/action/TriggerPointShowAction.java
   FHoSS/trunk/src/de/fhg/fokus/hss/action/TriggerPointShowXMLAction.java
   FHoSS/trunk/src/de/fhg/fokus/hss/action/TriggerPointSubmitAction.java
   FHoSS/trunk/src/de/fhg/fokus/hss/diam/CommandAction.java
   FHoSS/trunk/src/de/fhg/fokus/hss/diam/CommandListener.java
   FHoSS/trunk/src/de/fhg/fokus/hss/diam/Constants.java
   FHoSS/trunk/src/de/fhg/fokus/hss/diam/OriginHostResolver.java
   FHoSS/trunk/src/de/fhg/fokus/hss/diam/ResultCode.java
   FHoSS/trunk/src/de/fhg/fokus/hss/diam/cx/CxCommandListener.java
   FHoSS/trunk/src/de/fhg/fokus/hss/diam/cx/LIRCommandListener.java
   FHoSS/trunk/src/de/fhg/fokus/hss/diam/cx/MARCommandListener.java
   FHoSS/trunk/src/de/fhg/fokus/hss/diam/cx/PPRCommandAction.java
   FHoSS/trunk/src/de/fhg/fokus/hss/diam/cx/RTRCommandAction.java
   FHoSS/trunk/src/de/fhg/fokus/hss/diam/cx/SARCommandListener.java
   FHoSS/trunk/src/de/fhg/fokus/hss/diam/cx/UARCommandListener.java
   FHoSS/trunk/src/de/fhg/fokus/hss/diam/sh/PNRCommandAction.java
   FHoSS/trunk/src/de/fhg/fokus/hss/diam/sh/PURCommandListener.java
   FHoSS/trunk/src/de/fhg/fokus/hss/diam/sh/SNRCommandListener.java
   FHoSS/trunk/src/de/fhg/fokus/hss/diam/sh/ShCommandListener.java
   FHoSS/trunk/src/de/fhg/fokus/hss/diam/sh/UDRCommandListener.java
   FHoSS/trunk/src/de/fhg/fokus/hss/diam/zh/MARzhCommandListener.java
   FHoSS/trunk/src/de/fhg/fokus/hss/diam/zh/ZhCommandListener.java
   FHoSS/trunk/src/de/fhg/fokus/hss/form/ImpiForm.java
   FHoSS/trunk/src/de/fhg/fokus/hss/form/ImpuSubSelectForm.java
   FHoSS/trunk/src/de/fhg/fokus/hss/main/HssServer.java
   FHoSS/trunk/src/de/fhg/fokus/hss/main/TomcatServer.java
   FHoSS/trunk/src/de/fhg/fokus/hss/model/ApsvrBO.java
   FHoSS/trunk/src/de/fhg/fokus/hss/model/CxUserProfil.java
   FHoSS/trunk/src/de/fhg/fokus/hss/model/IfcBO.java
   FHoSS/trunk/src/de/fhg/fokus/hss/model/ImpiBO.java
   FHoSS/trunk/src/de/fhg/fokus/hss/model/Impu.java
   FHoSS/trunk/src/de/fhg/fokus/hss/model/ImpuBO.java
   FHoSS/trunk/src/de/fhg/fokus/hss/model/PsiBO.java
   FHoSS/trunk/src/de/fhg/fokus/hss/model/RepDataBO.java
   FHoSS/trunk/src/de/fhg/fokus/hss/model/ShUserProfil.java
   FHoSS/trunk/src/de/fhg/fokus/hss/model/SvpBO.java
   FHoSS/trunk/src/de/fhg/fokus/hss/model/TrigptBO.java
   FHoSS/trunk/src/de/fhg/fokus/hss/server/cx/CSCFOperationsImpl.java
   FHoSS/trunk/src/de/fhg/fokus/hss/server/cx/HSScxOperationsImpl.java
   FHoSS/trunk/src/de/fhg/fokus/hss/server/cx/op/AuthCxOperation.java
   FHoSS/trunk/src/de/fhg/fokus/hss/server/cx/op/CxOperation.java
   FHoSS/trunk/src/de/fhg/fokus/hss/server/cx/op/DeregisterCxOperation.java
   FHoSS/trunk/src/de/fhg/fokus/hss/server/cx/op/LocationCxOperation.java
   FHoSS/trunk/src/de/fhg/fokus/hss/server/cx/op/PullCxOperation.java
   FHoSS/trunk/src/de/fhg/fokus/hss/server/cx/op/QueryCxOperation.java
   FHoSS/trunk/src/de/fhg/fokus/hss/server/sh/HSSshOperationsImpl.java
   FHoSS/trunk/src/de/fhg/fokus/hss/server/sh/op/NotifShOperation.java
   FHoSS/trunk/src/de/fhg/fokus/hss/server/sh/op/PullShOperation.java
   FHoSS/trunk/src/de/fhg/fokus/hss/server/sh/op/ShOperation.java
   FHoSS/trunk/src/de/fhg/fokus/hss/server/sh/op/SubsShOperation.java
   FHoSS/trunk/src/de/fhg/fokus/hss/server/sh/op/UpdateShOperation.java
   FHoSS/trunk/src/de/fhg/fokus/hss/server/zh/HSSzhOperationsImpl.java
   FHoSS/trunk/src/de/fhg/fokus/hss/util/HibernateUtil.java
   FHoSS/trunk/src/de/fhg/fokus/hss/util/LoggerHelper.java
   FHoSS/trunk/src/de/fhg/fokus/security/auth/DigestAKA.java
   FHoSS/trunk/src/de/fhg/fokus/zh/AuthenticationVector.java
   FHoSS/trunk/src/hibernate.cfg.xml
   FHoSS/trunk/tomcat/webapps/ROOT/index.jsp
Log:
Fixes and Improvements:
 - managing hibernate transactions; all the problems related to hibernate and the underlying database layer solved.
 - reconfiguration of the c3p0 properties and upgrade to the last version available 
 - some updates in the web interface related to: impi, psi, psi template, logger
 - adding missing AVPs in the request/response messages related to Cx and Sh interfaces
 - fixing the bugs related to UDR and PUR

 

Modified: FHoSS/trunk/.classpath
===================================================================
--- FHoSS/trunk/.classpath	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/.classpath	2007-02-06 16:48:35 UTC (rev 119)
@@ -39,5 +39,6 @@
 	&lt;classpathentry kind=&quot;lib&quot; path=&quot;lib/struts.jar&quot;/&gt;
 	&lt;classpathentry kind=&quot;lib&quot; path=&quot;lib/castor-1.0.5.jar&quot;/&gt;
 	&lt;classpathentry kind=&quot;lib&quot; path=&quot;lib/jdp.jar&quot;/&gt;
+	&lt;classpathentry kind=&quot;lib&quot; path=&quot;lib/c3p0-0.9.1.jar&quot;/&gt;
 	&lt;classpathentry kind=&quot;output&quot; path=&quot;bin&quot;/&gt;
 &lt;/classpath&gt;

Modified: FHoSS/trunk/config/DiameterPeerHSS.xml
===================================================================
--- FHoSS/trunk/config/DiameterPeerHSS.xml	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/config/DiameterPeerHSS.xml	2007-02-06 16:48:35 UTC (rev 119)
@@ -13,7 +13,7 @@
 &gt;
 	&lt;Peer FQDN=&quot;icscf.open-ims.test&quot; Realm=&quot;open-ims.test&quot; port=&quot;3869&quot; /&gt; 
 	&lt;Peer FQDN=&quot;scscf.open-ims.test&quot; Realm=&quot;open-ims.test&quot; port=&quot;3870&quot; /&gt; 
-	
+
 	&lt;Acceptor port=&quot;3868&quot; bind=&quot;127.0.0.1&quot; /&gt;
 	
 	&lt;Auth id=&quot;16777216&quot; vendor=&quot;10415&quot;/&gt;

Added: FHoSS/trunk/config/c3p0.properties

Modified: FHoSS/trunk/config/hibernate.properties
===================================================================
--- FHoSS/trunk/config/hibernate.properties	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/config/hibernate.properties	2007-02-06 16:48:35 UTC (rev 119)
@@ -1,5 +1,6 @@
 ## MySQL
 
+# hibernate configuration
 hibernate.dialect=org.hibernate.dialect.MySQLDialect
 hibernate.connection.driver_class=org.gjt.mm.mysql.Driver
 hibernate.connection.driver_class=com.mysql.jdbc.Driver
@@ -8,8 +9,10 @@
 hibernate.connection.password=hss
 hibernate.connection.isolation=4
 
-hibernate.c3p0.min_size=2
-hibernate.c3p0.max_size=20
-hibernate.c3p0.timeout=300
-hibernate.c3p0.max_statements=50
-hibernate.c3p0.idle_test_period=3000
+# C3P0 configuration
+hibernate.c3p0.acquire_increment=1
+hibernate.c3p0.min_size=1
+hibernate.c3p0.max_size=30
+hibernate.c3p0.timeout=3600
+hibernate.c3p0.max_statements=0
+hibernate.c3p0.idle_test_period=1200

Modified: FHoSS/trunk/install.txt
===================================================================
--- FHoSS/trunk/install.txt	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/install.txt	2007-02-06 16:48:35 UTC (rev 119)
@@ -26,6 +26,11 @@
 4.2. Deploy the application to the specified path.
 ant deploy
 
+4.3 IMPORTANT NOTE: regarding reinstallation and updates
+If you just updated FHoSS sources and you make only a reinstallation, please make a clean with &quot;ant cleanall&quot; or remove the old
+deploy/ folder before you make the new deployment! If you do not want to remove your old deployment, please chose another 
+directory for the new installation. Otherwise, conflicts between versions could occur.
+
 5. Configuration after deploy
 ------------------------------
 Default configuration is made for all the needed files to run FHoSS on the 

Deleted: FHoSS/trunk/lib/c3p0-0.9.0.2.jar

Added: FHoSS/trunk/lib/c3p0-0.9.1.jar


Property changes on: FHoSS/trunk/lib/c3p0-0.9.1.jar
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Deleted: FHoSS/trunk/lib/c3p0-oracle-thin-extras-0.9.0.2.jar

Modified: FHoSS/trunk/src/MessageResources.properties
===================================================================
--- FHoSS/trunk/src/MessageResources.properties	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/MessageResources.properties	2007-02-06 16:48:35 UTC (rev 119)
@@ -23,7 +23,7 @@
 imsu.title=IMS Subscription
 imsu.head.name=IMSU Name
 imsu.error.missing.name=Missing IMS Subscription name.
-
+imsu.error.impi.assigned=The subscription cannot be deleted as a private identity is assigned to it, remove the private identity first.
 impi.title=Private Identity
 impi.head.id=Private ID
 impi.head.imsi=IMSI
@@ -35,7 +35,6 @@
 impi.head.amf=AMF
 impi.head.sqn=Sequence Number
 impi.head.sqn.reset=New Value for SQN
-impi.head.algorithm=Algorithm
 impi.head.operatorId=Operator ID
 impi.head.chrginfo=Charging Info Set
 impi.head.guss=GUSS
@@ -79,6 +78,7 @@
 network.rename=Please re-enter the network name
 network.error.missing.networkstring=Enter a network identifier string.
 network.error.duplicated=Network String exists currently.
+network.error.roam.assigned=The network cannot be deleted as it is assigned to some Private Identities for roaming
 
 # Charging Sets
 chrginfo.title=Charging Sets
@@ -89,7 +89,7 @@
 chrginfo.set.secEvent=Secundary Event.Fn.name
 chrginfo.set.error.missing.name=Enter a charging set name.
 chrginfo.set.error.missing.priEvent=Enter a Primary Event.Fn.Name.
-
+chrginfo.set.error.assigned.impi=Charging set cannot be deleted as it is assigned to some private identities.
 # roaming edit
 roam.title=Roaming Networks
 
@@ -100,6 +100,7 @@
 
 # as - application server parameter is part of ifc
 as.title=Application Server
+as.list=List of Application Servers
 as.head.asName=Application Server Name
 as.head.asAddress=AS Address
 as.head.defaultHandling=Default Handling

Modified: FHoSS/trunk/src/de/fhg/fokus/cx/AuthenticationVector.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/cx/AuthenticationVector.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/cx/AuthenticationVector.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -102,6 +102,9 @@
 		this.sipAuthorization = sipAuthorization;
 	}
 	
+	public AuthenticationVector(){
+	}
+	
 	/**
 	 * constructor 
 	 * @param authenticationScheme 

Deleted: FHoSS/trunk/src/de/fhg/fokus/hss/Log4jInit.java

Added: FHoSS/trunk/src/de/fhg/fokus/hss/Log4jInit.java

Deleted: FHoSS/trunk/src/de/fhg/fokus/hss/StartUp.java

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/action/AsDeleteAction.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/action/AsDeleteAction.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/action/AsDeleteAction.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -54,10 +54,13 @@
 import org.apache.struts.action.ActionMapping;
 import org.apache.struts.action.ActionMessage;
 import org.apache.struts.action.ActionMessages;
+import org.hibernate.Session;
 
 import de.fhg.fokus.hss.form.AsForm;
 import de.fhg.fokus.hss.model.Apsvr;
 import de.fhg.fokus.hss.model.AsPermList;
+import de.fhg.fokus.hss.util.HibernateUtil;
+import de.fhg.fokus.hss.util.InfrastructureException;
 
 /**
  * @author Andre Charton (dev -at- open-ims dot org)
@@ -68,10 +71,9 @@
 
 	public ActionForward execute(ActionMapping mapping, ActionForm actionForm,
 			HttpServletRequest request, HttpServletResponse reponse)
-			throws Exception
-	{
+			throws Exception{
+		
 		LOGGER.debug(&quot;entering&quot;);
-
 		ActionForward forward = null;
 		AsForm form = (AsForm) actionForm;
 		LOGGER.debug(form);
@@ -79,26 +81,22 @@
 
 		try
 		{
-			int assignendIfcs = ((Integer) getSession()
-					.createQuery(
-							&quot;select count(ifc) from de.fhg.fokus.hss.model.Ifc ifc where ifc.apsvr.apsvrId = ?&quot;)
+			HibernateUtil.beginTransaction();
+			Session session = HibernateUtil.getCurrentSession();
+			int assignendIfcs = ((Integer) session
+					.createQuery(&quot;select count(ifc) from de.fhg.fokus.hss.model.Ifc ifc where ifc.apsvr.apsvrId = ?&quot;)
 					.setInteger(0, primaryKey).uniqueResult()).intValue();
 
-			int assignendPsis = ((Integer) getSession()
-					.createQuery(
-							&quot;select count(psiTempl) from de.fhg.fokus.hss.model.PsiTempl psiTempl where psiTempl.apsvr.apsvrId = ?&quot;)
+			int assignendPsis = ((Integer) session
+					.createQuery(&quot;select count(psiTempl) from de.fhg.fokus.hss.model.PsiTempl psiTempl where psiTempl.apsvr.apsvrId = ?&quot;)
 					.setInteger(0, primaryKey).uniqueResult()).intValue();
 
 			if ((assignendIfcs == 0) &amp;&amp; (assignendPsis == 0))
 			{
-				beginnTx();
-				Apsvr apsvr = (Apsvr) getSession()
-						.load(Apsvr.class, primaryKey);
-				AsPermList asPermList = (AsPermList) getSession().load(
-						AsPermList.class, primaryKey);
-				getSession().delete(asPermList);
-				getSession().delete(apsvr);
-				endTx();
+				Apsvr apsvr = (Apsvr) session.load(Apsvr.class, primaryKey);
+				AsPermList asPermList = (AsPermList) session.load(AsPermList.class, primaryKey);
+				session.delete(asPermList);
+				session.delete(apsvr);
 				forward = mapping.findForward(FORWARD_SUCCESS);
 			} else
 			{
@@ -117,13 +115,13 @@
 				}
 
 				saveMessages(request, actionMessages);
-
 				forward = mapping.findForward(FORWARD_FAILURE);
 			}
-		} finally
-		{
-			closeSession();
+			HibernateUtil.commitTransaction();
 		}
+		finally{
+			HibernateUtil.closeSession();
+		}
 
 		LOGGER.debug(&quot;exiting&quot;);
 

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/action/AsSearchAction.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/action/AsSearchAction.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/action/AsSearchAction.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -45,6 +45,8 @@
 package de.fhg.fokus.hss.action;
 
 import de.fhg.fokus.hss.form.AsSearchForm;
+import de.fhg.fokus.hss.util.HibernateUtil;
+import de.fhg.fokus.hss.util.InfrastructureException;
 
 import org.apache.log4j.Logger;
 
@@ -66,9 +68,7 @@
 
 	
 	public ActionForward execute(ActionMapping mapping, ActionForm actionForm,
-			HttpServletRequest request, HttpServletResponse reponse)
-			throws Exception
-	{
+			HttpServletRequest request, HttpServletResponse reponse) throws Exception {
 		LOGGER.debug(&quot;entering&quot;);
 
 		AsSearchForm form = (AsSearchForm) actionForm;
@@ -76,10 +76,10 @@
 
 		try
 		{
+			HibernateUtil.beginTransaction();
 			// Prepare Querry
-			Query query = getSession()
-					.createQuery(
-							&quot;select apsvr from de.fhg.fokus.hss.model.Apsvr as apsvr where apsvr.name like ?&quot;);
+			Query query = HibernateUtil.getCurrentSession()
+					.createQuery(&quot;select apsvr from de.fhg.fokus.hss.model.Apsvr as apsvr where apsvr.name like ?&quot;);
 			query.setString(0, &quot;%&quot; + form.getAsName() + &quot;%&quot;);
 
 			// Check page browsing values
@@ -87,8 +87,7 @@
 			int currentPage = Integer.parseInt(form.getPage()) - 1;
 			int maxPages = (int) ((query.list().size() - 1) / rowPerPage) + 1;
 
-			if (currentPage &gt; maxPages)
-			{
+			if (currentPage &gt; maxPages){
 				currentPage = 0;
 			}
 
@@ -100,13 +99,15 @@
 
 			// store attributes in request
 			request.setAttribute(&quot;result&quot;, query.list());
-
+			HibernateUtil.commitTransaction();
+			
 			request.setAttribute(&quot;maxPages&quot;, String.valueOf(maxPages));
 			request.setAttribute(&quot;currentPage&quot;, String.valueOf(currentPage));
 			request.setAttribute(&quot;rowPerPage&quot;, String.valueOf(rowPerPage));
-		} finally
+		}
+		finally
 		{
-			closeSession();
+			HibernateUtil.closeSession();
 		}
 
 		LOGGER.debug(&quot;exiting&quot;);

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/action/AsShowAction.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/action/AsShowAction.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/action/AsShowAction.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -55,6 +55,8 @@
 import de.fhg.fokus.hss.form.AsForm;
 import de.fhg.fokus.hss.model.Apsvr;
 import de.fhg.fokus.hss.model.AsPermList;
+import de.fhg.fokus.hss.util.HibernateUtil;
+import de.fhg.fokus.hss.util.InfrastructureException;
 
 /**
  * @author Andre Charton (dev -at- open-ims dot org)
@@ -64,50 +66,54 @@
 	private static final Logger LOGGER = Logger.getLogger(AsShowAction.class);
 
 	public ActionForward execute(ActionMapping mapping, ActionForm actionForm,
-			HttpServletRequest request, HttpServletResponse reponse)
-			throws Exception
-	{
+			HttpServletRequest request, HttpServletResponse reponse) throws Exception{
+		
 		LOGGER.debug(&quot;entering&quot;);
 
 		AsForm form = (AsForm) actionForm;
-		// LOGGER.debug(form);
-
-		Apsvr apsvr = (Apsvr) getSession().load(Apsvr.class,
+		ActionForward action = null; 
+			
+		try{
+			HibernateUtil.beginTransaction();
+			Apsvr apsvr = (Apsvr) HibernateUtil.getCurrentSession().load(Apsvr.class,
 				form.getPrimaryKey());
-		form.setAsAddress(apsvr.getAddress());
-		form.setAsName(apsvr.getName());
-		form.setAsId(String.valueOf(apsvr.getApsvrId().intValue()));
-		form.setDefaultHandling(String.valueOf(apsvr.getDefaultHandling()));
+			form.setAsAddress(apsvr.getAddress());
+			form.setAsName(apsvr.getName());
+			form.setAsId(String.valueOf(apsvr.getApsvrId().intValue()));
+			form.setDefaultHandling(String.valueOf(apsvr.getDefaultHandling()));
 
-		AsPermList asPermList = (AsPermList) getSession().get(AsPermList.class,
-				form.getPrimaryKey());
-		if (asPermList != null)
-		{
-			form.setPullRepData(asPermList.isPullRepData());
-			form.setPull(asPermList.isPull());
-			form.setPullCharging(asPermList.isPullCharging());
-			form.setPullIfc(asPermList.isPullIfc());
-			form.setPullImpu(asPermList.isPullImpu());
-			form.setPullImpuUserState(asPermList.isPullImpuUserState());
-			form.setPullUserState(asPermList.isPullUserState());
-			form.setPullScscfName(asPermList.isPullScscfName());
-			form.setPullMsisdn(asPermList.isPullMsisdn());
-			form.setPullPsi(asPermList.isPullPsi());
-			form.setPullLocInfo(asPermList.isPullLocInfo());
-			form.setUpdPsi(asPermList.isUpdPsi());
-			form.setUpdRepData(asPermList.isUpdRepData());
-			form.setSubIfc(asPermList.isSubIfc());
-			form.setSubImpuUserState(asPermList.isSubImpuUserState());
-			form.setSubRepData(asPermList.isSubRepData());
-			form.setSubScscfname(asPermList.isSubScscfname());
-			form.setSubPsi(asPermList.isSubPsi());
+			AsPermList asPermList = (AsPermList) HibernateUtil.getCurrentSession().get(AsPermList.class, form.getPrimaryKey());
+			if (asPermList != null)
+			{
+				form.setPullRepData(asPermList.isPullRepData());
+				form.setPull(asPermList.isPull());
+				form.setPullCharging(asPermList.isPullCharging());
+				form.setPullIfc(asPermList.isPullIfc());
+				form.setPullImpu(asPermList.isPullImpu());
+				form.setPullImpuUserState(asPermList.isPullImpuUserState());
+				form.setPullUserState(asPermList.isPullUserState());
+				form.setPullScscfName(asPermList.isPullScscfName());
+				form.setPullMsisdn(asPermList.isPullMsisdn());
+				form.setPullPsi(asPermList.isPullPsi());
+				form.setPullLocInfo(asPermList.isPullLocInfo());
+				form.setUpdPsi(asPermList.isUpdPsi());
+				form.setUpdRepData(asPermList.isUpdRepData());
+				form.setSubIfc(asPermList.isSubIfc());
+				form.setSubImpuUserState(asPermList.isSubImpuUserState());
+				form.setSubRepData(asPermList.isSubRepData());
+				form.setSubScscfname(asPermList.isSubScscfname());
+				form.setSubPsi(asPermList.isSubPsi());
+			}			
+			HibernateUtil.commitTransaction();
+			action = mapping.findForward(FORWARD_SUCCESS); 
 		}
-
-		closeSession();
-
+		finally{
+			HibernateUtil.closeSession();
+		}
+		
 		LOGGER.debug(&quot;exiting&quot;);
 
-		return mapping.findForward(FORWARD_SUCCESS);
+		return action;
 	}
 
 }

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/action/AsSubmitAction.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/action/AsSubmitAction.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/action/AsSubmitAction.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -48,6 +48,8 @@
 import de.fhg.fokus.hss.model.Apsvr;
 import de.fhg.fokus.hss.model.ApsvrBO;
 import de.fhg.fokus.hss.model.AsPermList;
+import de.fhg.fokus.hss.util.HibernateUtil;
+import de.fhg.fokus.hss.util.InfrastructureException;
 
 import org.apache.log4j.Logger;
 
@@ -89,6 +91,7 @@
 
 		try
 		{
+			HibernateUtil.beginTransaction();
 			if (primaryKey.intValue() == -1)
 			{
 				apsvr = new Apsvr();
@@ -130,21 +133,20 @@
 			asPermList.setSubPsi(form.isSubPsi());
 
 			apsvrBO.saveOrUpdate(apsvr, asPermList);
-
+			HibernateUtil.commitTransaction();
+			
 			forward = mapping.findForward(FORWARD_SUCCESS);
-			forward = new ActionForward(forward.getPath() + &quot;?asId=&quot;
-					+ apsvr.getApsvrId(), true);
-		} catch (ConstraintViolationException e)
-		{
+			forward = new ActionForward(forward.getPath() + &quot;?asId=&quot; + apsvr.getApsvrId(), true);
+		} 
+		catch (ConstraintViolationException e){
 			LOGGER.debug(this, e);
 			ActionMessages actionMessages = new ActionMessages();
-			actionMessages.add(Globals.MESSAGE_KEY, new ActionMessage(
-					&quot;error.duplicate&quot;));
+			actionMessages.add(Globals.MESSAGE_KEY, new ActionMessage(&quot;error.duplicate&quot;));
 			saveMessages(request, actionMessages);
 			forward = mapping.findForward(FORWARD_FAILURE);
-		} finally
-		{
-			apsvrBO.closeSession();
+		} 
+		finally{
+			HibernateUtil.closeSession();
 		}
 
 		if (LOGGER.isDebugEnabled())

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/action/ChargingSetsShowAction.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/action/ChargingSetsShowAction.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/action/ChargingSetsShowAction.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -46,6 +46,8 @@
 
 import de.fhg.fokus.hss.form.ChrginfoForm;
 import de.fhg.fokus.hss.model.Chrginfo;
+import de.fhg.fokus.hss.model.Impi;
+import de.fhg.fokus.hss.util.HibernateUtil;
 
 import org.apache.log4j.Logger;
 
@@ -56,8 +58,11 @@
 import org.apache.struts.action.ActionMessage;
 import org.apache.struts.action.ActionMessages;
 
+import org.hibernate.Query;
+import org.hibernate.Session;
 import org.hibernate.exception.ConstraintViolationException;
 
+import java.util.Iterator;
 import java.util.List;
 
 import javax.servlet.http.HttpServletRequest;
@@ -75,95 +80,101 @@
 			.getLogger(ChargingSetsShowAction.class);
 
 	public ActionForward execute(ActionMapping mapping, ActionForm form,
-			HttpServletRequest request, HttpServletResponse response)
-			throws Exception
-	{
+			HttpServletRequest request, HttpServletResponse response) throws Exception {
+		
 		LOGGER.debug(&quot;entering&quot;);
-
 		ActionForward forward = null;
-		List chrginfoList = getSession().createCriteria(Chrginfo.class).list();
-
-		ChrginfoForm chrgForm = (ChrginfoForm) form;
-
-		try
-		{
+		
+		try{
+			HibernateUtil.beginTransaction();
+			Session session = HibernateUtil.getCurrentSession();
+			
+			List chrginfoList = session.createCriteria(Chrginfo.class).list();
+			ChrginfoForm chrgForm = (ChrginfoForm) form;
 			if (chrgForm.getAction() != null)
 			{
-				Integer primaryKey = Integer.valueOf(request
-						.getParameter(&quot;chrgId&quot;));
+				Integer primaryKey = Integer.valueOf(request.getParameter(&quot;chrgId&quot;));
 
-				if (chrgForm.getAction().equals(ChrginfoForm.ACTION_EDIT))
-				{
-					Chrginfo chrginfo = (Chrginfo) getSession().get(
-							Chrginfo.class, primaryKey);
+				if (chrgForm.getAction().equals(ChrginfoForm.ACTION_EDIT)){
+					Chrginfo chrginfo = (Chrginfo) session.get(Chrginfo.class, primaryKey);
+					
 					chrgForm.setChrgId(convString(chrginfo.getChrgId()));
 					chrgForm.setName(chrginfo.getName());
-					chrgForm.setPriChrgCollFnName(chrginfo
-							.getPriChrgCollFnName());
-					chrgForm.setSecChrgCollFnName(chrginfo
-							.getSecChrgCollFnName());
-					chrgForm.setPriEventChrgFnName(chrginfo
-							.getPriEventChrgFnName());
-					chrgForm.setSecEventChrgFnName(chrginfo
-							.getSecEventChrgFnName());
-				} else if (chrgForm.getAction().equals(
-						ChrginfoForm.ACTION_SUBMIT))
-				{
+					chrgForm.setPriChrgCollFnName(chrginfo.getPriChrgCollFnName());
+					chrgForm.setSecChrgCollFnName(chrginfo.getSecChrgCollFnName());
+					chrgForm.setPriEventChrgFnName(chrginfo.getPriEventChrgFnName());
+					chrgForm.setSecEventChrgFnName(chrginfo.getSecEventChrgFnName());
+				}
+				else if (chrgForm.getAction().equals(ChrginfoForm.ACTION_SUBMIT)){
 					Chrginfo chrginfo = null;
 
-					if (primaryKey.intValue() != -1)
-					{
-						chrginfo = (Chrginfo) getSession().get(Chrginfo.class,
-								primaryKey);
-					} else
-					{
+					if (primaryKey.intValue() != -1){
+						chrginfo = (Chrginfo) session.get(Chrginfo.class,primaryKey);
+					} 
+					else{
 						chrginfo = new Chrginfo();
 						chrginfoList.add(chrginfo);
 					}
 
 					chrginfo.setName(chrgForm.getName());
-					chrginfo.setPriChrgCollFnName(chrgForm
-							.getPriChrgCollFnName());
-					chrginfo.setPriEventChrgFnName(chrgForm
-							.getPriEventChrgFnName());
-					chrginfo.setSecChrgCollFnName(chrgForm
-							.getSecChrgCollFnName());
-					chrginfo.setSecEventChrgFnName(chrgForm
-							.getSecEventChrgFnName());
-					beginnTx();
-					getSession().saveOrUpdate(chrginfo);
-					endTx();
-				} else if (chrgForm.getAction().equals(
-						ChrginfoForm.ACTION_DELETE))
-				{
-					Chrginfo chrginfo = (Chrginfo) getSession().get(
-							Chrginfo.class, primaryKey);
-					beginnTx();
-					getSession().delete(chrginfo);
-					chrginfoList.remove(chrginfo);
-					endTx();
+					chrginfo.setPriChrgCollFnName(chrgForm.getPriChrgCollFnName());
+					chrginfo.setPriEventChrgFnName(chrgForm.getPriEventChrgFnName());
+					chrginfo.setSecChrgCollFnName(chrgForm.getSecChrgCollFnName());
+					chrginfo.setSecEventChrgFnName(chrgForm.getSecEventChrgFnName());
+					session.saveOrUpdate(chrginfo);
 				}
+				else if (chrgForm.getAction().equals(ChrginfoForm.ACTION_DELETE)){
+					
+					if(checkAssignedImpis(primaryKey)){
+                    	ActionMessages actionMessages = new ActionMessages();
+                        actionMessages.add(Globals.MESSAGE_KEY, new ActionMessage(&quot;chrginfo.set.error.assigned.impi&quot;));
+                        saveMessages(request, actionMessages);
+                        forward = mapping.findForward(FORWARD_FAILURE);
+                        HibernateUtil.commitTransaction();
+                        HibernateUtil.closeSession();
+                        return forward;
+                    }					
+					else{
+						Chrginfo chrginfo = (Chrginfo) session.get(Chrginfo.class, primaryKey);
+						session.delete(chrginfo);
+						chrginfoList.remove(chrginfo);
+					}
+				}
 			}
-
+			
+			HibernateUtil.commitTransaction();
 			forward = mapping.findForward(FORWARD_SUCCESS);
-		} catch (ConstraintViolationException e)
-		{
+			request.setAttribute(&quot;chrginfos&quot;, chrginfoList);
+			
+		} 
+		catch (ConstraintViolationException e){
 			LOGGER.debug(this, e);
 
 			ActionMessages actionMessages = new ActionMessages();
-			actionMessages.add(Globals.MESSAGE_KEY, new ActionMessage(
-					&quot;error.duplicate&quot;));
+			actionMessages.add(Globals.MESSAGE_KEY, new ActionMessage(&quot;error.duplicate&quot;));
 			saveMessages(request, actionMessages);
 			forward = mapping.findForward(FORWARD_FAILURE);
-		} finally
-		{
-			closeSession();
+		} 
+		finally{
+			HibernateUtil.closeSession();
 		}
 
-		request.setAttribute(&quot;chrginfos&quot;, chrginfoList);
-
 		LOGGER.debug(&quot;exiting&quot;);
-
-		return mapping.findForward(FORWARD_SUCCESS);
+		return forward;
 	}
+	
+    private boolean checkAssignedImpis(Integer pKey){
+    	Chrginfo chrgInfo = null;
+        Impi impi = null;
+        Iterator it = null;
+        Chrginfo chrginfo = (Chrginfo) HibernateUtil.getCurrentSession().get(Chrginfo.class, pKey);
+        List list = HibernateUtil.getCurrentSession().createQuery(&quot;from de.fhg.fokus.hss.model.Impi as impi where impi.chrginfo = :value&quot;)
+        	.setEntity(&quot;value&quot;, chrginfo).list();
+        
+        if (list != null &amp;&amp; list.size() &gt; 0){
+        	return true;
+        }
+        
+        return false;
+    }	
 }

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/action/GussShowAction.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/action/GussShowAction.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/action/GussShowAction.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -61,6 +61,7 @@
 import de.fhg.fokus.hss.form.UssForm;
 import de.fhg.fokus.hss.model.Impi;
 import de.fhg.fokus.hss.model.UserSecSettings;
+import de.fhg.fokus.hss.util.HibernateUtil;
 
 /**
  * @author Andre Charton (dev -at- open-ims dot org)
@@ -70,61 +71,58 @@
 	private static final Logger LOGGER = Logger.getLogger(GussShowAction.class);
 
 	public ActionForward execute(ActionMapping mapping, ActionForm actionForm,
-			HttpServletRequest request, HttpServletResponse reponse)
-			throws Exception
-	{
+			HttpServletRequest request, HttpServletResponse reponse) throws Exception {
+
 		LOGGER.debug(&quot;entering&quot;);
 
 		GussForm form = (GussForm) actionForm;
+		
+		try{
+			HibernateUtil.beginTransaction();
+			Impi impi = (Impi) HibernateUtil.getCurrentSession().load(Impi.class, form.getPrimaryKey());
 
-		Impi impi = (Impi) getSession().load(Impi.class, form.getPrimaryKey());
+			// Load the uss list
+			Query query = HibernateUtil.getCurrentSession()
+				.createQuery(&quot;select uss from de.fhg.fokus.hss.model.UserSecSettings as uss where uss.impiId = ?&quot;);
+			query.setInteger(0, form.getPrimaryKey());
 
-		// Load the uss list
-		Query query = getSession()
-				.createQuery(
-						&quot;select uss from de.fhg.fokus.hss.model.UserSecSettings as uss where uss.impiId = ?&quot;);
+			List gussList = query.list();
+			
+			ArrayList ussList = new ArrayList();
+			Iterator it = gussList.iterator();
 
-		query.setInteger(0, form.getPrimaryKey());
+			while (it.hasNext()){
+				UserSecSettings uss = (UserSecSettings) it.next();
+				UssForm ussForm = new UssForm();
+				ussForm.setId(convString(uss.getId()));
+				ussForm.setFlag(uss.getFlag().intValue());
+				ussForm.setUssType(uss.getUssType());
+				ussForm.setNafGroup(uss.getNafGroup());
+				ussList.add(ussForm);
+			}
 
-		List gussList = query.list();
-		ArrayList ussList = new ArrayList();
+			if ((request.getParameter(&quot;addUss&quot;) != null) &amp;&amp; (request.getParameter(&quot;addUss&quot;).equals(&quot;true&quot;))){
+				UssForm ussForm = new UssForm();
+				ussForm.setId(&quot;-1&quot;);
+				ussList.add(ussForm);
+			}
 
-		Iterator it = gussList.iterator();
+			form.setUssList(ussList);
 
-		while (it.hasNext())
-		{
-			UserSecSettings uss = (UserSecSettings) it.next();
-			UssForm ussForm = new UssForm();
-			ussForm.setId(convString(uss.getId()));
-			ussForm.setFlag(uss.getFlag().intValue());
-			ussForm.setUssType(uss.getUssType());
-			ussForm.setNafGroup(uss.getNafGroup());
-			ussList.add(ussForm);
-		}
+			// add the impi values
+			form.setUiccType(impi.getUiccType().intValue());
+			form.setImpiString(impi.getImpiString());
 
-		if ((request.getParameter(&quot;addUss&quot;) != null)
-				&amp;&amp; (request.getParameter(&quot;addUss&quot;).equals(&quot;true&quot;)))
-		{
-			UssForm ussForm = new UssForm();
-			ussForm.setId(&quot;-1&quot;);
-			ussList.add(ussForm);
+			if (impi.getKeyLifeTime() != null){
+				form.setKeyLifeTime(impi.getKeyLifeTime());
+			}
+			HibernateUtil.commitTransaction();
 		}
-
-		form.setUssList(ussList);
-
-		// add the impi values
-		form.setUiccType(impi.getUiccType().intValue());
-		form.setImpiString(impi.getImpiString());
-
-		if (impi.getKeyLifeTime() != null)
-		{
-			form.setKeyLifeTime(impi.getKeyLifeTime());
+		finally{
+			HibernateUtil.closeSession();
 		}
-
-		closeSession();
-
+		
 		LOGGER.debug(&quot;exiting&quot;);
-
 		return mapping.findForward(FORWARD_SUCCESS);
 	}
 }

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/action/GussSubmitAction.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/action/GussSubmitAction.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/action/GussSubmitAction.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -58,6 +58,7 @@
 import de.fhg.fokus.hss.form.UssForm;
 import de.fhg.fokus.hss.model.Impi;
 import de.fhg.fokus.hss.model.UserSecSettings;
+import de.fhg.fokus.hss.util.HibernateUtil;
 
 /**
  * @author Andre Charton (dev -at- open-ims dot org)
@@ -68,80 +69,63 @@
 			.getLogger(GussSubmitAction.class);
 
 	public ActionForward execute(ActionMapping mapping, ActionForm actionForm,
-			HttpServletRequest request, HttpServletResponse reponse)
-			throws Exception
-	{
+			HttpServletRequest request, HttpServletResponse reponse) throws Exception {
 		LOGGER.debug(&quot;entering&quot;);
 
 		GussForm form = (GussForm) actionForm;
 
 		Impi impi;
-		try
-		{
-			beginnTx();
-
-			impi = (Impi) getSession().load(Impi.class, form.getPrimaryKey());
-
+		try{
+			HibernateUtil.beginTransaction();
+			impi = (Impi) HibernateUtil.getCurrentSession().load(Impi.class, form.getPrimaryKey());
 			impi.setUiccType(new Integer(form.getUiccType()));
 			impi.setKeyLifeTime(new Integer(form.getKeyLifeTime()));
 
 			Iterator it = form.getUssList().iterator();
-
 			while (it.hasNext())
 			{
 				UssForm ussForm = (UssForm) it.next();
 				UserSecSettings userSecSettings = null;
 				Integer primaryKey = ussForm.getPrimaryKey();
 
-				if (primaryKey.intValue() != -1)
-				{
+				if (primaryKey.intValue() != -1){
 					// Load USS
-					userSecSettings = (UserSecSettings) getSession().load(
-							UserSecSettings.class, primaryKey);
-				} else
-				{
-					if (ussForm.isDelete() == false)
-					{
+					userSecSettings = (UserSecSettings) HibernateUtil.getCurrentSession().load(UserSecSettings.class, primaryKey);
+				} 
+				else{
+					if (ussForm.isDelete() == false){
 						// Create new if no delete
 						userSecSettings = new UserSecSettings();
 						userSecSettings.setImpiId(impi.getImpiId());
 					}
 				}
 
-				if (ussForm.isDelete())
-				{
-					if (primaryKey.intValue() != -1)
-					{
+				if (ussForm.isDelete()){
+					if (primaryKey.intValue() != -1){
 						// Delete if delete seleceted and id is known
-						getSession().delete(userSecSettings);
+						HibernateUtil.getCurrentSession().delete(userSecSettings);
 					}
-				} else
-				{
+				} 
+				else{
 					// Save or update if no delete selected
 					userSecSettings.setFlag(ussForm.getFlag());
 					userSecSettings.setNafGroup(ussForm.getNafGroup());
-					userSecSettings
-							.setUssType(new Integer(ussForm.getUssType()));
-					getSession().saveOrUpdate(userSecSettings);
+					userSecSettings.setUssType(new Integer(ussForm.getUssType()));
+					HibernateUtil.getCurrentSession().saveOrUpdate(userSecSettings);
 				}
 			}
 
-			getSession().update(impi);
-			endTx();
-		} catch (Exception e)
-		{
-			throw e;
-		} finally
-		{
-			closeSession();
+			HibernateUtil.getCurrentSession().update(impi);
+			HibernateUtil.commitTransaction();
 		}
+		finally{
+			HibernateUtil.closeSession();
+		}
 
 		ActionForward forward = mapping.findForward(FORWARD_SUCCESS);
-		forward = new ActionForward(forward.getPath() + &quot;?impiId=&quot;
-				+ impi.getImpiId(), true);
+		forward = new ActionForward(forward.getPath() + &quot;?impiId=&quot; + impi.getImpiId(), true);
 
 		LOGGER.debug(&quot;exiting&quot;);
-
 		return forward;
 	}
 }

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/action/HssAction.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/action/HssAction.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/action/HssAction.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -66,55 +66,11 @@
 
 	public static final String FORWARD_FAILURE = &quot;failure&quot;;
 
-	private Session session = null;
 
-	private Transaction tx = null;
 
-	protected Session getSession()
-	{
-		if (session != null)
-		{
-			return session;
-		} else
-		{
-			openSession();
-
-			return session;
-		}
-	}
-
 	protected static String convString(Integer integerObj)
 	{
 		return String.valueOf(integerObj.intValue());
 	}
 
-	protected void openSession()
-	{
-		session = HibernateUtil.currentSession();
-	}
-
-	public void closeSession()
-	{
-		session = null;
-		HibernateUtil.closeSession();
-	}
-
-	protected void flushSession()
-	{
-		session.flush();
-	}
-
-	protected void beginnTx()
-	{
-		tx = getSession().beginTransaction();
-	}
-
-	protected void endTx()
-	{
-		if ((tx != null) &amp;&amp; (session.isOpen()))
-		{
-			tx.commit();
-			session.flush();
-		}
-	}
 }

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/action/Ifc2svpEditAction.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/action/Ifc2svpEditAction.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/action/Ifc2svpEditAction.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -60,6 +60,7 @@
 import de.fhg.fokus.hss.model.Ifc;
 import de.fhg.fokus.hss.model.Ifc2svp;
 import de.fhg.fokus.hss.model.Svp;
+import de.fhg.fokus.hss.util.HibernateUtil;
 
 /**
  * @author Andre Charton (dev -at- open-ims dot org)
@@ -70,43 +71,40 @@
 			.getLogger(Ifc2svpEditAction.class);
 
 	public ActionForward execute(ActionMapping mapping, ActionForm actionForm,
-			HttpServletRequest request, HttpServletResponse reponse)
-			throws Exception
-	{
+			HttpServletRequest request, HttpServletResponse reponse) throws Exception {
+		
 		LOGGER.debug(&quot;entering&quot;);
 
 		Ifc2svpForm form = (Ifc2svpForm) actionForm;
 
-		Query query = getSession()
-				.createQuery(
-						&quot;select ifc2svp from de.fhg.fokus.hss.model.Ifc2svp as ifc2svp where ifc2svp.comp_id.svpId = ? order by ifc2svp.priority asc&quot;);
+		try{
+			HibernateUtil.beginTransaction();
+			Query query = HibernateUtil.getCurrentSession().createQuery(&quot;select ifc2svp from de.fhg.fokus.hss.model.Ifc2svp as ifc2svp where ifc2svp.comp_id.svpId = ? order by ifc2svp.priority asc&quot;);
+			query.setString(0, form.getSvpId());
 
-		query.setString(0, form.getSvpId());
+			ArrayList assignedIfcs = new ArrayList();
+			Iterator ifcs2impiIt = query.list().iterator();
 
-		ArrayList assignedIfcs = new ArrayList();
-		Iterator ifcs2impiIt = query.list().iterator();
+			while (ifcs2impiIt.hasNext()){
+				Ifc2svp ifc2svp = (Ifc2svp) ifcs2impiIt.next();
+				assignedIfcs.add(ifc2svp.getIfc());
+			}
 
-		while (ifcs2impiIt.hasNext())
-		{
-			Ifc2svp ifc2svp = (Ifc2svp) ifcs2impiIt.next();
-			assignedIfcs.add(ifc2svp.getIfc());
-		}
+			ArrayList ifcs = new ArrayList(HibernateUtil.getCurrentSession().createCriteria(Ifc.class).list());
+			ifcs.removeAll(assignedIfcs);
 
-		ArrayList ifcs = new ArrayList(getSession().createCriteria(Ifc.class)
-				.list());
-		ifcs.removeAll(assignedIfcs);
+			form.setAssignedIfcs(assignedIfcs);
+			form.setIfcs(ifcs);
 
-		form.setAssignedIfcs(assignedIfcs);
-		form.setIfcs(ifcs);
-
-		Svp svp = (Svp) getSession().load(Svp.class, form.getPrimaryKey());
-		form.setSvpId(convString(svp.getSvpId()));
-		form.setName(svp.getName());
-
+			Svp svp = (Svp) HibernateUtil.getCurrentSession().load(Svp.class, form.getPrimaryKey());
+			form.setSvpId(convString(svp.getSvpId()));
+			form.setName(svp.getName());
+			HibernateUtil.commitTransaction();
+		}
+		finally{
+			HibernateUtil.closeSession();
+		}
 		LOGGER.debug(actionForm);
-
-		closeSession();
-
 		LOGGER.debug(&quot;exiting&quot;);
 
 		return mapping.findForward(FORWARD_SUCCESS);

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/action/Ifc2svpSubmitAction.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/action/Ifc2svpSubmitAction.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/action/Ifc2svpSubmitAction.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -60,6 +60,7 @@
 import de.fhg.fokus.hss.model.Ifc2svpPK;
 import de.fhg.fokus.hss.model.Svp;
 import de.fhg.fokus.hss.model.SvpBO;
+import de.fhg.fokus.hss.util.HibernateUtil;
 
 /**
  * @author Andre Charton (dev -at- open-ims dot org)
@@ -73,9 +74,7 @@
 	 * Get the roam string list from request and store them to selected impi.
 	 */
 	public ActionForward execute(ActionMapping mapping, ActionForm actionForm,
-			HttpServletRequest request, HttpServletResponse response)
-			throws Exception
-	{
+			HttpServletRequest request, HttpServletResponse response) throws Exception {
 		LOGGER.debug(&quot;entering&quot;);
 
 		// Get assigned ifcs strings list from request
@@ -85,68 +84,61 @@
 		Iterator it = null;
 		Svp svp;
 
-		try
-		{
+		try{
 			boolean commitSvpChanges = false;
-			beginnTx();
-			svp = (Svp) getSession().get(Svp.class, svpId);
+			
+			HibernateUtil.beginTransaction();
+			svp = (Svp) HibernateUtil.getCurrentSession().get(Svp.class, svpId);
 			Set oldIfcsList = svp.getIfc2svps();
 
-			if (assignedIfcs != null)
-			{
+			if (assignedIfcs != null){
 				// get a list with all roaming network
-				it = getSession()
-						.createQuery(
-								&quot;select ifc from de.fhg.fokus.hss.model.Ifc as ifc where ifc.ifcId in (:ifcsList)&quot;)
+				it = HibernateUtil.getCurrentSession()
+						.createQuery(&quot;select ifc from de.fhg.fokus.hss.model.Ifc as ifc where ifc.ifcId in (:ifcsList)&quot;)
 						.setParameterList(&quot;ifcsList&quot;, assignedIfcs).list()
 						.iterator();
 
 				// Iterete throw selected Ifcs and add them with priority to
-				while (it.hasNext())
-				{
+				while (it.hasNext()){
 					Ifc ifc = (Ifc) it.next();
 					Ifc2svp ifc2svp = null;
 					Ifc2svpPK pk = new Ifc2svpPK(ifc.getIfcId(), svpId);
 
-					ifc2svp = (Ifc2svp) getSession().get(Ifc2svp.class, pk);
+					ifc2svp = (Ifc2svp) HibernateUtil.getCurrentSession().get(Ifc2svp.class, pk);
 
-					if (ifc2svp == null)
-					{
-						ifc2svp = new Ifc2svp(pk, calculatePriorityId(
-								assignedIfcs, ifc), svp, ifc);
-						getSession().save(ifc2svp);
+					if (ifc2svp == null){
+						ifc2svp = new Ifc2svp(pk, calculatePriorityId(assignedIfcs, ifc), svp, ifc);
+						HibernateUtil.getCurrentSession().save(ifc2svp);
 						commitSvpChanges = true;
-					} else
-					{
+					} 
+					else{
 						// remove from deselection list
 						oldIfcsList.remove(ifc2svp);
 						int oldPriority = ifc2svp.getPriority();
 						int newPriority = calculatePriorityId(assignedIfcs, ifc);
 						ifc2svp.setPriority(newPriority);
-						commitSvpChanges = commitSvpChanges
-								|| (oldPriority != newPriority);
-						getSession().update(ifc2svp);
+						commitSvpChanges = commitSvpChanges || (oldPriority != newPriority);
+						HibernateUtil.getCurrentSession().update(ifc2svp);
 					}
 				}
 			}
 			commitSvpChanges = commitSvpChanges || deselectIfcs(oldIfcsList);
-			endTx();
-			if (commitSvpChanges)
-			{
+			HibernateUtil.commitTransaction();
+			
+			if (commitSvpChanges){
 				SvpBO svpBO = new SvpBO();
 				svpBO.commitCxChanges(svp);
-				svpBO.closeSession();
 			}
-		} finally
-		{
-			closeSession();
 		}
-
+		finally{
+			HibernateUtil.closeSession();
+		}
+		
 		// forward to impiShow with specific svpid
 		ActionForward forward = mapping.findForward(FORWARD_SUCCESS);
 		forward = new ActionForward(forward.getPath() + &quot;?svpId=&quot; + svpId, true);
 		LOGGER.debug(&quot;exiting&quot;);
-
+		
 		return forward;
 	}
 
@@ -158,10 +150,8 @@
 	 */
 	private int calculatePriorityId(String[] assignedIfcs, Ifc ifc)
 	{
-		for (int ix = 0; ix &lt; assignedIfcs.length; ix++)
-		{
-			if (ifc.getIfcId().intValue() == Integer.parseInt(assignedIfcs[ix]))
-			{
+		for (int ix = 0; ix &lt; assignedIfcs.length; ix++){
+			if (ifc.getIfcId().intValue() == Integer.parseInt(assignedIfcs[ix])){
 				return ix;
 			}
 		}
@@ -173,14 +163,13 @@
 	 * Removes the Ifc
 	 * @param oldIfcsList
 	 */
-	private boolean deselectIfcs(Set oldIfcsList)
-	{
+	private boolean deselectIfcs(Set oldIfcsList){
 		Iterator it;
 		it = oldIfcsList.iterator();
 		boolean deleted = false;
-		while (it.hasNext())
-		{
-			getSession().delete((Ifc2svp) it.next());
+
+		while (it.hasNext()){
+			HibernateUtil.getCurrentSession().delete((Ifc2svp) it.next());
 			deleted = true;
 		}
 		return deleted;

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/action/IfcDeleteAction.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/action/IfcDeleteAction.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/action/IfcDeleteAction.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -59,6 +59,7 @@
 
 import de.fhg.fokus.hss.form.IfcForm;
 import de.fhg.fokus.hss.model.Ifc;
+import de.fhg.fokus.hss.util.HibernateUtil;
 
 /**
  * Delete a IFC.
@@ -71,9 +72,8 @@
 			.getLogger(IfcDeleteAction.class);
 
 	public ActionForward execute(ActionMapping mapping, ActionForm actionForm,
-			HttpServletRequest request, HttpServletResponse reponse)
-			throws Exception
-	{
+			HttpServletRequest request, HttpServletResponse reponse) throws Exception {
+		
 		LOGGER.debug(&quot;entering&quot;);
 
 		ActionForward forward = null;
@@ -82,16 +82,16 @@
 
 		try
 		{
-			beginnTx();
-
 			Integer primaryKey = form.getPrimaryKey();
-			Ifc ifc = (Ifc) getSession().load(Ifc.class, primaryKey,
-					LockMode.READ);
-			getSession().delete(ifc);
-			endTx();
+
+			HibernateUtil.beginTransaction();
+			Ifc ifc = (Ifc) HibernateUtil.getCurrentSession().load(Ifc.class, primaryKey, LockMode.READ);
+			HibernateUtil.getCurrentSession().delete(ifc);
+			HibernateUtil.commitTransaction();
+			
 			forward = mapping.findForward(FORWARD_SUCCESS);
-		} catch (ConstraintViolationException e)
-		{
+		}
+		catch (ConstraintViolationException e){
 			LOGGER.debug(this, e);
 
 			ActionMessages actionMessages = new ActionMessages();
@@ -99,17 +99,16 @@
 					&quot;error.constraint&quot;));
 			saveMessages(request, actionMessages);
 			forward = mapping.findForward(FORWARD_FAILURE);
-		} finally
-		{
-			closeSession();
 		}
+		finally{
+			HibernateUtil.closeSession();
+		}
 
 		if (LOGGER.isDebugEnabled())
 		{
 			LOGGER.debug(forward);
 			LOGGER.debug(&quot;exiting&quot;);
 		}
-
 		return forward;
 	}
 }

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/action/IfcSearchAction.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/action/IfcSearchAction.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/action/IfcSearchAction.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -54,6 +54,7 @@
 import org.hibernate.Query;
 
 import de.fhg.fokus.hss.form.IfcSearchForm;
+import de.fhg.fokus.hss.util.HibernateUtil;
 
 /**
  * Searches an IFC
@@ -66,20 +67,17 @@
 			.getLogger(IfcSearchAction.class);
 
 	public ActionForward execute(ActionMapping mapping, ActionForm actionForm,
-			HttpServletRequest request, HttpServletResponse reponse)
-			throws Exception
-	{
+			HttpServletRequest request, HttpServletResponse reponse) throws Exception {
+		
 		LOGGER.debug(&quot;entering&quot;);
 
 		IfcSearchForm form = (IfcSearchForm) actionForm;
 		LOGGER.debug(form);
 
-		try
-		{
-			// Prepare Querry
-			Query query = getSession()
-					.createQuery(
-							&quot;select ifc from de.fhg.fokus.hss.model.Ifc as ifc where ifc.name like ?&quot;);
+		try{
+			HibernateUtil.beginTransaction();
+			
+			Query query = HibernateUtil.getCurrentSession().createQuery(&quot;select ifc from de.fhg.fokus.hss.model.Ifc as ifc where ifc.name like ?&quot;);
 			query.setString(0, &quot;%&quot; + form.getIfcName() + &quot;%&quot;);
 
 			// Check page browsing values
@@ -87,8 +85,7 @@
 			int currentPage = Integer.parseInt(form.getPage()) - 1;
 			int maxPages = (int) ((query.list().size() - 1) / rowPerPage) + 1;
 
-			if (currentPage &gt; maxPages)
-			{
+			if (currentPage &gt; maxPages){
 				currentPage = 0;
 			}
 
@@ -100,17 +97,17 @@
 
 			// store attributes in request
 			request.setAttribute(&quot;result&quot;, query.list());
-
+			HibernateUtil.commitTransaction();
+			
 			request.setAttribute(&quot;maxPages&quot;, String.valueOf(maxPages));
 			request.setAttribute(&quot;currentPage&quot;, String.valueOf(currentPage));
 			request.setAttribute(&quot;rowPerPage&quot;, String.valueOf(rowPerPage));
-		} finally
-		{
-			closeSession();
+		} 
+		finally{
+			HibernateUtil.closeSession();
 		}
 
 		LOGGER.debug(&quot;exiting&quot;);
-
 		return mapping.findForward(FORWARD_SUCCESS);
 	}
 }

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/action/IfcShowAction.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/action/IfcShowAction.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/action/IfcShowAction.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -56,6 +56,7 @@
 import de.fhg.fokus.hss.model.Apsvr;
 import de.fhg.fokus.hss.model.Ifc;
 import de.fhg.fokus.hss.model.Trigpt;
+import de.fhg.fokus.hss.util.HibernateUtil;
 
 /**
  * @author Andre Charton (dev -at- open-ims dot org)
@@ -73,41 +74,37 @@
 		LOGGER.debug(form);
 		Integer primaryKey = form.getPrimaryKey();
 
-		try
-		{
-			/**
-			 * If create (id = -1), dont load the ifc, only the selection values
-			 */
-			if (primaryKey.intValue() != -1)
-			{
-				Ifc ifc = (Ifc) getSession().get(Ifc.class, primaryKey);
+		try{
+			//If create (id = -1), dont load the ifc, only the selection values
+			
+			HibernateUtil.beginTransaction();
+			if (primaryKey.intValue() != -1){
+				Ifc ifc = (Ifc) HibernateUtil.getCurrentSession().get(Ifc.class, primaryKey);
 
 				form.setIfcId(convString(ifc.getIfcId()));
 				form.setIfcName(ifc.getName());
 
 				form.setTriggerPointName(ifc.getTrigpt().getName());
-				form
-						.setTriggerPointId(convString(ifc.getTrigpt()
-								.getTrigptId()));
+				form.setTriggerPointId(convString(ifc.getTrigpt().getTrigptId()));
 
 				form.setApsvrId(convString(ifc.getApsvr().getApsvrId()));
 				form.setApsvrName(ifc.getApsvr().getName());
 			}
 
-			form.setApsvrs(getSession().createCriteria(Apsvr.class).list());
-			form.setTriggerPoints(getSession().createCriteria(Trigpt.class)
-					.list());
-		} finally
-		{
-			closeSession();
+			form.setApsvrs(HibernateUtil.getCurrentSession().createCriteria(Apsvr.class).list());
+			form.setTriggerPoints(HibernateUtil.getCurrentSession().createCriteria(Trigpt.class).list());
+			HibernateUtil.commitTransaction();
+			
 		}
+		finally{
+			HibernateUtil.closeSession();
+		}
 
 		if (LOGGER.isDebugEnabled())
 		{
 			LOGGER.debug(form);
 			LOGGER.debug(&quot;exiting&quot;);
 		}
-
 		return mapping.findForward(FORWARD_SUCCESS);
 	}
 }

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/action/IfcSubmitAction.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/action/IfcSubmitAction.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/action/IfcSubmitAction.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -49,6 +49,7 @@
 import de.fhg.fokus.hss.model.Ifc;
 import de.fhg.fokus.hss.model.IfcBO;
 import de.fhg.fokus.hss.model.Trigpt;
+import de.fhg.fokus.hss.util.HibernateUtil;
 
 import org.apache.log4j.Logger;
 
@@ -75,9 +76,7 @@
 			.getLogger(IfcSubmitAction.class);
 
 	public ActionForward execute(ActionMapping mapping, ActionForm actionForm,
-			HttpServletRequest request, HttpServletResponse reponse)
-			throws Exception
-	{
+			HttpServletRequest request, HttpServletResponse reponse) throws Exception {
 		LOGGER.debug(&quot;entering&quot;);
 
 		ActionForward forward = null;
@@ -88,46 +87,40 @@
 		Ifc ifc = null;
 		IfcBO ifcBO = new IfcBO();
 
-		try
-		{
-			if (primaryKey.intValue() == -1)
-			{
+		try{
+			
+			HibernateUtil.beginTransaction();
+			if (primaryKey.intValue() == -1){
 				ifc = ifcBO.create();
-			} else
-			{
+			}
+			else{
 				ifc = ifcBO.load(primaryKey);
 			}
-
 			ifc.setName(form.getIfcName());
-			ifc.setApsvr((Apsvr) getSession().load(Apsvr.class,
-					Integer.valueOf(form.getApsvrId())));
-			ifc.setTrigpt((Trigpt) getSession().load(Trigpt.class,
-					Integer.valueOf(form.getTriggerPointId())));
-
+			ifc.setApsvr((Apsvr) HibernateUtil.getCurrentSession().load(Apsvr.class, Integer.valueOf(form.getApsvrId())));
+			ifc.setTrigpt((Trigpt) HibernateUtil.getCurrentSession().load(Trigpt.class, Integer.valueOf(form.getTriggerPointId())));
 			ifcBO.saveOrUpdate(ifc);
+			HibernateUtil.commitTransaction();
+			
 			forward = mapping.findForward(FORWARD_SUCCESS);
-			forward = new ActionForward(forward.getPath() + &quot;?ifcId=&quot;
-					+ ifc.getIfcId(), true);
-		} catch (ConstraintViolationException e)
-		{
+			forward = new ActionForward(forward.getPath() + &quot;?ifcId=&quot; + ifc.getIfcId(), true);
+		}
+		catch (ConstraintViolationException e){
 			LOGGER.debug(e);
 
 			ActionMessages actionMessages = new ActionMessages();
-			actionMessages.add(Globals.MESSAGE_KEY, new ActionMessage(
-					&quot;error.duplicate&quot;));
+			actionMessages.add(Globals.MESSAGE_KEY, new ActionMessage(&quot;error.duplicate&quot;));
 			saveMessages(request, actionMessages);
 			forward = mapping.findForward(FORWARD_FAILURE);
-		} finally
-		{
-			ifcBO.closeSession();
 		}
+		finally{
+			HibernateUtil.closeSession();
+		}
 
-		if (LOGGER.isDebugEnabled())
-		{
+		if (LOGGER.isDebugEnabled()){
 			LOGGER.debug(forward);
 			LOGGER.debug(&quot;exiting&quot;);
 		}
-
 		return forward;
 	}
 }

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/action/ImpiDeleteAction.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/action/ImpiDeleteAction.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/action/ImpiDeleteAction.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -47,6 +47,7 @@
 import de.fhg.fokus.hss.form.ImpiForm;
 import de.fhg.fokus.hss.model.Impi;
 import de.fhg.fokus.hss.model.Impu;
+import de.fhg.fokus.hss.util.HibernateUtil;
 
 import org.apache.log4j.Logger;
 
@@ -75,9 +76,8 @@
 			.getLogger(ImpiDeleteAction.class);
 
 	public ActionForward execute(ActionMapping mapping, ActionForm actionForm,
-			HttpServletRequest request, HttpServletResponse response)
-			throws Exception
-	{
+			HttpServletRequest request, HttpServletResponse response) throws Exception {
+		
 		LOGGER.debug(&quot;entering&quot;);
 
 		ActionForward forward = null;
@@ -86,64 +86,42 @@
 
 		try
 		{
-			doDeleteBusiness(form);
-			forward = mapping.findForward(FORWARD_SUCCESS);
-		} catch (ConstraintViolationException e)
-		{
-			ActionMessages actionMessages = new ActionMessages();
-			actionMessages.add(Globals.MESSAGE_KEY, new ActionMessage(
-					&quot;error.constraint&quot;));
-			saveMessages(request, actionMessages);
-			forward = mapping.findForward(FORWARD_FAILURE);
-		}
-
-		LOGGER.debug(&quot;exiting&quot;);
-
-		return forward;
-	}
-
-	/**
-	 * Delete a private user identity from database and disconnect impus.
-	 * 
-	 * @param form
-	 */
-	private void doDeleteBusiness(ImpiForm form)
-			throws ConstraintViolationException
-	{
-		try
-		{
-			beginnTx();
-
 			Integer primaryKey = form.getPrimaryKey();
 			Impi impi = null;
-
-			impi = (Impi) getSession().load(Impi.class, primaryKey);
-
+			
+			HibernateUtil.beginTransaction();
+			impi = (Impi) HibernateUtil.getCurrentSession().load(Impi.class, primaryKey);
 			// Disconnect impus, if necessary unregister impu.
 			Iterator it = impi.getImpus().iterator();
 
-			while (it.hasNext())
-			{
+			while (it.hasNext()){
 				Impu impu = (Impu) it.next();
 				impu.getImpis().remove(impi);
 
-				if (impu.getImpis().isEmpty())
-				{
+				if (impu.getImpis().isEmpty()){
 					impu.setUserStatus(Impu.USER_STATUS_NOT_REGISTERED);
 				}
-
-				getSession().update(impu);
+				HibernateUtil.getCurrentSession().update(impu);
 			}
 
-			getSession().delete(impi);
-			endTx();
-		} catch (ConstraintViolationException e)
-		{
-			LOGGER.warn(this, e);
-			throw e;
-		} finally
-		{
-			closeSession();
+			HibernateUtil.getCurrentSession().delete(impi);
+			HibernateUtil.commitTransaction();
 		}
+		catch (ConstraintViolationException e){
+			ActionMessages actionMessages = new ActionMessages();
+			actionMessages.add(Globals.MESSAGE_KEY, new ActionMessage(
+					&quot;error.constraint&quot;));
+			saveMessages(request, actionMessages);
+			forward = mapping.findForward(FORWARD_FAILURE);
+		}
+		finally{
+			HibernateUtil.closeSession();
+		}
+		
+		forward = mapping.findForward(FORWARD_SUCCESS);
+
+		LOGGER.debug(&quot;exiting&quot;);
+		return forward;
 	}
+
 }

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/action/ImpiSearchAction.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/action/ImpiSearchAction.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/action/ImpiSearchAction.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -45,6 +45,7 @@
 package de.fhg.fokus.hss.action;
 
 import de.fhg.fokus.hss.form.ImpiSearchForm;
+import de.fhg.fokus.hss.util.HibernateUtil;
 
 import org.apache.log4j.Logger;
 
@@ -76,10 +77,10 @@
 
 		try
 		{
+			HibernateUtil.beginTransaction();
 			// Prepare Querry
-			Query query = getSession()
-					.createQuery(
-							&quot;select impi from de.fhg.fokus.hss.model.Impi as impi where impi.impiString like ? order by impi.impiString&quot;);
+			Query query = HibernateUtil.getCurrentSession()
+					.createQuery(&quot;select impi from de.fhg.fokus.hss.model.Impi as impi where impi.impiString like ? order by impi.impiString&quot;);
 			query.setString(0, form.getImpiString() + &quot;%&quot;);
 
 			// Check page browsing values
@@ -104,9 +105,11 @@
 			request.setAttribute(&quot;maxPages&quot;, String.valueOf(maxPages));
 			request.setAttribute(&quot;currentPage&quot;, String.valueOf(currentPage));
 			request.setAttribute(&quot;rowPerPage&quot;, String.valueOf(rowPerPage));
+			
+			HibernateUtil.commitTransaction();
 		} finally
 		{
-			closeSession();
+			HibernateUtil.closeSession();
 		}
 
 		LOGGER.debug(&quot;exiting&quot;);

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/action/ImpiShowAction.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/action/ImpiShowAction.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/action/ImpiShowAction.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -62,6 +62,7 @@
 import de.fhg.fokus.hss.model.Chrginfo;
 import de.fhg.fokus.hss.model.Impi;
 import de.fhg.fokus.hss.model.Network;
+import de.fhg.fokus.hss.util.HibernateUtil;
 
 /**
  * @author Andre Charton (dev -at- open-ims dot org)
@@ -78,26 +79,15 @@
 
 		ImpiForm form = (ImpiForm) actionForm;
 		LOGGER.debug(form);
-		doLoadBusiness(form);
-		LOGGER.debug(&quot;exiting&quot;);
-
-		return mapping.findForward(FORWARD_SUCCESS);
-	}
-
-	/**
-	 * Load object and convert them to form
-	 * 
-	 * @param form
-	 */
-	private void doLoadBusiness(ImpiForm form)
-	{
+		
 		try
 		{
 			Integer primaryKey = form.getPrimaryKey();
 
+			HibernateUtil.beginTransaction();
 			if (primaryKey.intValue() != -1)
 			{
-				Impi impi = (Impi) getSession().load(Impi.class,
+				Impi impi = (Impi) HibernateUtil.getCurrentSession().load(Impi.class,
 						form.getPrimaryKey());
 
 				// copy basic values
@@ -110,26 +100,28 @@
 				addRoams(form, impi);
 
 				// Add impu selector values
-				ImpuSubSelectForm.doImpuSelection(getSession(), form, impi
-						.getImpus());
+				PsiShowAction.doImpuSelection(HibernateUtil.getCurrentSession(), form, impi.getImpus());
+				
 			}
-
 			// add charging functions
 			addChrgInfos(form);
-		} finally
-		{
-			closeSession();
+			
+			HibernateUtil.commitTransaction();
+			
+		} 
+		finally{
+			HibernateUtil.closeSession();
 		}
 
-		LOGGER.debug(form);
+		LOGGER.debug(&quot;exiting&quot;);
+
+		return mapping.findForward(FORWARD_SUCCESS);
 	}
 
-	private void addChrgInfos(ImpiForm form)
-	{
-		LOGGER.debug(&quot;entering&quot;);
-		form.setChrgInfos(new ArrayList(getSession().createCriteria(
-				Chrginfo.class).list()));
 
+	private void addChrgInfos(ImpiForm form){
+		LOGGER.debug(&quot;entering&quot;);
+		form.setChrgInfos(new ArrayList(HibernateUtil.getCurrentSession().createCriteria(Chrginfo.class).list()));
 		LOGGER.debug(&quot;exiting&quot;);
 	}
 
@@ -138,13 +130,11 @@
 	 * @param form
 	 * @param impi
 	 */
-	private void addImpus(ImpiForm form, Impi impi)
-	{
-		if (impi.getImpus().size() &gt; 1)
-		{
+	private void addImpus(ImpiForm form, Impi impi){
+		if (impi.getImpus().size() &gt; 1){
 			form.setImpus(impi.getImpus());
-		} else
-		{
+		}
+		else{
 			form.getImpus().addAll(impi.getImpus());
 		}
 	}
@@ -154,22 +144,19 @@
 	 * @param form
 	 * @param impi
 	 */
-	private void addRoams(ImpiForm form, Impi impi)
-	{
+	private void addRoams(ImpiForm form, Impi impi){
 		Set roamNIds = impi.getRoams();
 		Iterator it = roamNIds.iterator();
 
-		while (it.hasNext())
-		{
+		while (it.hasNext()){
 			Network roam = (Network) it.next();
 
-			if (form.getRoamNetworkIdentifiers() == null)
-			{
+			if (form.getRoamNetworkIdentifiers() == null){
 				Set roams = new TreeSet();
 				roams.add(roam.getNetworkString());
 				form.setRoamNetworkIdentifiers(roams);
-			} else
-			{
+			} 
+			else{
 				form.getRoamNetworkIdentifiers().add(roam.getNetworkString());
 			}
 		}
@@ -180,8 +167,7 @@
 	 * @param form
 	 * @param impi
 	 */
-	private void copyValues(ImpiForm form, Impi impi)
-	{
+	private void copyValues(ImpiForm form, Impi impi){
 		form.setImpiString(impi.getImpiString());
 		form.setImsi(impi.getImsi());
 		form.setScscfName(impi.getScscfName());
@@ -193,9 +179,10 @@
 		form.setSqn(impi.getSqn());
 		form.setImsuId(impi.getImsu().getImsuId());
 
-		if (impi.getChrginfo() != null)
-		{
+		if (impi.getChrginfo() != null){
 			form.setChrgInfoId(convString(impi.getChrginfo().getChrgId()));
 		}
 	}
+	
+	
 }

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/action/ImpiSubmitAction.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/action/ImpiSubmitAction.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/action/ImpiSubmitAction.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -57,11 +57,11 @@
 import org.hibernate.LockMode;
 
 import de.fhg.fokus.hss.form.ImpiForm;
-import de.fhg.fokus.hss.model.AuthSchemeBO;
 import de.fhg.fokus.hss.model.Chrginfo;
 import de.fhg.fokus.hss.model.Impi;
 import de.fhg.fokus.hss.model.ImpiBO;
 import de.fhg.fokus.hss.model.Imsu;
+import de.fhg.fokus.hss.util.HibernateUtil;
 
 /**
  * @author Andre Charton(dev -at- open-ims dot org)
@@ -73,8 +73,8 @@
 
 	public ActionForward execute(ActionMapping mapping, ActionForm actionForm,
 			HttpServletRequest request, HttpServletResponse reponse)
-			throws Exception
-	{
+			throws Exception{
+		
 		LOGGER.debug(&quot;entering&quot;);
 
 		ImpiForm form = (ImpiForm) actionForm;
@@ -82,62 +82,54 @@
 
 		ActionMessages actionMessages = null;
 		ActionForward forward = null;
+		
 		Impi impi = null;
 		ImpiBO impiBO = new ImpiBO();
-		try
-		{
-			openSession();
-
+		try{
 			Integer primaryKey = form.getPrimaryKey();
-
+			HibernateUtil.beginTransaction();
 			// if pk id = -1 create a new impi and concat them to current imsu
-			if (primaryKey.intValue() == -1)
-			{
+			if (primaryKey.intValue() == -1){
 				// check for existing impi with the same impi string
-				if (((Integer) getSession()
-						.createQuery(
-								&quot;select count(impi) from de.fhg.fokus.hss.model.Impi as impi where impi.impiString = ?&quot;)
+				if (((Integer) HibernateUtil.getCurrentSession()
+						.createQuery(&quot;select count(impi) from de.fhg.fokus.hss.model.Impi as impi where impi.impiString = ?&quot;)
 						.setString(0, form.getImpiString()).uniqueResult())
-						.intValue() == 0)
-				{
+						.intValue() == 0){
+					
 					impi = new Impi();
 
 					// store assigned imsu if exists
-					if (form.getImsuId() != null)
-					{
-						Integer assignedSubscriptionId = new Integer(form
-								.getImsuId());
-						impi.setImsu((Imsu) getSession().load(Imsu.class,
-								assignedSubscriptionId, LockMode.READ));
+					if (form.getImsuId() != null){
+						Integer assignedSubscriptionId = new Integer(form.getImsuId());
+						impi.setImsu((Imsu) HibernateUtil.getCurrentSession().load(Imsu.class, assignedSubscriptionId, LockMode.READ));
 					}
-				} else
-				{
+				}
+				else{
 					actionMessages = new ActionMessages();
-					actionMessages.add(Globals.MESSAGE_KEY, new ActionMessage(
-							&quot;impi.error.duplicated&quot;));
+					actionMessages.add(Globals.MESSAGE_KEY, new ActionMessage(&quot;impi.error.duplicated&quot;));
 					saveMessages(request, actionMessages);
 					forward = mapping.findForward(FORWARD_FAILURE);
 				}
-			} else
-			{
+			} 
+			else{
 				impi = impiBO.load(primaryKey);
 			}
-		} finally
-		{
-			closeSession();
-			impiBO.closeSession();
-		}
 
-		// on errors dont store anything, forward to error page.
-		if (forward == null)
-		{
-			copyValues(form, impi);
-			impiBO.saveOrUpdate(impi);
-			forward = mapping.findForward(FORWARD_SUCCESS);
-			forward = new ActionForward(forward.getPath() + &quot;?impiId=&quot;
-					+ impi.getImpiId(), true);
+			// on errors dont store anything, forward to error page.
+			if (forward == null){
+				copyValues(form, impi);
+				impiBO.saveOrUpdate(impi);
+				forward = mapping.findForward(FORWARD_SUCCESS);
+				forward = new ActionForward(forward.getPath() + &quot;?impiId=&quot;+ impi.getImpiId(), true);
+			}
+			
+			HibernateUtil.commitTransaction();
+		} 
+		finally{
+			HibernateUtil.closeSession();
 		}
 
+
 		LOGGER.debug(&quot;exiting&quot;);
 
 		return forward;
@@ -148,52 +140,23 @@
 	 * @param form
 	 * @param impi
 	 */
-	private void copyValues(ImpiForm form, Impi impi)
-	{
+	private void copyValues(ImpiForm form, Impi impi){
+		
 		impi.setImsi(form.getImsi());
 		impi.setImpiString(form.getImpiString());
 		impi.setScscfName(form.getScscfName());
 
-		if (form.getAuthScheme().equals(AuthSchemeBO.AUTH_SCHEME_AKAv1))
-		{
-			System.out.println(&quot;\n\nAUTH_SCHEME: 1&quot;);
-			impi.setAlgorithm(form.getAlgorithm());
-			impi.setAuthScheme(form.getAuthScheme());
-			impi.setSkey(form.getSkey());
-			impi.setOperatorId(form.getOperatorId());
-			impi.setAmf(form.getAmf());
-		} 
-		else if (form.getAuthScheme().equals(AuthSchemeBO.AUTH_SCHEME_AKAv2))
-		{
-			impi.setAlgorithm(form.getAlgorithm());
-			impi.setAuthScheme(form.getAuthScheme());
-			impi.setSkey(form.getSkey());
-			impi.setOperatorId(form.getOperatorId());
-			impi.setAmf(form.getAmf());
-		} 
-		else if (form.getAuthScheme().equals(AuthSchemeBO.AUTH_SCHEME_MD5)){
-			impi.setAlgorithm(form.getAlgorithm());
-			impi.setAuthScheme(form.getAuthScheme());
-			impi.setSkey(form.getSkey());
-			impi.setOperatorId(form.getOperatorId());
-			impi.setAmf(form.getAmf());
-		}
-		else
-		{
-			impi.setAlgorithm(null);
-			impi.setAuthScheme(null);
-			impi.setSkey(null);
-			impi.setOperatorId(null);
-			impi.setAmf(null);
-		}
-
-		if (form.getSqnUpdate().equals(ImpiForm.SQD_UPDATE_TRUE))
-		{
+		impi.setAuthScheme(form.getAuthScheme());
+		impi.setSkey(form.getSkey());
+		impi.setOperatorId(form.getOperatorId());
+		impi.setAmf(form.getAmf());
+		
+		if (form.getSqnUpdate().equals(ImpiForm.SQD_UPDATE_TRUE)){
 			impi.setSqn(form.getSqn());
 		}
 
-		impi.setChrginfo((Chrginfo) getSession().get(Chrginfo.class,
-				Integer.valueOf(form.getChrgInfoId())));
+		impi.setChrginfo((Chrginfo) HibernateUtil.getCurrentSession().get(Chrginfo.class, Integer.valueOf(form.getChrgInfoId())));
+
 		// TODO: Read this values
 		impi.setUiccType(new Integer(1));
 		impi.setKeyLifeTime(new Integer(3600));

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/action/Impu2ImpiAction.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/action/Impu2ImpiAction.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/action/Impu2ImpiAction.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -54,6 +54,8 @@
 
 import de.fhg.fokus.hss.form.ImpiForm;
 import de.fhg.fokus.hss.model.ImpuBO;
+import de.fhg.fokus.hss.util.HibernateUtil;
+import de.fhg.fokus.hss.util.InfrastructureException;
 
 /**
  * Link or unlink a Impu to a Impi.
@@ -62,13 +64,12 @@
  */
 public class Impu2ImpiAction extends HssAction
 {
-	private static final Logger LOGGER = Logger
-			.getLogger(Impu2ImpiAction.class);
+	private static final Logger LOGGER = Logger.getLogger(Impu2ImpiAction.class);
 
 	public ActionForward execute(ActionMapping mapping, ActionForm actionForm,
 			HttpServletRequest request, HttpServletResponse reponse)
-			throws Exception
-	{
+			throws Exception{
+		
 		LOGGER.debug(&quot;entering&quot;);
 
 		ImpiForm form = (ImpiForm) actionForm;
@@ -80,8 +81,15 @@
 		Integer impuPk = Integer.valueOf(form.getImpuSelectId());
 		boolean isLink = form.getImpuSelect().equals(&quot;remove&quot;) == false;
 
-		impuBO.linkImpu2Impi(impiPk, impuPk, isLink);
-
+		try{
+			HibernateUtil.beginTransaction();
+			impuBO.linkImpu2Impi(impiPk, impuPk, isLink);
+			HibernateUtil.commitTransaction();
+		}
+		finally{
+			HibernateUtil.closeSession();
+		}
+		
 		// find forward
 		ActionForward forward = mapping.findForward(FORWARD_SUCCESS);
 		String actionPath = forward.getPath() + &quot;?impiId=&quot; + form.getImpiId();

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/action/Impu2PsiAction.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/action/Impu2PsiAction.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/action/Impu2PsiAction.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -54,6 +54,7 @@
 
 import de.fhg.fokus.hss.form.PsiForm;
 import de.fhg.fokus.hss.model.PsiBO;
+import de.fhg.fokus.hss.util.HibernateUtil;
 
 /**
  * Link or unlink a Impu to a Impi.
@@ -66,10 +67,9 @@
 
 	public ActionForward execute(ActionMapping mapping, ActionForm actionForm,
 			HttpServletRequest request, HttpServletResponse reponse)
-			throws Exception
-	{
+			throws Exception{
+		
 		LOGGER.debug(&quot;entering&quot;);
-
 		PsiForm form = (PsiForm) actionForm;
 		LOGGER.debug(form);
 
@@ -77,8 +77,15 @@
 		Integer impuPk = Integer.valueOf(form.getImpuSelectId());
 		boolean isLink = form.getImpuSelect().equals(&quot;remove&quot;) == false;
 
-		PsiBO.linkImpu2Psi(psiPk, impuPk, isLink);
-
+		try{
+			HibernateUtil.beginTransaction();
+			PsiBO.linkImpu2Psi(psiPk, impuPk, isLink);
+			HibernateUtil.commitTransaction();
+		}
+		finally{
+			HibernateUtil.closeSession();
+		}
+		
 		// find forward
 		ActionForward forward = mapping.findForward(FORWARD_SUCCESS);
 		String actionPath = forward.getPath() + &quot;?psiId=&quot; + form.getPsiId();

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/action/ImpuDeleteAction.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/action/ImpuDeleteAction.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/action/ImpuDeleteAction.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -74,44 +74,38 @@
 
 	public ActionForward execute(ActionMapping mapping, ActionForm actionForm,
 			HttpServletRequest request, HttpServletResponse reponse)
-			throws Exception
-	{
+			throws Exception{
+		
 		LOGGER.debug(&quot;entering&quot;);
 
-		try
-		{
-			beginnTx();
+		try{
+		
+			HibernateUtil.beginTransaction();
 
-			Impu impu = (Impu) getSession().load(Impu.class,
-					new Integer(request.getParameter(&quot;impuId&quot;)));
-
-			Iterator it = getSession()
-					.createQuery(
+			Impu impu = (Impu) HibernateUtil.getCurrentSession().load(Impu.class, new Integer(request.getParameter(&quot;impuId&quot;)));
+			Iterator it = HibernateUtil.getCurrentSession().createQuery(
 							&quot;select impi from de.fhg.fokus.hss.model.Impi impi where impi.impus.impuId = ?&quot;)
-					.setInteger(0, impu.getImpuId()).list().iterator();
+							.setInteger(0, impu.getImpuId()).list().iterator();
 
-			while (it.hasNext())
-			{
+			while (it.hasNext()){
 				Impi impi = (Impi) it.next();
 				impi.getImpus().remove(impu);
 			}
 
-			it = getSession()
-					.createQuery(
-							&quot;select psi from de.fhg.fokus.hss.model.Psi psi where psi.impus.impuId = ?&quot;)
-					.setInteger(0, impu.getImpuId()).list().iterator();
+			it = HibernateUtil.getCurrentSession()
+						.createQuery(&quot;select psi from de.fhg.fokus.hss.model.Psi psi where psi.impus.impuId = ?&quot;)
+						.setInteger(0, impu.getImpuId()).list().iterator();
 
-			while (it.hasNext())
-			{
+			while (it.hasNext()){
 				Psi psi = (Psi) it.next();
 				psi.getImpus().remove(impu);
 			}
 
-			getSession().delete(impu);
-			endTx();
-		} finally
-		{
-			closeSession();
+			HibernateUtil.getCurrentSession().delete(impu);
+			HibernateUtil.commitTransaction();
+		} 
+		finally{
+			HibernateUtil.closeSession();
 		}
 
 		LOGGER.debug(&quot;exiting&quot;);

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/action/ImpuSearchAction.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/action/ImpuSearchAction.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/action/ImpuSearchAction.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -45,6 +45,7 @@
 package de.fhg.fokus.hss.action;
 
 import de.fhg.fokus.hss.form.ImpuSearchForm;
+import de.fhg.fokus.hss.util.HibernateUtil;
 
 import org.apache.log4j.Logger;
 
@@ -67,19 +68,18 @@
 
 	public ActionForward execute(ActionMapping mapping, ActionForm actionForm,
 			HttpServletRequest request, HttpServletResponse reponse)
-			throws Exception
-	{
+			throws Exception{
+		
 		LOGGER.debug(&quot;entering&quot;);
 
 		ImpuSearchForm form = (ImpuSearchForm) actionForm;
 		LOGGER.debug(form);
 
-		try
-		{
+		try{
+			HibernateUtil.beginTransaction();
 			// Prepare Querry
-			Query query = getSession()
-					.createQuery(
-							&quot;select impu from de.fhg.fokus.hss.model.Impu as impu where impu.psi = 0 and impu.sipUrl like ? order by impu.sipUrl&quot;);
+			Query query = HibernateUtil.getCurrentSession()
+							.createQuery(&quot;select impu from de.fhg.fokus.hss.model.Impu as impu where impu.psi = 0 and impu.sipUrl like ? order by impu.sipUrl&quot;);
 			query.setString(0, &quot;%&quot; + form.getSipUrl() + &quot;%&quot;);
 
 			// Check page browsing values
@@ -87,8 +87,7 @@
 			int currentPage = Integer.parseInt(form.getPage()) - 1;
 			int maxPages = (int) ((query.list().size() - 1) / rowPerPage) + 1;
 
-			if (currentPage &gt; maxPages)
-			{
+			if (currentPage &gt; maxPages){
 				currentPage = 0;
 			}
 
@@ -100,17 +99,16 @@
 
 			// store attributes in request
 			request.setAttribute(&quot;result&quot;, query.list());
-
+			HibernateUtil.commitTransaction();
+			
 			request.setAttribute(&quot;maxPages&quot;, String.valueOf(maxPages));
 			request.setAttribute(&quot;currentPage&quot;, String.valueOf(currentPage));
 			request.setAttribute(&quot;rowPerPage&quot;, String.valueOf(rowPerPage));
-		} finally
-		{
-			closeSession();
+		} 
+		finally{
+			HibernateUtil.closeSession();
 		}
-
 		LOGGER.debug(&quot;exiting&quot;);
-
 		return mapping.findForward(FORWARD_SUCCESS);
 	}
 }

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/action/ImpuShowAction.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/action/ImpuShowAction.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/action/ImpuShowAction.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -56,6 +56,7 @@
 import de.fhg.fokus.hss.model.Impu;
 import de.fhg.fokus.hss.model.ImpuBO;
 import de.fhg.fokus.hss.model.Svp;
+import de.fhg.fokus.hss.util.HibernateUtil;
 
 /**
  * @author Andre Charton (dev -at- open-ims dot org)
@@ -66,48 +67,41 @@
 
 	public ActionForward execute(ActionMapping mapping, ActionForm actionForm,
 			HttpServletRequest request, HttpServletResponse reponse)
-			throws Exception
-	{
+			throws Exception{
+		
 		LOGGER.debug(&quot;entering&quot;);
 
-		try
-		{
+		try{
 			ImpuForm form = (ImpuForm) actionForm;
 			LOGGER.debug(form);
 
-			if (form.getPrimaryKey().intValue() != -1)
-			{
-				doLoadBusiness(form);
+			HibernateUtil.beginTransaction();
+			if (form.getPrimaryKey().intValue() != -1){
+				ImpuBO impuBO = new ImpuBO();
+				Impu impu = impuBO.load(form.getPrimaryKey());
+		        
+				form.setSipUrl(impu.getSipUrl());
+				form.setTelUrl(impu.getTelUrl());
+				form.setBarred(impu.getBarringIndication().booleanValue());
+				form.setUserStatusId(impu.getUserStatus());
+				
+				if (impu.getSvp() != null){
+					form.setSvpId(convString(impu.getSvp().getSvpId()));
+				}
 			}
+			
 			// Add assginable service profiles
-			form.setSvps(getSession().createCriteria(Svp.class).list());
-
+			form.setSvps(HibernateUtil.getCurrentSession().createCriteria(Svp.class).list());
+			HibernateUtil.commitTransaction();
+			
 			LOGGER.debug(form);
-		} finally
-		{
-			closeSession();
 		}
+		finally{
+			HibernateUtil.closeSession();
+		}
+		
 		LOGGER.debug(&quot;exiting&quot;);
-
 		return mapping.findForward(FORWARD_SUCCESS);
 	}
 
-	/**
-	 * Load object and convert them to form
-	 * 
-	 * @param form
-	 */
-	private void doLoadBusiness(ImpuForm form)
-	{
-		ImpuBO impuBO = new ImpuBO();
-		Impu impu = impuBO.load(form.getPrimaryKey());
-		form.setSipUrl(impu.getSipUrl());
-		form.setTelUrl(impu.getTelUrl());
-		form.setBarred(impu.getBarringIndication().booleanValue());
-		form.setUserStatusId(impu.getUserStatus());
-		if (impu.getSvp() != null)
-		{
-			form.setSvpId(convString(impu.getSvp().getSvpId()));
-		}
-	}
 }

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/action/ImpuSubmitAction.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/action/ImpuSubmitAction.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/action/ImpuSubmitAction.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -48,6 +48,7 @@
 import de.fhg.fokus.hss.model.Impu;
 import de.fhg.fokus.hss.model.ImpuBO;
 import de.fhg.fokus.hss.model.Svp;
+import de.fhg.fokus.hss.util.HibernateUtil;
 
 import org.apache.log4j.Logger;
 
@@ -77,58 +78,51 @@
 	{
 		LOGGER.debug(&quot;entering&quot;);
 
-		ActionForward forward;
-		Impu impu;
+		ActionForward forward = null;
+		Impu impu = null;
 		ImpuBO impuBO = new ImpuBO();
 
 		try
 		{
 			ImpuForm form = (ImpuForm) actionForm;
 			LOGGER.debug(form);
-
-			impu = null;
-
 			Integer primaryKey = form.getPrimaryKey();
-
-			if (primaryKey.intValue() == -1)
-			{
+			
+			HibernateUtil.beginTransaction();
+			if (primaryKey.intValue() == -1){
 				impu = impuBO.create();
-			} else
-			{
+			} 
+			else{
 				impu = impuBO.load(primaryKey);
 			}
-
 			impu.setSipUrl(form.getSipUrl());
 			impu.setTelUrl(form.getTelUrl());
 			impu.setUserStatus(form.getUserStatusId());
 			impu.setBarringIndication(form.isBarred());
 
 			Integer svpKey = Integer.valueOf(form.getSvpId());
-
-			if (svpKey.intValue() != -1)
-			{
-				impu.setSvp((Svp) getSession().get(Svp.class, svpKey));
+			if (svpKey.intValue() != -1){
+				impu.setSvp((Svp) HibernateUtil.getCurrentSession().get(Svp.class, svpKey));
 			}
 
 			impuBO.saveOrUpdate(impu);
+			HibernateUtil.commitTransaction();
+			
 			forward = mapping.findForward(FORWARD_SUCCESS);
-			forward = new ActionForward(forward.getPath() + &quot;?impuId=&quot;
-					+ impu.getImpuId(), true);
-
+			forward = new ActionForward(forward.getPath() + &quot;?impuId=&quot; + impu.getImpuId(), true);
 			LOGGER.debug(form);
-		} catch (ConstraintViolationException e)
-		{
+		} 
+		catch (ConstraintViolationException e){
 			LOGGER.warn(this, e);
 
 			ActionMessages actionMessages = new ActionMessages();
-			actionMessages.add(Globals.MESSAGE_KEY, new ActionMessage(
-					&quot;error.duplicate&quot;));
+			actionMessages.add(Globals.MESSAGE_KEY, new ActionMessage(&quot;error.duplicate&quot;));
 			saveMessages(request, actionMessages);
 			forward = mapping.findForward(FORWARD_FAILURE);
-		} finally
+		} 
+		finally
 		{
-			impuBO.closeSession();
-			closeSession();
+			HibernateUtil.closeSession();
 		}
 
 		LOGGER.debug(&quot;exiting&quot;);

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/action/ImsuRemoveAction.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/action/ImsuRemoveAction.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/action/ImsuRemoveAction.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -60,6 +60,8 @@
 import javax.servlet.http.HttpServletRequest;
 import javax.servlet.http.HttpServletResponse;
 
+import de.fhg.fokus.hss.util.HibernateUtil;
+import de.fhg.fokus.hss.util.InfrastructureException;
 /**
  * Select profiles from database and prepate viewable objects.
  * 
@@ -72,36 +74,55 @@
 
 	public ActionForward execute(ActionMapping mapping, ActionForm actionForm,
 			HttpServletRequest request, HttpServletResponse reponse)
-			throws Exception
-	{
+			throws Exception{
+		
 		LOGGER.debug(&quot;entering&quot;);
 
 		ActionForward forward = null;
-
-		try
-		{
-			Imsu imsu = (Imsu) getSession().load(Imsu.class,
-					new Integer(request.getParameter(&quot;imsuId&quot;)));
-			beginnTx();
-			getSession().delete(imsu);
-			endTx();
+		try{
+			
+			HibernateUtil.beginTransaction();
+			Imsu imsu = (Imsu) HibernateUtil.getCurrentSession().load(Imsu.class, new Integer(request.getParameter(&quot;imsuId&quot;)));
+			
+            if(checkIfImpiAssigned(imsu) == true){
+                ActionMessages actionMessages = new ActionMessages();
+                actionMessages.add(Globals.MESSAGE_KEY, new ActionMessage(&quot;imsu.error.impi.assigned&quot;));
+                saveMessages(request, actionMessages);
+                forward = mapping.findForward(FORWARD_FAILURE);     
+    			HibernateUtil.commitTransaction();
+    			HibernateUtil.closeSession();
+                return forward;
+            } 			
+			
+			HibernateUtil.getCurrentSession().delete(imsu);
+			HibernateUtil.commitTransaction();
+			
 			forward = mapping.findForward(FORWARD_SUCCESS);
-		} catch (ConstraintViolationException e)
-		{
+		} 
+		catch (ConstraintViolationException e){
 			LOGGER.warn(this, e);
-
 			ActionMessages actionMessages = new ActionMessages();
-			actionMessages.add(Globals.MESSAGE_KEY, new ActionMessage(
-					&quot;error.constraint&quot;));
+			actionMessages.add(Globals.MESSAGE_KEY, new ActionMessage(&quot;error.constraint&quot;));
 			saveMessages(request, actionMessages);
 			forward = mapping.findForward(FORWARD_FAILURE);
-		} finally
-		{
-			closeSession();
+		} 
+		catch(InfrastructureException e){
+			if (e.getCause() instanceof org.hibernate.exception.GenericJDBCException){
+				
+			}
 		}
+		finally{
+			HibernateUtil.closeSession();
+		}
 
 		LOGGER.debug(&quot;exiting&quot;);
-
 		return forward;
 	}
+	
+	
+    private boolean checkIfImpiAssigned(Imsu imsu){
+         return ((Integer) HibernateUtil.getCurrentSession()
+                 .createQuery(&quot;select count(impi) from de.fhg.fokus.hss.model.Impi as impi where impi.imsu = ?&quot;)
+                 .setParameter(0, imsu).uniqueResult()).intValue() &gt; 0;  	
+     }  	
 }

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/action/ImsuSearchAction.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/action/ImsuSearchAction.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/action/ImsuSearchAction.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -45,6 +45,7 @@
 package de.fhg.fokus.hss.action;
 
 import de.fhg.fokus.hss.form.ImsuSearchForm;
+import de.fhg.fokus.hss.util.HibernateUtil;
 
 import org.apache.log4j.Logger;
 
@@ -70,16 +71,15 @@
 			throws Exception
 	{
 		LOGGER.debug(&quot;entering&quot;);
-
 		ImsuSearchForm form = (ImsuSearchForm) actionForm;
 		LOGGER.debug(form);
 
 		try
 		{
+			HibernateUtil.beginTransaction();
 			// Prepare Querry
-			Query query = getSession()
-					.createQuery(
-							&quot;select imsu from de.fhg.fokus.hss.model.Imsu as imsu where imsu.name like ? order by imsu.name&quot;);
+			Query query = HibernateUtil.getCurrentSession()
+								.createQuery(&quot;select imsu from de.fhg.fokus.hss.model.Imsu as imsu where imsu.name like ? order by imsu.name&quot;);
 			query.setString(0, form.getName() + &quot;%&quot;);
 
 			// Check page browsing values
@@ -87,8 +87,7 @@
 			int currentPage = Integer.parseInt(form.getPage()) - 1;
 			int maxPages = (int) ((query.list().size() - 1) / rowPerPage) + 1;
 
-			if (currentPage &gt; maxPages)
-			{
+			if (currentPage &gt; maxPages){
 				currentPage = 0;
 			}
 
@@ -100,14 +99,15 @@
 
 			// store attributes in request
 			request.setAttribute(&quot;result&quot;, query.list());
-
+			HibernateUtil.commitTransaction();
+			
 			request.setAttribute(&quot;maxPages&quot;, String.valueOf(maxPages));
 			request.setAttribute(&quot;currentPage&quot;, String.valueOf(currentPage));
 			request.setAttribute(&quot;rowPerPage&quot;, String.valueOf(rowPerPage));
-		} finally
-		{
-			closeSession();
 		}
+		finally{
+			HibernateUtil.closeSession();
+		}
 
 		LOGGER.debug(&quot;exiting&quot;);
 

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/action/ImsuShowAction.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/action/ImsuShowAction.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/action/ImsuShowAction.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -54,7 +54,7 @@
 
 import de.fhg.fokus.hss.form.ImsuForm;
 import de.fhg.fokus.hss.model.Imsu;
-
+import de.fhg.fokus.hss.util.HibernateUtil;
 /**
  * Select profiles from database and prepate viewable objects.
  * 
@@ -62,54 +62,37 @@
  */
 public class ImsuShowAction extends HssAction
 {
-	protected static final Logger LOGGER = Logger
-			.getLogger(ImsuShowAction.class);
+	protected static final Logger LOGGER = Logger.getLogger(ImsuShowAction.class);
 
 	public ActionForward execute(ActionMapping mapping, ActionForm actionForm,
 			HttpServletRequest request, HttpServletResponse reponse)
-			throws Exception
-	{
+			throws Exception{
+		
 		LOGGER.debug(&quot;entering&quot;);
-
 		ImsuForm form = (ImsuForm) actionForm;
 
-		doLoadBusiness(form);
-
-		if (LOGGER.isDebugEnabled())
-		{
+		try{
+			HibernateUtil.beginTransaction();
+			Imsu imsu = (Imsu) HibernateUtil.getCurrentSession().load(Imsu.class, form.getPrimaryKey());
+			
+			form.setName(imsu.getName());
+			form.setImsuId(imsu.getImsuId().toString());
+			form.setImpis(imsu.getImpis());
+			HibernateUtil.commitTransaction();
+			
+			if (LOGGER.isDebugEnabled()){
+				LOGGER.debug(form);
+			}
+		}
+		finally{
+			HibernateUtil.closeSession();
+		}
+		
+		if (LOGGER.isDebugEnabled()){
 			LOGGER.debug(&quot;exiting&quot;);
 		}
-
 		return mapping.findForward(FORWARD_SUCCESS);
 	}
 
-	protected void doLoadBusiness(ImsuForm form)
-	{
-		try
-		{
-			Imsu imsu = (Imsu) getSession().load(Imsu.class,
-					form.getPrimaryKey());
-			copyValues(form, imsu);
-			if (LOGGER.isDebugEnabled())
-			{
-				LOGGER.debug(form);
-			}
-		} finally
-		{
-			closeSession();
-		}
-	}
 
-	/**
-	 * Copy values from bo to form
-	 * 
-	 * @param form
-	 * @param imsu
-	 */
-	private void copyValues(ImsuForm form, Imsu imsu)
-	{
-		form.setName(imsu.getName());
-		form.setImsuId(imsu.getImsuId().toString());
-		form.setImpis(imsu.getImpis());
-	}
 }

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/action/ImsuSubmitAction.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/action/ImsuSubmitAction.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/action/ImsuSubmitAction.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -58,6 +58,7 @@
 
 import de.fhg.fokus.hss.form.ImsuForm;
 import de.fhg.fokus.hss.model.Imsu;
+import de.fhg.fokus.hss.util.HibernateUtil;
 
 /**
  * Select profiles from database.
@@ -71,50 +72,45 @@
 			.getLogger(ImsuSubmitAction.class);
 
 	public ActionForward execute(ActionMapping mapping, ActionForm actionForm,
-			HttpServletRequest request, HttpServletResponse reponse)
-			throws Exception
-	{
+			HttpServletRequest request, HttpServletResponse reponse) throws Exception{
+		
 		LOGGER.debug(&quot;entering&quot;);
 
-		ActionForward forward;
+		ActionForward forward = null;
 		ImsuForm form = (ImsuForm) actionForm;
 		LOGGER.debug(&quot;Storing: &quot; + form);
 
 		Integer primaryKey = form.getPrimaryKey();
 		Imsu imsu = null;
 
-		try
-		{
-			if (primaryKey.intValue() != -1)
-			{
-				imsu = (Imsu) getSession().load(Imsu.class, primaryKey);
-			} else
-			{
+		try{
+			HibernateUtil.beginTransaction();
+			if (primaryKey.intValue() != -1){
+				imsu = (Imsu) HibernateUtil.getCurrentSession().load(Imsu.class, primaryKey);
+			}
+			else{
 				imsu = new Imsu();
 			}
 
 			imsu.setName(form.getName());
-			beginnTx();
-			getSession().saveOrUpdate(imsu);
-			endTx();
+			HibernateUtil.getCurrentSession().saveOrUpdate(imsu);
+			HibernateUtil.commitTransaction();
+			
 			forward = mapping.findForward(FORWARD_SUCCESS);
-			forward = new ActionForward(forward.getPath() + &quot;?imsuId=&quot;
-					+ imsu.getImsuId().intValue(), true);
-		} catch (ConstraintViolationException e)
-		{
+			forward = new ActionForward(forward.getPath() + &quot;?imsuId=&quot; + imsu.getImsuId().intValue(), true);
+		} 
+		catch (ConstraintViolationException e){
 			LOGGER.warn(this, e);
 			ActionMessages actionMessages = new ActionMessages();
-			actionMessages.add(Globals.MESSAGE_KEY, new ActionMessage(
-					&quot;error.duplicate&quot;));
+			actionMessages.add(Globals.MESSAGE_KEY, new ActionMessage(&quot;error.duplicate&quot;));
 			saveMessages(request, actionMessages);
 			forward = mapping.findForward(FORWARD_FAILURE);
-		} finally
-		{
-			closeSession();
+		} 
+		finally{
+			HibernateUtil.closeSession();
 		}
 
 		LOGGER.debug(&quot;exiting&quot;);
-
 		return forward;
 	}
 }

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/action/NetworksShowAction.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/action/NetworksShowAction.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/action/NetworksShowAction.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -45,6 +45,7 @@
 package de.fhg.fokus.hss.action;
 
 import de.fhg.fokus.hss.model.Network;
+import de.fhg.fokus.hss.util.HibernateUtil;
 
 import org.apache.log4j.Logger;
 
@@ -63,22 +64,24 @@
  * 
  * @author Andre Charton (dev -at- open-ims dot org)
  */
-public class NetworksShowAction extends HssAction
-{
-	private static final Logger LOGGER = Logger
-			.getLogger(NetworksShowAction.class);
+public class NetworksShowAction extends HssAction{
+	private static final Logger LOGGER = Logger.getLogger(NetworksShowAction.class);
 
 	public ActionForward execute(ActionMapping mapping, ActionForm form,
-			HttpServletRequest request, HttpServletResponse response)
-			throws Exception
-	{
+			HttpServletRequest request, HttpServletResponse response) throws Exception{
 		LOGGER.debug(&quot;entering&quot;);
 
-		List networks = getSession().createCriteria(Network.class).list();
-		request.setAttribute(&quot;networks&quot;, networks);
-		closeSession();
+		try{
+			HibernateUtil.beginTransaction();
+			List networks = HibernateUtil.getCurrentSession().createCriteria(Network.class).list();
+			request.setAttribute(&quot;networks&quot;, networks);
+			HibernateUtil.commitTransaction();
+		}
+		finally{
+			HibernateUtil.closeSession();
+		}
+		
 		LOGGER.debug(&quot;exiting&quot;);
-
 		return mapping.findForward(FORWARD_SUCCESS);
 	}
 }

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/action/NetworksSubmitAction.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/action/NetworksSubmitAction.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/action/NetworksSubmitAction.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -44,8 +44,14 @@
  */
 package de.fhg.fokus.hss.action;
 
+import java.util.Iterator;
+import java.util.List;
+import java.util.ListIterator;
+
 import de.fhg.fokus.hss.form.NetworkForm;
+import de.fhg.fokus.hss.model.Impi;
 import de.fhg.fokus.hss.model.Network;
+import de.fhg.fokus.hss.util.HibernateUtil;
 
 import org.apache.log4j.Logger;
 
@@ -67,89 +73,108 @@
  */
 public class NetworksSubmitAction extends HssAction
 {
-	private static final Logger LOGGER = Logger
-			.getLogger(NetworksShowAction.class);
+	private static final Logger LOGGER = Logger.getLogger(NetworksShowAction.class);
 
 	public ActionForward execute(ActionMapping mapping, ActionForm form,
-			HttpServletRequest request, HttpServletResponse response)
-			throws Exception
-	{
+			HttpServletRequest request, HttpServletResponse response) throws Exception {
+		
 		LOGGER.debug(&quot;entering&quot;);
 
 		ActionMessages actionMessages = null;
 		ActionForward forward = null;
-
 		Network network = null;
 
-		beginnTx();
-
 		NetworkForm networkForm = (NetworkForm) form;
 		LOGGER.debug(networkForm);
 
-		if (networkForm.getActionString().equals(NetworkForm.ACTION_CREATE))
-		{
-			LOGGER.debug(&quot;action type is create&quot;);
+		try{
+			HibernateUtil.beginTransaction();
+			if (networkForm.getActionString().equals(NetworkForm.ACTION_CREATE)){
+				LOGGER.debug(&quot;Action type is: create&quot;);
 
-			if (checkExist(networkForm.getNetworkString()))
-			{
-				actionMessages = new ActionMessages();
-				actionMessages.add(Globals.MESSAGE_KEY, new ActionMessage(
-						&quot;network.error.duplicated&quot;));
-				saveMessages(request, actionMessages);
-			} else
-			{
-				network = new Network();
-				network.setNetworkString(networkForm.getNetworkString());
-				getSession().save(network);
-			}
-		} else if (networkForm.getActionString().equals(
-				NetworkForm.ACTION_RENAME))
-		{
-			LOGGER.debug(&quot;action type is rename&quot;);
+				if (checkExist(networkForm.getNetworkString())){
+					actionMessages = new ActionMessages();
+					actionMessages.add(Globals.MESSAGE_KEY, new ActionMessage(&quot;network.error.duplicated&quot;));
+					saveMessages(request, actionMessages);
+				} 
+				else{
+					network = new Network();
+					network.setNetworkString(networkForm.getNetworkString());
+					HibernateUtil.getCurrentSession().save(network);
+				}
+			}	 
+			else if (networkForm.getActionString().equals(NetworkForm.ACTION_RENAME)){
+				LOGGER.debug(&quot;Action type is: rename&quot;);
 
-			if (checkExist(networkForm.getNetworkString()))
-			{
-				actionMessages = new ActionMessages();
-				actionMessages.add(Globals.MESSAGE_KEY, new ActionMessage(
-						&quot;network.error.duplicated&quot;));
-				saveMessages(request, actionMessages);
-			} else
-			{
-				network = (Network) getSession().load(Network.class,
-						networkForm.getPrimaryKey());
-				network.setNetworkString(networkForm.getNetworkString());
-				getSession().update(network);
+				if (checkExist(networkForm.getNetworkString())){
+					actionMessages = new ActionMessages();
+					actionMessages.add(Globals.MESSAGE_KEY, new ActionMessage(&quot;network.error.duplicated&quot;));
+					saveMessages(request, actionMessages);
+				}
+				else{
+					network = (Network) HibernateUtil.getCurrentSession().load(Network.class, networkForm.getPrimaryKey());
+					network.setNetworkString(networkForm.getNetworkString());
+					HibernateUtil.getCurrentSession().update(network);
+				}
 			}
-		} else if (networkForm.getActionString().equals(
-				NetworkForm.ACTION_DELETE))
-		{
-			// TODO: check for assigned roams
-			// Delete Network
-			Integer primaryKey = networkForm.getPrimaryKey();
-			network = (Network) getSession().load(Network.class, primaryKey);
-
-			getSession().delete(network);
+			else if (networkForm.getActionString().equals(NetworkForm.ACTION_DELETE)){
+				
+	            if(checkAssignedRoams(networkForm.getId()) == true){
+	              	actionMessages = new ActionMessages();
+	                actionMessages.add(Globals.MESSAGE_KEY,new ActionMessage(&quot;network.error.roam.assigned&quot;));
+	                saveMessages(request, actionMessages);	
+	            }
+	            else{
+	            	Integer primaryKey = networkForm.getPrimaryKey();
+	            	network = (Network) HibernateUtil.getCurrentSession().load(Network.class, primaryKey);
+	            	HibernateUtil.getCurrentSession().delete(network);
+				}
+			}
+			HibernateUtil.commitTransaction();
 		}
-
-		endTx();
+		finally{
+			HibernateUtil.closeSession();
+		}
+		
 		LOGGER.debug(&quot;exiting&quot;);
 
-		if (actionMessages == null)
-		{
+		if (actionMessages == null){
 			forward = mapping.findForward(FORWARD_SUCCESS);
-		} else
-		{
+		} 
+		else{
 			forward = mapping.findForward(FORWARD_FAILURE);
 		}
 
 		return forward;
 	}
 
-	private boolean checkExist(String name)
-	{
-		return ((Integer) getSession()
-				.createQuery(
-						&quot;select count(network) from de.fhg.fokus.hss.model.Network as network where network.networkString = ?&quot;)
+	
+	  private boolean checkAssignedRoams(String net_id){
+		  Network roam = null;
+		  Impi impi = null;
+		  
+		  List impiList = HibernateUtil.getCurrentSession().createQuery(&quot;from de.fhg.fokus.hss.model.Impi&quot;).list();
+		  Iterator iterator = impiList.iterator();
+		  while(iterator.hasNext()){
+			  impi = (Impi) iterator.next();
+			  Iterator roamIt;
+
+			  if(impi.getRoams() != null){
+				  roamIt = impi.getRoams().iterator();
+				  while(roamIt.hasNext()){
+					  roam = (Network)roamIt.next();
+					  if((roam.getNwId().toString()).equals(net_id)){	
+						  return true;
+					  }
+	        		}
+	        	}                             
+	        } 
+	        return false;
+	  }   	
+	
+	private boolean checkExist(String name){
+		return ((Integer) HibernateUtil.getCurrentSession()
+				.createQuery(&quot;select count(network) from de.fhg.fokus.hss.model.Network as network where network.networkString = ?&quot;)
 				.setString(0, name).uniqueResult()).intValue() != 0;
 	}
 }

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/action/PsiDeleteAction.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/action/PsiDeleteAction.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/action/PsiDeleteAction.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -46,6 +46,7 @@
 
 import de.fhg.fokus.hss.form.PsiForm;
 import de.fhg.fokus.hss.model.Psi;
+import de.fhg.fokus.hss.util.HibernateUtil;
 
 import org.apache.log4j.Logger;
 
@@ -65,35 +66,30 @@
 			.getLogger(PsiDeleteAction.class);
 
 	public ActionForward execute(ActionMapping mapping, ActionForm actionForm,
-			HttpServletRequest request, HttpServletResponse reponse)
-			throws Exception
-	{
+			HttpServletRequest request, HttpServletResponse reponse) throws Exception {
 		LOGGER.debug(&quot;entering&quot;);
 
 		PsiForm form = (PsiForm) actionForm;
 		LOGGER.debug(form);
 
-		try
-		{
-			beginnTx();
-
+		try{
 			Integer primaryKey = form.getPrimaryKey();
-
+			
+			HibernateUtil.beginTransaction();
 			Psi psi = null;
-			psi = (Psi) getSession().load(Psi.class, primaryKey);
-			getSession().delete(psi);
-			endTx();
-		} finally
-		{
-			closeSession();
+			psi = (Psi) HibernateUtil.getCurrentSession().load(Psi.class, primaryKey);
+			HibernateUtil.getCurrentSession().delete(psi);
+			HibernateUtil.commitTransaction();
 		}
+		finally{
+			HibernateUtil.closeSession();
+		}
 
 		if (LOGGER.isDebugEnabled())
 		{
 			LOGGER.debug(form);
 			LOGGER.debug(&quot;exiting&quot;);
 		}
-
 		return mapping.findForward(FORWARD_SUCCESS);
 	}
 }

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/action/PsiSearchAction.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/action/PsiSearchAction.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/action/PsiSearchAction.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -45,6 +45,7 @@
 package de.fhg.fokus.hss.action;
 
 import de.fhg.fokus.hss.form.PsiSearchForm;
+import de.fhg.fokus.hss.util.HibernateUtil;
 
 import org.apache.log4j.Logger;
 
@@ -64,24 +65,20 @@
  */
 public class PsiSearchAction extends HssAction
 {
-	private static final Logger LOGGER = Logger
-			.getLogger(PsiSearchAction.class);
+	private static final Logger LOGGER = Logger.getLogger(PsiSearchAction.class);
 
 	public ActionForward execute(ActionMapping mapping, ActionForm actionForm,
-			HttpServletRequest request, HttpServletResponse reponse)
-			throws Exception
-	{
+			HttpServletRequest request, HttpServletResponse reponse) throws Exception {
+		
 		LOGGER.debug(&quot;entering&quot;);
 
 		PsiSearchForm form = (PsiSearchForm) actionForm;
 		LOGGER.debug(form);
 
-		try
-		{
-			// Prepare Querry
-			Query query = getSession()
-					.createQuery(
-							&quot;select psi from de.fhg.fokus.hss.model.Psi as psi where psi.name like ?&quot;);
+		try{
+			
+			HibernateUtil.beginTransaction();
+			Query query = HibernateUtil.getCurrentSession().createQuery(&quot;select psi from de.fhg.fokus.hss.model.Psi as psi where psi.name like ?&quot;);
 			query.setString(0, &quot;%&quot; + form.getPsiName() + &quot;%&quot;);
 
 			// Check page browsing values
@@ -89,8 +86,7 @@
 			int currentPage = Integer.parseInt(form.getPage()) - 1;
 			int maxPages = (int) ((query.list().size() - 1) / rowPerPage) + 1;
 
-			if (currentPage &gt; maxPages)
-			{
+			if (currentPage &gt; maxPages){
 				currentPage = 0;
 			}
 
@@ -102,17 +98,17 @@
 
 			// store attributes in request
 			request.setAttribute(&quot;result&quot;, query.list());
-
+			HibernateUtil.commitTransaction();
+			
 			request.setAttribute(&quot;maxPages&quot;, String.valueOf(maxPages));
 			request.setAttribute(&quot;currentPage&quot;, String.valueOf(currentPage));
 			request.setAttribute(&quot;rowPerPage&quot;, String.valueOf(rowPerPage));
-		} finally
-		{
-			closeSession();
 		}
+		finally{
+			HibernateUtil.closeSession();
+		}
 
 		LOGGER.debug(&quot;exiting&quot;);
-
 		return mapping.findForward(FORWARD_SUCCESS);
 	}
 }

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/action/PsiShowAction.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/action/PsiShowAction.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/action/PsiShowAction.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -44,16 +44,22 @@
  */
 package de.fhg.fokus.hss.action;
 
+import java.util.List;
+import java.util.Set;
+
 import de.fhg.fokus.hss.form.ImpuSubSelectForm;
 import de.fhg.fokus.hss.form.PsiForm;
 import de.fhg.fokus.hss.model.Psi;
 import de.fhg.fokus.hss.model.PsiTempl;
+import de.fhg.fokus.hss.util.HibernateUtil;
 
 import org.apache.log4j.Logger;
 
 import org.apache.struts.action.ActionForm;
 import org.apache.struts.action.ActionForward;
 import org.apache.struts.action.ActionMapping;
+import org.hibernate.Query;
+import org.hibernate.Session;
 
 import javax.servlet.http.HttpServletRequest;
 import javax.servlet.http.HttpServletResponse;
@@ -66,9 +72,7 @@
 	private static final Logger LOGGER = Logger.getLogger(PsiShowAction.class);
 
 	public ActionForward execute(ActionMapping mapping, ActionForm actionForm,
-			HttpServletRequest request, HttpServletResponse reponse)
-			throws Exception
-	{
+			HttpServletRequest request, HttpServletResponse reponse) throws Exception {
 		LOGGER.debug(&quot;entering&quot;);
 
 		PsiForm form = (PsiForm) actionForm;
@@ -78,12 +82,9 @@
 
 		try
 		{
-			/**
-			 * If create (id = -1), dont load the ifc, only the selection values
-			 */
-			if (primaryKey.intValue() != -1)
-			{
-				Psi psi = (Psi) getSession().get(Psi.class, primaryKey);
+			HibernateUtil.beginTransaction();
+			if (primaryKey.intValue() != -1){
+				Psi psi = (Psi) HibernateUtil.getCurrentSession().get(Psi.class, primaryKey);
 
 				form.setPsiId(convString(psi.getPsiId()));
 				form.setPsiName(psi.getName());
@@ -92,35 +93,59 @@
 				PsiTempl psiTempl = psi.getPsiTempl();
 				form.setPsiTemplId(convString(psiTempl.getTemplId()));
 
-				String impuName = psiTempl.getUsername() + psi.getWildcard()
-						+ &quot;@&quot; + psiTempl.getHostname();
+				String impuName = psiTempl.getUsername() + psi.getWildcard() + &quot;@&quot; + psiTempl.getHostname();
 				form.setImpuName(impuName);
 
-				if (psi.getImpus().size() &gt; 1)
-				{
+				if (psi.getImpus().size() &gt; 1){
 					form.setImpus(psi.getImpus());
-				} else
-				{
+				} 
+				else{
 					form.getImpus().addAll(psi.getImpus());
 				}
-
-				ImpuSubSelectForm.doImpuSelection(getSession(), form, psi
-						.getImpus());
+				doImpuSelection(HibernateUtil.getCurrentSession(), form, psi.getImpus());
 			}
-
-			form.setPsiTempls(getSession().createCriteria(PsiTempl.class)
-					.list());
-		} finally
-		{
-			closeSession();
+			form.setPsiTempls(HibernateUtil.getCurrentSession().createCriteria(PsiTempl.class).list());
+			HibernateUtil.commitTransaction();
 		}
+		finally{
+			HibernateUtil.closeSession();
+		}
 
-		if (LOGGER.isDebugEnabled())
-		{
+		if (LOGGER.isDebugEnabled()){
 			LOGGER.debug(form);
 			LOGGER.debug(&quot;exiting&quot;);
 		}
-
 		return mapping.findForward(FORWARD_SUCCESS);
 	}
+	
+    public static void doImpuSelection(Session session, ImpuSubSelectForm form, Set givenImpus){
+    	
+        if ((form.getImpuSelect().equals(&quot;true&quot;)) &amp;&amp; ((form.getImpuUrl() != null) &amp;&amp; (form.getImpuUrl().length() &gt; 0))){
+            List results = null;
+
+            if (form.getImsuId() != null){
+                Query query = session.createQuery(&quot;select impu from de.fhg.fokus.hss.model.Impu as impu where impu.psi = 0 and impu.sipUrl like ? and impu.impis.imsu.imsuId = ?&quot;);
+                query.setString(0, &quot;%&quot; + form.getImpuUrl() + &quot;%&quot;);
+                query.setInteger(1, form.getImsuId());
+                query.setMaxResults(20);
+                results = query.list();
+                query = session.createQuery
+                	(&quot;select impu from de.fhg.fokus.hss.model.Impu as impu where impu.psi = 0 and impu.sipUrl like ? and impu.impis is empty&quot;);
+                query.setString(0, &quot;%&quot; + form.getImpuUrl() + &quot;%&quot;);
+                results.addAll(query.list());
+            }
+            else{
+                // Prepare Querry
+                Query query = session.createQuery(&quot;select impu from de.fhg.fokus.hss.model.Impu as impu where impu.psi = 0 and impu.sipUrl like ?&quot;);
+                query.setString(0, &quot;%&quot; + form.getImpuUrl() + &quot;%&quot;);
+                query.setMaxResults(20);
+                results = query.list();
+            }
+
+            results.removeAll(givenImpus);
+            form.setImpusSelected(results);
+            LOGGER.debug(form);
+        }
+    }
+
 }

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/action/PsiSubmitAction.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/action/PsiSubmitAction.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/action/PsiSubmitAction.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -48,6 +48,7 @@
 import de.fhg.fokus.hss.model.Impu;
 import de.fhg.fokus.hss.model.Psi;
 import de.fhg.fokus.hss.model.PsiTempl;
+import de.fhg.fokus.hss.util.HibernateUtil;
 
 import org.apache.log4j.Logger;
 
@@ -67,12 +68,10 @@
 			.getLogger(PsiSubmitAction.class);
 
 	public ActionForward execute(ActionMapping mapping, ActionForm actionForm,
-			HttpServletRequest request, HttpServletResponse reponse)
-			throws Exception
-	{
+			HttpServletRequest request, HttpServletResponse reponse) throws Exception {
 		LOGGER.debug(&quot;entering&quot;);
 
-		ActionForward forward;
+		ActionForward forward = null;
 
 		try
 		{
@@ -85,68 +84,58 @@
 			Impu assginedImpu = null;
 			String sipName = null;
 
-			PsiTempl psiTempl = (PsiTempl) getSession().load(PsiTempl.class,
-					Integer.valueOf(form.getPsiTemplId()));
-
-			beginnTx();
-
-			/*
-			 * If create (id = -1), dont load the psi, create new psi.
-			 */
-			if (primaryKey.intValue() == -1)
-			{
+			HibernateUtil.beginTransaction();
+			PsiTempl psiTempl = (PsiTempl) HibernateUtil.getCurrentSession().load(PsiTempl.class, Integer.valueOf(form.getPsiTemplId()));
+			
+			 //If id = -1 create a new psi.
+			if (primaryKey.intValue() == -1){
 				psi = new Psi();
 				assginedImpu = new Impu();
 				assginedImpu.setUserStatus(Impu.USER_STATUS_UNREGISTERED);
 				assginedImpu.setPsi(true);
 
-				sipName = psiTempl.getUsername() + form.getWildcard() + &quot;@&quot;
-						+ psiTempl.getHostname();
+				sipName = psiTempl.getUsername() + form.getWildcard() + &quot;@&quot; + psiTempl.getHostname();
 				assginedImpu.setSipUrl(sipName);
 				assginedImpu.setTelUrl(&quot;&quot;);
 				assginedImpu.setBarringIndication(false);
-				getSession().save(assginedImpu);
+				HibernateUtil.getCurrentSession().save(assginedImpu);
 
 				// impu --&gt; psi
 				psi.setImpuRoot(assginedImpu);
-
 				psi.setName(form.getPsiName());
 				psi.setWildcard(form.getWildcard());
 				psi.setPsiTempl(psiTempl);
+				HibernateUtil.getCurrentSession().save(psi);
 
-				getSession().save(psi);
-
 				// psi --&gt; impu
 				assginedImpu.setAssignedPsi(psi);
-				getSession().saveOrUpdate(assginedImpu);
-			} else
-			{
-				psi = (Psi) getSession().load(Psi.class, primaryKey);
+				HibernateUtil.getCurrentSession().saveOrUpdate(assginedImpu);
+			} 
+			else{
+				psi = (Psi) HibernateUtil.getCurrentSession().load(Psi.class, primaryKey);
 				assginedImpu = psi.getImpuRoot();
 
 				psi.setName(form.getPsiName());
 				psi.setWildcard(form.getWildcard());
 				psi.setPsiTempl(psiTempl);
 
-				sipName = psiTempl.getUsername() + psi.getWildcard() + &quot;@&quot;
-						+ psiTempl.getHostname();
+				sipName = psiTempl.getUsername() + psi.getWildcard() + &quot;@&quot; + psiTempl.getHostname();
 				assginedImpu.setSipUrl(sipName);
-				getSession().saveOrUpdate(psi);
-				getSession().saveOrUpdate(assginedImpu);
+				HibernateUtil.getCurrentSession().saveOrUpdate(psi);
+				HibernateUtil.getCurrentSession().saveOrUpdate(assginedImpu);
 			}
 
-			endTx();
+			HibernateUtil.commitTransaction();
 			LOGGER.debug(form);
 
 			forward = mapping.findForward(FORWARD_SUCCESS);
-			forward = new ActionForward(forward.getPath() + &quot;?psiId=&quot;
-					+ psi.getPsiId(), true);
-		} finally
-		{
-			LOGGER.debug(&quot;exiting&quot;);
-			closeSession();
+			forward = new ActionForward(forward.getPath() + &quot;?psiId=&quot; + psi.getPsiId(), true);
 		}
-
+		finally{
+			HibernateUtil.closeSession();
+		}
+		
+		LOGGER.debug(&quot;exiting&quot;);
 		return forward;
 	}
 }

Added: FHoSS/trunk/src/de/fhg/fokus/hss/action/PsiTemplDeleteAction.java

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/action/PsiTemplSearchAction.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/action/PsiTemplSearchAction.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/action/PsiTemplSearchAction.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -45,6 +45,7 @@
 package de.fhg.fokus.hss.action;
 
 import de.fhg.fokus.hss.form.PsiTemplSearchForm;
+import de.fhg.fokus.hss.util.HibernateUtil;
 
 import org.apache.log4j.Logger;
 
@@ -74,12 +75,10 @@
 		PsiTemplSearchForm form = (PsiTemplSearchForm) actionForm;
 		LOGGER.debug(form);
 
-		try
-		{
-			// Prepare Querry
-			Query query = getSession()
-					.createQuery(
-							&quot;select psiTempl from de.fhg.fokus.hss.model.PsiTempl as psiTempl where psiTempl.templName like ?&quot;);
+		try{
+			HibernateUtil.beginTransaction();
+			Query query = HibernateUtil.getCurrentSession()
+				.createQuery(&quot;select psiTempl from de.fhg.fokus.hss.model.PsiTempl as psiTempl where psiTempl.templName like ?&quot;);
 			query.setString(0, &quot;%&quot; + form.getPsiTemplName() + &quot;%&quot;);
 
 			// Check page browsing values
@@ -87,8 +86,7 @@
 			int currentPage = Integer.parseInt(form.getPage()) - 1;
 			int maxPages = (int) ((query.list().size() - 1) / rowPerPage) + 1;
 
-			if (currentPage &gt; maxPages)
-			{
+			if (currentPage &gt; maxPages){
 				currentPage = 0;
 			}
 
@@ -100,17 +98,17 @@
 
 			// store attributes in request
 			request.setAttribute(&quot;result&quot;, query.list());
-
+			HibernateUtil.commitTransaction();
+			
 			request.setAttribute(&quot;maxPages&quot;, String.valueOf(maxPages));
 			request.setAttribute(&quot;currentPage&quot;, String.valueOf(currentPage));
 			request.setAttribute(&quot;rowPerPage&quot;, String.valueOf(rowPerPage));
-		} finally
-		{
-			closeSession();
+		} 
+		finally{
+			HibernateUtil.closeSession();
 		}
-
+		
 		LOGGER.debug(&quot;exiting&quot;);
-
 		return mapping.findForward(FORWARD_SUCCESS);
 	}
 }

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/action/PsiTemplShowAction.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/action/PsiTemplShowAction.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/action/PsiTemplShowAction.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -47,6 +47,7 @@
 import de.fhg.fokus.hss.form.PsiTemplForm;
 import de.fhg.fokus.hss.model.Apsvr;
 import de.fhg.fokus.hss.model.PsiTempl;
+import de.fhg.fokus.hss.util.HibernateUtil;
 
 import org.apache.log4j.Logger;
 
@@ -66,9 +67,7 @@
 			.getLogger(PsiTemplShowAction.class);
 
 	public ActionForward execute(ActionMapping mapping, ActionForm actionForm,
-			HttpServletRequest request, HttpServletResponse reponse)
-			throws Exception
-	{
+			HttpServletRequest request, HttpServletResponse reponse) throws Exception {
 		LOGGER.debug(&quot;entering&quot;);
 
 		PsiTemplForm form = (PsiTemplForm) actionForm;
@@ -76,15 +75,11 @@
 
 		Integer primaryKey = form.getPrimaryKey();
 
-		try
-		{
-			/**
-			 * If create (id = -1), dont load the ifc, only the selection values
-			 */
-			if (primaryKey.intValue() != -1)
-			{
-				PsiTempl psiTempl = (PsiTempl) getSession().get(PsiTempl.class,
-						primaryKey);
+		try{
+			 //If create (id = -1), dont load the ifc, only the selection values
+			HibernateUtil.beginTransaction();
+			if (primaryKey.intValue() != -1){
+				PsiTempl psiTempl = (PsiTempl) HibernateUtil.getCurrentSession().get(PsiTempl.class, primaryKey);
 
 				form.setPsiTemplId(convString(psiTempl.getTemplId()));
 				form.setApsvrId(convString(psiTempl.getApsvr().getApsvrId()));
@@ -93,15 +88,14 @@
 				form.setUsername(psiTempl.getUsername());
 				form.setPsiTemplName(psiTempl.getTemplName());
 			}
-
-			form.setApsvrs(getSession().createCriteria(Apsvr.class).list());
-		} finally
-		{
-			closeSession();
+			form.setApsvrs(HibernateUtil.getCurrentSession().createCriteria(Apsvr.class).list());
+			HibernateUtil.commitTransaction();
+		} 
+		finally{
+			HibernateUtil.closeSession();
 		}
 
-		if (LOGGER.isDebugEnabled())
-		{
+		if (LOGGER.isDebugEnabled()){
 			LOGGER.debug(form);
 			LOGGER.debug(&quot;exiting&quot;);
 		}

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/action/PsiTemplSubmitAction.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/action/PsiTemplSubmitAction.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/action/PsiTemplSubmitAction.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -47,6 +47,7 @@
 import de.fhg.fokus.hss.form.PsiTemplForm;
 import de.fhg.fokus.hss.model.Apsvr;
 import de.fhg.fokus.hss.model.PsiTempl;
+import de.fhg.fokus.hss.util.HibernateUtil;
 
 import org.apache.log4j.Logger;
 
@@ -78,43 +79,35 @@
 
 		PsiTempl psiTempl = null;
 
-		try
-		{
-			beginnTx();
-
+		try{
 			Integer primaryKey = form.getPrimaryKey();
-
-			if (primaryKey.intValue() == -1)
-			{
+			
+			HibernateUtil.beginTransaction();
+			if (primaryKey.intValue() == -1){
 				psiTempl = new PsiTempl();
-			} else
-			{
-				psiTempl = (PsiTempl) getSession().load(PsiTempl.class,
-						primaryKey);
+			} 
+			else{
+				psiTempl = (PsiTempl) HibernateUtil.getCurrentSession().load(PsiTempl.class,primaryKey);
 			}
 
 			psiTempl.setTemplName(form.getPsiTemplName());
-			psiTempl.setApsvr((Apsvr) getSession().load(Apsvr.class,
-					Integer.valueOf(form.getApsvrId())));
+			psiTempl.setApsvr((Apsvr) HibernateUtil.getCurrentSession().load(Apsvr.class, Integer.valueOf(form.getApsvrId())));
 			psiTempl.setHostname(form.getHostname());
 			psiTempl.setUsername(form.getUsername());
 
-			getSession().saveOrUpdate(psiTempl);
-
-			endTx();
-		} finally
-		{
-			closeSession();
+			HibernateUtil.getCurrentSession().saveOrUpdate(psiTempl);
+			HibernateUtil.commitTransaction();
+			
+		} 
+		finally{
+			HibernateUtil.closeSession();
 		}
-
 		LOGGER.debug(form);
 
 		ActionForward forward = mapping.findForward(FORWARD_SUCCESS);
-		forward = new ActionForward(forward.getPath() + &quot;?psiTemplId=&quot;
-				+ psiTempl.getTemplId(), true);
+		forward = new ActionForward(forward.getPath() + &quot;?psiTemplId=&quot;+ psiTempl.getTemplId(), true);
 
 		LOGGER.debug(&quot;exiting&quot;);
-
 		return forward;
 	}
 }

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/action/RoamEditAction.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/action/RoamEditAction.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/action/RoamEditAction.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -47,6 +47,7 @@
 import de.fhg.fokus.hss.form.RoamingForm;
 import de.fhg.fokus.hss.model.Impi;
 import de.fhg.fokus.hss.model.Network;
+import de.fhg.fokus.hss.util.HibernateUtil;
 
 import org.apache.log4j.Logger;
 
@@ -70,37 +71,32 @@
 	private static final Logger LOGGER = Logger.getLogger(RoamEditAction.class);
 
 	public ActionForward execute(ActionMapping mapping, ActionForm actionForm,
-			HttpServletRequest request, HttpServletResponse reponse)
-			throws Exception
-	{
+			HttpServletRequest request, HttpServletResponse reponse) throws Exception {
+		
 		LOGGER.debug(&quot;entering&quot;);
-
 		RoamingForm roamingForm = (RoamingForm) actionForm;
 
-		try
-		{
-			Query query = getSession()
-					.createQuery(
-							&quot;select impi from de.fhg.fokus.hss.model.Impi as impi where impi.impiId = ?&quot;);
-
+		try{
+			HibernateUtil.beginTransaction();
+			Query query = HibernateUtil.getCurrentSession()
+				.createQuery(&quot;select impi from de.fhg.fokus.hss.model.Impi as impi where impi.impiId = ?&quot;);
 			query.setString(0, roamingForm.getImpiId());
 
 			Impi impi = (Impi) query.uniqueResult();
 			Set roams = impi.getRoams();
 			roamingForm.setRoams(roams);
 
-			List networks = getSession().createCriteria(Network.class).list();
-
+			List networks = HibernateUtil.getCurrentSession().createCriteria(Network.class).list();
 			networks.removeAll(roams);
-
 			roamingForm.setNetworks(networks);
-		} finally
-		{
-			closeSession();
+			HibernateUtil.commitTransaction();
+			
+		} 
+		finally{
+			HibernateUtil.closeSession();
 		}
 
-		if (LOGGER.isDebugEnabled())
-		{
+		if (LOGGER.isDebugEnabled()){
 			LOGGER.debug(actionForm);
 			LOGGER.debug(&quot;exiting&quot;);
 		}

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/action/RoamSubmitAction.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/action/RoamSubmitAction.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/action/RoamSubmitAction.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -46,6 +46,7 @@
 
 import de.fhg.fokus.hss.form.RoamingForm;
 import de.fhg.fokus.hss.model.Impi;
+import de.fhg.fokus.hss.util.HibernateUtil;
 
 import org.apache.log4j.Logger;
 
@@ -64,68 +65,59 @@
  */
 public class RoamSubmitAction extends HssAction
 {
-	private static final Logger LOGGER = Logger
-			.getLogger(RoamSubmitAction.class);
+	private static final Logger LOGGER = Logger.getLogger(RoamSubmitAction.class);
 
 	/**
 	 * Get the roam string list from request and store them to selected impi.
 	 */
 	public ActionForward execute(ActionMapping mapping, ActionForm actionForm,
-			HttpServletRequest request, HttpServletResponse response)
-			throws Exception
-	{
+			HttpServletRequest request, HttpServletResponse response) throws Exception {
+		
 		LOGGER.debug(&quot;entering&quot;);
-
 		RoamingForm roamingForm = (RoamingForm) actionForm;
 
-		try
-		{
-			beginnTx();
-
+		try{
 			// Get roam id string list from request
 			String[] roams = request.getParameterValues(&quot;roams&quot;);
 			ArrayList roamList = new ArrayList();
 			List networks = null;
 
-			if (roams != null)
-			{
-				for (int ix = 0; ix &lt; roams.length; ix++)
-				{
+			if (roams != null){
+				for (int ix = 0; ix &lt; roams.length; ix++){
 					roamList.add(roams[ix]);
 				}
-
+				
+				HibernateUtil.beginTransaction();
+				
 				// get a list with all roaming network
-				networks = getSession()
-						.createQuery(
-								&quot;select network from de.fhg.fokus.hss.model.Network as network where network.nwId in (:roamList)&quot;)
-						.setParameterList(&quot;roamList&quot;, roamList).list();
+				networks = HibernateUtil.getCurrentSession()
+					.createQuery(&quot;select network from de.fhg.fokus.hss.model.Network as network where network.nwId in (:roamList)&quot;)
+					.setParameterList(&quot;roamList&quot;, roamList).list();
 			}
+			else{
+				HibernateUtil.beginTransaction();
+			}
 
 			// Load impi and add the roam networks list
-			Impi impi = (Impi) getSession().load(Impi.class,
-					new Integer(roamingForm.getImpiId()));
-
+			Impi impi = (Impi) HibernateUtil.getCurrentSession().load(Impi.class, new Integer(roamingForm.getImpiId()));
 			impi.getRoams().clear();
 
-			if (networks != null)
-			{
+			if (networks != null){
 				impi.getRoams().addAll(networks);
 			}
-
-			getSession().saveOrUpdate(impi);
-			endTx();
-		} finally
-		{
-			closeSession();
+			HibernateUtil.getCurrentSession().saveOrUpdate(impi);
+			HibernateUtil.commitTransaction();
+			
+		} 
+		finally{
+			HibernateUtil.closeSession();
 		}
 
 		// forward to impiShow with specific impiId
 		ActionForward forward = mapping.findForward(FORWARD_SUCCESS);
-		forward = new ActionForward(forward.getPath() + &quot;?impiId=&quot;
-				+ roamingForm.getImpiId(), true);
+		forward = new ActionForward(forward.getPath() + &quot;?impiId=&quot; + roamingForm.getImpiId(), true);
 
 		LOGGER.debug(&quot;exiting&quot;);
-
 		return forward;
 	}
 }

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/action/SvpDeleteAction.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/action/SvpDeleteAction.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/action/SvpDeleteAction.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -59,6 +59,7 @@
 import de.fhg.fokus.hss.model.Svp;
 import de.fhg.fokus.hss.model.Ifc2svpPK;
 import de.fhg.fokus.hss.model.Ifc2svp;
+import de.fhg.fokus.hss.util.HibernateUtil;
 
 import java.util.Iterator;
 import java.util.ArrayList;
@@ -70,13 +71,11 @@
  */
 public class SvpDeleteAction extends HssAction
 {
-	private static final Logger LOGGER = Logger
-			.getLogger(SvpDeleteAction.class);
+	private static final Logger LOGGER = Logger.getLogger(SvpDeleteAction.class);
 
 	public ActionForward execute(ActionMapping mapping, ActionForm actionForm,
-			HttpServletRequest request, HttpServletResponse reponse)
-			throws Exception
-	{
+			HttpServletRequest request, HttpServletResponse reponse) throws Exception {
+		
 		LOGGER.debug(&quot;entering&quot;);
 
 		SvpForm form = (SvpForm) actionForm;
@@ -84,12 +83,13 @@
 		Svp svp = null;
 		ActionForward forward = null;
 
-		try
-		{
+		try{
 			Integer primaryKey = form.getPrimaryKey();
-			svp = (Svp) getSession().get(Svp.class, primaryKey);
-			Query query = getSession().createQuery(
-					&quot;FROM de.fhg.fokus.hss.model.Ifc2svp&quot;);
+			
+			HibernateUtil.beginTransaction();
+			svp = (Svp) HibernateUtil.getCurrentSession().get(Svp.class, primaryKey);
+			Query query = HibernateUtil.getCurrentSession().createQuery(&quot;from de.fhg.fokus.hss.model.Ifc2svp&quot;);
+			
 			ArrayList list = (ArrayList) query.list();
 			Iterator itr = list.iterator();
 			boolean exist = false;
@@ -97,48 +97,40 @@
 			Ifc2svp i2s;
 			Integer b = null;
 
-			while (itr.hasNext())
-			{
+			while (itr.hasNext()){
 				i2s = (Ifc2svp) itr.next();
 				i2sPK = i2s.getComp_id();
 				b = i2sPK.getSvpId();
-				if (b != null)
-				{
-					if (b.intValue() == primaryKey.intValue())
-					{
+				
+				if (b != null){
+					if (b.intValue() == primaryKey.intValue()){
 						exist = true;
 						break;
 					}
 				}
 			}
 
-			if (!exist)
-			{
-				beginnTx();
-				getSession().delete(svp);
-				endTx();
+			if (!exist){
+				HibernateUtil.getCurrentSession().delete(svp);
 				forward = mapping.findForward(FORWARD_SUCCESS);
-			} else
-			{
+			} 
+			else{
 				ActionMessages actionMessages = new ActionMessages();
-
-				if (exist)
-				{
-					actionMessages.add(Globals.MESSAGE_KEY, new ActionMessage(
-							&quot;svp.error.existIfcs&quot;));
+				if (exist){
+					actionMessages.add(Globals.MESSAGE_KEY, new ActionMessage(&quot;svp.error.existIfcs&quot;));
 				}
-
 				saveMessages(request, actionMessages);
 
 				forward = mapping.findForward(FORWARD_FAILURE);
 			}
 
-		} finally
-		{
-			closeSession();
+			HibernateUtil.commitTransaction();
+		} 
+		finally{
+			HibernateUtil.closeSession();
 		}
+		
 		LOGGER.debug(&quot;exiting&quot;);
 		return forward;
-
 	}
 }

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/action/SvpSearchAction.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/action/SvpSearchAction.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/action/SvpSearchAction.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -54,6 +54,7 @@
 import org.hibernate.Query;
 
 import de.fhg.fokus.hss.form.SvpSearchForm;
+import de.fhg.fokus.hss.util.HibernateUtil;
 
 /**
  * @author Andre Charton (dev -at- open-ims dot org)
@@ -72,12 +73,11 @@
 		SvpSearchForm form = (SvpSearchForm) actionForm;
 		LOGGER.debug(form);
 
-		try
-		{
+		try{
+			HibernateUtil.beginTransaction();
 			// Prepare Querry
-			Query query = getSession()
-					.createQuery(
-							&quot;select svp from de.fhg.fokus.hss.model.Svp as svp where svp.name like ?&quot;);
+			Query query = HibernateUtil.getCurrentSession()
+				.createQuery(&quot;select svp from de.fhg.fokus.hss.model.Svp as svp where svp.name like ?&quot;);
 			query.setString(0, &quot;%&quot; + form.getName() + &quot;%&quot;);
 
 			// Check page browsing values
@@ -85,8 +85,7 @@
 			int currentPage = Integer.parseInt(form.getPage()) - 1;
 			int maxPages = (int) ((query.list().size() - 1) / rowPerPage) + 1;
 
-			if (currentPage &gt; maxPages)
-			{
+			if (currentPage &gt; maxPages){
 				currentPage = 0;
 			}
 
@@ -98,16 +97,17 @@
 
 			// store attributes in request
 			request.setAttribute(&quot;result&quot;, query.list());
-
+			HibernateUtil.commitTransaction();
+			
 			request.setAttribute(&quot;maxPages&quot;, String.valueOf(maxPages));
 			request.setAttribute(&quot;currentPage&quot;, String.valueOf(currentPage));
 			request.setAttribute(&quot;rowPerPage&quot;, String.valueOf(rowPerPage));
-		} finally
-		{
-			closeSession();
+		} 
+		finally{
+			HibernateUtil.closeSession();
 		}
+		
 		LOGGER.debug(&quot;exiting&quot;);
-
 		return mapping.findForward(FORWARD_SUCCESS);
 	}
 

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/action/SvpShowAction.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/action/SvpShowAction.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/action/SvpShowAction.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -59,57 +59,52 @@
 import de.fhg.fokus.hss.form.SvpForm;
 import de.fhg.fokus.hss.model.Ifc2svp;
 import de.fhg.fokus.hss.model.Svp;
+import de.fhg.fokus.hss.util.HibernateUtil;
 
 /**
  * @author Andre Charton (dev -at- open-ims dot org)
  */
-public class SvpShowAction extends HssAction
-{
+public class SvpShowAction extends HssAction{
 	private static final Logger LOGGER = Logger.getLogger(SvpShowAction.class);
 
 	public ActionForward execute(ActionMapping mapping, ActionForm actionForm,
-			HttpServletRequest request, HttpServletResponse reponse)
-			throws Exception
-	{
+			HttpServletRequest request, HttpServletResponse reponse) throws Exception{
+		
 		LOGGER.debug(&quot;entering&quot;);
 
 		SvpForm form = (SvpForm) actionForm;
 		LOGGER.debug(form);
 
-		try
-		{
+		try{
 			Integer primaryKey = form.getPrimaryKey();
-			if (primaryKey.intValue() != -1)
-			{
-				Svp svp = (Svp) getSession().get(Svp.class, primaryKey);
+			HibernateUtil.beginTransaction();
+			if (primaryKey.intValue() != -1){
+				Svp svp = (Svp) HibernateUtil.getCurrentSession().get(Svp.class, primaryKey);
 				form.setName(svp.getName());
 				addIfcs(svp, form);
 			}
-
-		} catch (NullPointerException excep)
-		{
-			LOGGER.error(&quot;A nullpointerexception occured&quot;);
+			HibernateUtil.commitTransaction();
 		}
+		catch (NullPointerException e){
+			LOGGER.error(&quot;NULL pointer exception!&quot;);
+			e.printStackTrace();
+		}
 
-		finally
-		{
-			closeSession();
+		finally{
+			HibernateUtil.closeSession();
 		}
 
 		LOGGER.debug(&quot;exiting&quot;);
-
 		return mapping.findForward(FORWARD_SUCCESS);
 	}
 
 	private void addIfcs(Svp svp, SvpForm form)
 	{
 		Iterator it = svp.getIfc2svps().iterator();
-		while (it.hasNext())
-		{
+		while (it.hasNext()){
 			Ifc2svp ifc2svp = (Ifc2svp) it.next();
 			IfcForm ifcForm = new IfcForm();
-			ifcForm
-					.setIfcId(convString(ifc2svp.getIfc().getIfcId().intValue()));
+			ifcForm.setIfcId(convString(ifc2svp.getIfc().getIfcId().intValue()));
 			ifcForm.setIfcName(ifc2svp.getIfc().getName());
 			ifcForm.setPriority(convString(ifc2svp.getPriority()));
 			form.getIfcs().add(ifcForm);
@@ -120,17 +115,14 @@
 
 		IfcForm temp;
 		int a, b;
-		for (int x = 0; x &lt; length - 1; x++)
-		{
-			for (int y = 0; y &lt; length - 1 - x; y++)
-			{
+		for (int x = 0; x &lt; length - 1; x++){
+			for (int y = 0; y &lt; length - 1 - x; y++){
 
 				IfcForm form1 = (IfcForm) lst.get(y);
 				IfcForm form2 = (IfcForm) lst.get(y + 1);
 				a = Integer.parseInt(form2.getPriority());
 				b = Integer.parseInt(form1.getPriority());
-				if (a &lt; b)
-				{
+				if (a &lt; b){
 					temp = (IfcForm) lst.get(y);
 					lst.set(y, (IfcForm) lst.get(y + 1));
 					lst.set(y + 1, temp);
@@ -138,8 +130,6 @@
 			}
 
 		}
-
 		form.setIfcs(lst);
-
 	}
 }

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/action/SvpSubmitAction.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/action/SvpSubmitAction.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/action/SvpSubmitAction.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -47,6 +47,7 @@
 import de.fhg.fokus.hss.form.SvpForm;
 import de.fhg.fokus.hss.model.Svp;
 import de.fhg.fokus.hss.model.SvpBO;
+import de.fhg.fokus.hss.util.HibernateUtil;
 
 import org.apache.log4j.Logger;
 
@@ -71,9 +72,8 @@
 			.getLogger(SvpSubmitAction.class);
 
 	public ActionForward execute(ActionMapping mapping, ActionForm actionForm,
-			HttpServletRequest request, HttpServletResponse reponse)
-			throws Exception
-	{
+			HttpServletRequest request, HttpServletResponse reponse) throws Exception{
+		
 		LOGGER.debug(&quot;entering&quot;);
 
 		SvpForm form = (SvpForm) actionForm;
@@ -83,43 +83,40 @@
 		SvpBO svpBO = new SvpBO();
 		ActionForward forward = null;
 
-		try
-		{
+		try{
 
+			HibernateUtil.beginTransaction();
 			Integer primaryKey = form.getPrimaryKey();
-
-			if (primaryKey.intValue() == -1)
-			{
+			if (primaryKey.intValue() == -1){
 				svp = svpBO.create();
-			} else
-			{
+			}
+			else{
 				svp = svpBO.load(primaryKey);
 			}
-
 			svp.setName(form.getName());
 			svpBO.saveOrUpdate(svp);
-			LOGGER.info(&quot;SERVICE PROFILE named &quot; + form.getName()
-					+ &quot; added successfully!&quot;);
+			HibernateUtil.commitTransaction();
+			
+			LOGGER.info(&quot;SERVICE PROFILE name &quot; + form.getName() + &quot; added successfully!&quot;);
 
 			// forward to impiShow with specific impiId
 			forward = mapping.findForward(FORWARD_SUCCESS);
 			forward = new ActionForward(forward.getPath() + &quot;?svpId=&quot;
 					+ svp.getSvpId(), true);
-		} catch (ConstraintViolationException e)
-		{
+		} 
+		catch (ConstraintViolationException e){
 			LOGGER.debug(this, e);
+			
 			ActionMessages actionMessages = new ActionMessages();
-			actionMessages.add(Globals.MESSAGE_KEY, new ActionMessage(
-					&quot;error.duplicate&quot;));
+			actionMessages.add(Globals.MESSAGE_KEY, new ActionMessage(&quot;error.duplicate&quot;));
 			saveMessages(request, actionMessages);
 			forward = mapping.findForward(FORWARD_FAILURE);
-		} finally
-		{
-			svpBO.closeSession();
+		} 
+		finally{
+			HibernateUtil.closeSession();
 		}
 
 		LOGGER.debug(&quot;exiting&quot;);
-
 		return forward;
 	}
 }

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/action/TriggerPointDeleteAction.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/action/TriggerPointDeleteAction.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/action/TriggerPointDeleteAction.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -46,6 +46,7 @@
 
 import de.fhg.fokus.hss.form.TriggerPointForm;
 import de.fhg.fokus.hss.model.Trigpt;
+import de.fhg.fokus.hss.util.HibernateUtil;
 
 import org.apache.log4j.Logger;
 
@@ -70,9 +71,8 @@
 			.getLogger(TriggerPointDeleteAction.class);
 
 	public ActionForward execute(ActionMapping mapping, ActionForm actionForm,
-			HttpServletRequest request, HttpServletResponse reponse)
-			throws Exception
-	{
+			HttpServletRequest request, HttpServletResponse reponse) throws Exception {
+		
 		LOGGER.debug(&quot;entering&quot;);
 
 		TriggerPointForm form = (TriggerPointForm) actionForm;
@@ -80,45 +80,38 @@
 
 		ActionForward forward = null;
 
-		try
-		{
+		try{
 			Integer primaryKey = form.getPrimaryKey();
 			Trigpt trigpt = null;
 
-			trigpt = (Trigpt) getSession().load(Trigpt.class, primaryKey);
+			HibernateUtil.beginTransaction();
+			trigpt = (Trigpt) HibernateUtil.getCurrentSession().load(Trigpt.class, primaryKey);
 
-			int assignendIfcs = ((Integer) getSession()
-					.createQuery(
-							&quot;select count(ifc) from de.fhg.fokus.hss.model.Ifc ifc where ifc.trigpt.trigptId = ?&quot;)
+			int assignendIfcs = ((Integer) HibernateUtil.getCurrentSession()
+					.createQuery(&quot;select count(ifc) from de.fhg.fokus.hss.model.Ifc ifc where ifc.trigpt.trigptId = ?&quot;)
 					.setInteger(0, primaryKey).uniqueResult()).intValue();
 
-			if (assignendIfcs == 0)
-			{
-				beginnTx();
-				getSession().delete(trigpt);
-				endTx();
+			if (assignendIfcs == 0){
+				HibernateUtil.getCurrentSession().delete(trigpt);
 				forward = mapping.findForward(FORWARD_SUCCESS);
-			} else
-			{
-				ActionMessages actionMessages = new ActionMessages();
 
-				if (assignendIfcs != 0)
-				{
-					actionMessages.add(Globals.MESSAGE_KEY, new ActionMessage(
-							&quot;triggerPoint.error.existIfcs&quot;));
+			} 
+			else{
+				ActionMessages actionMessages = new ActionMessages();
+				if (assignendIfcs != 0){
+					actionMessages.add(Globals.MESSAGE_KEY, new ActionMessage(&quot;triggerPoint.error.existIfcs&quot;));
 				}
-
 				saveMessages(request, actionMessages);
-
 				forward = mapping.findForward(FORWARD_FAILURE);
 			}
-		} finally
-		{
-			closeSession();
+			HibernateUtil.commitTransaction();
+			
+		} 
+		finally{
+			HibernateUtil.closeSession();
 		}
 
 		LOGGER.debug(&quot;exiting&quot;);
-
 		return forward;
 	}
 }

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/action/TriggerPointSearchAction.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/action/TriggerPointSearchAction.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/action/TriggerPointSearchAction.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -54,29 +54,27 @@
 import org.hibernate.Query;
 
 import de.fhg.fokus.hss.form.TriggerPointSearchForm;
+import de.fhg.fokus.hss.util.HibernateUtil;
 
 /**
  * @author Andre Charton (dev -at- open-ims dot org)
  */
 public class TriggerPointSearchAction extends HssAction
 {
-	private static final Logger LOGGER = Logger
-			.getLogger(TriggerPointSearchAction.class);
+	private static final Logger LOGGER = Logger.getLogger(TriggerPointSearchAction.class);
 
 	public ActionForward execute(ActionMapping mapping, ActionForm actionForm,
-			HttpServletRequest request, HttpServletResponse reponse)
-			throws Exception
-	{
+			HttpServletRequest request, HttpServletResponse reponse) throws Exception{
+		
 		LOGGER.debug(&quot;entering&quot;);
 
 		TriggerPointSearchForm form = (TriggerPointSearchForm) actionForm;
 		LOGGER.debug(form);
 
-		try
-		{
+		try{
+			HibernateUtil.beginTransaction();
 			// Prepare Querry
-			Query query = getSession()
-					.createQuery(
+			Query query = HibernateUtil.getCurrentSession().createQuery(
 							&quot;select triggerPoint from de.fhg.fokus.hss.model.Trigpt as triggerPoint where triggerPoint.name like ?&quot;);
 			query.setString(0, &quot;%&quot; + form.getTrigPtName() + &quot;%&quot;);
 
@@ -85,8 +83,7 @@
 			int currentPage = Integer.parseInt(form.getPage()) - 1;
 			int maxPages = (int) ((query.list().size() - 1) / rowPerPage) + 1;
 
-			if (currentPage &gt; maxPages)
-			{
+			if (currentPage &gt; maxPages){
 				currentPage = 0;
 			}
 
@@ -98,17 +95,17 @@
 
 			// store attributes in request
 			request.setAttribute(&quot;result&quot;, query.list());
-
+			HibernateUtil.commitTransaction();
+			
 			request.setAttribute(&quot;maxPages&quot;, String.valueOf(maxPages));
 			request.setAttribute(&quot;currentPage&quot;, String.valueOf(currentPage));
 			request.setAttribute(&quot;rowPerPage&quot;, String.valueOf(rowPerPage));
-		} finally
-		{
-			closeSession();
 		}
+		finally{
+			HibernateUtil.closeSession();
+		}
 
 		LOGGER.debug(&quot;exiting&quot;);
-
 		return mapping.findForward(FORWARD_SUCCESS);
 	}
 }

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/action/TriggerPointShowAction.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/action/TriggerPointShowAction.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/action/TriggerPointShowAction.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -49,6 +49,7 @@
 import de.fhg.fokus.hss.model.Spt;
 import de.fhg.fokus.hss.model.Trigpt;
 import de.fhg.fokus.hss.model.TrigptBO;
+import de.fhg.fokus.hss.util.HibernateUtil;
 
 import org.apache.log4j.Logger;
 
@@ -74,74 +75,68 @@
 			.getLogger(TriggerPointShowAction.class);
 
 	public ActionForward execute(ActionMapping mapping, ActionForm actionForm,
-			HttpServletRequest request, HttpServletResponse reponse)
-			throws Exception
-	{
+			HttpServletRequest request, HttpServletResponse reponse) throws Exception{
+		
 		LOGGER.debug(&quot;entering&quot;);
-
 		TriggerPointForm form = (TriggerPointForm) actionForm;
 		LOGGER.debug(form);
 
-		if (form.getPrimaryKey().intValue() != -1)
-		{
-			// Load the Trigger Point
-			Trigpt trigpt = (Trigpt) getSession().load(Trigpt.class,
-					form.getPrimaryKey(), LockMode.READ);
+		if (form.getPrimaryKey().intValue() != -1){
+			try{
+				HibernateUtil.beginTransaction();
+				// 	Load the Trigger Point
+				Trigpt trigpt = (Trigpt) HibernateUtil.getCurrentSession().load(Trigpt.class, form.getPrimaryKey(), LockMode.READ);
 
-			// Save current Trigger Point Values
-			form.setTrigPtName(trigpt.getName());
-			form.setTrigPtId(String.valueOf(trigpt.getTrigptId().intValue()));
-			form.setCnf(trigpt.getCnf());
+				// Save current Trigger Point Values
+				form.setTrigPtName(trigpt.getName());
+				form.setTrigPtId(String.valueOf(trigpt.getTrigptId().intValue()));
+				form.setCnf(trigpt.getCnf());
 
-			// Save all SPT's
-			form.setSpts(getSpts(trigpt));
-
-			closeSession();
+				// Save all SPT's
+				form.setSpts(getSpts(trigpt));
+				HibernateUtil.commitTransaction();
+			}
+			finally{
+				HibernateUtil.closeSession();
+			}
 		}
 
 		LOGGER.debug(&quot;exiting&quot;);
-
 		return mapping.findForward(FORWARD_SUCCESS);
 	}
 
-	private List getSpts(Trigpt trigpt)
-	{
+	private List getSpts(Trigpt trigpt){
+		
 		ArrayList sptList = new ArrayList();
 		Iterator it = trigpt.getSpts().iterator();
 
-		while (it.hasNext())
-		{
+		while (it.hasNext()){
+			
 			Spt spt = (Spt) it.next();
 			SptForm sptForm = new SptForm();
 
-			switch (spt.getType())
-			{
-			case TrigptBO.TYPE_URI:
-				sptForm.setRequestUri(spt.getReqUri());
+			switch (spt.getType()){
+				case TrigptBO.TYPE_URI:
+					sptForm.setRequestUri(spt.getReqUri());
+					break;
 
-				break;
+				case TrigptBO.TYPE_SIP_METHOD:
+					sptForm.setSipMethod(spt.getSipMethod());
+					break;
 
-			case TrigptBO.TYPE_SIP_METHOD:
-				sptForm.setSipMethod(spt.getSipMethod());
+				case TrigptBO.TYPE_SIP_HEADER:
+					sptForm.setSipHeader(spt.getSipHeader());
+					sptForm.setSipHeaderContent(spt.getSipHeaderContent());
+					break;
 
-				break;
+				case TrigptBO.TYPE_SESSION_CASE:
+					sptForm.setSessionCase(String.valueOf(spt.getSessionCase()));
+					break;
 
-			case TrigptBO.TYPE_SIP_HEADER:
-				sptForm.setSipHeader(spt.getSipHeader());
-				sptForm.setSipHeaderContent(spt.getSipHeaderContent());
-
-				break;
-
-			case TrigptBO.TYPE_SESSION_CASE:
-				sptForm.setSessionCase(String.valueOf(spt.getSessionCase()));
-
-				break;
-
-			case TrigptBO.TYPE_SESSION_DESC:
-				sptForm.setSessionDescContent(spt.getSessionDescContent());
-				sptForm.setSessionDescLine(spt.getSessionDescLine());
-
-				break;
+				case TrigptBO.TYPE_SESSION_DESC:
+					sptForm.setSessionDescContent(spt.getSessionDescContent());
+					sptForm.setSessionDescLine(spt.getSessionDescLine());
+					break;
 			}
 
 			sptForm.setSptId(String.valueOf(spt.getSptId().intValue()));

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/action/TriggerPointShowXMLAction.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/action/TriggerPointShowXMLAction.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/action/TriggerPointShowXMLAction.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -48,6 +48,7 @@
 import de.fhg.fokus.hss.form.TriggerPointForm;
 import de.fhg.fokus.hss.model.CxUserProfil;
 import de.fhg.fokus.hss.model.Trigpt;
+import de.fhg.fokus.hss.util.HibernateUtil;
 
 import org.apache.log4j.Logger;
 
@@ -68,50 +69,55 @@
 /**
  * @author Andre Charton (dev -at- open-ims dot org)
  */
-public class TriggerPointShowXMLAction extends HssAction
-{
-	private static final Logger LOGGER = Logger
-			.getLogger(TriggerPointShowXMLAction.class);
+public class TriggerPointShowXMLAction extends HssAction{
+	
+	private static final Logger LOGGER = Logger.getLogger(TriggerPointShowXMLAction.class);
 
 	public ActionForward execute(ActionMapping mapping, ActionForm actionForm,
-			HttpServletRequest request, HttpServletResponse reponse)
-			throws Exception
-	{
+			HttpServletRequest request, HttpServletResponse reponse) throws Exception{
+		
 		LOGGER.debug(&quot;entering&quot;);
-
 		ActionForward forward = null;
 		TriggerPointForm form = (TriggerPointForm) actionForm;
 		LOGGER.debug(form);
 
-		// Load the Trigger Point
-		Trigpt trigpt = (Trigpt) getSession().load(Trigpt.class,
-				form.getPrimaryKey(), LockMode.READ);
+		TriggerPoint triggerPoint = null;
+		try{
+			HibernateUtil.beginTransaction();
+			// Load the Trigger Point
+			Trigpt trigpt = (Trigpt) HibernateUtil.getCurrentSession().load(Trigpt.class, form.getPrimaryKey(), LockMode.READ);
+			triggerPoint = CxUserProfil.getTriggerPoint(trigpt);
+			HibernateUtil.commitTransaction();
+		}
+		finally{
+			HibernateUtil.closeSession();
+		}
+		
+		if (triggerPoint != null){
+			StringWriter sw = new StringWriter();
+			try{
+				triggerPoint.marshal(sw);
+				forward = mapping.findForward(FORWARD_SUCCESS);
+			}
+			catch (Exception e){
+				LOGGER.warn(this, e);
+				ActionMessages actionMessages = new ActionMessages();
+				actionMessages.add(Globals.MESSAGE_KEY, new ActionMessage(&quot;triggerPoint.error.xml&quot;));
+				saveMessages(request, actionMessages);
+				forward = mapping.findForward(FORWARD_FAILURE);
+			}
 
-		TriggerPoint triggerPoint = CxUserProfil.getTriggerPoint(trigpt);
-		StringWriter sw = new StringWriter();
-
-		try
-		{
-			triggerPoint.marshal(sw);
-			forward = mapping.findForward(FORWARD_SUCCESS);
-		} catch (Exception e)
-		{
-			LOGGER.warn(this, e);
-
+			String xml = sw.getBuffer().toString();
+			request.setAttribute(&quot;triggerPointXML&quot;, xml);
+		}
+		else{
 			ActionMessages actionMessages = new ActionMessages();
-			actionMessages.add(Globals.MESSAGE_KEY, new ActionMessage(
-					&quot;triggerPoint.error.xml&quot;));
+			actionMessages.add(Globals.MESSAGE_KEY, new ActionMessage(&quot;triggerPoint.error.xml&quot;));
 			saveMessages(request, actionMessages);
 			forward = mapping.findForward(FORWARD_FAILURE);
-			forward = mapping.findForward(FORWARD_FAILURE);
 		}
-
-		String xml = sw.getBuffer().toString();
-		request.setAttribute(&quot;triggerPointXML&quot;, xml);
-		closeSession();
-
-		if (LOGGER.isDebugEnabled())
-		{
+		
+		if (LOGGER.isDebugEnabled()){
 			LOGGER.debug(forward);
 			LOGGER.debug(&quot;exiting&quot;);
 		}

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/action/TriggerPointSubmitAction.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/action/TriggerPointSubmitAction.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/action/TriggerPointSubmitAction.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -50,6 +50,7 @@
 import de.fhg.fokus.hss.model.SptBO;
 import de.fhg.fokus.hss.model.Trigpt;
 import de.fhg.fokus.hss.model.TrigptBO;
+import de.fhg.fokus.hss.util.HibernateUtil;
 
 import org.apache.log4j.Logger;
 
@@ -73,15 +74,13 @@
  * 
  * @author Andre Charton (dev -at- open-ims dot org)
  */
-public class TriggerPointSubmitAction extends HssAction
-{
-	private static final Logger LOGGER = Logger
-			.getLogger(TriggerPointSubmitAction.class);
+public class TriggerPointSubmitAction extends HssAction{
+	
+	private static final Logger LOGGER = Logger.getLogger(TriggerPointSubmitAction.class);
 
 	public ActionForward execute(ActionMapping mapping, ActionForm actionForm,
-			HttpServletRequest request, HttpServletResponse reponse)
-			throws Exception
-	{
+			HttpServletRequest request, HttpServletResponse reponse) throws Exception{
+		
 		LOGGER.debug(&quot;entering&quot;);
 
 		ActionForward forward = null;
@@ -91,29 +90,29 @@
 		Integer primaryKey = form.getPrimaryKey();
 		Trigpt trigpt = null;
 
-		try
-		{
-			if (primaryKey.intValue() == -1)
-			{
+		try{
+			HibernateUtil.beginTransaction();
+			if (primaryKey.intValue() == -1){
 				trigpt = createTriggerPoint(form);
 			}
-
-			else
-			{
+			else{
 				trigpt = updateTriggerPoint(form, primaryKey);
 			}
-
+			HibernateUtil.commitTransaction();
+			
 			forward = mapping.findForward(FORWARD_SUCCESS);
-			forward = new ActionForward(forward.getPath() + &quot;?trigPtId=&quot;
-					+ trigpt.getTrigptId(), true);
-		} catch (ConstraintViolationException e)
-		{
+			forward = new ActionForward(forward.getPath() + &quot;?trigPtId=&quot; + trigpt.getTrigptId(), true);
+		}
+		catch (ConstraintViolationException e){
 			ActionMessages actionMessages = new ActionMessages();
 			actionMessages.add(Globals.MESSAGE_KEY, new ActionMessage(
 					&quot;error.duplicate&quot;));
 			saveMessages(request, actionMessages);
 			forward = mapping.findForward(FORWARD_FAILURE);
 		}
+		finally{
+			HibernateUtil.closeSession();
+		}
 
 		LOGGER.debug(&quot;exiting&quot;);
 
@@ -125,41 +124,26 @@
 	 * @return
 	 */
 	private Trigpt createTriggerPoint(TriggerPointForm form)
-			throws ConstraintViolationException
-	{
+			throws ConstraintViolationException{
+		
 		LOGGER.debug(&quot;entering&quot;);
-
 		Trigpt trigpt = null;
 
-		try
-		{
-			// Create a new TriggerPoint
-			openSession();
-			trigpt = new Trigpt();
-			trigpt.setName(form.getTrigPtName());
-			trigpt.setCnf(form.getCnf());
+		// Create a new TriggerPoint
+		trigpt = new Trigpt();
+		trigpt.setName(form.getTrigPtName());
+		trigpt.setCnf(form.getCnf());
 
-			Spt spt = new Spt();
-			spt.setGroupId(0);
-			spt.setType(TrigptBO.TYPE_URI);
-			spt.setTrigpt(trigpt);
-			spt.setNeg(false);
-			beginnTx();
-			getSession().save(trigpt);
-			spt.setTrigpt(trigpt);
-			getSession().save(spt);
-			endTx();
-		} catch (ConstraintViolationException e)
-		{
-			LOGGER.debug(this, e);
-			throw e;
-		} finally
-		{
-			closeSession();
-		}
+		Spt spt = new Spt();
+		spt.setGroupId(0);
+		spt.setType(TrigptBO.TYPE_URI);
+		spt.setTrigpt(trigpt);
+		spt.setNeg(false);
+		HibernateUtil.getCurrentSession().save(trigpt);
+		spt.setTrigpt(trigpt);
+		HibernateUtil.getCurrentSession().save(spt);
 
 		LOGGER.debug(&quot;exiting&quot;);
-
 		return trigpt;
 	}
 
@@ -170,33 +154,22 @@
 	 * @return
 	 */
 	private Trigpt updateTriggerPoint(TriggerPointForm form, Integer primaryKey)
-			throws ConstraintViolationException
-	{
+			throws ConstraintViolationException{
+		
 		LOGGER.debug(&quot;entering&quot;);
 
 		// Update a Trigger Point
 		TrigptBO trigptBO = null;
 		Trigpt trigpt = null;
 
-		try
-		{
-			trigptBO = new TrigptBO();
-			trigpt = trigptBO.load(primaryKey);
-			saveSpts(form, trigpt);
-			trigpt.setName(form.getTrigPtName());
-			trigpt.setCnf(form.getCnf());
-			trigptBO.saveOrUpdate(trigpt);
-		} catch (ConstraintViolationException e)
-		{
-			LOGGER.debug(this, e);
-			throw e;
-		} finally
-		{
-			trigptBO.closeSession();
-		}
+		trigptBO = new TrigptBO();
+		trigpt = trigptBO.load(primaryKey);
+		saveSpts(form, trigpt);
+		trigpt.setName(form.getTrigPtName());
+		trigpt.setCnf(form.getCnf());
+		trigptBO.saveOrUpdate(trigpt);
 
 		LOGGER.debug(&quot;exiting&quot;);
-
 		return trigpt;
 	}
 
@@ -205,57 +178,45 @@
 	 * @param form
 	 * @param trigpt
 	 */
-	private void saveSpts(TriggerPointForm form, Trigpt trigpt)
-	{
+	private void saveSpts(TriggerPointForm form, Trigpt trigpt){
 		Iterator itSptForms = form.getSpts().iterator();
 
-		try
-		{
-			beginnTx();
+		int newGroupId = -1;
+		int formGroupId = -1;
+		Spt spt = null;
+		SptForm sptForm = null;
+		Integer primaryKey = null;
 
-			int newGroupId = -1;
-			int formGroupId = -1;
-			Spt spt = null;
-			SptForm sptForm = null;
-			Integer primaryKey = null;
+		while (itSptForms.hasNext()){
+			sptForm = (SptForm) itSptForms.next();
+			primaryKey = sptForm.getPrimaryKey();
+			spt = (Spt) HibernateUtil.getCurrentSession().load(Spt.class, primaryKey);
+			spt.addPropertyChangeListener(trigpt);
 
-			while (itSptForms.hasNext())
+			if (sptForm.isDelete() == true)
 			{
-				sptForm = (SptForm) itSptForms.next();
-				primaryKey = sptForm.getPrimaryKey();
-				spt = (Spt) getSession().load(Spt.class, primaryKey);
-				spt.addPropertyChangeListener(trigpt);
-
-				if (sptForm.isDelete() == true)
+				if (primaryKey.intValue() != -1)
 				{
-					if (primaryKey.intValue() != -1)
-					{
-						getSession().delete(spt);
-						trigpt.markChanged(true);
-					}
-				} else
+					HibernateUtil.getCurrentSession().delete(spt);
+					trigpt.markChanged(true);
+				}
+			} 
+			else{
+				getSptChoice(sptForm, spt);
+				if (formGroupId != sptForm.getGroup())
 				{
-					getSptChoice(sptForm, spt);
-
-					if (formGroupId != sptForm.getGroup())
-					{
-						formGroupId = sptForm.getGroup();
-						newGroupId++;
-					}
-
-					spt.setGroupId(newGroupId);
-					spt.setNeg(sptForm.isNeg());
-					getSession().saveOrUpdate(spt);
+					formGroupId = sptForm.getGroup();
+					newGroupId++;
 				}
+
+				spt.setGroupId(newGroupId);
+				spt.setNeg(sptForm.isNeg());
+				HibernateUtil.getCurrentSession().saveOrUpdate(spt);
 			}
+		}
 
-			addSpt(form, trigpt);
+		addSpt(form, trigpt);
 
-			endTx();
-		} finally
-		{
-			closeSession();
-		}
 	}
 
 	/**
@@ -263,36 +224,30 @@
 	 * @param sptForm
 	 * @param spt
 	 */
-	private void getSptChoice(SptForm sptForm, Spt spt)
-	{
-		switch (spt.getType())
-		{
-		case TrigptBO.TYPE_URI:
-			spt.setReqUri(sptForm.getRequestUri());
+	private void getSptChoice(SptForm sptForm, Spt spt){
+		switch (spt.getType()){
 
-			break;
+			case TrigptBO.TYPE_URI:
+				spt.setReqUri(sptForm.getRequestUri());
+				break;
 
-		case TrigptBO.TYPE_SIP_METHOD:
-			spt.setSipMethod(sptForm.getSipMethod());
+			case TrigptBO.TYPE_SIP_METHOD:
+				spt.setSipMethod(sptForm.getSipMethod());
+				break;
 
-			break;
+			case TrigptBO.TYPE_SESSION_CASE:
+				spt.setSessionCase(Integer.parseInt(sptForm.getSessionCase()));
+				break;
 
-		case TrigptBO.TYPE_SESSION_CASE:
-			spt.setSessionCase(Integer.parseInt(sptForm.getSessionCase()));
-
+			case TrigptBO.TYPE_SESSION_DESC:
+				spt.setSessionDescLine(sptForm.getSessionDescLine());
+				spt.setSessionDescContent(sptForm.getSessionDescContent());
 			break;
 
-		case TrigptBO.TYPE_SESSION_DESC:
-			spt.setSessionDescLine(sptForm.getSessionDescLine());
-			spt.setSessionDescContent(sptForm.getSessionDescContent());
-
-			break;
-
-		case TrigptBO.TYPE_SIP_HEADER:
-			spt.setSipHeader(sptForm.getSipHeader());
-			spt.setSipHeaderContent(sptForm.getSipHeaderContent());
-
-			break;
+			case TrigptBO.TYPE_SIP_HEADER:
+				spt.setSipHeader(sptForm.getSipHeader());
+				spt.setSipHeaderContent(sptForm.getSipHeaderContent());
+				break;
 		}
 	}
 
@@ -302,48 +257,41 @@
 	 * @param form
 	 * @param trigpt
 	 */
-	private void addSpt(TriggerPointForm form, Trigpt trigpt)
-	{
+	private void addSpt(TriggerPointForm form, Trigpt trigpt){
+
 		// Check for new Selected SPT's
-		if ((form.getGroup() != -1) &amp;&amp; (form.getType() != -1))
-		{
+		if ((form.getGroup() != -1) &amp;&amp; (form.getType() != -1)){
 			Spt spt = new Spt();
 			spt.setGroupId(form.getGroup());
 			spt.setType(form.getType());
 			spt.setTrigpt(trigpt);
 			spt.setNeg(false);
 
-			switch (form.getType())
-			{
-			case TrigptBO.TYPE_URI:
-				spt.setReqUri(&quot;&quot;);
+			switch (form.getType()){
+				case TrigptBO.TYPE_URI:
+					spt.setReqUri(&quot;&quot;);
+					break;
 
-				break;
+				case TrigptBO.TYPE_SESSION_CASE:
+					spt.setSessionCase(0);
+					break;
 
-			case TrigptBO.TYPE_SESSION_CASE:
-				spt.setSessionCase(0);
+				case TrigptBO.TYPE_SESSION_DESC:
+					spt.setSessionDescContent(&quot;&quot;);
+					spt.setSessionDescLine(&quot;&quot;);
+					break;
 
-				break;
+				case TrigptBO.TYPE_SIP_METHOD:
+					spt.setSipMethod(SptBO.SIP_METHOD.INVITE);
+					break;
 
-			case TrigptBO.TYPE_SESSION_DESC:
-				spt.setSessionDescContent(&quot;&quot;);
-				spt.setSessionDescLine(&quot;&quot;);
-
-				break;
-
-			case TrigptBO.TYPE_SIP_METHOD:
-				spt.setSipMethod(SptBO.SIP_METHOD.INVITE);
-
-				break;
-
-			case TrigptBO.TYPE_SIP_HEADER:
-				spt.setSipHeader(&quot;&quot;);
-				spt.setSipHeaderContent(&quot;&quot;);
-
-				break;
+				case TrigptBO.TYPE_SIP_HEADER:
+					spt.setSipHeader(&quot;&quot;);
+					spt.setSipHeaderContent(&quot;&quot;);
+					break;
 			}
 
-			getSession().saveOrUpdate(spt);
+			HibernateUtil.getCurrentSession().saveOrUpdate(spt);
 		}
 	}
 }

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/diam/CommandAction.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/diam/CommandAction.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/diam/CommandAction.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -79,23 +79,16 @@
      * @param serverName
      * @param resolve indicates whether the server name needs to be resolved or not
      */
-    protected void sendMessage(
-        DiameterMessage message, String serverName, boolean resolve)
-    {
-        if (resolve == true)
-        {
+    protected void sendMessage(DiameterMessage message, String serverName, boolean resolve){
+        if (resolve == true){
             serverName = OriginHostResolver.getOriginHost(serverName);
         }
 
-        if (serverName != null)
-        {
+        if (serverName != null){
             HssDiameterStack.diameterPeer.sendMessage(serverName, message);
         }
-        else
-        {
-            LOGGER.error(
-                &quot;HSS has tryed to send PPR to unknown Origin Host: &quot;
-                + serverName);
+        else{
+            LOGGER.error(&quot;HSS tryed to send PPR to unknown host: &quot; + serverName);
         }
     }
 

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/diam/CommandListener.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/diam/CommandListener.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/diam/CommandListener.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -81,14 +81,14 @@
 
    
     /**
-     * Extract result code from repsonse and generate resultcode AVP as an base
-     * or grouped experimental avp.
+     * Generates Result Code AVP for the specified resultCode. If the boolean flag is true a final response is generated, otherwise
+     * an Experimental Result is created.
      * 
      * @param resultCode expected result codecontained in response 
      * @param isBase it indicates either a base or grouped experimental avp
      * @return result code avp.
      */
-    protected AVP saveResultCode(int resultCode, boolean isBase){
+    protected AVP getResultCodeAVP(int resultCode, boolean isBase){
         AVP resultCodeAVP;
 
         if (isBase){

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/diam/Constants.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/diam/Constants.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/diam/Constants.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -88,7 +88,7 @@
 package de.fhg.fokus.hss.diam;
 
 /**
- * It contains constant values like Application types, Vendor types and AVP Codes
+ * It contains all the possible values for Application, Vendor, Command Code, AVP Code, Authentication Scheme
  *
  * @author Andre Charton (dev -at- open-ims dot org)
  */
@@ -228,4 +228,11 @@
     	
     }
     
+    public class AuthScheme{
+    	public static final String AUTH_SCHEME_AKAv1 = &quot;Digest-AKAv1-MD5&quot;;
+    	public static final String AUTH_SCHEME_AKAv2 = &quot;Digest-AKAv2-MD5&quot;;
+    	public static final String AUTH_SCHEME_MD5 = &quot;Digest-MD5&quot;;
+    	public static final String AUTH_SCHEME_EARLY = &quot;Early IMS&quot;;		
+    	public static final String AUTH_SCHEME_ANY = &quot;any&quot;;
+    }
 }

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/diam/OriginHostResolver.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/diam/OriginHostResolver.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/diam/OriginHostResolver.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -84,9 +84,8 @@
         int size = 0;
         hosts = new TreeMap();
 
-        Session session = HibernateUtil.currentSession();
-        Iterator it =
-            session.createCriteria(DiamServer.class).list().iterator();
+        Session session = HibernateUtil.getCurrentSession();
+        Iterator it = session.createCriteria(DiamServer.class).list().iterator();
         
         while (it.hasNext())
         {
@@ -128,7 +127,7 @@
         {
             // Create a new resolver entry
             hosts.put(serverName, originHost);
-            Session session = HibernateUtil.currentSession();
+            Session session = HibernateUtil.getCurrentSession();
             Transaction tx = session.beginTransaction();
             DiamServer diamServer = new DiamServer();
             diamServer.setServer(serverName);
@@ -147,7 +146,7 @@
                 // Update a resolver entry
                 hosts.put(serverName, originHost);
 
-                Session session = HibernateUtil.currentSession();
+                Session session = HibernateUtil.getCurrentSession();
                 Transaction tx = session.beginTransaction();
                 DiamServer diamServer =
                     (DiamServer) session.load(DiamServer.class, serverName);

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/diam/ResultCode.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/diam/ResultCode.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/diam/ResultCode.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -55,11 +55,8 @@
 	public static final int _DIAMETER_MULTI_ROUND_AUTH=0;
 	public static final int _DIAMETER_SUCCESS=2001;
 	public static final int _DIAMETER_SUBSEQUENT_REGISTRATION = 2002;
-	
 	public static final int _DIAMETER_AUTHORIZATION_REJECTED = 5003;
 	public static final int _DIAMETER_ERROR_IDENTITY_NOT_REGISTERED = 5003;
-	
-
 	public static final int _DIAMETER_UNABLE_TO_COMPLY=5012;
 
 

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/diam/cx/CxCommandListener.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/diam/cx/CxCommandListener.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/diam/cx/CxCommandListener.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -182,11 +182,9 @@
         DiameterException diameterException){
     	
         try{
-            if ((diameterPeer != null) &amp;&amp; (FQDN != null)
-                    &amp;&amp; (requestMessage != null)){
-            	
+            if ((diameterPeer != null) &amp;&amp; (FQDN != null) &amp;&amp; (requestMessage != null)){
                 DiameterMessage msg = diameterPeer.newResponse(requestMessage);
-                AVP resultAVP = saveResultCode( diameterException.getCode(),(diameterException instanceof DiameterBaseException));
+                AVP resultAVP = getResultCodeAVP( diameterException.getCode(),(diameterException instanceof DiameterBaseException));
                 msg.addAVP(resultAVP);
                 diameterPeer.sendMessage(FQDN, msg);
             }

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/diam/cx/LIRCommandListener.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/diam/cx/LIRCommandListener.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/diam/cx/LIRCommandListener.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -99,8 +99,7 @@
         if (requestMessage.commandCode == COMMAND_ID){
             counter++;
             try{
-                PublicIdentity publicIdentity =
-                    loadPublicIdentity(requestMessage);
+                PublicIdentity publicIdentity = loadPublicIdentity(requestMessage);
 
                 CxLocationQueryResponse response = null;
                 AVP resultCode = null;
@@ -110,27 +109,29 @@
                     throw new UnableToComply();
                 }
 
-                DiameterMessage responseMessage =
-                    diameterPeer.newResponse(requestMessage);
+                DiameterMessage responseMessage = diameterPeer.newResponse(requestMessage);
 
                  // Add assigned Server Name
                 AVP assginedSCSCFName = new AVP(Constants.AVPCode.CX_SERVER_NAME, true, Constants.Vendor.V3GPP);
                 assginedSCSCFName.setData(response.getAssignedSCSCFName());
                 responseMessage.addAVP(assginedSCSCFName);
-                    
-                AVP vendorSpecificApplicationID = new AVP(Constants.AVPCode.VENDOR_SPECIFIC_APPLICATION_ID, true, Constants.Vendor.V3GPP);
+                
+                /* vendor-specific app id */
+                AVP vendorSpecificApplicationID = new AVP(Constants.AVPCode.VENDOR_SPECIFIC_APPLICATION_ID, true, Constants.Vendor.DIAM);
                 AVP vendorID = new AVP(Constants.AVPCode.VENDOR_ID, true, Constants.Vendor.DIAM);
+                vendorID.setData(Constants.Vendor.V3GPP);
                 vendorSpecificApplicationID.addChildAVP(vendorID);
-                
-                AVP applicationID = new AVP(Constants.AVPCode.AUTH_APPLICATION_ID, true,  Constants.Vendor.V3GPP);
+                AVP applicationID = new AVP(Constants.AVPCode.AUTH_APPLICATION_ID, true,  Constants.Vendor.DIAM);
+                applicationID.setData(Constants.Application.CX);
                 vendorSpecificApplicationID.addChildAVP(applicationID);
                 responseMessage.addAVP(vendorSpecificApplicationID);
-                    
-                AVP authenticationSessionState = new AVP(Constants.AVPCode.AUTH_SESSION_STATE, true, Constants.Vendor.V3GPP);
+
+                /* auth-session-state, no state maintained */
+                AVP authenticationSessionState = new AVP(Constants.AVPCode.AUTH_SESSION_STATE, true, Constants.Vendor.DIAM);
                 authenticationSessionState.setData(1);
                 responseMessage.addAVP(authenticationSessionState);
                 
-                resultCode = saveResultCode(response.getResultCode(), response.resultCodeIsBase());
+                resultCode = getResultCodeAVP(response.getResultCode(), response.resultCodeIsBase());
                 responseMessage.addAVP(resultCode);
 
                 diameterPeer.sendMessage(FQDN, responseMessage);

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/diam/cx/MARCommandListener.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/diam/cx/MARCommandListener.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/diam/cx/MARCommandListener.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -108,18 +108,14 @@
                 AVP resultCode = null;
                 PublicIdentity publicIdentity = loadPublicIdentity(requestMessage);
                     
-                LOGGER.info(&quot;MAR of User: &quot;+ publicIdentity.getIdentity() + 
-                           &quot; is being processed&quot;);      
+                LOGGER.info(&quot;MAR of User: &quot;+ publicIdentity.getIdentity() + &quot; is being processed&quot;);      
                     
                 URI privateUserIdentity = loadPrivateUserIdentity(requestMessage);
                 Long numberOfAuthVectors = loadNumberOfAuthVectors(requestMessage);
                 AuthenticationVector authenticationVector = loadAuthVector(requestMessage);
 
-                String scscfName =
-                    new String(avpLookUp(requestMessage, Constants.AVPCode.CX_SERVER_NAME, true, Constants.Vendor.V3GPP).data);
-
+                String scscfName = new String(avpLookUp(requestMessage, Constants.AVPCode.CX_SERVER_NAME, true, Constants.Vendor.V3GPP).data);
                 CxAuthDataResponse authDataResponse = null;
-                
                 authDataResponse = operations.cxAuthData(publicIdentity, privateUserIdentity, numberOfAuthVectors, authenticationVector, scscfName);
                 
                 if (authDataResponse == null){
@@ -127,14 +123,30 @@
                 }
 
                 DiameterMessage responseMessage = diameterPeer.newResponse(requestMessage);
+                
+        		/* vendor-specific app id */
+                AVP vendorSpecificApplicationID = new AVP(Constants.AVPCode.VENDOR_SPECIFIC_APPLICATION_ID, true, Constants.Vendor.DIAM);
+                AVP vendorID = new AVP(Constants.AVPCode.VENDOR_ID, true, Constants.Vendor.DIAM);
+                vendorID.setData(Constants.Vendor.V3GPP);
+                vendorSpecificApplicationID.addChildAVP(vendorID);
+                AVP applicationID = new AVP(Constants.AVPCode.AUTH_APPLICATION_ID, true,  Constants.Vendor.DIAM);
+                applicationID.setData(Constants.Application.CX);
+                vendorSpecificApplicationID.addChildAVP(applicationID);
+                responseMessage.addAVP(vendorSpecificApplicationID);
+        		
+        		/* auth-session-state, no state maintained */
+                AVP authenticationSessionState = new AVP(Constants.AVPCode.AUTH_SESSION_STATE, true, Constants.Vendor.DIAM);
+                authenticationSessionState.setData(1);
+                responseMessage.addAVP(authenticationSessionState);
+                
+                /* add authentication data items */
                 saveAuthData(authDataResponse, responseMessage);
 
-                // Add result code
-                resultCode = saveResultCode(authDataResponse.getResultCode(), authDataResponse.resultCodeIsBase());
-
+                /* Add the result code */
+                resultCode = getResultCodeAVP(authDataResponse.getResultCode(), authDataResponse.resultCodeIsBase());
                 responseMessage.addAVP(resultCode);
+                
                 diameterPeer.sendMessage(FQDN, responseMessage);
-                System.out.println(&quot;MAR finished!&quot;);
             }
             catch (DiameterException e){
                 LOGGER.warn(this, e);
@@ -247,11 +259,16 @@
 		}
 
         AVP sipAuthorization = authVectorAVP.findChildAVP(Constants.AVPCode.SIP_AUTHORIZATION, true, Vendor.V3GPP);
+        AVP sipAuthScheme = authVectorAVP.findChildAVP(Constants.AVPCode.SIP_AUTHENTICATION_SCHEME, true, Vendor.V3GPP);
 
+        authenticationVector = new AuthenticationVector();
         if (sipAuthorization != null){
-            authenticationVector = new AuthenticationVector(sipAuthorization.data);
+            authenticationVector.sipAuthorization = sipAuthorization.data;
         }
-
+        if (sipAuthScheme != null){
+        	authenticationVector.authenticationScheme = new String(sipAuthScheme.getData());
+        }
+        	
         return authenticationVector;
     }
 }

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/diam/cx/PPRCommandAction.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/diam/cx/PPRCommandAction.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/diam/cx/PPRCommandAction.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -152,19 +152,20 @@
     		message.addAVP(a);
 
     		/* vendor-specific app id */
-    		a = new AVP(260,true,0);
-    		b = new AVP(266,true,0);
-    		b.setData(10415);
-    		a.addChildAVP(b);
-    		b = new AVP(258,true,0);
-    		b.setData(16777216);
-    		a.addChildAVP(b);
-    		message.addAVP(a);            
+            AVP vendorSpecificApplicationID = new AVP(Constants.AVPCode.VENDOR_SPECIFIC_APPLICATION_ID, true, Constants.Vendor.DIAM);
+            AVP vendorID = new AVP(Constants.AVPCode.VENDOR_ID, true, Constants.Vendor.DIAM);
+            vendorID.setData(Constants.Vendor.V3GPP);
+            vendorSpecificApplicationID.addChildAVP(vendorID);
+            AVP applicationID = new AVP(Constants.AVPCode.AUTH_APPLICATION_ID, true,  Constants.Vendor.DIAM);
+            applicationID.setData(Constants.Application.CX);
+            vendorSpecificApplicationID.addChildAVP(applicationID);
+            message.addAVP(vendorSpecificApplicationID);
     		
-    		/* auth-session-state, no session maintained */
-    		a = new AVP(277,true,0);
-    		a.setData(1);
-    		message.addAVP(a);
+    		
+    		/* auth-session-state, no state maintained */
+            AVP authenticationSessionState = new AVP(Constants.AVPCode.AUTH_SESSION_STATE, true, Constants.Vendor.DIAM);
+            authenticationSessionState.setData(1);
+            message.addAVP(authenticationSessionState);
 
     		/* destionation host and realm */
             AVP destHostAVP = new AVP(Constants.AVPCode.DESTINATION_HOST, true, Constants.Vendor.DIAM);

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/diam/cx/RTRCommandAction.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/diam/cx/RTRCommandAction.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/diam/cx/RTRCommandAction.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -140,19 +140,19 @@
     		message.addAVP(a);
 
     		/* vendor-specific app id */
-    		a = new AVP(260,true,0);
-    		b = new AVP(266,true,0);
-    		b.setData(10415);
-    		a.addChildAVP(b);
-    		b = new AVP(258,true,0);
-    		b.setData(16777216);
-    		a.addChildAVP(b);
-    		message.addAVP(a);            
+            AVP vendorSpecificApplicationID = new AVP(Constants.AVPCode.VENDOR_SPECIFIC_APPLICATION_ID, true, Constants.Vendor.DIAM);
+            AVP vendorID = new AVP(Constants.AVPCode.VENDOR_ID, true, Constants.Vendor.DIAM);
+            vendorID.setData(Constants.Vendor.V3GPP);
+            vendorSpecificApplicationID.addChildAVP(vendorID);
+            AVP applicationID = new AVP(Constants.AVPCode.AUTH_APPLICATION_ID, true,  Constants.Vendor.DIAM);
+            applicationID.setData(Constants.Application.CX);
+            vendorSpecificApplicationID.addChildAVP(applicationID);
+            message.addAVP(vendorSpecificApplicationID);
     		
-    		/* auth-session-state, no session maintained */
-    		a = new AVP(277,true,0);
-    		a.setData(1);
-    		message.addAVP(a);
+    		/* auth-session-state, no state maintained */
+            AVP authenticationSessionState = new AVP(Constants.AVPCode.AUTH_SESSION_STATE, true, Constants.Vendor.DIAM);
+            authenticationSessionState.setData(1);
+            message.addAVP(authenticationSessionState);
 
     		/* destionation host and realm */
             AVP destHostAVP = new AVP(Constants.AVPCode.DESTINATION_HOST, true, Constants.Vendor.DIAM);
@@ -174,7 +174,7 @@
                 message.addAVP(publicIdAVP);
             }
 
-
+            /* Deregistration reason */
             AVP deregAVP = new AVP(Constants.AVPCode.DEREGISTRATION_REASON, true, Constants.Vendor.V3GPP);
             AVP deregCode = new AVP(Constants.AVPCode.REASON_CODE, true, Constants.Vendor.V3GPP);
             deregCode.setData(deregistrationReason.getDeregistrationCode());

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/diam/cx/SARCommandListener.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/diam/cx/SARCommandListener.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/diam/cx/SARCommandListener.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -78,8 +78,7 @@
     /** counter */
     public static long counter = 0;
     /** logger */
-    private static final Logger LOGGER =
-        Logger.getLogger(SARCommandListener.class);
+    private static final Logger LOGGER = Logger.getLogger(SARCommandListener.class);
     /** the command id for SAR */     
     private static final int COMMAND_ID = Constants.Command.SAR;
     /** an object representing the Cx operations for HSS*/
@@ -90,9 +89,7 @@
      * @param _operations HssCxOpeation
      * @param _diameterPeer diameterPeer
      */ 
-    public SARCommandListener(
-        HSScxOperations _operations, DiameterPeer _diameterPeer)
-    {
+    public SARCommandListener(HSScxOperations _operations, DiameterPeer _diameterPeer){
         super(_diameterPeer);
         this.operations = _operations;
     }
@@ -105,33 +102,25 @@
      * @param requestMessage the diameter message
      * @see de.fhg.fokus.diameter.DiameterPeer.EventListener#recvMessage(java.lang.String, de.fhg.fokus.diameter.DiameterPeer.data.DiameterMessage) 
      */
-    public void recvMessage(String FQDN, DiameterMessage requestMessage)
-    {
-        if (requestMessage.commandCode == COMMAND_ID)
-        {
+    public void recvMessage(String FQDN, DiameterMessage requestMessage){
+        if (requestMessage.commandCode == COMMAND_ID){
             counter++;
             LOGGER.debug(&quot;entering&quot;);
             LOGGER.debug(FQDN);
 
-            try
-            {                
-                PublicIdentity publicIdentity =
-                    loadPublicIdentity(requestMessage);
+            try{                
+                PublicIdentity publicIdentity = loadPublicIdentity(requestMessage);
                 LOGGER.info(&quot;SAR of User: &quot;+ publicIdentity.getIdentity() + &quot; is being processed&quot;);                    
                 URI privateUserIdentity;
 
-                try
-                {
-                    privateUserIdentity =
-                        loadPrivateUserIdentity(requestMessage);
+                try{
+                    privateUserIdentity = loadPrivateUserIdentity(requestMessage);
                 }
-                catch (MissingAVP e)
-                {
+                catch (MissingAVP e){
                     privateUserIdentity = null;
                 }
 
                 String scscfName = loadServerName(requestMessage);
-
                 int serverAssignmentType = avpLookUp(requestMessage, Constants.AVPCode.SERVER_ASSIGNMENT_TYPE, true,
                         Constants.Vendor.V3GPP).int_data;
 
@@ -140,11 +129,9 @@
                 int userDataAlreadyAvailable = avpLookUp(requestMessage, Constants.AVPCode.USER_DATA_ALREADY_AVAILABLE,
                         true, Constants.Vendor.V3GPP).int_data;
                 CxSCSCFNotificationResponse response = null;
-                AVP resultCode = null;
 
-                response = operations.cxPull(
-                        publicIdentity, scscfName, privateUserIdentity,
-                        serverAssignmentType, userDataRequestType,
+
+                response = operations.cxPull(publicIdentity, scscfName, privateUserIdentity, serverAssignmentType, userDataRequestType,
                         userDataAlreadyAvailable);
 
                 if (response == null){
@@ -152,36 +139,41 @@
                 }
 
                 DiameterMessage responseMessage = diameterPeer.newResponse(requestMessage);
+                
+        		/* vendor-specific app id */
+                AVP vendorSpecificApplicationID = new AVP(Constants.AVPCode.VENDOR_SPECIFIC_APPLICATION_ID, true, Constants.Vendor.DIAM);
+                AVP vendorID = new AVP(Constants.AVPCode.VENDOR_ID, true, Constants.Vendor.DIAM);
+                vendorID.setData(Constants.Vendor.V3GPP);
+                vendorSpecificApplicationID.addChildAVP(vendorID);
+                AVP applicationID = new AVP(Constants.AVPCode.AUTH_APPLICATION_ID, true,  Constants.Vendor.DIAM);
+                applicationID.setData(Constants.Application.CX);
+                vendorSpecificApplicationID.addChildAVP(applicationID);
+                responseMessage.addAVP(vendorSpecificApplicationID);
+        		
+        		/* auth-session-state, no state maintained */
+                AVP authenticationSessionState = new AVP(Constants.AVPCode.AUTH_SESSION_STATE, true, Constants.Vendor.DIAM);
+                authenticationSessionState.setData(1);
+                responseMessage.addAVP(authenticationSessionState);
+                
+                AVP resultCode = null;
+                if (response.getUserProfile() != null){
+                	saveIMSSubscription(response.getUserProfile(), responseMessage);
+                	saveChargingInfoSet(response.getChargingInfoSet(), responseMessage);
 
-                if (resultCode == null)
-                {
-                    if (response.getUserProfile() != null)
-                    {
-                        saveIMSSubscription(
-                            response.getUserProfile(), responseMessage);
-                        saveChargingInfoSet(
-                            response.getChargingInfoSet(), responseMessage);
-                    }
-
-                    // Add result code
-                    resultCode =
-                        saveResultCode(
-                            response.getResultCode(),
-                            response.resultCodeIsBase());
                 }
 
+                // Generate the result code AVP and add it to the responseMessage
+                resultCode = getResultCodeAVP(response.getResultCode(), response.resultCodeIsBase());
                 responseMessage.addAVP(resultCode);
 
                 diameterPeer.sendMessage(FQDN, responseMessage);
                 LOGGER.debug(&quot;exiting&quot;);
             }
-            catch (DiameterException e)
-            {
+            catch (DiameterException e){
                 LOGGER.warn(this, e);
                 sendDiameterException(FQDN, requestMessage, e);
             }
-            catch (Exception e)
-            {
+            catch (Exception e){
                 LOGGER.error(this, e);
                 sendUnableToComply(FQDN, requestMessage);
             }
@@ -195,10 +187,9 @@
      * @throws MarshalException
      * @throws ValidationException
      */
-    public static void saveIMSSubscription(
-        IMSSubscription subscription, DiameterMessage responseMessage)
-        throws MarshalException, ValidationException
-    {
+    public static void saveIMSSubscription(IMSSubscription subscription, DiameterMessage responseMessage) 
+    	throws MarshalException, ValidationException {
+    	
         AVP userProfileAVP = new AVP(Constants.AVPCode.CX_USER_DATA, true, Constants.Vendor.V3GPP);
         StringWriter sw = new StringWriter();
         subscription.marshal(sw);
@@ -211,9 +202,8 @@
      * @param chargingInfoSet
      * @param responseMessage
      */
-    public static void saveChargingInfoSet(
-        ChargingInfoSet chargingInfoSet, DiameterMessage responseMessage)
-    {
+    public static void saveChargingInfoSet(ChargingInfoSet chargingInfoSet, DiameterMessage responseMessage){
+    	
         AVP chargingInfoAVP = new AVP(Constants.AVPCode.CHARGING_INFO, true, Constants.Vendor.V3GPP);
         AVP fnNameAVP = null;
 

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/diam/cx/UARCommandListener.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/diam/cx/UARCommandListener.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/diam/cx/UARCommandListener.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -136,25 +136,32 @@
 
                 DiameterMessage responseMessage = diameterPeer.newResponse(requestMessage);
 
-                if (resultCode == null){
-                	//add  Session Id from Request
-                	AVP sessionIdAVP = requestMessage.getAVP(0);
-                	responseMessage.addAVP(sessionIdAVP);
-                	
-                	AVP vsAVP = null;
-                	
-                    // Add assigned Server Name
-                    if ( (response.getAssignedSCSCFName() != null) &amp;&amp; (response.getAssignedSCSCFName().length() &gt; 0)){
-                        AVP assginedSCSCFName = new AVP(Constants.AVPCode.CX_SERVER_NAME, true, Constants.Vendor.V3GPP);
-                        assginedSCSCFName.setData(response.getAssignedSCSCFName());
-                        responseMessage.addAVP(assginedSCSCFName);
-                    }
-
-                    // Add result code
-                    resultCode = saveResultCode(response.getResultCode(), response.resultCodeIsBase());
+        		/* vendor-specific app id */
+                AVP vendorSpecificApplicationID = new AVP(Constants.AVPCode.VENDOR_SPECIFIC_APPLICATION_ID, true, Constants.Vendor.DIAM);
+                AVP vendorID = new AVP(Constants.AVPCode.VENDOR_ID, true, Constants.Vendor.DIAM);
+                vendorID.setData(Constants.Vendor.V3GPP);
+                vendorSpecificApplicationID.addChildAVP(vendorID);
+                AVP applicationID = new AVP(Constants.AVPCode.AUTH_APPLICATION_ID, true,  Constants.Vendor.DIAM);
+                applicationID.setData(Constants.Application.CX);
+                vendorSpecificApplicationID.addChildAVP(applicationID);
+                responseMessage.addAVP(vendorSpecificApplicationID);
+        		
+        		/* auth-session-state, no state maintained */
+                AVP authenticationSessionState = new AVP(Constants.AVPCode.AUTH_SESSION_STATE, true, Constants.Vendor.DIAM);
+                authenticationSessionState.setData(1);
+                responseMessage.addAVP(authenticationSessionState);
+                
+                // Add assigned Server Name
+                if ( (response.getAssignedSCSCFName() != null) &amp;&amp; (response.getAssignedSCSCFName().length() &gt; 0)){
+                	AVP assginedSCSCFName = new AVP(Constants.AVPCode.CX_SERVER_NAME, true, Constants.Vendor.V3GPP);
+                    assginedSCSCFName.setData(response.getAssignedSCSCFName());
+                    responseMessage.addAVP(assginedSCSCFName);
                 }
 
+                // Add result code
+                resultCode = getResultCodeAVP(response.getResultCode(), response.resultCodeIsBase());
                 responseMessage.addAVP(resultCode);
+                
                 diameterPeer.sendMessage(FQDN, responseMessage);
                 LOGGER.debug(&quot;exiting&quot;);
             }

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/diam/sh/PNRCommandAction.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/diam/sh/PNRCommandAction.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/diam/sh/PNRCommandAction.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -126,19 +126,41 @@
         try{
             message = HssDiameterStack.diameterPeer.newRequest(Constants.Command.PNR, Application.SH);
 
+    		/* session-id */
+    		AVP sessionID = new AVP(263,true,0);
+    		sessionID.setData(asAddress + publicIdentity.getPath() + &quot;;11271298949;&quot; + System.currentTimeMillis());
+    		message.addAVP(sessionID);
+            
+    		/* add Vendor-Specific app id */
+            AVP vendorSpecificApplicationID = new AVP(Constants.AVPCode.VENDOR_SPECIFIC_APPLICATION_ID, true, Constants.Vendor.DIAM);
+            AVP vendorID = new AVP(Constants.AVPCode.VENDOR_ID, true, Constants.Vendor.DIAM);
+            vendorID.setData(Constants.Vendor.V3GPP);
+            vendorSpecificApplicationID.addChildAVP(vendorID);
+            AVP applicationID = new AVP(Constants.AVPCode.AUTH_APPLICATION_ID, true,  Constants.Vendor.DIAM);
+            applicationID.setData(Constants.Application.SH);
+            vendorSpecificApplicationID.addChildAVP(applicationID);
+            message.addAVP(vendorSpecificApplicationID);
+    		
+    		/* add Auth-Session-State, no state maintained */
+            AVP authenticationSessionState = new AVP(Constants.AVPCode.AUTH_SESSION_STATE, true, Constants.Vendor.DIAM);
+            authenticationSessionState.setData(1);
+            message.addAVP(authenticationSessionState);
+
+            
+            /* add User-Identity */
+            AVP userIdentityAVP = new AVP(Constants.AVPCode.SH_USER_IDENTITY, true, Constants.Vendor.V3GPP);
+            AVP publicIdentityAVP = new AVP(Constants.AVPCode.SH_PUBLIC_IDENTITY, true, Constants.Vendor.V3GPP);
+            publicIdentityAVP.setData((publicIdentity.toString()).trim());
+            userIdentityAVP.addChildAVP(publicIdentityAVP);
+            message.addAVP(userIdentityAVP);
+            
+            /* add User-Data */
             AVP userDataAVP = new AVP(Constants.AVPCode.SH_USER_DATA, true, Constants.Vendor.V3GPP);
             StringWriter sw = new StringWriter();
             shData.marshal(sw);
             userDataAVP.setData(sw.getBuffer().toString());
             message.addAVP(userDataAVP);
             
-            AVP userIdentityAVP = new AVP(Constants.AVPCode.SH_USER_IDENTITY, true, Constants.Vendor.V3GPP);
-            AVP publicIdentityAVP = new AVP(Constants.AVPCode.SH_PUBLIC_IDENTITY, true, Constants.Vendor.V3GPP);
-            
-            publicIdentityAVP.setData(publicIdentity.getPath());
-            //publicIdentityAVP.setData((publicIdentity.toString()).trim());
-            userIdentityAVP.addChildAVP(publicIdentityAVP);
-            message.addAVP(userIdentityAVP);
             sendMessage(message, asAddress, false);
         }
         catch (Exception e){

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/diam/sh/PURCommandListener.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/diam/sh/PURCommandListener.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/diam/sh/PURCommandListener.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -111,24 +111,29 @@
                AVP shDataAVP = avpLookUp(requestMessage, Constants.AVPCode.SH_USER_DATA, true, Vendor.V3GPP);
                String shDataString = new String(shDataAVP.data);               
                ShData shData = (ShData) ShData.unmarshal(new StringReader(shDataString));
+               
                operations.shUpdate(publicIdentity, shData, applicationServerIdentity, requestedData);
 
+               // create the responseMessage
                DiameterMessage responseMessage = diameterPeer.newResponse(requestMessage);
+               
+               /* add Vendor-Specific app id */
                AVP vendorSpecificApplicationID = new AVP(Constants.AVPCode.VENDOR_SPECIFIC_APPLICATION_ID, true, 
-               		Constants.Vendor.DIAM);
+            		   Constants.Vendor.DIAM);
                AVP vendorID = new AVP(Constants.AVPCode.VENDOR_ID, true, Constants.Vendor.DIAM);
                vendorID.setData(Constants.Vendor.V3GPP);
                vendorSpecificApplicationID.addChildAVP(vendorID);
-               
                AVP applicationID = new AVP(Constants.AVPCode.AUTH_APPLICATION_ID, true,  Constants.Vendor.DIAM);
                applicationID.setData(Constants.Application.SH);
                vendorSpecificApplicationID.addChildAVP(applicationID);
                responseMessage.addAVP(vendorSpecificApplicationID);
                
+               /* add Auth-Session-State, no state maintained */
                AVP authSessionState = new AVP(Constants.AVPCode.AUTH_SESSION_STATE, true, Constants.Vendor.DIAM);
                authSessionState.setData(1);
                responseMessage.addAVP(authSessionState);
                
+               /* add result code */
                AVP resultCode = new AVP (Constants.AVPCode.RESULT_CODE, true, Constants.Vendor.DIAM);
                resultCode.setData(ResultCode._DIAMETER_SUCCESS);
                responseMessage.addAVP(resultCode);

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/diam/sh/SNRCommandListener.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/diam/sh/SNRCommandListener.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/diam/sh/SNRCommandListener.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -128,8 +128,7 @@
 
                 if (asNameAVP != null){
                     applicationServerName = new URI(new String(asNameAVP.data));
-	                OriginHostResolver.setOriginHost(
-	                    applicationServerName.getPath(), applicationServerIdentity);
+	                OriginHostResolver.setOriginHost(applicationServerName.getPath(), applicationServerIdentity);
                 }
                 
                 byte[] serviceIndication = null;
@@ -140,15 +139,32 @@
                     serviceIndication = svcIndAVP.data;
                 }
 
-                // Do HSS Bussiness
-                operations.shSubsNotif(publicIdentity, requestedData, subscriptionRequestType,
-                    serviceIndication, applicationServerIdentity, applicationServerName);
+                
+                operations.shSubsNotif(publicIdentity, requestedData, subscriptionRequestType, 
+                		serviceIndication, applicationServerIdentity, applicationServerName);
 
-                // Answer with a DIAMETER_SUCCESS, error cases will be handled
-                // by the exception handlers.
-                DiameterMessage responseMessage =
-                    diameterPeer.newResponse(requestMessage);
+                // Answer with a DIAMETER_SUCCESS, error cases will be handled by the exception handlers
 
+                // create the responseMessage
+                DiameterMessage responseMessage = diameterPeer.newResponse(requestMessage);
+
+                /* add Vendor-Specific app id */
+                AVP vendorSpecificApplicationID = new AVP(Constants.AVPCode.VENDOR_SPECIFIC_APPLICATION_ID, true, 
+             		   Constants.Vendor.DIAM);
+                AVP vendorID = new AVP(Constants.AVPCode.VENDOR_ID, true, Constants.Vendor.DIAM);
+                vendorID.setData(Constants.Vendor.V3GPP);
+                vendorSpecificApplicationID.addChildAVP(vendorID);
+                AVP applicationID = new AVP(Constants.AVPCode.AUTH_APPLICATION_ID, true,  Constants.Vendor.DIAM);
+                applicationID.setData(Constants.Application.SH);
+                vendorSpecificApplicationID.addChildAVP(applicationID);
+                responseMessage.addAVP(vendorSpecificApplicationID);
+                
+                /* add Auth-Session-State, no state maintained */
+                AVP authSessionState = new AVP(Constants.AVPCode.AUTH_SESSION_STATE, true, Constants.Vendor.DIAM);
+                authSessionState.setData(1);
+                responseMessage.addAVP(authSessionState);
+                
+                /* add Result Code */
                 AVP responseCode = new AVP(Constants.AVPCode.RESULT_CODE, true, Constants.Vendor.DIAM);
                 responseCode.setData(ResultCode._DIAMETER_SUCCESS);
                 responseMessage.addAVP(responseCode);

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/diam/sh/ShCommandListener.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/diam/sh/ShCommandListener.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/diam/sh/ShCommandListener.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -176,8 +176,7 @@
                 authSessionState.setData(1);
                 responseMessage.addAVP(authSessionState);
                 
-                AVP resultAVP = saveResultCode((int) diameterException.getCode(),
-                        (diameterException instanceof DiameterBaseException));
+                AVP resultAVP = getResultCodeAVP((int) diameterException.getCode(), (diameterException instanceof DiameterBaseException));
                 
                 responseMessage.addAVP(resultAVP);
                 diameterPeer.sendMessage(FQDN, responseMessage);

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/diam/sh/UDRCommandListener.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/diam/sh/UDRCommandListener.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/diam/sh/UDRCommandListener.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -73,11 +73,8 @@
 public class UDRCommandListener extends ShCommandListener{
     
 	/** logger */
-    private static final Logger LOGGER =
-        Logger.getLogger(UDRCommandListener.class);
-    /**
-     * Counter to count calls.
-     */
+    private static final Logger LOGGER = Logger.getLogger(UDRCommandListener.class);
+    /** Counter to count calls.*/
     public static long counter = 0;
     /** the command id for UDR */
     private static final int COMMAND_ID = Constants.Command.UDR;
@@ -128,22 +125,35 @@
                 }
                 
                 // response generate
-                ShData shData =
-                    operations.shPull(
-                        publicIdentity, requestedData, requestedDomain,
-                        currentLocation, serviceIndication,
-                        applicationServerIdentity, applicationServerName);
+                ShData shData = operations.shPull(publicIdentity, requestedData, requestedDomain,currentLocation, 
+                		serviceIndication, applicationServerIdentity, applicationServerName);
 
-                DiameterMessage responseMessage =
-                    diameterPeer.newResponse(requestMessage);
+                // create the diameter response message 
+                DiameterMessage responseMessage = diameterPeer.newResponse(requestMessage);
 
+                /* add Vendor-Specific app id */
+                AVP vendorSpecificApplicationID = new AVP(Constants.AVPCode.VENDOR_SPECIFIC_APPLICATION_ID, true, Constants.Vendor.DIAM);
+                AVP vendorID = new AVP(Constants.AVPCode.VENDOR_ID, true, Constants.Vendor.DIAM);
+                vendorID.setData(Constants.Vendor.V3GPP);
+                vendorSpecificApplicationID.addChildAVP(vendorID);
+                AVP applicationID = new AVP(Constants.AVPCode.AUTH_APPLICATION_ID, true,  Constants.Vendor.DIAM);
+                applicationID.setData(Constants.Application.SH);
+                vendorSpecificApplicationID.addChildAVP(applicationID);
+                responseMessage.addAVP(vendorSpecificApplicationID);
+        		
+        		/* add Auth-Session-State, no state maintained */
+                AVP authenticationSessionState = new AVP(Constants.AVPCode.AUTH_SESSION_STATE, true, Constants.Vendor.DIAM);
+                authenticationSessionState.setData(1);
+                responseMessage.addAVP(authenticationSessionState);
+
+                /* add User-Data */
                 AVP userDataAVP = new AVP(Constants.AVPCode.SH_USER_DATA, true, Constants.Vendor.V3GPP);
                 StringWriter sw = new StringWriter();
                 shData.marshal(sw);
                 userDataAVP.setData(sw.getBuffer().toString());
-
                 responseMessage.addAVP(userDataAVP);
 
+                /* add result code */
                 AVP responseCode = new AVP(Constants.AVPCode.RESULT_CODE, true, Constants.Vendor.DIAM);
                 responseCode.setData(ResultCode._DIAMETER_SUCCESS);
                 responseMessage.addAVP(responseCode);

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/diam/zh/MARzhCommandListener.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/diam/zh/MARzhCommandListener.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/diam/zh/MARzhCommandListener.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -57,7 +57,7 @@
 import de.fhg.fokus.diameter.DiameterPeer.data.DiameterMessage;
 import de.fhg.fokus.hss.diam.Constants;
 import de.fhg.fokus.hss.diam.ResultCode;
-import de.fhg.fokus.hss.model.AuthSchemeBO;
+import de.fhg.fokus.hss.model.Impi;
 import de.fhg.fokus.zh.AuthenticationVector;
 import de.fhg.fokus.zh.ZhAuthDataResponse;
 import de.fhg.fokus.zh.ZhOperations;
@@ -88,9 +88,7 @@
      * @param zhImpl Zh Opeations
      * @param _diameterPeer diameterPeer
      */ 
-    public MARzhCommandListener(
-        ZhOperations zhImpl, DiameterPeer _diameterPeer)
-    {
+    public MARzhCommandListener(ZhOperations zhImpl, DiameterPeer _diameterPeer){
         super(_diameterPeer);
         this.zhOperations = zhImpl;
     }
@@ -100,10 +98,9 @@
      * @param FQDN fully qualified domain name
      * @param requestMessage the diameter message   
      */ 
-    public void recvMessage(String FQDN, DiameterMessage requestMessage)
-    {
-        if (requestMessage.commandCode == COMMAND_ID)
-        {
+    public void recvMessage(String FQDN, DiameterMessage requestMessage){
+        
+    	if (requestMessage.commandCode == COMMAND_ID){
             counter++;
             if(LOGGER.isDebugEnabled()){
             	LOGGER.debug(&quot;entering&quot;);
@@ -111,92 +108,62 @@
             	LOGGER.debug(requestMessage);
             }
 
-            try
-            {
+            try{
                 AVP resultCode = null;
-
-                URI privateUserIdentity =
-                    loadPrivateUserIdentity(requestMessage);
-                Long numberOfAuthVectors =
-                    loadNumberOfAuthVectors(requestMessage);
+                URI privateUserIdentity = loadPrivateUserIdentity(requestMessage);
+                Long numberOfAuthVectors = loadNumberOfAuthVectors(requestMessage);
                 AuthenticationVector authenticationVector = null;
-
                 ZhAuthDataResponse authDataResponse = null;
 
-                authDataResponse =
-                    zhOperations.zhAuthData(
-                        privateUserIdentity, numberOfAuthVectors,
-                        authenticationVector, null);
+                authDataResponse = zhOperations.zhAuthData(privateUserIdentity, numberOfAuthVectors, authenticationVector, null);
 
-                DiameterMessage responseMessage =
-                    diameterPeer.newResponse(requestMessage);
+                DiameterMessage responseMessage = diameterPeer.newResponse(requestMessage);
 
                 final int SESSION_ID_AVP = 263;
-                AVP sessionId =
-                    requestMessage.findAVP(
-                        SESSION_ID_AVP, true, Constants.Vendor.DIAM);
+                AVP sessionId = requestMessage.findAVP(SESSION_ID_AVP, true, Constants.Vendor.DIAM);
 
-                if (sessionId != null)
-                {
+                if (sessionId != null){
                     responseMessage.addAVP(sessionId);
                 }
-                else
-                {
-                    LOGGER.debug(
-                        this, new NullPointerException(&quot;Session ID missed.&quot;));
+                else{
+                    LOGGER.warn(this, new NullPointerException(&quot;Session ID missing!&quot;));
                 }
 
                 final int VENDOR_APP_ID_AVP = 260;
-                AVP vendorId =
-                    requestMessage.findAVP(
-                        VENDOR_APP_ID_AVP, true, Constants.Vendor.DIAM);
+                AVP vendorId = requestMessage.findAVP(VENDOR_APP_ID_AVP, true, Constants.Vendor.DIAM);
 
-                if (vendorId != null)
-                {
+                if (vendorId != null){
                     responseMessage.addAVP(vendorId);
                 }
-                else
-                {
-                    LOGGER.warn(
-                        this, new NullPointerException(&quot;Vendor ID missed.&quot;));
+                else{
+                    LOGGER.warn(this, new NullPointerException(&quot;Vendor ID missed.&quot;));
                 }
 
                 final int AUTH_STATE_AVP = 277;
-                AVP authStateId =
-                    requestMessage.findAVP(
-                        AUTH_STATE_AVP, true, Constants.Vendor.DIAM);
+                AVP authStateId = requestMessage.findAVP(AUTH_STATE_AVP, true, Constants.Vendor.DIAM);
 
-                if (authStateId != null)
-                {
+                if (authStateId != null){
                     responseMessage.addAVP(authStateId);
                 }
-                else
-                {
-                    LOGGER.warn(
-                        this, new NullPointerException(&quot;Auth State ID missed.&quot;));
+                else{
+                    LOGGER.warn(this, new NullPointerException(&quot;Auth State ID missed.&quot;));
                 }
 
                 saveAuthData(authDataResponse, responseMessage);
                 saveGussData(authDataResponse, responseMessage);
 
                 // Add result code
-                resultCode =
-                    saveResultCode(
-                        authDataResponse.getResultCode(),
-                        authDataResponse.resultCodeIsBase());
-
+                resultCode = getResultCodeAVP(authDataResponse.getResultCode(), authDataResponse.resultCodeIsBase());
                 responseMessage.addAVP(resultCode);
                 
                 diameterPeer.sendMessage(FQDN, responseMessage);
                 LOGGER.debug(&quot;exiting&quot;);
             }
-            catch (DiameterException e)
-            {
+            catch (DiameterException e){
                 LOGGER.warn(this, e);
                 sendDiameterException(FQDN, requestMessage, e);
             }
-            catch (Exception e)
-            {
+            catch (Exception e){
                 LOGGER.error(this, e);
                 sendUnableToComply(FQDN, requestMessage);
             }
@@ -212,11 +179,10 @@
      * @throws MarshalException On marshal the Guss to the AVP failure
      * @throws ValidationException On marshal the Guss to the AVP failure
      */
-    private void saveGussData(
-        ZhAuthDataResponse authDataResponse, DiameterMessage responseMessage)
-        throws MarshalException, ValidationException{
+    private void saveGussData(ZhAuthDataResponse authDataResponse, DiameterMessage responseMessage)
+    	throws MarshalException, ValidationException{
+    	
         Guss guss = authDataResponse.getGuss();
-
         if (guss != null){
             AVP gussAVP = new AVP (Constants.AVPCode.ZH_GUSS, true, Constants.Vendor.V3GPP);
             StringWriter sw = new StringWriter();
@@ -232,8 +198,7 @@
      * @param authDataResponse 
      * @param responseMessage
      */
-    private void saveAuthData(
-        ZhAuthDataResponse authDataResponse, DiameterMessage responseMessage){
+    private void saveAuthData(ZhAuthDataResponse authDataResponse, DiameterMessage responseMessage){
         // Iterete and add vectors to response message
         Iterator it = authDataResponse.getAuthenticationVectors().iterator();
         int ix = 0;
@@ -286,8 +251,8 @@
      * @throws DiameterException
      */
     private Long loadNumberOfAuthVectors(DiameterMessage requestMessage)
-        throws DiameterException
-    {
+        throws DiameterException{
+    	
         //        Long numberOfAuthVectors = null;
         //
         //        try
@@ -315,8 +280,8 @@
      * @throws DiameterException
      */
     private AuthenticationVector loadAuthVector(DiameterMessage requestMessage)
-        throws DiameterException
-    {
+        throws DiameterException{
+    	
         //        AuthenticationVector authenticationVector = null;
         //        AVP authVectorAVP =
         //            avpLookUp(
@@ -333,7 +298,7 @@
         //        }
         //
         //        return authenticationVector;
-        return new AuthenticationVector(AuthSchemeBO.AUTH_ALGORITHM_AKAv1.getBytes());
+        return new AuthenticationVector(Constants.AuthScheme.AUTH_SCHEME_AKAv1.getBytes());
     }
     
     /**

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/diam/zh/ZhCommandListener.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/diam/zh/ZhCommandListener.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/diam/zh/ZhCommandListener.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -167,7 +167,7 @@
         try{
             if ((diameterPeer != null) &amp;&amp; (FQDN != null) &amp;&amp; (requestMessage != null)){
                 DiameterMessage msg = diameterPeer.newResponse(requestMessage);
-                AVP resultAVP = saveResultCode(diameterException.getCode(), (diameterException instanceof DiameterBaseException));
+                AVP resultAVP = getResultCodeAVP(diameterException.getCode(), (diameterException instanceof DiameterBaseException));
                 msg.addAVP(resultAVP);
                 diameterPeer.sendMessage(FQDN, msg);
             }

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/form/ImpiForm.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/form/ImpiForm.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/form/ImpiForm.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -44,8 +44,8 @@
  */
 package de.fhg.fokus.hss.form;
 
+import de.fhg.fokus.hss.diam.Constants;
 import de.fhg.fokus.hss.main.HSSProperties;
-import de.fhg.fokus.hss.model.AuthSchemeBO;
 import de.fhg.fokus.hss.util.Converter;
 
 import org.apache.commons.lang.builder.ToStringBuilder;
@@ -70,30 +70,22 @@
  */
 public class ImpiForm extends ImpuSubSelectForm
 {
+	public static final ArrayList authSchemes;
+	
+	static{
+		authSchemes = new ArrayList();
+		authSchemes.add(new Tupel(Constants.AuthScheme.AUTH_SCHEME_AKAv1, Constants.AuthScheme.AUTH_SCHEME_AKAv1));
+		authSchemes.add(new Tupel(Constants.AuthScheme.AUTH_SCHEME_AKAv2, Constants.AuthScheme.AUTH_SCHEME_AKAv2));
+		authSchemes.add(new Tupel(Constants.AuthScheme.AUTH_SCHEME_MD5, Constants.AuthScheme.AUTH_SCHEME_MD5));
+		authSchemes.add(new Tupel(Constants.AuthScheme.AUTH_SCHEME_EARLY, Constants.AuthScheme.AUTH_SCHEME_EARLY));
+		authSchemes.add(new Tupel(Constants.AuthScheme.AUTH_SCHEME_ANY, Constants.AuthScheme.AUTH_SCHEME_ANY));
+	}
+	
     private static final Logger LOGGER = Logger.getLogger(ImpiForm.class);
-    private static final ArrayList authSchemes;
-    private static final ArrayList authAlgos;
 
-    static
-    {
-        authSchemes = new ArrayList();
-        //authSchemes.add(new Tupel(AuthSchemeBO.AUS_EARLY, AuthSchemeBO.AUS_EARLY));
-        authSchemes.add(new Tupel(AuthSchemeBO.AUTH_SCHEME_AKAv1, AuthSchemeBO.AUTH_SCHEME_AKAv1));
-        authSchemes.add(new Tupel(AuthSchemeBO.AUTH_SCHEME_AKAv2, AuthSchemeBO.AUTH_SCHEME_AKAv2));
-        authSchemes.add(new Tupel(AuthSchemeBO.AUTH_SCHEME_MD5, AuthSchemeBO.AUTH_SCHEME_MD5));
-    }
-
-    static
-    {
-        authAlgos = new ArrayList();
-        //authAlgos.add(new Tupel(AuthSchemeBO));
-        authAlgos.add(new Tupel(AuthSchemeBO.AUTH_ALGORITHM_AKAv1, AuthSchemeBO.AUTH_ALGORITHM_AKAv1));
-        authAlgos.add(new Tupel(AuthSchemeBO.AUTH_ALGORITHM_AKAv2, AuthSchemeBO.AUTH_ALGORITHM_AKAv2));
-        authAlgos.add(new Tupel(AuthSchemeBO.AUTH_ALGORITHM_MD5, AuthSchemeBO.AUTH_ALGORITHM_MD5));
-    }
-
     public static final String SQD_UPDATE_TRUE = &quot;1&quot;;
     public static final String SQD_UPDATE_FALSE = &quot;0&quot;;
+
     private String impiId;
     private String impiString;
     private String imsi;
@@ -126,45 +118,27 @@
 
         ActionErrors actionErrors = new ActionErrors();
 
-        if ((getImpiString() == null) || (getImpiString().length() &lt; 1))
-        {
-            actionErrors.add(
-                &quot;impiString&quot;, new ActionMessage(
-                    &quot;impi.error.missing.impiString&quot;));
+        if ((getImpiString() == null) || (getImpiString().length() &lt; 1)){
+            actionErrors.add(&quot;impiString&quot;, new ActionMessage(&quot;impi.error.missing.impiString&quot;));
         }
 
-        if (
-            (getAuthScheme() != null)
-                &amp;&amp; (getAuthScheme().equals(AuthSchemeBO.AUTH_SCHEME_AKAv1) || getAuthScheme().equals(AuthSchemeBO.AUTH_SCHEME_AKAv2)))
-        {
-            if ((getAmf() == null) || (getAmf().length() != 4))
-            {
-                actionErrors.add(
-                    &quot;amf&quot;, new ActionMessage(&quot;impi.error.size.amf&quot;));
-            }
+        if ((getAmf() == null) || (getAmf().length() != 4)){
+                actionErrors.add(&quot;amf&quot;, new ActionMessage(&quot;impi.error.size.amf&quot;));
+        }
 
-            if ((getOperatorId() == null) || (getOperatorId().length() != 32))
-            {
-                actionErrors.add(
-                    &quot;operatorId&quot;,
-                    new ActionMessage(&quot;impi.error.size.operatorId&quot;));
-            }
+        if ((getOperatorId() == null) || (getOperatorId().length() != 32)){
+        	actionErrors.add(&quot;operatorId&quot;,new ActionMessage(&quot;impi.error.size.operatorId&quot;));
+        }
 
-            if ((getSkey() == null) || (getSkey().length() != 32))
-            {
-                actionErrors.add(
-                    &quot;skey&quot;, new ActionMessage(&quot;impi.error.size.skey&quot;));
-            }
+        if ((getSkey() == null) || (getSkey().length() != 32)){
+        	actionErrors.add(&quot;skey&quot;, new ActionMessage(&quot;impi.error.size.skey&quot;));
+        }
 
-            if ((getSqn() == null) || (getSqn().length() != 12))
-            {
-                actionErrors.add(
-                    &quot;sqn&quot;, new ActionMessage(&quot;impi.error.size.sqn&quot;));
-            }
+        if ((getSqn() == null) || (getSqn().length() != 12)){
+        	actionErrors.add(&quot;sqn&quot;, new ActionMessage(&quot;impi.error.size.sqn&quot;));
         }
 
         LOGGER.debug(&quot;exiting&quot;);
-
         return actionErrors;
     }
 
@@ -177,9 +151,8 @@
         roamNetworkIdentifiers = new TreeSet();
         scscfName = null;
         skey = &quot;00000000000000000000000000000000&quot;;
-        authScheme = AuthSchemeBO.AUTH_SCHEME_AKAv1;
+        authScheme = Constants.AuthScheme.AUTH_SCHEME_AKAv1;
         amf = HSSProperties.AMF_ID;
-        algorithm = AuthSchemeBO.AUTH_ALGORITHM_AKAv1;
         operatorId = HSSProperties.OPERATOR_ID;
         sqn = &quot;000000000000&quot;;
         sqnUpdate = SQD_UPDATE_FALSE;
@@ -302,16 +275,7 @@
         skey = Converter.convertStringToByteString(key, 32);
     }
 
-    public ArrayList getAuthSchemes()
-    {
-        return authSchemes;
-    }
 
-    public static void setAuthSchemes(ArrayList authSchemes)
-    {
-        // do Nothing;
-    }
-
     public String getSqn()
     {
         return sqn;
@@ -332,11 +296,6 @@
         this.asBytes = asBytes;
     }
 
-    public ArrayList getAuthAlgos()
-    {
-        return authAlgos;
-    }
-
     public String getChrgInfoId()
     {
         return chrgInfoId;
@@ -366,4 +325,8 @@
     {
         this.sqnUpdate = sqnUpdate;
     }
+    
+    public ArrayList getAuthSchemes(){
+    	return this.authSchemes;
+    }
 }

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/form/ImpuSubSelectForm.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/form/ImpuSubSelectForm.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/form/ImpuSubSelectForm.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -64,8 +64,7 @@
  */
 public abstract class ImpuSubSelectForm extends HssForm
 {
-    private static final Logger LOGGER =
-        Logger.getLogger(ImpuSubSelectForm.class);
+    private static final Logger LOGGER = Logger.getLogger(ImpuSubSelectForm.class);
 
     /**
      * impu lookup selector
@@ -153,52 +152,6 @@
         return null;
     }
 
-    public static void doImpuSelection(
-        Session session, ImpuSubSelectForm form, Set givenImpus)
-    {
-        if (
-            (form.getImpuSelect().equals(&quot;true&quot;))
-                &amp;&amp; (
-                    (form.getImpuUrl() != null)
-                    &amp;&amp; (form.getImpuUrl().length() &gt; 0)
-                ))
-        {
-            List results = null;
-
-            if (form.getImsuId() != null)
-            {
-                // Prepare Querry
-                Query query =
-                    session.createQuery(
-                        &quot;select impu from de.fhg.fokus.hss.model.Impu as impu where impu.psi = 0 and impu.sipUrl like ? and impu.impis.imsu.imsuId = ?&quot;);
-                query.setString(0, &quot;%&quot; + form.getImpuUrl() + &quot;%&quot;);
-                query.setInteger(1, form.getImsuId());
-                query.setMaxResults(20);
-                results = query.list();
-                query =
-                    session.createQuery(
-                        &quot;select impu from de.fhg.fokus.hss.model.Impu as impu where impu.psi = 0 and impu.sipUrl like ? and impu.impis is empty&quot;);
-                query.setString(0, &quot;%&quot; + form.getImpuUrl() + &quot;%&quot;);
-                results.addAll(query.list());
-            }
-            else
-            {
-                // Prepare Querry
-                Query query =
-                    session.createQuery(
-                        &quot;select impu from de.fhg.fokus.hss.model.Impu as impu where impu.psi = 0 and impu.sipUrl like ?&quot;);
-                query.setString(0, &quot;%&quot; + form.getImpuUrl() + &quot;%&quot;);
-                query.setMaxResults(20);
-                results = query.list();
-            }
-
-            results.removeAll(givenImpus);
-            form.setImpusSelected(results);
-
-            LOGGER.debug(form);
-        }
-    }
-
     public Integer getImsuId()
     {
         return imsuId;

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/main/HssServer.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/main/HssServer.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/main/HssServer.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -98,11 +98,7 @@
             
             HssDiameterStack diameterStack = new HssDiameterStack();
             diameterStack.startup();
-            
-            LOGGER.info(&quot;FHoSS was started and is ready for use !&quot;);
-            LOGGER.debug(&quot;Testing&quot;);
-            LOGGER.warn(&quot;Testing&quot;);
-            
+            LOGGER.info(&quot;FHoSS was started and is ready for use!&quot;);
             waitForExit();
             
             // stoping FHoSS

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/main/TomcatServer.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/main/TomcatServer.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/main/TomcatServer.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -109,7 +109,6 @@
 
         // Create an embedded server
         embedded = new Embedded();
-
         // Add a realm
         MemoryRealm memRealm = new MemoryRealm();
         embedded.setRealm(memRealm);

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/model/ApsvrBO.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/model/ApsvrBO.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/model/ApsvrBO.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -56,6 +56,7 @@
 import de.fhg.fokus.cx.datatypes.PublicIdentity;
 import de.fhg.fokus.cx.exceptions.DiameterException;
 import de.fhg.fokus.hss.server.cx.op.UpdateCxOperation;
+import de.fhg.fokus.hss.util.HibernateUtil;
 
 
 /**
@@ -63,8 +64,11 @@
  *
  * @author Andre Charton (dev -at- open-ims dot org)
  */
-public class ApsvrBO extends HssBO
+
+public class ApsvrBO
 {
+	public ApsvrBO(){
+	}
     /** logger */
     private static final Logger LOGGER = Logger.getLogger(ApsvrBO.class);
 
@@ -78,6 +82,8 @@
      */
     public static final int DH_SESSION_TERMINATED = 1;
 
+    
+    
     /**
      * loads application server with the help of provided primary key
      * @param primaryKey
@@ -86,7 +92,7 @@
      */
     public Apsvr load(Serializable primaryKey)
     {
-        Apsvr apsvr = (Apsvr) getSession().load(Apsvr.class, primaryKey);
+        Apsvr apsvr = (Apsvr) HibernateUtil.getCurrentSession().load(Apsvr.class, primaryKey);
         apsvr.addPropertyChangeListener(apsvr);
 
         return apsvr;
@@ -102,10 +108,7 @@
      */
     public AsPermList loadAsPermList(Serializable primaryKey)
     {
-        AsPermList asPermList = (AsPermList) getSession()
-                                                 .load(AsPermList.class,
-                primaryKey);
-
+        AsPermList asPermList = (AsPermList) HibernateUtil.getCurrentSession().load(AsPermList.class, primaryKey);
         return asPermList;
     }
 
@@ -120,18 +123,15 @@
     {
         LOGGER.debug(&quot;entering&quot;);
 
-        beginnTx();
-        getSession().saveOrUpdate(apsvr);
+        HibernateUtil.getCurrentSession().saveOrUpdate(apsvr);
         asPermList.setApsvrId(apsvr.getApsvrId());
-        getSession().saveOrUpdate(asPermList);
-        endTx();
+        HibernateUtil.getCurrentSession().saveOrUpdate(asPermList);
 
         if (apsvr.isChange() == true)
         {
             commitCxChanges(apsvr);
         }
 
-        closeSession();
         LOGGER.debug(&quot;exiting&quot;);
     }
 
@@ -145,16 +145,14 @@
 
         try
         {
-            Query query = getSession()
-                              .createQuery(&quot;select ifc from de.fhg.fokus.hss.model.Ifc as ifc where ifc.apsvr.apsvrId = ?&quot;);
+            Query query = HibernateUtil.getCurrentSession()
+            	.createQuery(&quot;select ifc from de.fhg.fokus.hss.model.Ifc as ifc where ifc.apsvr.apsvrId = ?&quot;);
             query.setInteger(0, apsvr.getApsvrId());
 
             Iterator itIfc = query.list().iterator();
-
             ArrayList impuIds = new ArrayList();
 
-            while (itIfc.hasNext())
-            {
+            while (itIfc.hasNext()){
                 Ifc ifc = (Ifc) itIfc.next();
 
                 if (ifc.getSvp() != null)

Deleted: FHoSS/trunk/src/de/fhg/fokus/hss/model/AuthSchemeBO.java

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/model/CxUserProfil.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/model/CxUserProfil.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/model/CxUserProfil.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -74,6 +74,7 @@
 import de.fhg.fokus.cx.exceptions.base.UnableToComply;
 import de.fhg.fokus.cx.exceptions.ims.IdentitiesDontMatch;
 import de.fhg.fokus.cx.exceptions.ims.UserUnknown;
+import de.fhg.fokus.hss.util.HibernateUtil;
 
 
 /**
@@ -84,7 +85,7 @@
  *
  * @author Andre Charton (dev -at- open-ims dot org)
  */
-public class CxUserProfil extends HssBO
+public class CxUserProfil
 {
     private static final Logger LOGGER = Logger.getLogger(CxUserProfil.class);
 
@@ -142,11 +143,9 @@
      * @throws IdentitiesDontMatch
      * @throws DiameterException
      */
-    public CxUserProfil(Impu impu, Session session)
-        throws IdentitiesDontMatch, DiameterException
+    public CxUserProfil(Impu impu)throws IdentitiesDontMatch, DiameterException
     {
         LOGGER.debug(&quot;entering&quot;);
-        setSession(session);
         setImpu(impu);
         loadAssignedImpi();
         LOGGER.debug(&quot;exiting&quot;);
@@ -162,7 +161,7 @@
     {
         LOGGER.debug(&quot;entering&quot;);
 
-        this.impi = (Impi) getSession().load(Impi.class, _impi.getImpiId());
+        this.impi = (Impi) HibernateUtil.getCurrentSession().load(Impi.class, _impi.getImpiId());
         impuList = this.impi.getImpus();
 
         if ((impuList != null) &amp;&amp; (impuList.size() &gt; 0))
@@ -184,8 +183,7 @@
     {
         LOGGER.debug(&quot;entering&quot;);
 
-        Query query =
-            getSession().createQuery(
+        Query query = HibernateUtil.getCurrentSession().createQuery(
                 &quot;select impu from de.fhg.fokus.hss.model.Impu as impu where impu.sipUrl = ?&quot;);
         query.setString(0, publicIdentity.getIdentity());
 
@@ -252,9 +250,8 @@
         try
         {
             impi =
-                (Impi) getSession()
-                           .createQuery(
-                    &quot;select impi from de.fhg.fokus.hss.model.Impi as impi where impi.impiString = ?&quot;)
+                (Impi) HibernateUtil.getCurrentSession().createQuery(
+                		&quot;select impi from de.fhg.fokus.hss.model.Impi as impi where impi.impiString = ?&quot;)
                            .setString(0, privateUserIdentity.getPath())
                            .uniqueResult();
 
@@ -439,26 +436,17 @@
     {
         LOGGER.debug(&quot;entering&quot;);
 
-        try
+        if (impi != null)
         {
-            if (impi != null)
-            {
-                ImpiBO impiBO = new ImpiBO();
-                impiBO.saveOrUpdate(impi);
-            }
-
-            if (impu != null)
-            {
-                beginnTx();
-                getSession().update(impu);
-                endTx();
-            }
+            ImpiBO impiBO = new ImpiBO();
+            impiBO.saveOrUpdate(impi);
         }
-        finally
+
+        if (impu != null)
         {
-            closeSession();
+            ImpuBO impuBO = new ImpuBO();
+            impuBO.saveOrUpdate(impu);
         }
-
         LOGGER.debug(&quot;exiting&quot;);
     }
 
@@ -649,63 +637,51 @@
         TriggerPoint triggerPoint = new TriggerPoint();
         triggerPoint.setConditionTypeCNF(trigpt.getCnf() == 1);
 
-        if ((trigpt.getSpts() != null) &amp;&amp; (
-                    trigpt.getSpts().isEmpty() == false
-                ))
-        {
+        if ((trigpt.getSpts() != null) &amp;&amp; (trigpt.getSpts().isEmpty() == false)){
             Iterator itSpt = trigpt.getSpts().iterator();
             TSePoTriChoice choice = null;
             Spt sptData = null;
             SPT spt = null;
 
-            while (itSpt.hasNext())
-            {
+            while (itSpt.hasNext()){
                 sptData = (Spt) itSpt.next();
                 choice = new TSePoTriChoice();
                 spt = new SPT();
                 spt.setConditionNegated(sptData.isNeg());
                 spt.addGroup(sptData.getGroupId());
 
-                switch (sptData.getType())
-                {
-                case TrigptBO.TYPE_URI:
-                    choice.setRequestURI(sptData.getReqUri());
+                switch (sptData.getType()){
+                
+                	case TrigptBO.TYPE_URI:
+                		choice.setRequestURI(sptData.getReqUri());
+                		break;
 
-                    break;
+                	case TrigptBO.TYPE_SIP_METHOD:
+                		choice.setMethod(sptData.getSipMethod());
+                		break;
 
-                case TrigptBO.TYPE_SIP_METHOD:
-                    choice.setMethod(sptData.getSipMethod());
+                	case TrigptBO.TYPE_SESSION_CASE:
 
-                    break;
+                		TDirectionOfRequest dir =
+                			TDirectionOfRequest.valueOf(
+                					String.valueOf(sptData.getSessionCase()));
+                		choice.setSessionCase(dir);
+                		break;
 
-                case TrigptBO.TYPE_SESSION_CASE:
+                	case TrigptBO.TYPE_SESSION_DESC:
+                		SessionDescription sessionDescription =
+                			new SessionDescription();
+                		sessionDescription.setContent(sptData.getSessionDescContent());
+                		sessionDescription.setLine(sptData.getSessionDescLine());
+                		choice.setSessionDescription(sessionDescription);
+                		break;
 
-                    TDirectionOfRequest dir =
-                        TDirectionOfRequest.valueOf(
-                            String.valueOf(sptData.getSessionCase()));
-                    choice.setSessionCase(dir);
-
-                    break;
-
-                case TrigptBO.TYPE_SESSION_DESC:
-
-                    SessionDescription sessionDescription =
-                        new SessionDescription();
-                    sessionDescription.setContent(
-                        sptData.getSessionDescContent());
-                    sessionDescription.setLine(sptData.getSessionDescLine());
-                    choice.setSessionDescription(sessionDescription);
-
-                    break;
-
-                case TrigptBO.TYPE_SIP_HEADER:
-
-                    SIPHeader header = new SIPHeader();
-                    header.setContent(sptData.getSipHeaderContent());
-                    header.setHeader(sptData.getSipHeader());
-                    choice.setSIPHeader(header);
-
-                    break;
+                	case TrigptBO.TYPE_SIP_HEADER:
+                		SIPHeader header = new SIPHeader();
+                		header.setContent(sptData.getSipHeaderContent());
+                		header.setHeader(sptData.getSipHeader());
+                		choice.setSIPHeader(header);
+                		break;
                 }
 
                 spt.setTSePoTriChoice(choice);

Deleted: FHoSS/trunk/src/de/fhg/fokus/hss/model/HssBO.java

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/model/IfcBO.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/model/IfcBO.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/model/IfcBO.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -53,6 +53,8 @@
 import org.apache.log4j.Logger;
 
 import de.fhg.fokus.hss.server.sh.ASshOperationsImpl;
+import de.fhg.fokus.hss.util.HibernateUtil;
+import de.fhg.fokus.hss.util.Util;
 import de.fhg.fokus.sh.data.ApplicationServer;
 import de.fhg.fokus.sh.data.InitialFilterCriteria;
 import de.fhg.fokus.sh.data.SIPHeader;
@@ -71,7 +73,7 @@
  * other Cx and Sh specific functions.
  * @author Andre Charton (dev -at- open-ims dot org)
  */
-public class IfcBO extends HssBO
+public class IfcBO
 {
     /** logger */
     private static final Logger LOGGER = Logger.getLogger(IfcBO.class);
@@ -95,9 +97,8 @@
      */
     public Ifc load(Serializable primaryKey)
     {
-        Ifc ifc = (Ifc) getSession().load(Ifc.class, primaryKey);
+        Ifc ifc = (Ifc) HibernateUtil.getCurrentSession().load(Ifc.class, primaryKey);
         ifc.addPropertyChangeListener(ifc);
-
         return ifc;
     }
 
@@ -108,22 +109,12 @@
      */
     public void saveOrUpdate(Ifc ifc)
     {
-        try
-        {
-            beginnTx();
-            getSession().saveOrUpdate(ifc);
-            endTx();
+        HibernateUtil.getCurrentSession().saveOrUpdate(ifc);
 
-            if (ifc.isChange())
-            {
-                commitShChanges(ifc);
-                commitCxChanges(ifc);
-            }
+        if (ifc.isChange()){
+            commitShChanges(ifc);
+            commitCxChanges(ifc);
         }
-        finally
-        {
-            closeSession();
-        }
     }
 
     /**
@@ -134,8 +125,7 @@
     {
         LOGGER.debug(&quot;entering&quot;);
 
-        List notifyIfcs =
-            getSession()
+        List notifyIfcs = HibernateUtil.getCurrentSession()
                 .createQuery(
                 &quot;select nifc from de.fhg.fokus.hss.model.NotifyIfc as nifc where nifc.comp_id.ifcApsvrId = ?&quot;)
                 .setInteger(0, ifc.getApsvr().getApsvrId()).list();
@@ -150,32 +140,18 @@
 
             Iterator it = notifyIfcs.iterator();
 
-            while (it.hasNext())
-            {
+            while (it.hasNext()){
                 NotifyIfc notifyIfc = (NotifyIfc) it.next();
                 Impu impu = notifyIfc.getImpu();
-                Apsvr notifApsvr =
-                    (Apsvr) getSession().get(
-                        Apsvr.class, notifyIfc.getComp_id().getApsvrId());
+                Apsvr notifApsvr = (Apsvr) HibernateUtil.getCurrentSession().get(Apsvr.class, notifyIfc.getComp_id().getApsvrId());
 
-                try
-                {
-                	// XLB
-                    // Use FQDN name instead of SIP     
-                    operationsImpl.shNotif(
-                            new URI(impu.getSipUrl()), shData,
-                            notifApsvr.getName());  
-                    
-/*                    operationsImpl.shNotif(
-                        new URI(impu.getSipUrl()), shData,
-                        notifApsvr.getAddress());*/
+                try{
+                    operationsImpl.shNotif(new URI(impu.getSipUrl()), shData, Util.getHost(notifApsvr.getAddress()));
                 }
-                catch (URISyntaxException e)
-                {
+                catch (URISyntaxException e){
                     LOGGER.warn(IfcBO.class, e);
                 }
-                catch (de.fhg.fokus.sh.DiameterException e)
-                {
+                catch (de.fhg.fokus.sh.DiameterException e){
                     LOGGER.warn(IfcBO.class, e);
                 }
             }
@@ -193,7 +169,6 @@
         LOGGER.debug(&quot;entering&quot;);
 
         SvpBO svpBO = new SvpBO();
-        svpBO.setSession(getSession());
 
         // Forward to assigned Service Profiles
         if (ifc.getSvp() != null)

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/model/ImpiBO.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/model/ImpiBO.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/model/ImpiBO.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -51,17 +51,18 @@
 import org.apache.log4j.Logger;
 
 import de.fhg.fokus.hss.server.sh.ASshOperationsImpl;
+import de.fhg.fokus.hss.util.HibernateUtil;
 import de.fhg.fokus.sh.data.ShData;
 import de.fhg.fokus.sh.data.ShIMSData;
+import de.fhg.fokus.hss.util.*;
 
-
 /**
  * This a helping class which assists loading, updating or saving
  * private identity from or in the database. Further it performs
  * other Sh specific functions.
  * @author Andre Charton (dev -at- open-ims dot org)
  */
-public class ImpiBO extends HssBO
+public class ImpiBO
 {
     /** logger */
     private static final Logger LOGGER = Logger.getLogger(ImpiBO.class);
@@ -73,7 +74,7 @@
      */
     public Impi load(Serializable primaryKey)
     {
-        Impi impi = (Impi) getSession().get(Impi.class, primaryKey);
+        Impi impi = (Impi) HibernateUtil.getCurrentSession().get(Impi.class, primaryKey);
         impi.addPropertyChangeListener(impi);
 
         return impi;
@@ -88,21 +89,11 @@
     {
         LOGGER.debug(&quot;entering&quot;);
 
-        try
-        {
-            beginnTx();
-            getSession().saveOrUpdate(impi);
-            endTx();
+        HibernateUtil.getCurrentSession().saveOrUpdate(impi);
 
-            if (impi.isChangeScscfName())
-            {
+        if (impi.isChangeScscfName()){
                 commitShChanges(impi);
-            }
         }
-        finally
-        {
-            closeSession();
-        }
 
         LOGGER.debug(&quot;exiting&quot;);
     }
@@ -115,8 +106,7 @@
     {
         LOGGER.debug(&quot;entering&quot;);
 
-        if (impi.getImpus().isEmpty() == false)
-        {
+        if (impi.getImpus().isEmpty() == false){
             ASshOperationsImpl operationsImpl = new ASshOperationsImpl();
             ShData shData = new ShData();
             ShIMSData shIMSData = new ShIMSData();
@@ -124,37 +114,19 @@
             shData.setShIMSData(shIMSData);
 
             Iterator impuIt = impi.getImpus().iterator();
-
-            while (impuIt.hasNext())
-            {
+            while (impuIt.hasNext()){
                 Impu impu = (Impu) impuIt.next();
+                if (impu.getNotifyScscfnames().isEmpty() == false){
+                    Iterator it = impu.getNotifyScscfnames().iterator();
 
-                if (impu.getNotifyImsUserStates().isEmpty() == false)
-                {
-                    Iterator it = impu.getNotifyImsUserStates().iterator();
-
-                    while (it.hasNext())
-                    {
-                        NotifyImsUserState notifyImsUserState =
-                            (NotifyImsUserState) it.next();
-                        Apsvr notifApsvr =
-                            (Apsvr) getSession().get(
-                                Apsvr.class,
-                                notifyImsUserState.getComp_id().getApsvrId());
-
-                        try
-                        {
-                        // XLB 
-                    	/*                            operationsImpl.shNotif(
-                    	                                new URI(impu.getSipUrl()), shData,
-                    	                                notifApsvr.getAddress());*/
-                        // Use FQDN name instead of SIP 
-                            operationsImpl.shNotif(
-                                    new URI(impu.getSipUrl()), shData,
-                                    notifApsvr.getName());
+                    while (it.hasNext()){
+                    	NotifyScscfname notifyScscfName = (NotifyScscfname) it.next();
+                        Apsvr notifApsvr = (Apsvr) HibernateUtil.getCurrentSession().get(Apsvr.class,
+                        		notifyScscfName.getComp_id().getApsvrId());                    	
+                        try{
+                        	operationsImpl.shNotif(new URI(impu.getSipUrl()), shData, Util.getHost(notifApsvr.getAddress()));
                         }
-                        catch (Exception e)
-                        {
+                        catch (Exception e){
                             LOGGER.warn(this, e);
                         }
                     }

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/model/Impu.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/model/Impu.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/model/Impu.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -319,7 +319,7 @@
 
    /**
     * Getter method for impis
-    * @return public indentities
+    * @return private indentities
     */
     public Set getImpis()
     {

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/model/ImpuBO.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/model/ImpuBO.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/model/ImpuBO.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -61,8 +61,10 @@
 import de.fhg.fokus.hss.server.cx.op.UpdateCxOperation;
 import de.fhg.fokus.hss.server.sh.ASshOperationsImpl;
 import de.fhg.fokus.hss.util.HibernateUtil;
+import de.fhg.fokus.hss.util.Util;
 import de.fhg.fokus.sh.data.ShData;
 import de.fhg.fokus.sh.data.ShIMSData;
+import de.fhg.fokus.sh.data.types.TCSUserState;
 import de.fhg.fokus.sh.data.types.TIMSUserState;
 
 /**
@@ -70,7 +72,7 @@
  *
  * @author Andre Charton (dev -at- open-ims dot org)
  */
-public class ImpuBO extends HssBO
+public class ImpuBO
 {
     /** logger */
     private static final Logger LOGGER = Logger.getLogger(ImpuBO.class);
@@ -94,11 +96,9 @@
     public Impu load(Serializable primaryKey)
     {
         LOGGER.debug(&quot;entering&quot;);
-        openSession();
 
-        Impu impu = (Impu) getSession().load(Impu.class, primaryKey);
+        Impu impu = (Impu) HibernateUtil.getCurrentSession().load(Impu.class, primaryKey);
         impu.addPropertyChangeListener(impu);
-        closeSession();
         LOGGER.debug(&quot;exiting&quot;);
 
         return impu;
@@ -113,17 +113,12 @@
     {
         LOGGER.debug(&quot;entering&quot;);
 
-        beginnTx();
-        getSession().saveOrUpdate(impu);
-        endTx();
+        HibernateUtil.getCurrentSession().saveOrUpdate(impu);
 
-        if (
-            (impu.isChange())
+        if ((impu.isChange())
                 &amp;&amp; (
                     impu.getUserStatus().equals(
-                        Impu.USER_STATUS_NOT_REGISTERED) == false
-                ))
-        {
+                        Impu.USER_STATUS_NOT_REGISTERED) == false)){
             commitCxChanges(impu);
         }
         else if (impu.isDeregistered())
@@ -135,7 +130,6 @@
         	commitShChanges(impu);
         }
         
-        closeSession();
         LOGGER.debug(&quot;exiting&quot;);
     }
 
@@ -171,22 +165,21 @@
 	            	break;
 	            }
 	            
-	            //shIMSData.setIMSUserState((byte)Integer.parseInt(impu.getUserStatus()));
 	            shData.setShIMSData(shIMSData);
-	            
-				// XLB
 				//shData.setCSUserState((byte)Integer.parseInt(impu.getUserStatus()));
 				while(it.hasNext()){
 					NotifyImsUserState notifyImsUserState = (NotifyImsUserState) it.next();
-					Apsvr notifApsvr = (Apsvr) getSession().get(Apsvr.class, notifyImsUserState.getComp_id().getApsvrId());
+					Apsvr notifApsvr = (Apsvr) HibernateUtil.getCurrentSession()
+						.get(Apsvr.class, notifyImsUserState.getComp_id().getApsvrId());
+					
 					try {
-	                    // Use FQDN name instead of SIP     XLB
-						operationsImpl.shNotif(new URI(impu.getSipUrl()), shData, notifApsvr.getName());
-						// operationsImpl.shNotif(new URI(impu.getSipUrl()), shData, notifApsvr.getAddress());
-					} catch (Exception e) {
+						operationsImpl.shNotif(new URI(impu.getSipUrl()), shData, Util.getHost(notifApsvr.getAddress()));
+					} 
+					catch (Exception e) {
 						LOGGER.warn(this, e);
 					}					
 				}
+				
 			}
 			LOGGER.debug(&quot;exiting&quot;);
 			
@@ -234,22 +227,18 @@
      */
     private void commitCxDeregister(Impu impu)
     {
-        try
-        {
+        try{
             DeregistrationReason reason = new DeregistrationReason(0);
             reason.setDeregistrationInfo(&quot;Registration was canceled by HSS.&quot;);
 
-            if (impu.getImpis().iterator().hasNext())
-            {
+            if (impu.getImpis().iterator().hasNext()){
                 Impi impi = (Impi) impu.getImpis().iterator().next();
                 CxUserProfil cxUserProfil = new CxUserProfil(impi);
-                DeregisterCxOperation cxOperation =
-                    new DeregisterCxOperation(cxUserProfil, reason);
+                DeregisterCxOperation cxOperation = new DeregisterCxOperation(cxUserProfil, reason);
                 cxOperation.execute();
             }
         }
-        catch (DiameterException e)
-        {
+        catch (DiameterException e){
             LOGGER.error(this, e);
         }
     }
@@ -262,30 +251,21 @@
      */
     public void linkImpu2Impi(Integer impiPk, Integer impuPk, boolean isLink)
     {
-        Session session = null;
-        session = HibernateUtil.currentSession();
+        Session session = HibernateUtil.getCurrentSession();
 
-        Transaction tx = session.beginTransaction();
-
         Impi impi = (Impi) session.load(Impi.class, impiPk, LockMode.UPGRADE);
         Impu impu = (Impu) session.load(Impu.class, impuPk);
 
-        if (isLink)
-        {
+        if (isLink){
             LOGGER.debug(&quot;add impu to impi&quot;);
             impi.getImpus().add(impu);
         }
-        else
-        {
+        else{
             LOGGER.debug(&quot;remove impu from impi&quot;);
             impi.getImpus().remove(impu);
             impu.getImpis().remove(impi);
         }
 
-        //session.saveOrUpdate(impi);
-        tx.commit();
-        session.flush();
-
-        HibernateUtil.closeSession();
+        session.saveOrUpdate(impi);
     }
 }

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/model/PsiBO.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/model/PsiBO.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/model/PsiBO.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -84,14 +84,10 @@
      * @param impuPk primary key for public identity
      * @param isLink indicator for link or unlink
      */
-    public static void linkImpu2Psi(
-        Integer psiPk, Integer impuPk, boolean isLink)
-    {
+    public static void linkImpu2Psi(Integer psiPk, Integer impuPk, boolean isLink){
         Session session = null;
-        session = HibernateUtil.currentSession();
+        session = HibernateUtil.getCurrentSession();
 
-        Transaction tx = session.beginTransaction();
-
         Psi psi = (Psi) session.load(Psi.class, psiPk, LockMode.UPGRADE);
         Impu impu = (Impu) session.load(Impu.class, impuPk);
 
@@ -105,11 +101,6 @@
             LOGGER.debug(&quot;remove impu from psi&quot;);
             psi.getImpus().remove(impu);
         }
-
         session.saveOrUpdate(psi);
-        tx.commit();
-        session.flush();
-
-        HibernateUtil.closeSession();
     }
 }

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/model/RepDataBO.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/model/RepDataBO.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/model/RepDataBO.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -51,22 +51,24 @@
 import java.util.Iterator;
 
 import org.apache.log4j.Logger;
+import org.hibernate.Session;
+import org.hibernate.Transaction;
 
 import de.fhg.fokus.hss.server.sh.ASshOperationsImpl;
+import de.fhg.fokus.hss.util.HibernateUtil;
 import de.fhg.fokus.sh.DiameterException;
 import de.fhg.fokus.sh.TransparentDataOutOfSync;
 import de.fhg.fokus.sh.UnableToComply;
 import de.fhg.fokus.sh.data.RepositoryData;
 import de.fhg.fokus.sh.data.ServiceData;
 import de.fhg.fokus.sh.data.ShData;
+import de.fhg.fokus.hss.util.*;
 
-
 /**
- * Contains all bussiness methods for repository data, like update or notify.
+ * Contains all bussiness methods for repository data (like update or notify).
  * @author Andre Charton (dev -at- open-ims dot org)
  */
-public class RepDataBO extends HssBO
-{
+public class RepDataBO{
     /** logger */
     private static final Logger LOGGER = Logger.getLogger(RepDataBO.class);
     /** sh specific repository data */
@@ -82,8 +84,7 @@
      * @param _apsvr Application Server
      * @param _userProfil User Profil contained assigned user
      */
-    public RepDataBO(ShData _shData, Apsvr _apsvr, ShUserProfil _userProfil)
-    {
+    public RepDataBO(ShData _shData, Apsvr _apsvr, ShUserProfil _userProfil){
         LOGGER.debug(&quot;entering&quot;);
         this.shData = _shData;
         this.apsvr = _apsvr;
@@ -92,7 +93,7 @@
     }
 
     /**
-     * It updates the repository data
+     * It +s the repository data
      *
      * @throws DiameterException
      */
@@ -124,21 +125,19 @@
             repDataPK.setSvcInd(serviceInd);
 
             RepData repData = null;
-            repData = (RepData) getSession().get(RepData.class, repDataPK);
+            Session session = HibernateUtil.getCurrentSession();
+            repData = (RepData) session.get(RepData.class, repDataPK);
 
             if ((repData == null) &amp;&amp; (bufRepData != null)){
                 // Create entry
                 LOGGER.debug(&quot;create&quot;);
 
                 if (sqn == 0){
-                    beginnTx();
                     repData = new RepData();
                     repData.setComp_id(repDataPK);
                     repData.setSqn(new Integer(0));
                     repData.setSvcData(bufRepData);
-                    
-                    getSession().save(repData);
-                    endTx();
+                    session.save(repData);
                 }
                 else{
                 	throw new TransparentDataOutOfSync();
@@ -151,39 +150,32 @@
                 if ((sqn - 1) == repData.getSqn().intValue()){
                 	repData.setSvcData(bufRepData);
                 	repData.setSqn(sqn);
-                	beginnTx();
-                	getSession().update(repData);
-                	endTx();
-                	commitShChanges(repData);
+                	session.update(repData);
+                	commitShChanges(repData, session);
                 }
                 else{
-                        LOGGER.warn(
-                            &quot;Repository-Data out of Sync! SH-SQN-1: &quot; + (sqn - 1)
-                            + &quot; versus HSS-SQN: &quot; + repData.getSqn().intValue());
-                        throw new TransparentDataOutOfSync();
+                	LOGGER.warn(&quot;Repository-Data out of Sync! SH-SQN-1: &quot; + (sqn - 1) + &quot; versus HSS-SQN: &quot; + 
+                			repData.getSqn().intValue());
+                	throw new TransparentDataOutOfSync();
                }
             }
              else if (repData != null &amp;&amp; bufRepData == null){
             	 LOGGER.debug(&quot;delete&quot;);
-                 commitShChanges(repData);
+                 commitShChanges(repData, session);
                  
                  // Delete
-                 beginnTx();
-                 getSession().delete(repData);
-                 endTx();
+                 session.delete(repData);
                  
             }
              else{
             	 // repository data is already null
             	 throw new UnableToComply();
              }
-            closeSession();
         }
         catch (IOException e){
             LOGGER.error(this, e);
             throw new UnableToComply();
         }
-
         LOGGER.debug(&quot;exiting&quot;);
     }
 
@@ -191,25 +183,20 @@
      * Commit changes to sh interface.
      * @param repData
      */
-    private void commitShChanges(RepData repData)
+    private void commitShChanges(RepData repData, Session session)
     {
         LOGGER.debug(&quot;entering&quot;);
 
-        //BUG, the repData is null after some time... NULLPointerException is sent!!!         
-        LOGGER.error(&quot;Notify: &quot; + repData.getNotifyRepDatas());
-
-        if (repData.getNotifyRepDatas().isEmpty() == false)
-        {
+        if (repData.getNotifyRepDatas().isEmpty() == false){
             Iterator it = repData.getNotifyRepDatas().iterator();
             ASshOperationsImpl operationsImpl = new ASshOperationsImpl();
 
-            while (it.hasNext())
-            {
+            while (it.hasNext()){
                 NotifyRepData notifyRepData = (NotifyRepData) it.next();
-                Apsvr notifApsvr = (Apsvr) getSession().get(Apsvr.class, notifyRepData.getComp_id().getApsvrId());
+                Apsvr notifApsvr = (Apsvr) session.get(Apsvr.class, notifyRepData.getComp_id().getApsvrId());
 
                 try{
-                    operationsImpl.shNotif(userProfil.getUri(), shData, notifApsvr.getName());
+                    operationsImpl.shNotif(userProfil.getUri(), shData, Util.getHost(notifApsvr.getAddress()));
                 }
                 catch (DiameterException e){
                     LOGGER.error(this, e);

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/model/ShUserProfil.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/model/ShUserProfil.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/model/ShUserProfil.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -105,7 +105,7 @@
     {
         LOGGER.debug(&quot;entering&quot;);
         this.uri = publicUserIdentity;
-        session = HibernateUtil.currentSession();
+        session = HibernateUtil.getCurrentSession();
         loadByPublicIdentity(publicUserIdentity);
         LOGGER.debug(&quot;exiting&quot;);
     }
@@ -229,8 +229,6 @@
     {
         LOGGER.debug(&quot;entering&quot;);
 
-        Transaction tx = session.beginTransaction();
-
         if (impi != null)
         {
             session.update(impi);
@@ -241,9 +239,6 @@
             session.update(impu);
         }
 
-        tx.commit();
-        session.flush();
-        HibernateUtil.closeSession();
         LOGGER.debug(&quot;exiting&quot;);
     }
 

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/model/SvpBO.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/model/SvpBO.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/model/SvpBO.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -54,13 +54,14 @@
 
 import de.fhg.fokus.cx.exceptions.DiameterException;
 import de.fhg.fokus.hss.server.cx.op.UpdateCxOperation;
+import de.fhg.fokus.hss.util.HibernateUtil;
 
 
 /**
  * This class provides database specific functions for service profiles
  * @author Andre Charton (dev -at- open-ims dot org)
  */
-public class SvpBO extends HssBO
+public class SvpBO
 {
     /** logger */
     private static final Logger LOGGER = Logger.getLogger(SvpBO.class);
@@ -83,7 +84,7 @@
      */
     public Svp load(Serializable primaryKey)
     {
-        Svp svp = (Svp) getSession().load(Svp.class, primaryKey);
+        Svp svp = (Svp) HibernateUtil.getCurrentSession().load(Svp.class, primaryKey);
         svp.addPropertyChangeListener(svp);
         return svp;
     }
@@ -95,21 +96,12 @@
      */
     public void saveOrUpdate(Svp svp)
     {
-        try
-        {
-            beginnTx();
-            getSession().saveOrUpdate(svp);
-            endTx();
+        HibernateUtil.getCurrentSession().saveOrUpdate(svp);
 
-            if (svp.isChange())
-            {
-                commitShChanges(svp);
-                commitCxChanges(svp);
-            }
-        }
-        finally
+        if (svp.isChange())
         {
-            closeSession();
+            commitShChanges(svp);
+            commitCxChanges(svp);
         }
     }
 
@@ -119,7 +111,7 @@
      */
     private void commitShChanges(Svp svp)
     {
-      
+      // to do
     }
 
     /**
@@ -130,43 +122,33 @@
     {
         LOGGER.debug(&quot;entering&quot;);
         CxUserProfil cxUserProfil = null;
-        try
-        {
+        
+        try{
             ArrayList operationsList = new ArrayList();
             Iterator itImpu = null;
 
             itImpu = svp.getImpus().iterator();
-
-            while (itImpu.hasNext())
-            {
+            while (itImpu.hasNext()){
                 Impu impu = (Impu) itImpu.next();
-                cxUserProfil =
-                    new CxUserProfil(impu, getSession());
+                cxUserProfil = new CxUserProfil(impu);
 
-                if (cxUserProfil.isRegistered())
-                {
-                    URI privateIdentity =
-                        new URI(cxUserProfil.getImpi().getImpiString());
-                    UpdateCxOperation cxOperation =
-                        new UpdateCxOperation(cxUserProfil, privateIdentity);
+                if (cxUserProfil.isRegistered()){
+                    URI privateIdentity = new URI(cxUserProfil.getImpi().getImpiString());
+                    UpdateCxOperation cxOperation = new UpdateCxOperation(cxUserProfil, privateIdentity);
                     operationsList.add(cxOperation);
                 }
             }
 
             Iterator it = operationsList.iterator();
-
-            while (it.hasNext())
-            {
+            while (it.hasNext()){
                 UpdateCxOperation cxOperation = (UpdateCxOperation) it.next();
                 cxOperation.execute();
             }
         }
-        catch (DiameterException e)
-        {
+        catch (DiameterException e){
             LOGGER.error(svp, e);
         }
-        catch (URISyntaxException e)
-        {
+        catch (URISyntaxException e){
             LOGGER.error(svp, e);
         }
 

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/model/TrigptBO.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/model/TrigptBO.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/model/TrigptBO.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -53,13 +53,14 @@
 import org.hibernate.Query;
 
 import de.fhg.fokus.cx.exceptions.DiameterException;
+import de.fhg.fokus.hss.util.HibernateUtil;
 
 
 /**
  * This class provides database specific functions for trigger point
  * @author Andre Charton (dev -at- open-ims dot org)
  */
-public class TrigptBO extends HssBO
+public class TrigptBO
 {
     /** logger */
     private static final Logger LOGGER = Logger.getLogger(Trigpt.class);
@@ -83,7 +84,7 @@
      */    
     public Trigpt load(Serializable primaryKey)
     {
-        Trigpt trigpt = (Trigpt) getSession().load(Trigpt.class, primaryKey);
+        Trigpt trigpt = (Trigpt) HibernateUtil.getCurrentSession().load(Trigpt.class, primaryKey);
         trigpt.addPropertyChangeListener(trigpt);
 
         return trigpt;
@@ -101,14 +102,11 @@
 
         try
         {
-            beginnTx();
-            getSession().saveOrUpdate(trigpt);
-            endTx();
+            HibernateUtil.getCurrentSession().saveOrUpdate(trigpt);
 
             if (trigpt.isChange())
             {
-                Query query =
-                    getSession().createQuery(
+                Query query = HibernateUtil.getCurrentSession().createQuery(
                         &quot;select ifc from de.fhg.fokus.hss.model.Ifc as ifc where ifc.trigpt.trigptId = ?&quot;);
                 query.setInteger(0, trigpt.getTrigptId());
 
@@ -128,10 +126,6 @@
         {
             LOGGER.error(TrigptBO.class, e);
         }
-        finally
-        {
-            closeSession();
-        }
 
         LOGGER.debug(&quot;exiting&quot;);
     }
@@ -150,8 +144,6 @@
         Iterator it = ifcList.iterator();
         IfcBO ifcBO = new IfcBO();
 
-        ifcBO.setSession(getSession());
-
         Ifc ifc = null;
 
         while (it.hasNext())

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/server/cx/CSCFOperationsImpl.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/server/cx/CSCFOperationsImpl.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/server/cx/CSCFOperationsImpl.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -65,11 +65,9 @@
  * @author Andre Charton (dev -at- open-ims dot org)
  */
 
-public class CSCFOperationsImpl implements CSCFOperations
-{
+public class CSCFOperationsImpl implements CSCFOperations{
     /** logger */
-    private static final Logger LOGGER =
-        Logger.getLogger(CSCFOperationsImpl.class);
+    private static final Logger LOGGER = Logger.getLogger(CSCFOperationsImpl.class);
 
     /**
      * It updates subscriber data. It is the implemenatation of PPR request which
@@ -81,15 +79,11 @@
      * @param _scscfName the name of serving call session control function
      * @throws DiameterException
      */
-    public void cxUpdateSubscriberData(
-        URI _privateUserIdentity, IMSSubscription _userData,
-        ChargingInfoSet _chargingInfoSet, String _scscfName)
-        throws DiameterException
-    {
-        LOGGER.debug(&quot;entering&quot;);
-        PPRCommandAction commandAction =
-            new PPRCommandAction(
-                _privateUserIdentity, _userData, _chargingInfoSet, _scscfName);
+    public void cxUpdateSubscriberData(URI _privateUserIdentity, IMSSubscription _userData,
+        ChargingInfoSet _chargingInfoSet, String _scscfName) throws DiameterException{
+        
+    	LOGGER.debug(&quot;entering&quot;);
+        PPRCommandAction commandAction = new PPRCommandAction(_privateUserIdentity, _userData, _chargingInfoSet, _scscfName);
         commandAction.execute();
         LOGGER.debug(&quot;exiting&quot;);
     }
@@ -104,12 +98,12 @@
      * @param scscfName the name of serving call session control function
      * @throws DiameterException
      */
-	 public void cxDeregister(DeregistrationSet deregistrationSet, DeregistrationReason deregistrationReason, String scscfName) throws DiameterException {
-			 LOGGER.debug(&quot;entering&quot;);
-       RTRCommandAction commandAction =
-           new RTRCommandAction(
-          		 deregistrationSet, deregistrationReason, scscfName);
-       commandAction.execute();
-       LOGGER.debug(&quot;exiting&quot;);
-		}
+	 public void cxDeregister(DeregistrationSet deregistrationSet, DeregistrationReason deregistrationReason, String scscfName) 
+	 	throws DiameterException {
+		 
+		 LOGGER.debug(&quot;entering&quot;);
+		 RTRCommandAction commandAction = new RTRCommandAction(deregistrationSet, deregistrationReason, scscfName);
+		 commandAction.execute();
+		 LOGGER.debug(&quot;exiting&quot;);
+	}
 }

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/server/cx/HSScxOperationsImpl.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/server/cx/HSScxOperationsImpl.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/server/cx/HSScxOperationsImpl.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -71,10 +71,8 @@
  *
  * @author Andre Charton (dev -at- open-ims dot org)
  */
-public class HSScxOperationsImpl implements HSScxOperations
-{
-    private static final Logger LOGGER =
-        Logger.getLogger(HSScxOperationsImpl.class);
+public class HSScxOperationsImpl implements HSScxOperations{
+    private static final Logger LOGGER = Logger.getLogger(HSScxOperationsImpl.class);
 
     /**
      * Implementation of the UAR/UAA.
@@ -85,21 +83,14 @@
      * @return response object contains all UAA values
      * @throws DiameterException
      */
-    public CxUserRegistrationStatusResponse cxQuery(
-        PublicIdentity publicIdentity, String visitedNetworkIdentifier,
-        int typeOfAuthorization, URI privateUserIdentity)
-        throws DiameterException
-    {
-        LOGGER.debug(&quot;entering&quot;);
+    public CxUserRegistrationStatusResponse cxQuery(PublicIdentity publicIdentity, String visitedNetworkIdentifier,
+        int typeOfAuthorization, URI privateUserIdentity) throws DiameterException {
 
-        QueryCxOperation query =
-            new QueryCxOperation(
-                publicIdentity, visitedNetworkIdentifier, typeOfAuthorization,
+    	LOGGER.debug(&quot;entering&quot;);
+        QueryCxOperation query = new QueryCxOperation(publicIdentity, visitedNetworkIdentifier, typeOfAuthorization,
                 privateUserIdentity);
-        CxUserRegistrationStatusResponse response =
-            (CxUserRegistrationStatusResponse) query.execute();
+        CxUserRegistrationStatusResponse response = (CxUserRegistrationStatusResponse) query.execute();
         LOGGER.debug(&quot;exiting&quot;);
-
         return response;
     }
 
@@ -115,23 +106,16 @@
      * @return response object contains all SAA values
      * @throws DiameterException
      */
-    public CxSCSCFNotificationResponse cxPull(
-        PublicIdentity publicIdentity, String serverName,
-        URI privateUserIdentity, int serverAssignmentType,
-        int userDataRequestType, int userDataAlreadyAvailable)
-        throws DiameterException
-    {
+    public CxSCSCFNotificationResponse cxPull(PublicIdentity publicIdentity, String serverName, 
+    		URI privateUserIdentity, int serverAssignmentType, int userDataRequestType, int userDataAlreadyAvailable)
+        throws DiameterException{
+    	
         LOGGER.debug(&quot;entering&quot;);
+        PullCxOperation pullCxOperation = new PullCxOperation(publicIdentity, serverName, privateUserIdentity,
+        		serverAssignmentType, userDataRequestType,userDataAlreadyAvailable);
+        CxSCSCFNotificationResponse response = (CxSCSCFNotificationResponse) pullCxOperation.execute();
 
-        PullCxOperation pullCxOperation =
-            new PullCxOperation(
-                publicIdentity, serverName, privateUserIdentity,
-                serverAssignmentType, userDataRequestType,
-                userDataAlreadyAvailable);
-        CxSCSCFNotificationResponse response =
-            (CxSCSCFNotificationResponse) pullCxOperation.execute();
         LOGGER.debug(&quot;exiting&quot;);
-
         return response;
     }
 
@@ -141,17 +125,12 @@
      * @return response object contains all LIA values
      * @throws DiameterException
      */
-    public CxLocationQueryResponse cxLocationQuery(
-        PublicIdentity publicIdentity) throws DiameterException
-    {
-        LOGGER.debug(&quot;entering&quot;);
+    public CxLocationQueryResponse cxLocationQuery(PublicIdentity publicIdentity) throws DiameterException{
 
-        LocationCxOperation locationCxOperation =
-            new LocationCxOperation(publicIdentity);
-        CxLocationQueryResponse response =
-            (CxLocationQueryResponse) locationCxOperation.execute();
+    	LOGGER.debug(&quot;entering&quot;);
+        LocationCxOperation locationCxOperation = new LocationCxOperation(publicIdentity);
+        CxLocationQueryResponse response = (CxLocationQueryResponse) locationCxOperation.execute();
         LOGGER.debug(&quot;exiting&quot;);
-
         return response;
     }
 
@@ -165,21 +144,14 @@
      * @return response object contains all MAA values
      * @throws DiameterException
      */
-    public CxAuthDataResponse cxAuthData(
-        PublicIdentity publicIdentity, URI privateUserIdentity,
-        Long numberOfAuthVectors, AuthenticationVector authenticationVector,
-        String scscfName) throws DiameterException
-    {
-        LOGGER.debug(&quot;entering&quot;);
-
+    public CxAuthDataResponse cxAuthData(PublicIdentity publicIdentity, URI privateUserIdentity,
+        Long numberOfAuthVectors, AuthenticationVector authenticationVector, String scscfName) throws DiameterException{
+        
+    	LOGGER.debug(&quot;entering&quot;);
         AuthCxOperation authCxOperation =
-            new AuthCxOperation(
-                publicIdentity, privateUserIdentity, numberOfAuthVectors,
-                authenticationVector, scscfName);
-        CxAuthDataResponse response =
-            (CxAuthDataResponse) authCxOperation.execute();
+            new AuthCxOperation(publicIdentity, privateUserIdentity, numberOfAuthVectors, authenticationVector, scscfName);
+        CxAuthDataResponse response = (CxAuthDataResponse) authCxOperation.execute();
         LOGGER.debug(&quot;exiting&quot;);
-
         return response;
     }
 }

Deleted: FHoSS/trunk/src/de/fhg/fokus/hss/server/cx/TestSubscibtion.java

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/server/cx/op/AuthCxOperation.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/server/cx/op/AuthCxOperation.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/server/cx/op/AuthCxOperation.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -57,7 +57,9 @@
 import de.fhg.fokus.cx.datatypes.PublicIdentity;
 import de.fhg.fokus.cx.exceptions.DiameterException;
 import de.fhg.fokus.cx.exceptions.base.UnableToComply;
+import de.fhg.fokus.hss.diam.Constants;
 import de.fhg.fokus.hss.diam.ResultCode;
+import de.fhg.fokus.hss.form.ImpiForm;
 import de.fhg.fokus.hss.main.HSSProperties;
 import de.fhg.fokus.hss.model.Impi;
 
@@ -80,11 +82,10 @@
  * @author Andre Charton  (dev -at- open-ims dot org)
  * 
  */
-public class AuthCxOperation extends CxOperation
-{
+
+public class AuthCxOperation extends CxOperation{
     /** Logger */
-    private static final Logger LOGGER =
-        Logger.getLogger(AuthCxOperation.class);
+    private static final Logger LOGGER = Logger.getLogger(AuthCxOperation.class);
     /** name of serving call session control function */    
     private String scscfName;
     /** authentication vector */
@@ -101,8 +102,7 @@
      * @param _scscfName serving call session control functions name
      */     
     public AuthCxOperation( PublicIdentity _publicIdentity, URI _privateUserIdentity,
-        Long _numberOfAuthVectors, AuthenticationVector _authenticationVector,
-        String _scscfName){
+        Long _numberOfAuthVectors, AuthenticationVector _authenticationVector, String _scscfName){
     	
         this.privateUserIdentity = _privateUserIdentity;
         this.publicIdentity = _publicIdentity;
@@ -129,6 +129,7 @@
         CxAuthDataResponse authDataResponse = null;
 
         try{
+        	HibernateUtil.beginTransaction();
             loadUserProfile();
             if (userProfil.getImpi().getScscfName().equals(scscfName) == false){
                 userProfil.getImpi().setScscfName(scscfName);
@@ -138,22 +139,22 @@
             ArrayList authenticationVectors = null;
 
             // Generate the Authentiaction Vectors
-            if (authenticationVector != null){
+            if (authenticationVector != null &amp;&amp; authenticationVector.sipAuthorization != null){
                 // perform synchronization for the SQN (SQN-hn = SQN-ms)
                 authenticationVectors = performSynchronization();
             }
             else{
                 // generate the authentication vectors
-                authenticationVectors = generateAuthenticationVectors();
+                authenticationVectors = generateAuthenticationVectors(authenticationVector);
             }
             authDataResponse = new CxAuthDataResponse(ResultCode._DIAMETER_SUCCESS, true);
             authDataResponse.setAuthenticationVectors(authenticationVectors);
             updateUserProfile();
+            
         }
         finally{
-        	if(getUserProfil() != null){
-        		getUserProfil().closeSession();
-        	}
+        	HibernateUtil.commitTransaction();
+        	HibernateUtil.closeSession();
         }
 
         return authDataResponse;
@@ -163,7 +164,7 @@
      * This method generates the list of the authentication vectors
      * @return list of authentication vectors
      */
-    public ArrayList generateAuthenticationVectors(){
+    public ArrayList generateAuthenticationVectors(AuthenticationVector receivedAuthVector){
         LOGGER.debug(&quot;Generation of Authentication Vectors&quot;);
         ArrayList vectorList = null;
         Impi impi = null;
@@ -181,13 +182,29 @@
             byte [] op = codec.decode(impi.getOperatorId());
             byte [] opC = Milenage.generateOpC(secretKey, op);
             
-            String authScheme = impi.getAuthScheme();
+            String supportedAuthScheme = impi.getAuthScheme();
             Inet4Address ip = impi.getIP();
             byte [] sqn = codec.decode(impi.getSqn());
 
-            LOGGER.debug(&quot;Auth-Scheme Used: &quot; + authScheme);
+            LOGGER.debug(&quot;Auth-Scheme Supported by the HSS: &quot; + supportedAuthScheme);
+            String usedAuthScheme;
+            if (receivedAuthVector != null &amp;&amp; receivedAuthVector.authenticationScheme != null){
+            	LOGGER.debug(&quot;Auth-Scheme asked by S-CSCF: &quot; + receivedAuthVector.authenticationScheme);
+            	usedAuthScheme = receivedAuthVector.authenticationScheme;
+            	if (supportedAuthScheme.equalsIgnoreCase(&quot;any&quot;) == false &amp;&amp; supportedAuthScheme.equalsIgnoreCase(usedAuthScheme) == false){
+            		throw new NoSuchAlgorithmException();
+            	}
+            }
+            else{
+            	usedAuthScheme = supportedAuthScheme;
+            	if (usedAuthScheme.equalsIgnoreCase(&quot;any&quot;)){
+            		// the default one
+            		usedAuthScheme = Constants.AuthScheme.AUTH_SCHEME_AKAv1;
+            	}
+            }
+            
             // MD5 Authentication Scheme
-            if (authScheme.equalsIgnoreCase(&quot;Digest-MD5&quot;)){
+            if (usedAuthScheme.equalsIgnoreCase(&quot;Digest-MD5&quot;)){
             	// Authentication Scheme is Digest-MD5
             	LOGGER.debug(&quot;Auth-Scheme is Digest-MD5&quot;);
                 SecureRandom randomAccess = SecureRandom.getInstance(&quot;SHA1PRNG&quot;);
@@ -199,18 +216,18 @@
                     
                 	secretKey = codec.decodePassword(impi.getSkey()).getBytes();
                 	
-                	AuthenticationVector aVector = new AuthenticationVector(authScheme, randBytes, secretKey);
+                	AuthenticationVector aVector = new AuthenticationVector(usedAuthScheme, randBytes, secretKey);
                 	vectorList.add(aVector);
                 }
             	markUpdateUserProfile();
             	return vectorList;
             }
-            else{
+            else if (usedAuthScheme.equalsIgnoreCase(Constants.AuthScheme.AUTH_SCHEME_AKAv1) || 
+            		usedAuthScheme.equalsIgnoreCase(Constants.AuthScheme.AUTH_SCHEME_AKAv2)){
             	// We have AKAv1 or AKAv2
             	LOGGER.debug(&quot;Auth-Scheme is Digest-AKA&quot;);
             	
-                for (long ix = 0; ix &lt; numberOfAuthVectors.intValue(); ix++)
-                {
+                for (long ix = 0; ix &lt; numberOfAuthVectors.intValue(); ix++){
                 	sqn = DigestAKA.getNextSQN(sqn, HSSProperties.IND_LEN);
         	        byte[] copySqnHe = new byte[6];
         	        int k = 0;
@@ -218,13 +235,16 @@
                 		copySqnHe[k] = sqn[i]; 
         	        }
 
-                	AuthenticationVector authenticationVector = DigestAKA.getAuthenticationVector(authScheme, ip,
+                	AuthenticationVector authenticationVector = DigestAKA.getAuthenticationVector(usedAuthScheme, ip,
                 			secretKey, opC, amf, copySqnHe);
                     vectorList.add(authenticationVector);
                 }
                 impi.setSqn(codec.encode(sqn));
                 markUpdateUserProfile();
             }
+            else throw new NoSuchAlgorithmException(&quot;The &quot; + usedAuthScheme + &quot; scheme is not supported on the HSS!&quot;);
+            
+            /* EarlyIMS to be implemented ...*/
         }
         catch (NoSuchAlgorithmException e){
             LOGGER.error(this, e);

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/server/cx/op/CxOperation.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/server/cx/op/CxOperation.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/server/cx/op/CxOperation.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -85,21 +85,16 @@
      * @param evt property change event
      */
     
-    public void propertyChange(PropertyChangeEvent evt)
-    {
+    public void propertyChange(PropertyChangeEvent evt){
         LOGGER.debug(&quot;entering&quot;);
 
-        try
-        {
-            UpdateCxOperation cxOperation =
-                new UpdateCxOperation(getUserProfil(), privateUserIdentity);
+        try{
+            UpdateCxOperation cxOperation = new UpdateCxOperation(getUserProfil(), privateUserIdentity);
             cxOperation.execute();
         }
-        catch (DiameterException e)
-        {
+        catch (DiameterException e){
             LOGGER.error(this, e);
         }
-
         LOGGER.debug(&quot;exiting&quot;);
     }
 
@@ -107,8 +102,7 @@
      * It adds property change listener
      * @param l property change listener
      */
-    public void addPropertyChangeListener(PropertyChangeListener l)
-    {
+    public void addPropertyChangeListener(PropertyChangeListener l){
         changeSupport.addPropertyChangeListener(l);
     }
 
@@ -116,8 +110,7 @@
      * It removes property change listener
      * @param l property change listener
      */
-    public void removePropertyChangeListener(PropertyChangeListener l)
-    {
+    public void removePropertyChangeListener(PropertyChangeListener l){
         changeSupport.removePropertyChangeListener(l);
     }
 
@@ -125,10 +118,8 @@
      * It is string converter
      * @return converted string
      */
-    public String toString()
-    {
-        return ToStringBuilder.reflectionToString(
-            this, ToStringStyle.MULTI_LINE_STYLE);
+    public String toString(){
+        return ToStringBuilder.reflectionToString(this, ToStringStyle.MULTI_LINE_STYLE);
     }
 
     /**
@@ -143,26 +134,21 @@
      * @throws IdentitiesDontMatch
      * @throws DiameterException
      */
-    protected void loadUserProfile()
-        throws IdentitiesDontMatch, DiameterException
-    {
-        if ((privateUserIdentity != null) &amp;&amp; (publicIdentity != null))
-        {
+    protected void loadUserProfile()throws IdentitiesDontMatch, DiameterException{
+    	
+        if ((privateUserIdentity != null) &amp;&amp; (publicIdentity != null)){
             userProfil = new CxUserProfil(privateUserIdentity, publicIdentity);
         }
-        else if (publicIdentity != null)
-        {
+        else if (publicIdentity != null){
             userProfil = new CxUserProfil(publicIdentity);
         }
-        else
-        {
+        else{
             throw new MissingUserId();
         }
 
         // Check whether the public identity received in the request 
         // is barred for the establishment of multimedia sessions.
-        if (getUserProfil().isBarred() == true)
-        {
+        if (getUserProfil().isBarred() == true){
             throw new BaseAuthorizationRejected();
         }
     }
@@ -171,8 +157,7 @@
      * Markup user profil update flag.
      *
      */
-    protected void markUpdateUserProfile()
-    {
+    protected void markUpdateUserProfile(){
         needUpdate = true;
     }
 
@@ -180,10 +165,8 @@
      * Update user profil if flag is set to true.
      *
      */
-    protected void updateUserProfile()
-    {
-        if (needUpdate == true)
-        {
+    protected void updateUserProfile(){
+        if (needUpdate == true){
             userProfil.update();
         }
     }
@@ -192,8 +175,7 @@
     * Getter method for user profile
     * @return the user profile
     */
-    public CxUserProfil getUserProfil()
-    {
+    public CxUserProfil getUserProfil(){
         return userProfil;
     }
 
@@ -201,8 +183,7 @@
     * Setter method for user profile
     * @param userProfil the user profile
     */
-    public void setUserProfil(CxUserProfil userProfil)
-    {
+    public void setUserProfil(CxUserProfil userProfil){
         this.userProfil = userProfil;
     }
 }

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/server/cx/op/DeregisterCxOperation.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/server/cx/op/DeregisterCxOperation.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/server/cx/op/DeregisterCxOperation.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -80,21 +80,26 @@
      * @param reason deregistartion reason object
      */ 	
 	public DeregisterCxOperation(CxUserProfil _userProfil, DeregistrationReason reason){
+		
 		LOGGER.debug(&quot;entering&quot;);
 		this.userProfil = _userProfil;
 		this.scscfName = userProfil.getImpi().getScscfName();
 		this.reason = reason;
+		
 		try {
 			this.privateUserIdentity = new URI(_userProfil.getImpi().getImpiString());
-		} catch (URISyntaxException e) {
+		}
+		catch (URISyntaxException e) {
 			LOGGER.error(this, e);
 		}
 		deregistrationSet = new DeregistrationSet(privateUserIdentity);
+		
 		Iterator it = _userProfil.getImpuList().iterator();
 		while(it.hasNext()){
 			Impu impu = (Impu) it.next();
 			deregistrationSet.addPublicId(impu.getSipUrl());
 		}
+		
 		LOGGER.debug(&quot;exiting&quot;);
 	}
 
@@ -108,7 +113,6 @@
 		CSCFOperations operations = new CSCFOperationsImpl();
 		PublicIdentity publicIdentity = new PublicIdentity();
 		publicIdentity.setIdentity(userProfil.getImpu().getSipUrl());
-		
 		operations.cxDeregister(deregistrationSet, reason, scscfName);
 		LOGGER.debug(&quot;exiting&quot;);
 		return null;

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/server/cx/op/LocationCxOperation.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/server/cx/op/LocationCxOperation.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/server/cx/op/LocationCxOperation.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -52,6 +52,7 @@
 import de.fhg.fokus.cx.exceptions.DiameterException;
 import de.fhg.fokus.cx.exceptions.ims.IdentityNotRegistered;
 import de.fhg.fokus.hss.diam.ResultCode;
+import de.fhg.fokus.hss.util.HibernateUtil;
 
 
 /**
@@ -59,17 +60,14 @@
  *
  * @author Andre Charton (dev -at- open-ims dot org)
  */
-public class LocationCxOperation extends CxOperation
-{
+public class LocationCxOperation extends CxOperation{
     /** logger */
-    private static final Logger LOGGER =
-        Logger.getLogger(LocationCxOperation.class);
+    private static final Logger LOGGER = Logger.getLogger(LocationCxOperation.class);
     /**
      * constructor
      * @param publicIdentity public user identity
      */
-    public LocationCxOperation(PublicIdentity publicIdentity)
-    {
+    public LocationCxOperation(PublicIdentity publicIdentity){
         LOGGER.debug(&quot;entering&quot;);
         this.publicIdentity = publicIdentity;
         LOGGER.debug(&quot;exiting&quot;);
@@ -80,10 +78,8 @@
      * @return an object containing the location information
      * @throws DiameterException
      */	   
-    public Object execute() throws DiameterException
-    {
-        if (LOGGER.isDebugEnabled())
-        {
+    public Object execute() throws DiameterException{
+        if (LOGGER.isDebugEnabled()){
             LOGGER.debug(&quot;entering&quot;);
             LOGGER.debug(this);
         }
@@ -92,43 +88,32 @@
 
         try
         {
+        	HibernateUtil.beginTransaction();
             loadUserProfile();
-
             String serverName = null;
 
-            if (getUserProfil().getImpu().getPsi())
-            {
-                serverName =
-                    getUserProfil().getImpu().getAssignedPsi().getPsiTempl()
-                        .getApsvr().getAddress();
+            if (getUserProfil().getImpu().getPsi()){
+                serverName = getUserProfil().getImpu().getAssignedPsi().getPsiTempl().getApsvr().getAddress();
             }
-            else
-            {
-                if (getUserProfil().getImpi() != null)
-                {
+            else{
+                if (getUserProfil().getImpi() != null){
                     serverName = getUserProfil().getImpi().getScscfName();
                 }
             }
 
-            if (serverName != null &amp;&amp; serverName.equals(&quot;&quot;) == false)
-            {
-                locationQueryResponse =
-                    new CxLocationQueryResponse(
-                        ResultCode._DIAMETER_SUCCESS, true);
-
+            if (serverName != null &amp;&amp; serverName.equals(&quot;&quot;) == false){
+                locationQueryResponse = new CxLocationQueryResponse(ResultCode._DIAMETER_SUCCESS, true);
                 locationQueryResponse.setAssignedSCSCFName(serverName);
             }
-            else
-            {
+            else{
             	LOGGER.info(&quot;User not registered, sending LIA: DIAMETER_ERROR_IDENTITY_NOT_REGISTERED !&quot;);
             	throw new IdentityNotRegistered();
             }
+            
         }
-        finally
-        {
-        	if(getUserProfil() != null){
-            getUserProfil().closeSession();
-        	}
+        finally{
+        	HibernateUtil.commitTransaction();
+        	HibernateUtil.closeSession();	
         }
 
         LOGGER.debug(&quot;exiting&quot;);

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/server/cx/op/PullCxOperation.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/server/cx/op/PullCxOperation.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/server/cx/op/PullCxOperation.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -70,6 +70,7 @@
 import de.fhg.fokus.hss.model.Impu;
 import de.fhg.fokus.hss.model.Psi;
 import de.fhg.fokus.hss.model.PsiBO;
+import de.fhg.fokus.hss.util.HibernateUtil;
 
 
 /**
@@ -98,15 +99,12 @@
      * @param _privateUserIdentity private user identity
      * @param _serverAssignmentType type of server assignment
      * @param _userDataRequestType type of user data request
-     * @param _userDataAlreadyAvailable an int value for the availability or 
-     *                                  unavailability of user data
+     * @param _userDataAlreadyAvailable an int value for the availability or unavailability of user data
      */ 
-    public PullCxOperation(
-        PublicIdentity _publicIdentity, String _serverName,
-        URI _privateUserIdentity, int _serverAssignmentType,
-        int _userDataRequestType, int _userDataAlreadyAvailable)
-    {
-        LOGGER.debug(&quot;entering&quot;);
+    public PullCxOperation( PublicIdentity _publicIdentity, String _serverName,
+        URI _privateUserIdentity, int _serverAssignmentType, int _userDataRequestType, int _userDataAlreadyAvailable){
+        
+    	LOGGER.debug(&quot;entering&quot;);
         this.publicIdentity = _publicIdentity;
         this.privateUserIdentity = _privateUserIdentity;
         this.serverName = _serverName;
@@ -122,46 +120,38 @@
      * @return an object providing SAA specific information 
      * @throws DiameterException
      */	
-    public Object execute() throws DiameterException
-    {
-        if (LOGGER.isDebugEnabled())
-        {
+    public Object execute() throws DiameterException{
+        if (LOGGER.isDebugEnabled()){
             LOGGER.debug(&quot;entering&quot;);
             LOGGER.debug(this);
         }
 
         CxSCSCFNotificationResponse notificationResponse = null;
-
-        try
-        {
+        try{
+        	HibernateUtil.beginTransaction();
             loadUserProfile();
             Impu impu1=getUserProfil().getImpu();
             String impu_status=impu1.getUserStatus();
+            
     	    if(impu_status.equals(impu1.USER_STATUS_NOT_REGISTERED))
-                    LOGGER.info(&quot;The current status of IMPU &quot;+ publicIdentity.getIdentity() +&quot; is &quot;
-                                 +&quot;not registered&quot;); 
+                    LOGGER.info(&quot;The current status of IMPU &quot;+ publicIdentity.getIdentity() +&quot; is not registered&quot;); 
             else if(impu_status.equals(impu1.USER_STATUS_REGISTERED))
-                    LOGGER.info(&quot;The current status of IMPU &quot;+ publicIdentity.getIdentity() +&quot; is &quot;
-                                 +&quot;registered&quot;);
+                    LOGGER.info(&quot;The current status of IMPU &quot;+ publicIdentity.getIdentity() +&quot; is registered&quot;);
             else if(impu_status.equals(impu1.USER_STATUS_UNREGISTERED))
-                    LOGGER.info(&quot;The current status of IMPU &quot;+ publicIdentity.getIdentity() +&quot; is &quot;
-                                 +&quot;unregistered&quot;);            
+                    LOGGER.info(&quot;The current status of IMPU &quot;+ publicIdentity.getIdentity() +&quot; is unregistered&quot;);            
 
-            if (getUserProfil().getImpu().getPsi() == true)
-            {
+            if (getUserProfil().getImpu().getPsi() == true){
                 // Look if Public User is PSI
                 notificationResponse = handlePSI();
             }
-            else
-            {
+            else{
                 notificationResponse = handleUserProfil();
             }
+            
         }
-        finally
-        {
-        	if(getUserProfil() != null){
-            getUserProfil().closeSession();
-        	}
+        finally{
+        	HibernateUtil.commitTransaction();
+        	HibernateUtil.closeSession();	
         }
 
         return notificationResponse;
@@ -174,154 +164,99 @@
      * @throws IdentitiesDontMatch
      */
     private CxSCSCFNotificationResponse handleUserProfil()
-        throws IdentitiesDontMatch, DiameterException
-    {
+        throws IdentitiesDontMatch, DiameterException{
+    	
         CxSCSCFNotificationResponse notificationResponse = null;
-
         boolean needUserProfil = false;
 
-        if (serverAssignmentType == ServerAssignmentTypeAVP._UNREGISTERED_USER)
-        {
-            userProfil.getImpu().setUserStatus(Impu.USER_STATUS_UNREGISTERED);
+        if (serverAssignmentType == ServerAssignmentTypeAVP._UNREGISTERED_USER){
+            
+        	userProfil.getImpu().setUserStatus(Impu.USER_STATUS_UNREGISTERED);
             userProfil.getImpi().setScscfName(serverName);
             markUpdateUserProfile();
-            LOGGER.info(&quot;user status of &quot;+userProfil.getImpu().getSipUrl()+&quot; set to unregistered&quot;);
+            LOGGER.info(&quot;User status of &quot; + userProfil.getImpu().getSipUrl()+&quot; set to unregistered&quot;);
             needUserProfil = true;
         }
-        else if (
-            (serverAssignmentType == ServerAssignmentTypeAVP._REGISTRATION)
-                || (
-                    serverAssignmentType == ServerAssignmentTypeAVP._RE_REGISTRATION
-                ))
-        {
+        else if ((serverAssignmentType == ServerAssignmentTypeAVP._REGISTRATION)
+                || (serverAssignmentType == ServerAssignmentTypeAVP._RE_REGISTRATION)){
+        	
             userProfil.getImpu().setUserStatus(Impu.USER_STATUS_REGISTERED);
             userProfil.getImpi().setScscfName(serverName);
             markUpdateUserProfile();
             LOGGER.info(&quot;user status of &quot;+userProfil.getImpu().getSipUrl()+&quot; set to registered&quot;);
             needUserProfil = true;
         }
-        else if (
-            (
-                    serverAssignmentType == ServerAssignmentTypeAVP._TIMEOUT_DEREGISTRATION
-                )
-                || (
-                    serverAssignmentType == ServerAssignmentTypeAVP._USER_DEREGISTRATION
-                )
-                || (
-                    serverAssignmentType == ServerAssignmentTypeAVP._DEREGISTRATION_TOO_MUCH_DATA
-                )
-                || (
-                    serverAssignmentType == ServerAssignmentTypeAVP._ADMINISTRATIVE_DEREGISTRATION
-                ))
-        {
-            if (
-                (
-                        userProfil.getImpu().getUserStatus().equals(
-                            Impu.USER_STATUS_REGISTERED)
-                    )
-                    || (
-                        userProfil.getImpu().getUserStatus().equals(
-                            Impu.USER_STATUS_UNREGISTERED)
-                    ))
-            {
-                if (userProfil.getImpu().getImpis().size() == 1)
-                {
-                    userProfil.getImpu().setUserStatus(
-                        Impu.USER_STATUS_NOT_REGISTERED);
+        else if ((serverAssignmentType == ServerAssignmentTypeAVP._TIMEOUT_DEREGISTRATION)
+                || (serverAssignmentType == ServerAssignmentTypeAVP._USER_DEREGISTRATION)
+                || (serverAssignmentType == ServerAssignmentTypeAVP._DEREGISTRATION_TOO_MUCH_DATA)
+                || (serverAssignmentType == ServerAssignmentTypeAVP._ADMINISTRATIVE_DEREGISTRATION)){
+        	
+            if ((userProfil.getImpu().getUserStatus().equals(Impu.USER_STATUS_REGISTERED))
+                    || (userProfil.getImpu().getUserStatus().equals(Impu.USER_STATUS_UNREGISTERED))){
+            	
+                if (userProfil.getImpu().getImpis().size() == 1){
+                    userProfil.getImpu().setUserStatus(Impu.USER_STATUS_NOT_REGISTERED);
                     userProfil.getImpi().setScscfName(&quot;&quot;);
                     LOGGER.info(&quot;user status of &quot;+userProfil.getImpu().getSipUrl()+&quot; set to not registered&quot;);
                     markUpdateUserProfile();
                 }
-                else
-                {
-                    LOGGER.info(
-                        &quot;user status not updated, because impu assigned to multiple impis&quot;);
+                else{
+                    LOGGER.info(&quot;user status not updated, because impu assigned to multiple impis&quot;);
                 }
 
                 needUserProfil = false;
             }
         }
-        else if (
-            (
-                    serverAssignmentType == ServerAssignmentTypeAVP._TIMEOUT_DEREGISTRATION_STORE_SERVER_NAME
-                )
-                || (
-                    serverAssignmentType == ServerAssignmentTypeAVP._USER_DEREGISTRATION_STORE_SERVER_NAME
-                ))
-        {
-            if (userProfil.getImpu().getImpis().size() == 1)
-            {
-                userProfil.getImpu().setUserStatus(
-                    Impu.USER_STATUS_UNREGISTERED);
+        else if ((serverAssignmentType == ServerAssignmentTypeAVP._TIMEOUT_DEREGISTRATION_STORE_SERVER_NAME)
+                || (serverAssignmentType == ServerAssignmentTypeAVP._USER_DEREGISTRATION_STORE_SERVER_NAME)){
+            
+        	if (userProfil.getImpu().getImpis().size() == 1){
+                userProfil.getImpu().setUserStatus(Impu.USER_STATUS_UNREGISTERED);
                 LOGGER.info(&quot;user status of &quot;+userProfil.getImpu().getSipUrl()+&quot; set to unregistered&quot;);
                 markUpdateUserProfile();
             }
 
             needUserProfil = false;
         }
-        else if (serverAssignmentType == ServerAssignmentTypeAVP._NO_ASSIGNMENT)
-        {
-            if (userProfil.getImpi().getScscfName().equals(serverName))
-            {
+        else if (serverAssignmentType == ServerAssignmentTypeAVP._NO_ASSIGNMENT){
+            if (userProfil.getImpi().getScscfName().equals(serverName)){
                 needUserProfil = true;
             }
-            else
-            {
+            else{
                 throw new UnableToComply();
             }
         }
-        else if (
-            (
-                    serverAssignmentType == ServerAssignmentTypeAVP._AUTHENTICATION_FAILURE
-                )
-                || (
-                    serverAssignmentType == ServerAssignmentTypeAVP._AUTHENTICATION_TIMEOUT
-                ))
-        {
-            if (userProfil.getImpu() != null)
-            {
-                userProfil.getImpu().setUserStatus(
-                    Impu.USER_STATUS_NOT_REGISTERED);
+        else if ((serverAssignmentType == ServerAssignmentTypeAVP._AUTHENTICATION_FAILURE)
+                || (serverAssignmentType == ServerAssignmentTypeAVP._AUTHENTICATION_TIMEOUT)){
+            
+        	if (userProfil.getImpu() != null){
+                userProfil.getImpu().setUserStatus(Impu.USER_STATUS_NOT_REGISTERED);
                 markUpdateUserProfile();
                 LOGGER.info(&quot;user status of &quot;+userProfil.getImpu().getSipUrl()+&quot; set to not registered&quot;);
             }
-            else
-            {
+            else{
                 Iterator it = userProfil.getImpuList().iterator();
-
-                while (it.hasNext())
-                {
+                while (it.hasNext()){
                     Impu next = (Impu) it.next();
                     next.setUserStatus(Impu.USER_STATUS_NOT_REGISTERED);
                 }
-
                 markUpdateUserProfile();
             }
         }
-
-        notificationResponse =
-            new CxSCSCFNotificationResponse(ResultCode._DIAMETER_SUCCESS, true);
-
-        if (needUserProfil == true)
-        {
+        notificationResponse = new CxSCSCFNotificationResponse(ResultCode._DIAMETER_SUCCESS, true);
+        if (needUserProfil == true){
             // Store the private user identity
-            try
-            {
-                notificationResponse.setPrivateUserIdentity(
-                    new URI(userProfil.getImpi().getImpiString()));
+            try{
+                notificationResponse.setPrivateUserIdentity(new URI(userProfil.getImpi().getImpiString()));
             }
-            catch (URISyntaxException e)
-            {
+            catch (URISyntaxException e){
                 throw new UnableToComply();
             }
-
             // Download the user profile and the charging functions
-            notificationResponse.setUserProfile(
-                userProfil.getIMSSubscription(), userProfil.getChargingInfoSet());
+            notificationResponse.setUserProfile(userProfil.getIMSSubscription(), userProfil.getChargingInfoSet());
         }
 
         updateUserProfile();
-
         return notificationResponse;
     }
 
@@ -335,11 +270,9 @@
         LOGGER.debug(&quot;entering&quot;);
 
         CxSCSCFNotificationResponse notificationResponse = null;
-
         Psi psi = getUserProfil().getImpu().getAssignedPsi();
         Apsvr apsvr = psi.getPsiTempl().getApsvr();
-        notificationResponse =
-            new CxSCSCFNotificationResponse(ResultCode._DIAMETER_SUCCESS);
+        notificationResponse = new CxSCSCFNotificationResponse(ResultCode._DIAMETER_SUCCESS);
 
         IMSSubscription subscription = new IMSSubscription();
         subscription.setPrivateID(PsiBO.DEFAULT_PSI_IMPI.getPath());
@@ -356,13 +289,13 @@
         
         switch (apsvr.getDefaultHandling()){
         
-        case TDefaultHandling.VALUE_0_TYPE:
-        	applicationServer.setDefaultHandling(TDefaultHandling.VALUE_0);
-        	break;
+        	case TDefaultHandling.VALUE_0_TYPE:
+        		applicationServer.setDefaultHandling(TDefaultHandling.VALUE_0);
+        		break;
 
-        case TDefaultHandling.VALUE_1_TYPE:
-        	applicationServer.setDefaultHandling(TDefaultHandling.VALUE_1);
-        	break;
+        	case TDefaultHandling.VALUE_1_TYPE:
+        		applicationServer.setDefaultHandling(TDefaultHandling.VALUE_1);
+        		break;
         }
         
         //applicationServer.setDefaultHandling((byte) apsvr.getDefaultHandling());
@@ -383,12 +316,10 @@
         subscription.addServiceProfile(serviceProfile);
         notificationResponse.setPrivateUserIdentity(PsiBO.DEFAULT_PSI_IMPI);
 
-        ChargingInfoSet chargingInfoSet =
-            new ChargingInfoSet(PsiBO.DEFAULT_PRI_COLL_CHRG_FN);
+        ChargingInfoSet chargingInfoSet = new ChargingInfoSet(PsiBO.DEFAULT_PRI_COLL_CHRG_FN);
         notificationResponse.setUserProfile(subscription, chargingInfoSet);
 
         LOGGER.debug(&quot;exiting&quot;);
-
         return notificationResponse;
     }
 }

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/server/cx/op/QueryCxOperation.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/server/cx/op/QueryCxOperation.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/server/cx/op/QueryCxOperation.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -54,6 +54,7 @@
 import de.fhg.fokus.cx.exceptions.ims.RoamingNotAllowed;
 import de.fhg.fokus.hss.diam.ResultCode;
 import de.fhg.fokus.hss.diam.UserAuthorizationTypeAVP;
+import de.fhg.fokus.hss.util.HibernateUtil;
 
 
 /**
@@ -63,8 +64,7 @@
 public class QueryCxOperation extends CxOperation
 {
     /** logger */
-    private static final Logger LOGGER =
-        Logger.getLogger(QueryCxOperation.class);
+    private static final Logger LOGGER = Logger.getLogger(QueryCxOperation.class);
 
     /**
      * The default scscf name
@@ -83,11 +83,10 @@
      * @param _typeOfAuthorization type of authorization
      * @param _privateUserIdentity private user identity
      */ 
-    public QueryCxOperation(
-        PublicIdentity _publicIdentity, String _visitedNetworkIdentifier,
-        int _typeOfAuthorization, URI _privateUserIdentity)
-    {
-        LOGGER.debug(&quot;entering&quot;);
+    public QueryCxOperation(PublicIdentity _publicIdentity, String _visitedNetworkIdentifier, 
+    		int _typeOfAuthorization, URI _privateUserIdentity){
+        
+    	LOGGER.debug(&quot;entering&quot;);
         this.publicIdentity = _publicIdentity;
         this.privateUserIdentity = _privateUserIdentity;
         this.visitedNetworkIdentifier = _visitedNetworkIdentifier;
@@ -101,10 +100,8 @@
      * @return an object providing UAA specific information 
      * @throws DiameterException
      */   
-    public Object execute() throws DiameterException
-    {
-        if (LOGGER.isDebugEnabled())
-        {
+    public Object execute() throws DiameterException{
+        if (LOGGER.isDebugEnabled()){
             LOGGER.debug(&quot;entering&quot;);
             LOGGER.debug(this);
         }
@@ -113,55 +110,40 @@
 
         try
         {
+        	HibernateUtil.beginTransaction();
             loadUserProfile();
 
             // HSS shall check that the user is allowed to roam in the visited
             // network on REGISTRATION
-            if (
-                (
-                        typeOfAuthorization == UserAuthorizationTypeAVP._REGISTRATION
-                    )
-                    || (
-                        typeOfAuthorization == UserAuthorizationTypeAVP._REGISTRATION_AND_CAPABILITIES
-                    ))
-            {
-                if (
-                    userProfil.isRoamingAllowed(visitedNetworkIdentifier) == false)
-                {
+            if ((typeOfAuthorization == UserAuthorizationTypeAVP._REGISTRATION) || 
+            		(typeOfAuthorization == UserAuthorizationTypeAVP._REGISTRATION_AND_CAPABILITIES)){
+            	
+                if (userProfil.isRoamingAllowed(visitedNetworkIdentifier) == false){
                     throw new RoamingNotAllowed();
                 }
 
-                registrationStatusResponse =
-                    new CxUserRegistrationStatusResponse(
-                        ResultCode._DIAMETER_SUBSEQUENT_REGISTRATION, false);
+                registrationStatusResponse = new CxUserRegistrationStatusResponse(
+                		ResultCode._DIAMETER_SUBSEQUENT_REGISTRATION, false);
             }
-            else
-            {
+            else{
                 // DE_REGISTRATION
-                registrationStatusResponse =
-                    new CxUserRegistrationStatusResponse(
-                        ResultCode._DIAMETER_SUCCESS, true);
+                registrationStatusResponse = new CxUserRegistrationStatusResponse(ResultCode._DIAMETER_SUCCESS, true);
             }
 
-            if (userProfil.getImpi().getScscfName() != null)
-            {
-                registrationStatusResponse.setAssignedSCSCFName(
-                    userProfil.getImpi().getScscfName());
+            if (userProfil.getImpi().getScscfName() != null){
+                registrationStatusResponse.setAssignedSCSCFName(userProfil.getImpi().getScscfName());
             }
-            else
-            {
-                registrationStatusResponse.setAssignedSCSCFName(
-                    DEFAULT_SCSCF_NAME);
+            else{
+                registrationStatusResponse.setAssignedSCSCFName(DEFAULT_SCSCF_NAME);
             }
+            
         }
-        finally
-        {
-        	if(getUserProfil() != null){
-            getUserProfil().closeSession();
-        	}
-            LOGGER.debug(&quot;exiting&quot;);
+        finally{
+        	HibernateUtil.commitTransaction();
+        	HibernateUtil.closeSession();
         }
 
+        LOGGER.debug(&quot;exiting&quot;);
         return registrationStatusResponse;
     }
 }

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/server/sh/HSSshOperationsImpl.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/server/sh/HSSshOperationsImpl.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/server/sh/HSSshOperationsImpl.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -77,8 +77,7 @@
 public class HSSshOperationsImpl implements HSSOperations
 {
     /** Logger */
-    private static final Logger LOGGER =
-        Logger.getLogger(HSSshOperationsImpl.class);
+    private static final Logger LOGGER = Logger.getLogger(HSSshOperationsImpl.class);
 
 	/**
 	 * this methods represents the implementation of UDR command
@@ -94,25 +93,18 @@
 	 * @throws UserUnknown
 	 * @throws UserDataCannotBeRead
 	 */    
-    public ShData shPull(
-        URI userIdentity, RequestedData requestedData,
-        RequestedDomain requestedDomain, CurrentLocation currentLocation,
-        byte[] serviceIndication, String applicationServerIdentity,
-        URI applicationServerName)
-        throws DiameterException, OperationNotAllowed, UserUnknown, 
-            UserDataCannotBeRead
-    {
+    public ShData shPull(URI userIdentity, RequestedData requestedData, RequestedDomain requestedDomain, 
+    		CurrentLocation currentLocation, byte[] serviceIndication, String applicationServerIdentity, URI applicationServerName)
+        throws DiameterException, OperationNotAllowed, UserUnknown, UserDataCannotBeRead{
        
         LOGGER.debug(&quot;entering&quot;);
 
         PullShOperation pullShOperation =
-            new PullShOperation(
-                userIdentity, requestedData, requestedDomain, currentLocation,
-                serviceIndication, applicationServerIdentity,
+            new PullShOperation(userIdentity, requestedData, requestedDomain, currentLocation,serviceIndication, applicationServerIdentity,
                 applicationServerName);
         ShData shData = (ShData) pullShOperation.execute();
-        LOGGER.debug(&quot;exiting&quot;);
 
+        LOGGER.debug(&quot;exiting&quot;);
         return shData;
     }
 
@@ -131,19 +123,13 @@
 	 * @throws TooMuchData
 	 * 
 	 */   
-    public void shUpdate(
-        URI userIdentity, ShData shData, String applicationServerIdentity,
-        RequestedData requestedData)
-        throws DiameterException, OperationNotAllowed, UserUnknown, 
-            UserDataCannotBeModified, PriorUpdateInProgress, 
-            TransparentDataOutOfSync, TooMuchData
-    {
+    public void shUpdate(URI userIdentity, ShData shData, String applicationServerIdentity, RequestedData requestedData)
+        throws DiameterException, OperationNotAllowed, UserUnknown, UserDataCannotBeModified, PriorUpdateInProgress, 
+        TransparentDataOutOfSync, TooMuchData{
         
         LOGGER.debug(&quot;entering&quot;);
-
         UpdateShOperation updateShOperation =
-            new UpdateShOperation(
-                userIdentity, shData, applicationServerIdentity, requestedData);
+            new UpdateShOperation(userIdentity, shData, applicationServerIdentity, requestedData);
         updateShOperation.execute();
         LOGGER.debug(&quot;exiting&quot;);
     }
@@ -159,14 +145,10 @@
 	 * @param applicationServerName uri of application server
 	 * @throws DiameterException
 	 */ 
-    public void shSubsNotif(
-        URI userIdentity, RequestedData requestedData,
-        SubscriptionRequestType subscriptionRequestType,
-        byte[] serviceIndication, String applicationServerIdentity,
-        URI applicationServerName) throws DiameterException
-    {
-        LOGGER.debug(&quot;entering&quot;);
-
+    public void shSubsNotif(URI userIdentity, RequestedData requestedData, SubscriptionRequestType subscriptionRequestType,
+        byte[] serviceIndication, String applicationServerIdentity, URI applicationServerName) throws DiameterException{
+        
+    	LOGGER.debug(&quot;entering&quot;);
         SubsShOperation subsShOperation =
             new SubsShOperation(
                 userIdentity, requestedData, subscriptionRequestType,

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/server/sh/op/NotifShOperation.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/server/sh/op/NotifShOperation.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/server/sh/op/NotifShOperation.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -48,6 +48,7 @@
 
 import org.apache.log4j.Logger;
 
+import de.fhg.fokus.hss.util.HibernateUtil;
 import de.fhg.fokus.sh.DiameterException;
 import de.fhg.fokus.sh.RequestedData;
 
@@ -56,11 +57,9 @@
  * This class represents the pull operation which is triggered by PNR command
  * @author Andre Charton (dev -at- open-ims dot org)
  */
-public class NotifShOperation extends ShOperation
-{
+public class NotifShOperation extends ShOperation{
     /** logger */
-    private static final Logger LOGGER =
-        Logger.getLogger(NotifShOperation.class);
+    private static final Logger LOGGER = Logger.getLogger(NotifShOperation.class);
     /** requested data */
     private RequestedData requestedData;
     /** service indication */
@@ -77,10 +76,8 @@
 	 * @param applicationServerIdentity identity of application server
 	 * @param applicationServerName uri of application server
 	 */ 
-    public NotifShOperation(
-        URI userIdentity, RequestedData requestedData, byte[] serviceIndication,
-        String applicationServerIdentity, URI applicationServerName)
-    {
+    public NotifShOperation(URI userIdentity, RequestedData requestedData, byte[] serviceIndication,
+        String applicationServerIdentity, URI applicationServerName) {
         LOGGER.debug(&quot;entering&quot;);
         this.requestedData = requestedData;
         this.applicationServerIdentity = applicationServerIdentity;
@@ -96,19 +93,23 @@
      * @return an object containing the pulled data
      * @throws DiameterException
      */
-    public Object execute() throws DiameterException
-    {
-        if (LOGGER.isDebugEnabled())
-        {
+    public Object execute() throws DiameterException{
+        
+    	if (LOGGER.isDebugEnabled()){
             LOGGER.debug(&quot;entering&quot;);
             LOGGER.debug(this);
         }
 
-        loadApsvr();
-        loadUserProfile();
-
+    	try{
+    		HibernateUtil.beginTransaction();
+    		loadApsvr();
+    		loadUserProfile();
+    	}
+    	finally{
+    		HibernateUtil.commitTransaction();
+    		HibernateUtil.closeSession();
+    	}
         LOGGER.debug(&quot;exiting&quot;);
-
         return null;
     }
 }

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/server/sh/op/PullShOperation.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/server/sh/op/PullShOperation.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/server/sh/op/PullShOperation.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -51,6 +51,7 @@
 
 import org.apache.log4j.Logger;
 import org.hibernate.Session;
+import org.hibernate.Transaction;
 
 import de.fhg.fokus.hss.model.Chrginfo;
 import de.fhg.fokus.hss.model.Ifc;
@@ -60,6 +61,7 @@
 import de.fhg.fokus.hss.model.RepData;
 import de.fhg.fokus.hss.model.RepDataPK;
 import de.fhg.fokus.hss.util.HibernateUtil;
+import de.fhg.fokus.hss.util.InfrastructureException;
 import de.fhg.fokus.sh.CurrentLocation;
 import de.fhg.fokus.sh.DiameterException;
 import de.fhg.fokus.sh.InvalidAvpValue;
@@ -82,11 +84,9 @@
  * This class represents the pull operation which is triggered by UDR command
  * @author Andre Charton (dev -at- open-ims dot org)
  */
-public class PullShOperation extends ShOperation
-{
+public class PullShOperation extends ShOperation{
     /** logger */
-    private static final Logger LOGGER =
-        Logger.getLogger(PullShOperation.class);
+    private static final Logger LOGGER = Logger.getLogger(PullShOperation.class);
     /** requested data */
     private RequestedData requestedData;
     /** requested domain */
@@ -108,12 +108,9 @@
 	 * @param applicationServerIdentity identity of application server
 	 * @param applicationServerName uri of application server
 	 */     
-    public PullShOperation(
-        URI userIdentity, RequestedData requestedData,
-        RequestedDomain requestedDomain, CurrentLocation currentLocation,
-        byte[] serviceIndication, String applicationServerIdentity,
-        URI applicationServerName)
-    {
+    public PullShOperation(URI userIdentity, RequestedData requestedData, RequestedDomain requestedDomain, CurrentLocation currentLocation,
+        byte[] serviceIndication, String applicationServerIdentity,URI applicationServerName){
+    	
         LOGGER.debug(&quot;entering&quot;);
         this.requestedData = requestedData;
         this.requestedDomain = requestedDomain;
@@ -133,131 +130,106 @@
      * @return an object containing the pulled data
      * @throws DiameterException
      */
-    public Object execute() throws DiameterException
-    {
-        if (LOGGER.isDebugEnabled())
-        {
+    public Object execute() throws DiameterException{
+        if (LOGGER.isDebugEnabled()){
             LOGGER.debug(&quot;entering&quot;);
             LOGGER.debug(this);
         }
 
-        loadApsvr();
-
-        loadUserProfile();
-
         ShData shData = new ShData();
+        
+        try{
+        	HibernateUtil.beginTransaction();
+        	loadApsvr();
+        	loadUserProfile();
 
-        // Check requested data reference
-        switch (requestedData.getValue())
-        {
-        case RequestedData._CHARGINGINFORMATION:
+        	// Check requested data reference
+        	switch (requestedData.getValue()){
+        		
+        		case RequestedData._REPOSITORYDATA:
+        			if (asPermList.isPullRepData()){
+        				loadRepositoryData(shData);
+        			}
+        			else{
+        				throw new UserDataCannotBeRead();
+        			}
+        			break;
 
-            if (asPermList.isPullCharging())
-            {
-                loadChargingInformation(shData);
-            }
-            else
-            {
-                throw new UserDataCannotBeRead();
-            }
+        		case RequestedData._PUBLICIDENTIFIERS:
+        			
+        			if (asPermList.isPullImpu()){
+        				loadPublicIdentifiers(shData);
+        			}else{
+        				throw new UserDataCannotBeRead();
+        			}
+        			break;
+            
+        		case RequestedData._IMSUSERSTATE:
+        			
+        			if (asPermList.isPullImpuUserState()){
+        				loadIMSUserState(shData);
+        			}
+        			else{
+        				throw new UserDataCannotBeRead();
+        			}
+        			break;
+            
+        		case RequestedData._SCSCFNAME:
+        			if (asPermList.isPullScscfName()){
+        				loadScscfName(shData);
+        			}
+        			else{
+        				throw new UserDataCannotBeRead();
+        			}
+        			break;
 
-            break;
+        		case RequestedData._INITIALFILTERCRITERIA:
+        			if (asPermList.isPullIfc()){
+        				loadIfc(shData);
+        			}
+        			else{
+        				throw new UserDataCannotBeRead();
+        			}
+        			break;
+            
+        		case RequestedData._LOCATIONINFORMATION:
+        			
+        			if (asPermList.isPullLocInfo()){
+        				loadLocationInformation(shData);
+        			}
+        			else{
+        				throw new UserDataCannotBeRead();
+        			}
+        			break;
+            
+        		case RequestedData._USERSTATE:
 
-        case RequestedData._INITIALFILTERCRITERIA:
+        			if (asPermList.isPullUserState()){
+        				loadUserState(shData);
+        			}
+        			else{
+        				throw new UserDataCannotBeRead();
+        			}
+        			break;
 
-            if (asPermList.isPullIfc())
-            {
-                loadIfc(shData);
-            }
-            else
-            {
-                throw new UserDataCannotBeRead();
-            }
+        		case RequestedData._CHARGINGINFORMATION:
+        			if (asPermList.isPullCharging()){
+        				loadChargingInformation(shData);
+        			}
+        			else{
+        				throw new UserDataCannotBeRead();
+        			}
+        			break;
 
-            break;
-
-        case RequestedData._IMSUSERSTATE:
-
-            if (asPermList.isPullImpuUserState())
-            {
-                loadIMSUserState(shData);
-            }
-            else
-            {
-                throw new UserDataCannotBeRead();
-            }
-
-            break;
-
-        case RequestedData._LOCATIONINFORMATION:
-
-            if (asPermList.isPullLocInfo())
-            {
-                loadLocationInformation(shData);
-            }
-            else
-            {
-                throw new UserDataCannotBeRead();
-            }
-
-            break;
-
-        case RequestedData._PUBLICIDENTIFIERS:
-
-            if (asPermList.isPullImpu())
-            {
-                loadPublicIdentifiers(shData);
-            }
-            else
-            {
-                throw new UserDataCannotBeRead();
-            }
-
-            break;
-
-        case RequestedData._SCSCFNAME:
-
-            if (asPermList.isPullScscfName())
-            {
-                loadScscfName(shData);
-            }
-            else
-            {
-                throw new UserDataCannotBeRead();
-            }
-
-            break;
-
-        case RequestedData._USERSTATE:
-
-            if (asPermList.isPullUserState())
-            {
-                loadUserState(shData);
-            }
-            else
-            {
-                throw new UserDataCannotBeRead();
-            }
-
-            break;
-
-        case RequestedData._REPOSITORYDATA:
-
-            if (asPermList.isPullRepData())
-            {
-                loadRepositoryData(shData);
-            }
-            else
-            {
-                throw new UserDataCannotBeRead();
-            }
-
-            break;
-
-        default:
-            throw new InvalidAvpValue(&quot;Unknown RequestedData&quot;);
+        		default:
+        			throw new InvalidAvpValue(&quot;Unknown RequestedData&quot;);
+        	}
+        	
         }
-
+        finally{
+        	HibernateUtil.commitTransaction();
+        	HibernateUtil.closeSession();
+        }
         return shData;
     }
 
@@ -267,30 +239,22 @@
      * @param shData an object of class ShData which is filled with the repository data
      * @throws DiameterException
      */
-    private void loadRepositoryData(ShData shData) throws DiameterException
-    {
+    private void loadRepositoryData(ShData shData) throws DiameterException{
         LOGGER.debug(&quot;entering&quot;);
 
-        try
-        {
+        try{
             if ((serviceIndication == null) || (serviceIndication.length &lt; 1)){
                 throw new MissingAVP();
             }
 
-            Session session = HibernateUtil.currentSession();
-
             RepDataPK repDataPK = new RepDataPK();
             repDataPK.setImpuId(userProfil.getImpu().getImpuId());
 
             String svcIndString = new String(serviceIndication);
             repDataPK.setSvcInd(svcIndString);
 
-            //System.out.println(&quot;Service indication:&quot; + svcIndString);
-            //System.out.println(&quot;Impu id:&quot; + userProfil.getImpu().getImpuId());
-            
             RepData repData = null;
-            repData = (RepData) session.get(RepData.class, repDataPK);
-
+            repData = (RepData) HibernateUtil.getCurrentSession().get(RepData.class, repDataPK);
             if (repData == null)
             {
             	LOGGER.info(&quot;Repository data is null!&quot;);
@@ -302,19 +266,13 @@
             repositoryData.setSequenceNumber(repData.getSqn());
 
             ServiceData serviceData = new ServiceData();
-
-            ByteArrayInputStream bis =
-                new ByteArrayInputStream(repData.getSvcData());
+            ByteArrayInputStream bis = new ByteArrayInputStream(repData.getSvcData());
             ObjectInputStream ois = new ObjectInputStream(bis);
-
             serviceData.setAnyObject(ois.readObject());
             repositoryData.setServiceData(serviceData);
             ois.close();
-
             repositoryData.setServiceIndication(svcIndString);
             shData.setRepositoryData(repositoryData);
-
-            HibernateUtil.closeSession();
         }
         catch (DiameterException e)
         {
@@ -333,28 +291,24 @@
      * It loads the ims user state from HSS
      * @param shData an object of class ShData which is filled with the ims user state
      */
-    private void loadIMSUserState(ShData shData)
-    {
+    private void loadIMSUserState(ShData shData){
         LOGGER.debug(&quot;entering&quot;);
 
         ShIMSData shIMSData = new ShIMSData();
-        
-        
         switch (Integer.parseInt(userProfil.getImpu().getUserStatus())){
         
-        case TIMSUserState.VALUE_0_TYPE:
-        	shIMSData.setIMSUserState(TIMSUserState.VALUE_0);
-        	break;
-        case TIMSUserState.VALUE_1_TYPE:
-        	shIMSData.setIMSUserState(TIMSUserState.VALUE_1);
-        	break;
-        case TIMSUserState.VALUE_2_TYPE:
-        	shIMSData.setIMSUserState(TIMSUserState.VALUE_2);
-        	break;
-        case TIMSUserState.VALUE_3_TYPE:
-        	shIMSData.setIMSUserState(TIMSUserState.VALUE_3);
-        	break;
-        
+        	case TIMSUserState.VALUE_0_TYPE:
+        		shIMSData.setIMSUserState(TIMSUserState.VALUE_0);
+        		break;
+        	case TIMSUserState.VALUE_1_TYPE:
+        		shIMSData.setIMSUserState(TIMSUserState.VALUE_1);
+        		break;
+        	case TIMSUserState.VALUE_2_TYPE:
+        		shIMSData.setIMSUserState(TIMSUserState.VALUE_2);
+        		break;
+        	case TIMSUserState.VALUE_3_TYPE:
+        		shIMSData.setIMSUserState(TIMSUserState.VALUE_3);
+        		break;
         }
         
         shData.setShIMSData(shIMSData);
@@ -365,10 +319,8 @@
      * It loads the name of scscf from HSS
      * @param shData an object of class ShData which is filled with scscf name
      */
-    private void loadScscfName(ShData shData)
-    {
+    private void loadScscfName(ShData shData){
         LOGGER.debug(&quot;entering&quot;);
-
         ShIMSData shIMSData = new ShIMSData();
         shIMSData.setSCSCFName(userProfil.getImpi().getScscfName());
         shData.setShIMSData(shIMSData);
@@ -379,21 +331,18 @@
      * It loads the public identifiers from HSS
      * @param shData an object of class ShData which is filled with public identifiers
      */
-    private void loadPublicIdentifiers(ShData shData)
-    {
+    private void loadPublicIdentifiers(ShData shData){
         LOGGER.debug(&quot;entering&quot;);
 
         PublicIdentifiers publicIdentifiers = new PublicIdentifiers();
         Iterator it = userProfil.getImpuList().iterator();
 
-        while (it.hasNext())
-        {
+        while (it.hasNext()){
             Impu impu = (Impu) it.next();
             publicIdentifiers.addIMSPublicIdentity(impu.getSipUrl());
         }
 
         shData.setPublicIdentifiers(publicIdentifiers);
-
         LOGGER.debug(&quot;exiting&quot;);
     }
 
@@ -401,11 +350,9 @@
      * It loads the location information from HSS
      * @param shData an object of class ShData which is filled with location information
      */
-    private void loadLocationInformation(ShData shData)
-    {
+    private void loadLocationInformation(ShData shData){
         LOGGER.debug(&quot;entering&quot;);
-        LOGGER.warn(
-            &quot;unsuported feature was called: location of public identity&quot;);
+        LOGGER.warn(&quot;unsuported feature was called: location of public identity&quot;);
         LOGGER.debug(&quot;exiting&quot;);
     }
 
@@ -413,11 +360,9 @@
      * It loads the user data from HSS
      * @shData an object of class ShData which is filled with the user state
      */
-    private void loadUserState(ShData shData)
-    {
+    private void loadUserState(ShData shData){
         LOGGER.debug(&quot;entering&quot;);
-        LOGGER.warn(
-            &quot;unsuported feature was called: user status of public identity&quot;);
+        LOGGER.warn(&quot;unsuported feature was called: user status of public identity&quot;);
         LOGGER.debug(&quot;exiting&quot;);
     }
 
@@ -426,41 +371,27 @@
      * @param shData an object filled with appropriate retrieved data from HSS
      * @throws DiameterException
      */
-    private void loadIfc(ShData shData) throws DiameterException
-    {
+    private void loadIfc(ShData shData) throws DiameterException{
         LOGGER.debug(&quot;entering&quot;);
 
-        if (applicationServerName == null)
-        {
+        if (applicationServerName == null){
             throw new MissingAVP();
         }
 
         ShIMSData shIMSData = new ShIMSData();
-
-        if (userProfil.getImpu().getSvp().getIfc2svps() != null)
-        {
+        if (userProfil.getImpu().getSvp().getIfc2svps() != null){
             Iterator it = userProfil.getImpu().getSvp().getIfc2svps().iterator();
-
-            while (it.hasNext())
-            {
+            while (it.hasNext()){
                 Ifc2svp ifc2svp = (Ifc2svp) it.next();
-
                 Ifc ifc = ifc2svp.getIfc();
-
                 int prio = ifc2svp.getPriority();
-
                 // Return IFC for the requested Application Server
-                if (
-                    ifc.getApsvr().getAddress().equals(
-                            applicationServerName.getPath()))
-                {
+                if (ifc.getApsvr().getAddress().equals(applicationServerName.getPath())){
                     IfcBO.addIfc2shIMSData(shIMSData, ifc, prio);
                 }
             }
         }
-
         shData.setShIMSData(shIMSData);
-
         LOGGER.debug(&quot;exiting&quot;);
     }
 
@@ -468,21 +399,15 @@
      * Load the charinging function from user profile
      * @param shData an object filled with appropriate retrieved data from HSS
      */
-    private void loadChargingInformation(ShData shData)
-    {
+    private void loadChargingInformation(ShData shData){
         LOGGER.debug(&quot;entering&quot;);
-
         ShIMSData shIMSData = new ShIMSData();
         Chrginfo chrginfo = userProfil.getImpi().getChrginfo();
         ChargingInformation chargingInformation = new ChargingInformation();
-        chargingInformation.setPrimaryChargingCollectionFunctionName(
-            chrginfo.getPriChrgCollFnName());
-        chargingInformation.setPrimaryEventChargingFunctionName(
-            chrginfo.getPriEventChrgFnName());
-        chargingInformation.setSecondaryChargingCollectionFunctionName(
-            chrginfo.getSecChrgCollFnName());
-        chargingInformation.setSecondaryEventChargingFunctionName(
-            chrginfo.getSecEventChrgFnName());
+        chargingInformation.setPrimaryChargingCollectionFunctionName(chrginfo.getPriChrgCollFnName());
+        chargingInformation.setPrimaryEventChargingFunctionName(chrginfo.getPriEventChrgFnName());
+        chargingInformation.setSecondaryChargingCollectionFunctionName(chrginfo.getSecChrgCollFnName());
+        chargingInformation.setSecondaryEventChargingFunctionName(chrginfo.getSecEventChrgFnName());
         shIMSData.setChargingInformation(chargingInformation);
         shData.setShIMSData(shIMSData);
         LOGGER.debug(&quot;exiting&quot;);

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/server/sh/op/ShOperation.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/server/sh/op/ShOperation.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/server/sh/op/ShOperation.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -50,6 +50,7 @@
 import org.apache.commons.lang.builder.ToStringStyle;
 import org.apache.log4j.Logger;
 import org.hibernate.Session;
+import org.hibernate.Transaction;
 
 import de.fhg.fokus.cx.exceptions.ims.IdentitiesDontMatch;
 import de.fhg.fokus.hss.model.Apsvr;
@@ -87,10 +88,8 @@
      *  This is string converter
      *  @return the string
      */
-    public String toString()
-    {
-        return ToStringBuilder.reflectionToString(
-            this, ToStringStyle.MULTI_LINE_STYLE);
+    public String toString(){
+        return ToStringBuilder.reflectionToString(this, ToStringStyle.MULTI_LINE_STYLE);
     }
 
     /**
@@ -106,15 +105,12 @@
      * @throws IdentitiesDontMatch
      * @throws DiameterException
      */
-    protected void loadUserProfile() throws DiameterException
-    {
+    protected void loadUserProfile() throws DiameterException{
         LOGGER.debug(&quot;entering&quot;);
 
-        if (publicUserIdentity != null)
-        {
+        if (publicUserIdentity != null){
             userProfil = new ShUserProfil(publicUserIdentity);
             LOGGER.debug(&quot;exititng&quot;);
-
             return;
         }
 
@@ -126,8 +122,7 @@
      * Markup user profil update flag.
      *
      */
-    protected void markUpdateUserProfile()
-    {
+    protected void markUpdateUserProfile(){
         needUpdate = true;
     }
 
@@ -135,10 +130,8 @@
      * Update user profil if flag is set to true.
      *
      */
-    protected void updateUserProfile()
-    {
-        if (needUpdate == true)
-        {
+    protected void updateUserProfile(){
+        if (needUpdate == true){
             userProfil.update();
         }
     }
@@ -149,27 +142,19 @@
      */
     protected void loadApsvr() throws DiameterException
     {
-        Session session = HibernateUtil.currentSession();
-        apsvr =
-            (Apsvr) session.createQuery(
-                &quot;select apsvr from de.fhg.fokus.hss.model.Apsvr as apsvr where apsvr.name = ?&quot;)
-                           .setString(0, applicationServerIdentity)
-                           .uniqueResult();
-
-        if (apsvr == null)
-        {
-            LOGGER.warn(
-                this,
-                new NullPointerException(
-                    &quot;Unknown application server: &quot; + applicationServerIdentity));
+        apsvr = (Apsvr) HibernateUtil.getCurrentSession()
+        	.createQuery(&quot;select apsvr from de.fhg.fokus.hss.model.Apsvr as apsvr where apsvr.name = ?&quot;)
+            .setString(0, applicationServerIdentity)
+            .uniqueResult();
+        
+        if (apsvr == null){
+            LOGGER.warn(this,new NullPointerException(&quot;Unknown application server: &quot; + applicationServerIdentity));
             throw new UnableToComply();
         }
 
-        asPermList =
-            (AsPermList) session.get(AsPermList.class, apsvr.getApsvrId());
-
-        if (asPermList == null)
-        {
+        asPermList = (AsPermList) HibernateUtil.getCurrentSession().get(AsPermList.class, apsvr.getApsvrId());
+        
+        if (asPermList == null){
             throw new UserDataCannotBeRead();
         }
     }

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/server/sh/op/SubsShOperation.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/server/sh/op/SubsShOperation.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/server/sh/op/SubsShOperation.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -96,12 +96,9 @@
 	 * @param applicationServerIdentity identity of application server
 	 * @param applicationServerName uri of application server
 	 */
-    public SubsShOperation(
-        URI userIdentity, RequestedData requestedData,
-        SubscriptionRequestType subscriptionRequestType,
-        byte[] serviceIndication, String applicationServerIdentity,
-        URI applicationServerName)
-    {
+    public SubsShOperation(URI userIdentity, RequestedData requestedData, SubscriptionRequestType subscriptionRequestType,
+        byte[] serviceIndication, String applicationServerIdentity, URI applicationServerName){
+    	
         LOGGER.debug(&quot;entering&quot;);
         this.requestedData = requestedData;
         this.applicationServerIdentity = applicationServerIdentity;
@@ -119,77 +116,68 @@
      * @return null 
      * @throws DiameterException
      */
-    public Object execute() throws DiameterException
-    {
-        if (LOGGER.isDebugEnabled())
-        {
+    public Object execute() throws DiameterException{
+    	
+        if (LOGGER.isDebugEnabled()){
             LOGGER.debug(&quot;entering&quot;);
             LOGGER.debug(this);
         }
 
-        loadApsvr();
-        loadUserProfile();
+        try{
+        	HibernateUtil.beginTransaction();
+        	loadApsvr();
+        	loadUserProfile();
 
-        switch (requestedData.getValue())
-        {
-        case RequestedData._REPOSITORYDATA:
+        	switch (requestedData.getValue()){
 
-            if (asPermList.isSubRepData())
-            {
-                subRepositoryData();
-            }
-            else
-            {
-                throw new UserDataCannotBeNotified();
-            }
+        		case RequestedData._REPOSITORYDATA:
+        			if (asPermList.isSubRepData()){
+        				subRepositoryData();
+        			}
+        			else{
+        				throw new UserDataCannotBeNotified();
+        			}
+        			break;
 
-            break;
+        		case RequestedData._IMSUSERSTATE:
+        			if (asPermList.isSubImpuUserState()){
+        				subImsUserState();
+        			}
+        			else{
+        				throw new UserDataCannotBeNotified();
+        			}
+        			break;
 
-        case RequestedData._IMSUSERSTATE:
+        		case RequestedData._SCSCFNAME:
 
-            if (asPermList.isSubImpuUserState())
-            {
-                subImsUserState();
-            }
-            else
-            {
-                throw new UserDataCannotBeNotified();
-            }
+        			if (asPermList.isSubImpuUserState()){
+        				subScscfName();
+        			}
+        			else{
+        				throw new UserDataCannotBeNotified();
+        			}
+        			break;
 
-            break;
-
-        case RequestedData._SCSCFNAME:
-
-            if (asPermList.isSubImpuUserState())
-            {
-                subScscfName();
-            }
-            else
-            {
-                throw new UserDataCannotBeNotified();
-            }
-
-            break;
-
-        case RequestedData._INITIALFILTERCRITERIA:
-
-            if (asPermList.isSubIfc())
-            {
-                subIfc();
-            }
-            else
-            {
-                throw new UserDataCannotBeNotified();
-            }
-
-            break;
-
-        default:
-            throw new InvalidAvpValue();
+        		case RequestedData._INITIALFILTERCRITERIA:
+        			if (asPermList.isSubIfc()){
+        				subIfc();
+        			}
+        			else{
+        				throw new UserDataCannotBeNotified();
+        			}
+        			break;
+        			
+        			// to do: not all values are supported here...
+        		default:
+        			throw new InvalidAvpValue();
+        	}
         }
+        finally{
+        	HibernateUtil.commitTransaction();
+        	HibernateUtil.closeSession();
+        }
 
         LOGGER.debug(&quot;exiting&quot;);
-
         return null;
     }
 
@@ -202,20 +190,13 @@
     {
         LOGGER.debug(&quot;entering&quot;);
 
-        Session session = HibernateUtil.currentSession();
+        Apsvr ifcApsvr = (Apsvr) HibernateUtil.getCurrentSession()
+        	.createQuery(&quot;select apsvr from de.fhg.fokus.hss.model.Apsvr as apsvr where apsvr.name = ?&quot;)
+        	.setString(0, applicationServerName.getPath())
+            .uniqueResult();
 
-        Apsvr ifcApsvr =
-            (Apsvr) session.createQuery(
-                &quot;select apsvr from de.fhg.fokus.hss.model.Apsvr as apsvr where apsvr.name = ?&quot;)
-                           .setString(0, applicationServerName.getPath())
-                           .uniqueResult();
-
-        if (ifcApsvr == null)
-        {
-            LOGGER.warn(
-                this,
-                new NullPointerException(
-                    &quot;Unknown application server requested for Ifc-AppSrv-Notif.&quot;));
+        if (ifcApsvr == null){
+            LOGGER.warn(this, new NullPointerException(&quot;Unknown application server requested for Ifc-AppSrv-Notif.&quot;));
             throw new UnableToComply();
         }
 
@@ -224,36 +205,21 @@
         primaryKey.setImpuId(userProfil.getImpu().getImpuId());
         primaryKey.setIfcApsvrId(ifcApsvr.getApsvrId());
 
-        NotifyIfc notifyIfc =
-            (NotifyIfc) session.get(NotifyIfc.class, primaryKey);
+        NotifyIfc notifyIfc = (NotifyIfc) HibernateUtil.getCurrentSession().get(NotifyIfc.class, primaryKey);
 
-        if (
-            subscriptionRequestType.getValue() == SubscriptionRequestType._SUBSCRIBE)
-        {
+        if (subscriptionRequestType.getValue() == SubscriptionRequestType._SUBSCRIBE){
             // Subscribe
-            if (notifyIfc == null)
-            {
+            if (notifyIfc == null){
                 notifyIfc = new NotifyIfc(primaryKey);
-                Transaction tx = session.beginTransaction();
-                session.save(notifyIfc);
-                tx.commit();
-                session.flush();
-                HibernateUtil.closeSession();
+                HibernateUtil.getCurrentSession().save(notifyIfc);
             }
         }
-        else
-        {
+        else{
             // Un-Subscribe
-            if (notifyIfc != null)
-            {
-                Transaction tx = session.beginTransaction();
-                session.delete(notifyIfc);
-                tx.commit();
-                session.flush();
-                HibernateUtil.closeSession();
+            if (notifyIfc != null){
+                HibernateUtil.getCurrentSession().delete(notifyIfc);
             }
         }
-
         LOGGER.debug(&quot;exiting&quot;);
     }
 
@@ -261,46 +227,29 @@
      * It subscribes or unsubscribes the SCSCF notification depending on the value
      * of subscriptionRequestType
      */
-    private void subScscfName()
-    {
+    private void subScscfName(){
         LOGGER.debug(&quot;entering&quot;);
 
-        Session session = HibernateUtil.currentSession();
+        Session session = HibernateUtil.getCurrentSession();
         NotifyScscfnamePK primaryKey = new NotifyScscfnamePK();
         primaryKey.setApsvrId(apsvr.getApsvrId());
         primaryKey.setImpuId(userProfil.getImpu().getImpuId());
 
-        NotifyScscfname notifyScscfname =
-            (NotifyScscfname) session.get(NotifyScscfname.class, primaryKey);
+        NotifyScscfname notifyScscfname = (NotifyScscfname) session.get(NotifyScscfname.class, primaryKey);
 
-        if (
-            subscriptionRequestType.getValue() == SubscriptionRequestType._SUBSCRIBE)
-        {
+        if (subscriptionRequestType.getValue() == SubscriptionRequestType._SUBSCRIBE){
             // Subscribe
-            if (notifyScscfname == null)
-            {
+            if (notifyScscfname == null){
                 notifyScscfname = new NotifyScscfname(primaryKey);
-
-                Transaction tx = session.beginTransaction();
-                session.save(notifyScscfname);
-                tx.commit();
-                session.flush();
-                HibernateUtil.closeSession();
+                HibernateUtil.getCurrentSession().save(notifyScscfname);
             }
         }
-        else
-        {
+        else{
             // Un-Subscribe
-            if (notifyScscfname != null)
-            {
-                Transaction tx = session.beginTransaction();
-                session.delete(notifyScscfname);
-                tx.commit();
-                session.flush();
-                HibernateUtil.closeSession();
+            if (notifyScscfname != null){
+                HibernateUtil.getCurrentSession().delete(notifyScscfname);
             }
         }
-
         LOGGER.debug(&quot;exiting&quot;);
     }
 
@@ -308,44 +257,27 @@
      * It subscribes or unsubscribes the ims user state notification depending 
      * on the value of subscriptionRequestType
      */
-    private void subImsUserState()
-    {
+    private void subImsUserState(){
         LOGGER.debug(&quot;entering&quot;);
 
-        Session session = HibernateUtil.currentSession();
+        Session session = HibernateUtil.getCurrentSession();
         NotifyImsUserStatePK primaryKey = new NotifyImsUserStatePK();
         primaryKey.setApsvrId(apsvr.getApsvrId());
         primaryKey.setImpuId(userProfil.getImpu().getImpuId());
 
-        NotifyImsUserState notifyImsUserState =
-            (NotifyImsUserState) session.get(
-                NotifyImsUserState.class, primaryKey);
+        NotifyImsUserState notifyImsUserState = (NotifyImsUserState) session.get(NotifyImsUserState.class, primaryKey);
 
-        if (
-            subscriptionRequestType.getValue() == SubscriptionRequestType._SUBSCRIBE)
-        {
+        if (subscriptionRequestType.getValue() == SubscriptionRequestType._SUBSCRIBE){
             // Subscribe
-            if (notifyImsUserState == null)
-            {
+            if (notifyImsUserState == null){
                 notifyImsUserState = new NotifyImsUserState(primaryKey);
-
-                Transaction tx = session.beginTransaction();
-                session.save(notifyImsUserState);
-                tx.commit();
-                session.flush();
-                HibernateUtil.closeSession();
+                HibernateUtil.getCurrentSession().save(notifyImsUserState);
             }
         }
-        else
-        {
+        else{
             // Un-Subscribe
-            if (notifyImsUserState != null)
-            {
-                Transaction tx = session.beginTransaction();
-                session.delete(notifyImsUserState);
-                tx.commit();
-                session.flush();
-                HibernateUtil.closeSession();
+            if (notifyImsUserState != null){
+                HibernateUtil.getCurrentSession().delete(notifyImsUserState);
             }
         }
 
@@ -356,46 +288,29 @@
      * It subscribes or unsubscribes the repository data notification 
      * depending on the value of subscriptionRequestType
      */
-    private void subRepositoryData()
-    {
+    private void subRepositoryData(){
         LOGGER.debug(&quot;entering&quot;);
+        Session session = HibernateUtil.getCurrentSession();
 
-        Session session = HibernateUtil.currentSession();
-
         //	Check for exiting Notify
         NotifyRepDataPK primaryKey = new NotifyRepDataPK();
         primaryKey.setImpuId(userProfil.getImpu().getImpuId());
         primaryKey.setSvcInd(new String(serviceIndication));
         primaryKey.setApsvrId(apsvr.getApsvrId());
 
-        NotifyRepData notifyRepData =
-            (NotifyRepData) session.get(NotifyRepData.class, primaryKey);
+        NotifyRepData notifyRepData = (NotifyRepData) session.get(NotifyRepData.class, primaryKey);
 
-        if (
-            subscriptionRequestType.getValue() == SubscriptionRequestType._SUBSCRIBE)
-        {
+        if (subscriptionRequestType.getValue() == SubscriptionRequestType._SUBSCRIBE){
             // Subscribe
-            if (notifyRepData == null)
-            {
+            if (notifyRepData == null){
                 notifyRepData = new NotifyRepData(primaryKey);
-
-                Transaction tx = session.beginTransaction();
-                session.save(notifyRepData);
-                tx.commit();
-                session.flush();
-                HibernateUtil.closeSession();
+                HibernateUtil.getCurrentSession().save(notifyRepData);
             }
         }
-        else
-        {
+        else{
             // Un-Subscribe
-            if (notifyRepData != null)
-            {
-                Transaction tx = session.beginTransaction();
-                session.delete(notifyRepData);
-                tx.commit();
-                session.flush();
-                HibernateUtil.closeSession();
+            if (notifyRepData != null){
+                HibernateUtil.getCurrentSession().delete(notifyRepData);
             }
         }
 

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/server/sh/op/UpdateShOperation.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/server/sh/op/UpdateShOperation.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/server/sh/op/UpdateShOperation.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -49,6 +49,7 @@
 import org.apache.log4j.Logger;
 
 import de.fhg.fokus.hss.model.RepDataBO;
+import de.fhg.fokus.hss.util.HibernateUtil;
 import de.fhg.fokus.sh.DiameterException;
 import de.fhg.fokus.sh.InvalidAvpValue;
 import de.fhg.fokus.sh.RequestedData;
@@ -63,8 +64,7 @@
 public class UpdateShOperation extends ShOperation
 {
     /** logger */
-    private static final Logger LOGGER =
-        Logger.getLogger(UpdateShOperation.class);
+    private static final Logger LOGGER = Logger.getLogger(UpdateShOperation.class);
     /** requested data */    
     private RequestedData requestedData;
     /** an object representing sh specific data */
@@ -80,10 +80,7 @@
 	 * @param applicationServerIdentity identity of application server
 	 * @param requestedData requested data 
 	 */ 
-    public UpdateShOperation(
-        URI userIdentity, ShData shData, String applicationServerIdentity,
-        RequestedData requestedData)
-    {
+    public UpdateShOperation(URI userIdentity, ShData shData, String applicationServerIdentity, RequestedData requestedData){
         LOGGER.debug(&quot;entering&quot;);
         this.requestedData = requestedData;
         this.applicationServerIdentity = applicationServerIdentity;
@@ -99,36 +96,35 @@
      * @return null 
      * @throws DiameterException
      */
-    public Object execute() throws DiameterException
-    {
-        if (LOGGER.isDebugEnabled())
-        {
+    public Object execute() throws DiameterException{
+        
+    	if (LOGGER.isDebugEnabled()){
             LOGGER.debug(&quot;entering&quot;);
             LOGGER.debug(this);
         }
 
-        loadApsvr();
-        loadUserProfile();
+        try{
+        	HibernateUtil.beginTransaction();
+        	loadApsvr();
+        	loadUserProfile();
+        	switch (requestedData.getValue()){
+        		case RequestedData._REPOSITORYDATA:
+        			if (asPermList.isUpdRepData()){
+        				updateRepData();
+        			}
+        			else{
+        				throw new UserDataCannotBeModified();
+        			}
+        			break;
 
-        switch (requestedData.getValue())
-        {
-        case RequestedData._REPOSITORYDATA:
-
-            if (asPermList.isUpdRepData())
-            {
-                updateRepData();
-            }
-            else
-            {
-                throw new UserDataCannotBeModified();
-            }
-
-            break;
-
-        default:
-            throw new InvalidAvpValue();
+        		default:
+        			throw new InvalidAvpValue();
+        	}
         }
-
+        finally{
+        	HibernateUtil.commitTransaction();
+        	HibernateUtil.closeSession();
+        }
         LOGGER.debug(&quot;exiting&quot;);
 
         return null;
@@ -138,10 +134,8 @@
      * Update Repository Data
      * @throws DiameterException
      */
-    private void updateRepData() throws DiameterException
-    {
+    private void updateRepData() throws DiameterException{
         LOGGER.debug(&quot;entering&quot;);
-
         RepDataBO repDataBO = new RepDataBO(shData, apsvr, userProfil);
         repDataBO.updateRepData();
         LOGGER.debug(&quot;exiting&quot;);

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/server/zh/HSSzhOperationsImpl.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/server/zh/HSSzhOperationsImpl.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/server/zh/HSSzhOperationsImpl.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -44,6 +44,7 @@
  */
 package de.fhg.fokus.hss.server.zh;
 
+import java.net.Inet4Address;
 import java.net.URI;
 import java.security.InvalidKeyException;
 import java.security.NoSuchAlgorithmException;
@@ -59,11 +60,15 @@
 
 import de.fhg.fokus.cx.exceptions.base.UnableToComply;
 import de.fhg.fokus.hss.diam.ResultCode;
+import de.fhg.fokus.hss.main.HSSProperties;
 import de.fhg.fokus.hss.model.GussBO;
 import de.fhg.fokus.hss.model.Impi;
 import de.fhg.fokus.hss.model.Impu;
 import de.fhg.fokus.hss.model.UserSecSettings;
 import de.fhg.fokus.hss.util.HibernateUtil;
+import de.fhg.fokus.security.auth.DigestAKA;
+import de.fhg.fokus.security.auth.HexCoDec;
+import de.fhg.fokus.security.auth.Milenage;
 import de.fhg.fokus.zh.AuthenticationVector;
 import de.fhg.fokus.zh.ZhAuthDataResponse;
 import de.fhg.fokus.zh.ZhOperations;
@@ -80,17 +85,17 @@
 import de.fhg.fokus.zh.exceptions.DiameterException;
 import de.fhg.fokus.zh.exceptions.UnknownImpi;
 
+import de.fhg.fokus.security.auth.*;
 
 /**
  * Implementation of the HSS Zh Operations.
  *
  * @author Andre Charton (dev -at- open-ims dot org)
  */
-public class HSSzhOperationsImpl implements ZhOperations
-{
+public class HSSzhOperationsImpl implements ZhOperations{
+	
     /** logger */
-    private static final Logger LOGGER =
-        Logger.getLogger(HSSzhOperationsImpl.class);
+    private static final Logger LOGGER = Logger.getLogger(HSSzhOperationsImpl.class);
     /** private user identity uri*/    
     private URI privateUserIdentity;
     /** number of authentication items */
@@ -99,73 +104,61 @@
     private AuthenticationVector sipAuthDataItem;
     /** private user identity object used for hibernate transaction*/
     private Impi impi;
-    /** hibernate session */
-    private Session session;
 
     /**
      * Implementation of zh-MAR-Auth Method.
      * @return an object containing the zh specific authentication data
      * @throws DiameterException
      */
-    public ZhAuthDataResponse zhAuthData(
-        URI _privateUserIdentity, Long _numberAuthItems,
-        AuthenticationVector _sipAuthDataItem, String _serverName)
-        throws DiameterException
-    {
+    public ZhAuthDataResponse zhAuthData(URI _privateUserIdentity, Long _numberAuthItems,
+    		AuthenticationVector _sipAuthDataItem, String _serverName) throws DiameterException{
+    	
         LOGGER.debug(&quot;entering&quot;);
         this.privateUserIdentity = _privateUserIdentity;
         this.numberAuthItems = _numberAuthItems;
         this.sipAuthDataItem = _sipAuthDataItem;
 
-        if (LOGGER.isDebugEnabled())
-        {
+        if (LOGGER.isDebugEnabled()){
             LOGGER.debug(this);
         }
 
-        ZhAuthDataResponse authDataResponse =
-            new ZhAuthDataResponse(ResultCode._DIAMETER_SUCCESS);
+        ZhAuthDataResponse authDataResponse = new ZhAuthDataResponse(ResultCode._DIAMETER_SUCCESS);
 
         try
         {
-            this.session = HibernateUtil.currentSession();
-            this.impi =
-                (Impi) session.createQuery(
-                    &quot;select impi from de.fhg.fokus.hss.model.Impi as impi where impi.impiString = ?&quot;)
-                              .setString(0, privateUserIdentity.getPath())
-                              .uniqueResult();
+            HibernateUtil.beginTransaction();
+            this.impi = (Impi) HibernateUtil.getCurrentSession()
+            	.createQuery(&quot;select impi from de.fhg.fokus.hss.model.Impi as impi where impi.impiString = ?&quot;)
+                .setString(0, privateUserIdentity.getPath())
+                .uniqueResult();
 
-            if (impi == null)
-            {
+            if (impi == null){
                 throw new UnknownImpi();
             }
 
             ArrayList authVector = null;
 
             // Generate the Authentiaction Vectors ...
-            if (sipAuthDataItem != null)
-            {
+            if (sipAuthDataItem != null){
                 // ... for synchronistation
-                authVector = handleSynchFailure();
+                authVector = performSynchronization();
             }
-            else
-            {
+            else{
                 // ... for authentication
-                authVector = generateVector();
+                authVector = generateAuthenticationVectors();
             }
-
             authDataResponse.setAuthenticationVectors(authVector);
 
             Guss guss = generateGuss();
-
             authDataResponse.setGuss(guss);
+            
         }
-        finally
-        {
+        finally{
+        	HibernateUtil.commitTransaction();
             HibernateUtil.closeSession();
         }
 
         LOGGER.debug(&quot;exiting&quot;);
-
         return authDataResponse;
     }
 
@@ -179,30 +172,25 @@
 
         Guss guss = new Guss();
         guss.setId(impi.getImpiString());
-/*
-        boolean isGba =
-            ((int) impi.getUiccType().byteValue() == 0) ? false : true;
+
+        boolean isGba = ((int) impi.getUiccType().byteValue() == 0) ? false : true;
         Integer keylifeTime = impi.getKeyLifeTime();
         BsfInfo bsfInfo = new BsfInfo();
 
-        if (!isGba)
-        {
+        if (!isGba){
             bsfInfo.setUiccType(&quot;1&quot;);
         }
 
-        if (keylifeTime != null)
-        {
+        if (keylifeTime != null){
             bsfInfo.setLifeTime(keylifeTime.intValue());
         }
-
         guss.setBsfInfo(bsfInfo);
 
         // Get Uids
         Uids uids = new Uids();
         Iterator it = impi.getImpus().iterator();
 
-        while (it.hasNext())
-        {
+        while (it.hasNext()){
             Impu impu = (Impu) it.next();
             TuidsItem item = new TuidsItem();
             item.setUid(impu.getSipUrl());
@@ -211,32 +199,25 @@
 
         // Iterate about the uss entrys
         UssList ussList = new UssList();
-
         UserSecSettings impiUss = null;
-        Iterator itUss =
-            session.createQuery(
-                &quot;from de.fhg.fokus.hss.model.UserSecSettings as uss where uss.impiId = ?&quot;)
-                   .setInteger(0, impi.getImpiId()).list().iterator();
+        Iterator itUss = HibernateUtil.getCurrentSession().createQuery(&quot;from de.fhg.fokus.hss.model.UserSecSettings as uss where uss.impiId = ?&quot;)
+        	.setInteger(0, impi.getImpiId()).list().iterator();
 
-        while (itUss.hasNext())
-        {
+        while (itUss.hasNext()){
             impiUss = (UserSecSettings) itUss.next();
-
             TussListItem ussItem = new TussListItem();
             Uss uss = new Uss();
             uss.setId(GussBO.getIdByType(impiUss.getUssType()));
-            uss.setType(impiUss.getUssType());pso/index.php?section=Teme&amp;file=Reguli
+            uss.setType(impiUss.getUssType());
             uss.setNafGroup(impiUss.getNafGroup());
 
             Integer flags = impiUss.getFlag();
             Flags ussFlags = new Flags();
             uss.setFlags(ussFlags);
 
-            if ((flags != null) &amp;&amp; (flags.intValue() &gt; 0))
-            {
+            if ((flags != null) &amp;&amp; (flags.intValue() &gt; 0)){
                 buildFlags(flags.intValue(), ussFlags);
             }
-
             uss.setUids(uids);
             ussItem.setUss(uss);
             ussList.addTussListItem(ussItem);
@@ -245,7 +226,6 @@
         guss.setUssList(ussList);
 
         LOGGER.debug(&quot;exiting&quot;);
-*/
         return guss;
     }
 
@@ -255,20 +235,16 @@
      * @param flagList a flag list in which the generated flags are saved
      *
      */
-    private void buildFlags(int value, Flags flagList)
-    {
+    private void buildFlags(int value, Flags flagList){
         int i = value;
         int j = 0;
 
-        while (i &gt; 0)
-        {
-            if ((i % 2) == 1)
-            {
+        while (i &gt; 0){
+            if ((i % 2) == 1){
                 TflagsItem flag = new TflagsItem();
                 flag.setFlag((int) Math.pow(2, j));
                 flagList.addTflagsItem(flag);
             }
-
             i /= 2;
             j++;
         }
@@ -278,73 +254,78 @@
      * This method generates the authentication vectors sized by given paramter.
      * @return a list of Authentication vectors
      */
-    public ArrayList generateVector()
-    {
+    public ArrayList generateAuthenticationVectors(){
         LOGGER.debug(&quot;entering&quot;);
 
-        ArrayList vector = null;
-/*
-        try
-        {
-            // create per init answer vector
-            vector = new ArrayList(numberAuthItems.intValue());
+        ArrayList vectorList = null;
+        try{
+        	
+            vectorList = new ArrayList(numberAuthItems.intValue());
 
-            ServerDigestAKA digestAKA = new ServerDigestAKA();
+            HexCoDec codec;
+            codec = new HexCoDec();
+            byte [] secretKey = codec.decode(impi.getSkey());
+            byte [] amf = codec.decode(impi.getAmf());
 
-            // Collection values
-            SecureRandom randomAccess = SecureRandom.getInstance(&quot;SHA1PRNG&quot;);
-            AuthKey secretKey = new AuthKey(impi.getSkey());
-            Amf amf = new Amf(impi.getAmf());
-            Op operator = new Op(impi.getOperatorId());
-            Opc opc = digestAKA.generateOp_c(secretKey, operator);
+            // op and generate opC	
+            byte [] op = codec.decode(impi.getOperatorId());
+            byte [] opC = Milenage.generateOpC(secretKey, op);
+            
             String authScheme = impi.getAuthScheme();
+            Inet4Address ip = impi.getIP();
+            byte [] sqn = codec.decode(impi.getSqn());
+        	
+            for (long ix = 0; ix &lt; numberAuthItems; ix++){
+            	sqn = DigestAKA.getNextSQN(sqn, HSSProperties.IND_LEN);
+                
+                vectorList.add(DigestAKA.getAuthenticationVector(authScheme, secretKey, opC, amf, sqn));
+            }
 
-            String sqnString = new String(impi.getSqn());
-            Sqn sqn;
+            
+            if (authScheme.equalsIgnoreCase(&quot;Digest-MD5&quot;)){
+            	// Authentication Scheme is Digest-MD5
+            	LOGGER.debug(&quot;Auth-Scheme is Digest-MD5&quot;);
+                SecureRandom randomAccess = SecureRandom.getInstance(&quot;SHA1PRNG&quot;);
 
-            if (sqnString == null)
-            {
-                sqn = SimpleSqn.getNewInstance();
+                for (long ix = 0; ix &lt;numberAuthItems; ix++){
+                    byte[] randBytes = new byte[16];
+                	randomAccess.setSeed(System.currentTimeMillis());
+                    randomAccess.nextBytes(randBytes);
+                    
+                	secretKey = codec.decodePassword(impi.getSkey()).getBytes();
+                	
+                	AuthenticationVector aVector = new AuthenticationVector(authScheme, randBytes, secretKey);
+                	vectorList.add(aVector);
+                }
+                impi.setSqn(codec.encode(sqn));
+                HibernateUtil.getCurrentSession().update(impi);
             }
-            else
-            {
-                sqn = new SimpleSqn(sqnString);
-            }
+            else{
+            	// We have AKAv1 or AKAv2
+            	LOGGER.debug(&quot;Auth-Scheme is Digest-AKA&quot;);
+            	
+                for (long ix = 0; ix &lt; numberAuthItems; ix++)
+                {
+                	sqn = DigestAKA.getNextSQN(sqn, HSSProperties.IND_LEN);
+        	        byte[] copySqnHe = new byte[6];
+        	        int k = 0;
+        	        for (int i = 0; i &lt; 6; i++, k++){
+                		copySqnHe[k] = sqn[i]; 
+        	        }
 
-            for (long ix = 0; ix &lt; numberAuthItems; ix++)
-            {
-                sqn = sqn.calculateNextSqn();
-                vector.add(
-                    generateAuthenticationVector(
-                        randomAccess, secretKey, amf, opc, sqn, (long) ix,
-                        digestAKA, authScheme));
-            }
-
-            impi.setSqn(sqn.getAsString());
-
-            Transaction tx = session.beginTransaction();
-            session.update(impi);
-            tx.commit();
-            session.flush();
+                    vectorList.add(DigestAKA.getAuthenticationVector(authScheme, secretKey, opC, amf, sqn));
+                }
+                impi.setSqn(codec.encode(sqn));
+                HibernateUtil.getCurrentSession().update(impi);            }
+            
         }
-        catch (NoSuchAlgorithmException e)
-        {
+        catch (NoSuchAlgorithmException e){
             LOGGER.error(this, e);
         }
-        catch (CoDecException e)
-        {
+        catch (InvalidKeyException e){
             LOGGER.error(this, e);
         }
-        catch (KernelNotFoundException e)
-        {
-            LOGGER.error(this, e);
-        }
-        catch (InvalidKeyException e)
-        {
-            LOGGER.error(this, e);
-        }
-        catch (Exception e)
-        {
+        catch (Exception e){
             // Check impi
             if (impi.getAmf() == null)
             {
@@ -367,213 +348,142 @@
                 throw new NullPointerException(&quot;Missing Operator ID.&quot;);
             }
         }
-*/
-        LOGGER.debug(&quot;exiting&quot;);
 
-        return vector;
+        LOGGER.debug(&quot;exiting&quot;);
+        return vectorList;
     }
 
-    /*
-     * It handles synchronization failure
-     * @return a list of authentication vectors
+    /**
+     * It handles the synchronization of the SQN-MS with the SQN-HE
      * @throws DiameterException
+     * @return a list of authentication vectorList
      */
-    public ArrayList handleSynchFailure() throws DiameterException
+    public ArrayList performSynchronization() throws DiameterException
     {
-        LOGGER.debug(&quot;entering&quot;);
-/*
-        try
-        {
-            ServerDigestAKA digestAKA = new ServerDigestAKA();
-            SIPAuthorization sipAuthorization =
-                new SIPAuthorization(sipAuthDataItem.sipAuthorization);
+    	LOGGER.info(&quot;Handling Synchronization between Mobile Station and Home Environment!&quot;);
+        byte[] sipAuthorization = sipAuthDataItem.sipAuthorization;
 
-            Nonce nonce = sipAuthorization.getNonce();
-            Auts auts = sipAuthorization.getAuts();
-            Ak ak = null;
-            Rand rand = nonce.getRand();
-            AuthKey key = new AuthKey(impi.getSkey());
-            Opc opc = digestAKA.generateOp_c(key, new Op(impi.getOperatorId()));
-            String sqnHeString = impi.getSqn();
-            String amf = impi.getAmf();
-            String authScheme = impi.getAuthScheme();
-            Sqn sqnHe = null;
+        HexCoDec codec;
+        codec = new HexCoDec();
 
-            if (sqnHeString == null)
-            {
-                sqnHe = SimpleSqn.getNewInstance();
-            }
-            else
-            {
-                sqnHe = new SimpleSqn(sqnHeString);
-            }
+        byte [] secretKey = codec.decode(impi.getSkey());
+        byte [] amf = codec.decode(impi.getAmf());
 
-            sqnHe = sqnHe.calculateNextSqn();
+        try {
+            // get op and generate opC	
+            byte [] op = codec.decode(impi.getOperatorId());
+			byte [] opC = Milenage.generateOpC(secretKey, op);
 
-            if (Ak.USE_AK)
-            {
-                ak = digestAKA.generateSynchronizationAnonoymityKey(
-                        key, rand, opc);
-            }
+			String authScheme = impi.getAuthScheme();
+	        Inet4Address ip = impi.getIP();
 
-            Sqn sqnMs = auts.extractSqn(ak);
+	        // sqnHE - represent the SQN from the HSS
+	        // sqnMS - represent the SQN from the client side
+	        byte[] sqnHe = codec.decode(impi.getSqn());
+	        sqnHe = DigestAKA.getNextSQN(sqnHe, HSSProperties.IND_LEN);
 
-            if (!sqnMs.isInRange(sqnHe))
-            {
-                Mac xMacS = digestAKA.generateXMACS(key, rand, opc, sqnMs);
-                Mac macS = auts.getMac();
-                LOGGER.debug(&quot;X-MACS: &quot; + xMacS);
-                LOGGER.debug(&quot;MACS:   &quot; + macS);
+	        byte [] nonce = new byte[32];
+	        byte [] auts = new byte[14];
+	        int k = 0;
+	        for (int i = 0; i &lt; 32; i++, k++){
+        		nonce[k] = sipAuthorization[i]; 
+	        }
+	        k = 0;
+	        for (int i = 32; i &lt; 46; i++, k++){
+        		auts[k] = sipAuthorization[i]; 
+	        }
+	        
+	        byte [] rand = new byte[16];
+	        k = 0;
+	        for (int i = 0; i &lt; 16; i++, k++){
+        		rand[k] = nonce[i]; 
+	        }
 
-                if (!xMacS.equals(macS))
-                {
-                    throw new UnableToComply();
-                }
-
-                sqnHe = sqnMs;
-                sqnHe = sqnHe.calculateNextSqn();
+	        byte[] ak = null;
+	        if (HSSProperties.USE_AK){
+                ak = Milenage.f5star(secretKey, rand, opC);
             }
 
-            AuthenticationVector newAv =
-                generateAuthenticationVector(
-                    rand, key, new Amf(amf), opc, sqnHe, 0, digestAKA,
-                    authScheme);
+	        byte [] sqnMs = new byte[6];
+	        k = 0;
+	        if (HSSProperties.USE_AK){
+		        for (int i = 0; i &lt; 6; i++, k++){
+	        		sqnMs[k] = (byte) (auts[i] ^ ak[i]); 
+		        }
+		        LOGGER.warn(&quot;USE_AK is enabled and will be used in Milenage algorithm!&quot;);
+	        }
+	        else{
+		        for (int i = 0; i &lt; 6; i++, k++){
+	        		sqnMs[k] = auts[i]; 
+		        }
+		        LOGGER.warn(&quot;USE_AK is NOT enabled and will NOT be used in Milenage algorithm!&quot;);
+	        }
+	        
+	        if (DigestAKA.SQNinRange(sqnMs, sqnHe, HSSProperties.IND_LEN, HSSProperties.delta, HSSProperties.L)){
+	        	LOGGER.info(&quot;The new generated SQN value shall be accepted on the client, abort synchronization!&quot;);
+	        	k = 0;
+	        	byte[] copySqnHe = new byte[6];
+		        for (int i = 0; i &lt; 6; i++, k++){
+	        		copySqnHe[k] = sqnHe[i]; 
+		        }
+	        	
+	            AuthenticationVector aVector = DigestAKA.getAuthenticationVector(authScheme, secretKey, opC, amf, copySqnHe);
+	            ArrayList vectorsList = new ArrayList();
+	            vectorsList.add(aVector);
 
-            ArrayList avs = new ArrayList();
-            avs.add(newAv);
+	            // update Cxdata
+	            impi.setSqn(codec.encode(sqnHe));
+	            HibernateUtil.getCurrentSession().update(impi);
+	            return vectorsList;	        	
+	        }
+	        	
+        	byte xmac_s[] = Milenage.f1star(secretKey, rand, opC, sqnMs, amf);
+        	byte mac_s[] = new byte[8];
+        	k = 0;
+        	for (int i = 6; i &lt; 14; i++, k++){
+        		mac_s[k] = auts[i];
+        	}
+	        	
+        	for (int i = 0; i &lt; 8; i ++)
+        		if (xmac_s[i] != mac_s[i]){
+        			LOGGER.error(&quot;XMAC and MAC are different! User not authorized in performing synchronization!&quot;);
+        			throw new DiameterBaseException(5012);
+               }
 
-            // update Cxdata
-            impi.setSqn(sqnHe.getAsString());
+            sqnHe = sqnMs;
+            sqnHe = DigestAKA.getNextSQN(sqnHe, HSSProperties.IND_LEN);
+     		LOGGER.info(&quot;Synchronization of SQN_HE with SQN_MS was completed successfully!&quot;);
+	        
+	        byte[] copySqnHe = new byte[6];
+	        k = 0;
+	        for (int i = 0; i &lt; 6; i++, k++){
+        		copySqnHe[k] = sqnHe[i]; 
+	        }
+            AuthenticationVector aVector = DigestAKA.getAuthenticationVector(authScheme, secretKey, opC, amf, copySqnHe);
+            ArrayList vectorsList = new ArrayList();
+            vectorsList.add(aVector);
 
-            Transaction tx = session.beginTransaction();
-            session.update(impi);
-            tx.commit();
-            session.flush();
-            LOGGER.debug(&quot;exiting&quot;);
-
-            return avs;
-        }
-        catch (CoDecException e)
-        {
-            LOGGER.error(this, e);
-            throw new DiameterBaseException(UnableToComply.ERRORCODE);
-        }
-        catch (InvalidKeyException e)
-        {
-            LOGGER.error(this, e);
-            throw new DiameterBaseException(UnableToComply.ERRORCODE);
-        }
-        catch (KernelNotFoundException e)
-        {
-            LOGGER.error(this, e);
-            throw new DiameterBaseException(UnableToComply.ERRORCODE);
-        }
-        catch (Exception e)
-        {
-            LOGGER.error(this, e);
-            throw new DiameterBaseException(UnableToComply.ERRORCODE);
-        }*/
+            // update Cxdata
+            impi.setSqn(codec.encode(sqnHe));
+            HibernateUtil.getCurrentSession().update(impi);
+            return vectorsList;
+            
+		} 
+        catch (InvalidKeyException e) {
+			e.printStackTrace();
+		}
+        catch (NoSuchAlgorithmException e) {
+			e.printStackTrace();
+		}
         
-        return null;
+        return new ArrayList();
     }
 
-    /**
-     * It generates authentication vector with the help of provided arguments
-     * @param random an object which can generate some random value
-     * @param secretKey secret key object
-     * @param amf authentication management field object
-     * @param opc operator specific parameter object
-     * @param sqn sequence number object
-     * @param pos position
-     * @param digestAKA digestAKA object
-     * @param authScheme authentication scheme
-     * @return the generated authentication vector
-     * @throws CoDecException
-     * @throws InvalidKeyException
-     */ 
-    
-/*    private static AuthenticationVector generateAuthenticationVector(
-        SecureRandom random, AuthKey secretKey, Amf amf, Opc opc, Sqn sqn,
-        long pos, ServerDigestAKA digestAKA, String authScheme)
-        throws CoDecException, InvalidKeyException
-    {
-        byte[] randBytes = new byte[Rand.BYTES_LENGTH];
-        random.setSeed(System.currentTimeMillis());
-        random.nextBytes(randBytes);
-
-        Rand rand = new Rand(randBytes);
-
-        return generateAuthenticationVector(
-            rand, secretKey, amf, opc, sqn, pos, digestAKA, authScheme);
-    }
-*/
-    /**
-     * It generates authentication vector with the help of provided arguments
-     * @param rand an object which can generate some random value
-     * @param secretKey secret key object
-     * @param amf authentication management field object
-     * @param opc operator specific parameter object
-     * @param sqn sequence number object
-     * @param pos position
-     * @param digestAKA digestAKA object
-     * @param authScheme authentication scheme
-     * @return the generated authentication vector
-     * @throws CoDecException
-     * @throws InvalidKeyException
-     */ 
-/*    private static AuthenticationVector generateAuthenticationVector(
-        Rand rand, AuthKey secretKey, Amf amf, Opc opc, Sqn sqn, long pos,
-        ServerDigestAKA digestAKA, String authScheme)
-        throws CoDecException, InvalidKeyException
-    {
-        LOGGER.debug(&quot;vector number: &quot; + pos);
-        LOGGER.debug(&quot;amf: &quot; + amf.getAsString());
-        LOGGER.debug(&quot;opc: &quot; + opc.getAsString());
-        LOGGER.debug(&quot;rand: &quot; + rand.getAsString());
-        LOGGER.debug(&quot;sqn: &quot; + sqn.getAsString());
-
-        Mac mac = digestAKA.generateMACA(secretKey, rand, opc, sqn, amf);
-
-        LOGGER.debug(&quot;mac: &quot; + mac.getAsString());
-
-        Res res = digestAKA.generateXRES(authScheme,secretKey, rand, opc);
-
-        LOGGER.debug(&quot;res: &quot; + res.getAsString());
-
-        Ck ck = digestAKA.generateCipherKey(secretKey, rand, opc);
-
-        LOGGER.debug(&quot;ck: &quot; + ck.getAsString());
-
-        Ik ik = digestAKA.generateIntegrityKey(secretKey, rand, opc);
-        LOGGER.debug(&quot;ik: &quot; + ik.getAsString());
-
-        Ak ak = null;
-        Autn autn = new Autn(sqn, amf, mac);
-
-        if (Ak.USE_AK)
-        {
-            ak = digestAKA.generateAnonoymityKey(secretKey, rand, opc);
-            LOGGER.debug(&quot;ak: &quot; + ak.getAsString());
-            autn.xorSqn(ak);
-        }
-
-        Nonce nonce = new Nonce(rand, autn);
-
-        byte[] sipAuthenticate = nonce.getBytes();
-        byte[] sipAuthorization = res.getBytes();
-
-        return new AuthenticationVector(
-            authScheme, sipAuthenticate, sipAuthorization, ck.getBytes(),
-            ik.getBytes());
-    }*/
-
     /** 
      *  a string converter
      *  @return the string
      */
-    public String toString()
-    {
-        return ToStringBuilder.reflectionToString(
-            this, ToStringStyle.MULTI_LINE_STYLE);
+    public String toString(){
+        return ToStringBuilder.reflectionToString(this, ToStringStyle.MULTI_LINE_STYLE);
     }
 }

Added: FHoSS/trunk/src/de/fhg/fokus/hss/servlet/ResponseFilter.java

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/util/HibernateUtil.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/util/HibernateUtil.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/util/HibernateUtil.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -46,9 +46,11 @@
 
 import org.apache.log4j.Logger;
 
+import org.hibernate.FlushMode;
+import org.hibernate.HibernateException;
 import org.hibernate.Session;
 import org.hibernate.SessionFactory;
-
+import org.hibernate.Transaction;
 import org.hibernate.cfg.Configuration;
 
 
@@ -60,61 +62,119 @@
  *
  * @author Andre Charton (dev -at- open-ims dot org)
  */
-public class HibernateUtil
-{
+
+public class HibernateUtil{
     /** the logger */
     private static final Logger LOGGER = Logger.getLogger(HibernateUtil.class);
     /** the session factory */
     private static final SessionFactory sessionFactory;
 
-    static
-    {
-        try
-        {
+    /** thread local variable  */
+    private static final ThreadLocal threadSession = new ThreadLocal();
+    private static final ThreadLocal threadTransaction = new ThreadLocal();
+
+    static{
+        try{
             //Create the SessionFactory
-            sessionFactory =
-                new Configuration().configure().buildSessionFactory();
+            sessionFactory = new Configuration().configure().buildSessionFactory();
         }
-        catch (Throwable ex)
-        {
+        catch (Throwable ex){
             //Make sure you log the exception, as it might be swallowed
             LOGGER.error(&quot;Initial SessionFactory creation failed.&quot;, ex);
             throw new ExceptionInInitializerError(ex);
         }
     }
-    /** thread local variable  */
-    public static final ThreadLocal session = new ThreadLocal();
+    
 
     /**
-     *  this method provides the current session
+     *  This method provides the session for the current thread
      *  @return the current session
      */
-    public static Session currentSession()
-    {
-        Session s = (Session) session.get();
+    public static Session getCurrentSession(){
+    	
+   		Session s = (Session) threadSession.get();
 
-        //	 Open a new Session, if this Thread has none yet
-        if (s == null)
-        {
-            s = sessionFactory.openSession();
-            session.set(s);
-        }
-
+   		try{
+    		// Open a new Session, if this Thread hasn't any session associated or if is closed 
+    		if (s == null || s.isOpen() == false){
+    			s = sessionFactory.openSession();
+    			threadSession.set(s);
+    		}
+    	}
+    	catch(HibernateException e){
+    		LOGGER.error(&quot;Problem in opening a new session for the thread!\nMessage:&quot; + e.getMessage());
+    		e.printStackTrace();
+    		throw new InfrastructureException(e);
+    	}
         return s;
     }
 
     /**
-     *  This method closes the Session
+     *  This method close the session for the current thread
      */
-    public static void closeSession()
-    {
-        Session s = (Session) session.get();
-
-        if (s != null)
-        {
-            s.close();
+    public static void closeSession(){
+    	
+        Session s = (Session) threadSession.get();
+        try{
+        	if (s != null){
+        		s.close();
+        		threadSession.set(null);            
+        	}
         }
+        catch(HibernateException e){
+    		LOGGER.error(&quot;Problem in closing the session for the thread!\nMessage:&quot; + e.getMessage());
+    		e.printStackTrace();
+    		throw new InfrastructureException(e);
+        }
+    }
 
-        session.set(null);
+    public static void beginTransaction() {
+    	Transaction tx = (Transaction) threadTransaction.get();
+    	try {
+    		if (tx == null) {
+    			tx = getCurrentSession().beginTransaction();
+    			threadTransaction.set(tx);
+    		}
+    	}
+    	catch (HibernateException e) {
+    		LOGGER.error(&quot;Problem in starting a new transaction for the session!\nMessage:&quot; + e.getMessage());
+    		e.printStackTrace();
+    		throw new InfrastructureException(e);
+    	}
     }
+
+    public static void commitTransaction() {
+    	Transaction tx = (Transaction) threadTransaction.get();
+    	try {
+    		if ( tx != null &amp;&amp; !tx.wasCommitted() &amp;&amp; !tx.wasRolledBack() )
+    			tx.commit();
+    		threadTransaction.set(null);
+    	} 
+    	catch (HibernateException e) {
+    		rollbackTransaction();
+    		LOGGER.error(&quot;Problem in commiting the transaction for the current session; transaction was rolledback!\nMessage:&quot; + e.getMessage());
+    		e.printStackTrace();
+    		throw new InfrastructureException(e);
+
+    	}
+   	}
+
+    public static void rollbackTransaction() {
+    	Transaction tx = (Transaction) threadTransaction.get();
+    	try {
+    		threadTransaction.set(null);
+    		if ( tx != null &amp;&amp; !tx.wasCommitted() &amp;&amp; !tx.wasRolledBack() ) {
+    			tx.rollback();
+    		}
+    	} 
+    	catch (HibernateException e) {
+    		LOGGER.error(&quot;Problem in rolling back the transaction of the current session!\nMessage:&quot; + e.getMessage());
+    		e.printStackTrace();
+    		throw new InfrastructureException(e);
+    	}
+    	finally {
+    		closeSession();
+    	}
+    }
+    
 }

Added: FHoSS/trunk/src/de/fhg/fokus/hss/util/InfrastructureException.java

Modified: FHoSS/trunk/src/de/fhg/fokus/hss/util/LoggerHelper.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/hss/util/LoggerHelper.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/hss/util/LoggerHelper.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -61,9 +61,10 @@
 {
     private static Logger LOGGER = Logger.getLogger(LoggerHelper.class);
     private static final String APPENDER_NAME = &quot;WebAppender&quot;;
-    public static StringWriter BUFFER;
-    public static boolean STATUS = false;
-    private static String loglevel= &quot;info&quot;;
+    public static StringWriter BUFFER=null;;
+    public static boolean STATUS=false;
+    public static boolean empty_buffer=true;
+    public static String loglevel=null;
     private static WriterAppender appender;
 
     static
@@ -71,8 +72,13 @@
         off();
     }
 
-    public static void init(String loglevel)
+    public static void init()
     {
+        if(!STATUS){
+          BUFFER = new StringWriter();
+          BUFFER.append(&quot;Please select a debug level!&quot;);
+          return;
+        }        
         STATUS = true;
         appender = new WriterAppender();
         BUFFER = new StringWriter();
@@ -85,26 +91,25 @@
         }
         else
         {
+           loglevel=&quot;info&quot;;
            appender.setThreshold(Priority.INFO);
         }
         Layout lt = new PatternLayout(&quot;%-5p %c- %M - %m%n&quot;);
         appender.setLayout(lt);
         Logger.getRootLogger().addAppender(appender);
         LOGGER.info(&quot;WebLoggingAppender added/cleared.&quot;);
+        empty_buffer=false;
     }
 
     public static void clear()
     {
-        if (STATUS)
-        {
-            Logger.getRootLogger().removeAppender(appender);
-            if(loglevel.equals(&quot;info&quot;)){
-               init(&quot;info&quot;);
+
+            if(!empty_buffer)
+            {
+	            BUFFER.flush();
+	            init();
             }
-            else{
-               init(&quot;debug&quot;);
-            }
-        }
+ 
     }
 
     public static void off()
@@ -112,15 +117,17 @@
         if (STATUS)
         {
             STATUS = false;
+            loglevel=null;
             Logger.getRootLogger().removeAppender(appender);
-            BUFFER.flush();
         }
         else
         {
             BUFFER = new StringWriter();
+            BUFFER.append(
+                  &quot;WebLoggerAppender is offline. Use the [TURN ON] link above to start logging.&quot;);
+            empty_buffer=false;                  
         }
 
-        BUFFER.append(
-            &quot;WebLoggerAppender is offline. Use the [TURN ON] link above to start logging.&quot;);
+
     }
 }

Modified: FHoSS/trunk/src/de/fhg/fokus/security/auth/DigestAKA.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/security/auth/DigestAKA.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/security/auth/DigestAKA.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -248,7 +248,7 @@
     }
     
     
-    public static AuthenticationVector getAuthenticationVector(String authenticationScheme, Inet4Address ip, 
+    public static de.fhg.fokus.cx.AuthenticationVector getAuthenticationVector(String authenticationScheme, Inet4Address ip, 
     		byte[] secretKey, byte [] opC, byte [] amf, byte [] sqn) throws NoSuchAlgorithmException, InvalidKeyException{
     
         // random bytes
@@ -317,4 +317,77 @@
     	
     	return authenticationVector;
     }
+    
+    
+    public static de.fhg.fokus.zh.AuthenticationVector getAuthenticationVector(String authenticationScheme, 
+    		byte[] secretKey, byte [] opC, byte [] amf, byte [] sqn) throws NoSuchAlgorithmException, InvalidKeyException{
+    
+        // random bytes
+        SecureRandom randomAccess = SecureRandom.getInstance(&quot;SHA1PRNG&quot;);
+        byte[] randBytes = new byte[16];
+    	randomAccess.setSeed(System.currentTimeMillis());
+        randomAccess.nextBytes(randBytes);
+    	
+    	byte[] mac = Milenage.f1(secretKey,randBytes, opC, sqn, amf);
+        byte[] xres = Milenage.f2(secretKey, randBytes, opC);
+        byte[] ck = Milenage.f3(secretKey, randBytes, opC);
+        byte[] ik = Milenage.f4(secretKey, randBytes, opC); 
+        
+        byte[] autn = new byte[16];
+        if (HSSProperties.USE_AK){
+        	byte[] ak = Milenage.f5(secretKey, randBytes, opC);
+        	for (int i = 0; i &lt; 6; i++){
+            	sqn[i] = (byte) (sqn[i] ^ ak[i]);
+            }	
+        }
+
+            // compute autn
+            int k = 0;
+            for (int i = 0; i &lt; 6; i++, k++)
+            	autn[k] = sqn[i];
+            for (int i = 0; i &lt; 2; i++, k++)
+            	autn[k] = amf[i];
+            for (int i = 0; i &lt; 8; i++, k++)
+            	autn[k] = mac[i];
+
+            // compute nonce
+            byte [] nonce = new byte[32];
+            k = 0;
+            for (int i = 0; i &lt; 16; i++, k++)
+            	nonce[k] = randBytes[i];
+            for (int i = 0; i &lt; 16; i++, k++)
+            	nonce[k] = autn[i];
+
+            de.fhg.fokus.zh.AuthenticationVector authenticationVector;
+            if (authenticationScheme.equalsIgnoreCase(DigestAKA.AKAv1)){
+            	//AKAv1
+            	LOGGER.debug(&quot;Authentication-Scheme: AKAv1!&quot;);
+            	authenticationVector = new de.fhg.fokus.zh.AuthenticationVector(
+            		authenticationScheme, nonce, xres, ck, ik);
+            }
+            else if (authenticationScheme.equalsIgnoreCase(DigestAKA.AKAv2)){
+            	// AKAv2
+            	LOGGER.debug(&quot;Authentication-Scheme: AKAv2!&quot;);
+            	byte xresV2[] =  new byte[xres.length + ck.length + ik.length];
+            	k = 0;
+            	for (int i = 0; i &lt; xres.length; i++, k++)
+            		xresV2[k] = xres[i];
+            	for (int i = 0; i &lt; ik.length; i++, k++)
+            		xresV2[k] = ik[i];
+
+            	for (int i = 0; i &lt; ck.length; i++, k++)
+            		xresV2[k] = ck[i];
+            	
+            	authenticationVector = new de.fhg.fokus.zh.AuthenticationVector(
+                		authenticationScheme, nonce, xresV2, ck, ik);
+            }
+            else{ 
+            	LOGGER.error(&quot;Authentication-Scheme not supported!&quot;);
+            	authenticationVector = null;
+            }
+    	
+    	return authenticationVector;
+    }
+    
+    
 }

Modified: FHoSS/trunk/src/de/fhg/fokus/zh/AuthenticationVector.java
===================================================================
--- FHoSS/trunk/src/de/fhg/fokus/zh/AuthenticationVector.java	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/de/fhg/fokus/zh/AuthenticationVector.java	2007-02-06 16:48:35 UTC (rev 119)
@@ -69,6 +69,7 @@
 	 * 
 	 * @param sipAuthorization
 	 */
+
 	public AuthenticationVector(byte [] sipAuthorization) {
 		this.sipAuthorization = sipAuthorization;
 	}
@@ -78,8 +79,22 @@
 	 * @param authenticationScheme
 	 * @param sipAuthenticate
 	 * @param sipAuthorization
+	 */
+
+	public AuthenticationVector(String authenticationScheme, byte [] sipAuthenticate, byte [] sipAuthorization) {
+		this.authenticationScheme = authenticationScheme;
+		this.sipAuthenticate = sipAuthenticate;
+		this.sipAuthorization = sipAuthorization;
+	}
+
+	/**
+	 * Creates a new AuthenticationVector 
+	 * @param authenticationScheme
+	 * @param sipAuthenticate
+	 * @param sipAuthorization
 	 * @param integrityKey
 	 */
+	
 	public AuthenticationVector(String authenticationScheme, byte [] sipAuthenticate, byte [] sipAuthorization, byte [] integrityKey) {
 		this.authenticationScheme = authenticationScheme;
 		this.sipAuthenticate = sipAuthenticate;

Deleted: FHoSS/trunk/src/ehcache.tmp

Modified: FHoSS/trunk/src/hibernate.cfg.xml
===================================================================
--- FHoSS/trunk/src/hibernate.cfg.xml	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src/hibernate.cfg.xml	2007-02-06 16:48:35 UTC (rev 119)
@@ -4,11 +4,21 @@
 
 &lt;hibernate-configuration&gt;
 	&lt;session-factory name=&quot;foo&quot;&gt;
-	&lt;!--
-		The Chache provider --&gt;
-		&lt;property name=&quot;hibernate.cache.provider_class&quot;&gt;org.hibernate.cache.EhCacheProvider&lt;/property&gt;
 	
+		&lt;!-- Disable the second-level cache --&gt;
+		
+
+		&lt;!-- If uncommented, this will enable the second level cache (ehcache) for hibernate --&gt;
+&lt;!--	&lt;property name=&quot;hibernate.cache.provider_class&quot;&gt;org.hibernate.cache.EhCacheProvider&lt;/property&gt; --&gt;
+		
+		&lt;!-- currently org.hibernate.cache.NoCacheProvider used --&gt;		
+		&lt;property name=&quot;cache.provider_class&quot;&gt;org.hibernate.cache.NoCacheProvider&lt;/property&gt;
+		
+		&lt;property name=&quot;connection.autocommit&quot;&gt;false&lt;/property&gt; 
 		&lt;property name=&quot;show_sql&quot;&gt;false&lt;/property&gt;
+		
+		&lt;!-- Mapping files for the java classes --&gt;
+		
 		&lt;mapping resource=&quot;mappings/Network.hbm.xml&quot;/&gt;		
 		&lt;mapping resource=&quot;mappings/Imsu.hbm.xml&quot;/&gt;
 		&lt;mapping resource=&quot;mappings/Impi.hbm.xml&quot;/&gt;
@@ -29,6 +39,8 @@
 		&lt;mapping resource=&quot;mappings/NotifyIfc.hbm.xml&quot;/&gt;
 		&lt;mapping resource=&quot;mappings/DiamServer.hbm.xml&quot;/&gt;	
 		&lt;mapping resource=&quot;mappings/Uss.hbm.xml&quot;/&gt;
-		&lt;mapping resource=&quot;mappings/Svp.hbm.xml&quot;/&gt;	
+		&lt;mapping resource=&quot;mappings/Svp.hbm.xml&quot;/&gt;
+		
 	&lt;/session-factory&gt;
+	
 &lt;/hibernate-configuration&gt;
\ No newline at end of file

Deleted: FHoSS/trunk/src/mapping.xml

Modified: FHoSS/trunk/src-web/WEB-INF/struts-config.xml
===================================================================
--- FHoSS/trunk/src-web/WEB-INF/struts-config.xml	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src-web/WEB-INF/struts-config.xml	2007-02-06 16:48:35 UTC (rev 119)
@@ -54,6 +54,7 @@
 	&lt;action-mappings&gt;
 		&lt;action path=&quot;/imsuShow&quot; name=&quot;imsuForm&quot; type=&quot;de.fhg.fokus.hss.action.ImsuShowAction&quot; input=&quot;/pages/errorPage.jsp&quot; validate=&quot;false&quot;&gt;
 			&lt;forward name=&quot;success&quot; path=&quot;/pages/profiles/imsu.jsp&quot; /&gt;
+			&lt;forward name=&quot;failure&quot; path=&quot;/pages/errorPage.jsp&quot; /&gt;
 		&lt;/action&gt;
 		&lt;action path=&quot;/imsuSubmit&quot; name=&quot;imsuForm&quot; type=&quot;de.fhg.fokus.hss.action.ImsuSubmitAction&quot; input=&quot;/pages/profiles/imsu.jsp&quot;&gt;
 			&lt;forward name=&quot;success&quot; path=&quot;/imsuShow.do&quot; /&gt;
@@ -141,6 +142,7 @@
 		
 		&lt;action path=&quot;/chargingShow&quot; name=&quot;chrginfoForm&quot; type=&quot;de.fhg.fokus.hss.action.ChargingSetsShowAction&quot; validate=&quot;false&quot;&gt;
 			&lt;forward name=&quot;success&quot; path=&quot;/pages/network/chargingSets.jsp&quot; /&gt;
+			&lt;forward name=&quot;failure&quot; path=&quot;/pages/errorPage.jsp&quot;/&gt;
 		&lt;/action&gt;
 		&lt;action path=&quot;/chargingSubmit&quot; name=&quot;chrginfoForm&quot; type=&quot;de.fhg.fokus.hss.action.ChargingSetsShowAction&quot; input=&quot;/chargingShow.do&quot;&gt;
 			&lt;forward name=&quot;success&quot; path=&quot;/pages/network/chargingSets.jsp&quot; /&gt;
@@ -230,6 +232,10 @@
 		&lt;action path=&quot;/psiTemplSubmit&quot; name=&quot;psiTemplForm&quot; type=&quot;de.fhg.fokus.hss.action.PsiTemplSubmitAction&quot; input=&quot;/psiTemplShow.do&quot; validate=&quot;true&quot;&gt;
 			&lt;forward name=&quot;success&quot; path=&quot;/psiTemplShow.do&quot; /&gt;
 		&lt;/action&gt;
+		&lt;action path=&quot;/psiTemplDelete&quot; name=&quot;psiTemplForm&quot; type=&quot;de.fhg.fokus.hss.action.PsiTemplDeleteAction&quot; input=&quot;/psiTemplDelete.do&quot; validate=&quot;false&quot;&gt;
+			&lt;forward name=&quot;success&quot; path=&quot;/pages/tiles/success.jsp&quot; /&gt;
+			&lt;forward name=&quot;failure&quot; path=&quot;/pages/errorPage.jsp&quot;/&gt;
+		&lt;/action&gt;
 		
 		&lt;action path=&quot;/psiSearch&quot; name=&quot;psiSearchForm&quot; type=&quot;de.fhg.fokus.hss.action.PsiSearchAction&quot; validate=&quot;false&quot;&gt;
 			&lt;forward name=&quot;success&quot; path=&quot;/pages/ifc/psiResult.jsp&quot; /&gt;

Modified: FHoSS/trunk/src-web/WEB-INF/web.xml
===================================================================
--- FHoSS/trunk/src-web/WEB-INF/web.xml	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src-web/WEB-INF/web.xml	2007-02-06 16:48:35 UTC (rev 119)
@@ -2,7 +2,30 @@
 &lt;!DOCTYPE web-app PUBLIC &quot;-//Sun Microsystems, Inc.//DTD Web Application 2.2//EN&quot; &quot;<A HREF="http://java.sun.com/j2ee/dtds/web-app_2_2.dtd">http://java.sun.com/j2ee/dtds/web-app_2_2.dtd</A>&quot;&gt;
 &lt;web-app&gt;
 	&lt;display-name&gt;HSS Management Console&lt;/display-name&gt;
+	
 	&lt;!-- Standard Action Servlet Configuration (with debugging) --&gt;
+	
+	&lt;filter id=&quot;respFilterId&quot;&gt;
+        &lt;filter-name&gt;respFilter&lt;/filter-name&gt;
+        &lt;filter-class&gt;de.fhg.fokus.hss.servlet.ResponseFilter&lt;/filter-class&gt;
+    &lt;/filter&gt;
+	
+    &lt;filter-mapping&gt;
+        &lt;filter-name&gt;respFilter&lt;/filter-name&gt;
+&lt;!--	    &lt;servlet-name&gt;action&lt;/servlet-name&gt; --&gt;
+	        &lt;url-pattern&gt;/pages/info/overview.jsp&lt;/url-pattern&gt;
+    &lt;/filter-mapping&gt;
+
+    &lt;filter-mapping&gt;
+        &lt;filter-name&gt;respFilter&lt;/filter-name&gt;
+	    &lt;url-pattern&gt;/pages/profiles/dStruct.jsp&lt;/url-pattern&gt;
+    &lt;/filter-mapping&gt;
+
+    &lt;filter-mapping&gt;
+        &lt;filter-name&gt;respFilter&lt;/filter-name&gt;
+	    &lt;url-pattern&gt;/pages/info/data.jsp&lt;/url-pattern&gt;
+    &lt;/filter-mapping&gt;
+
 	&lt;servlet id=&quot;actionId&quot;&gt;
 		&lt;servlet-name&gt;action&lt;/servlet-name&gt;
 		&lt;servlet-class&gt;
@@ -62,7 +85,7 @@
 	&lt;/welcome-file-list&gt;
 	
 
-	
+
 	&lt;!-- Struts Tag Library Descriptors --&gt;
 	&lt;taglib&gt;
 		&lt;taglib-uri&gt;/tags/struts-bean&lt;/taglib-uri&gt;
@@ -115,40 +138,18 @@
     &lt;/auth-constraint&gt;
   &lt;/security-constraint&gt;
   
-  &lt;!-- 
-  &lt;security-constraint&gt;
-    &lt;web-resource-collection&gt;
-      &lt;web-resource-name&gt;hss.web.console&lt;/web-resource-name&gt;
-      &lt;url-pattern&gt;*.do&lt;/url-pattern&gt;
-      &lt;url-pattern&gt;/pages/info/*&lt;/url-pattern&gt;
-    &lt;/web-resource-collection&gt;
-    &lt;auth-constraint&gt;
-       &lt;role-name&gt;hss_admin&lt;/role-name&gt;
-    &lt;/auth-constraint&gt;
-  &lt;/security-constraint&gt;
- 	--&gt;
- 	
   &lt;!-- Define the Login Configuration for this Application --&gt;
   &lt;login-config&gt;
     &lt;auth-method&gt;BASIC&lt;/auth-method&gt;
-    &lt;realm-name&gt;FSoSS open-ims.org&lt;/realm-name&gt;
+    &lt;realm-name&gt;open-ims.org&lt;/realm-name&gt;
   &lt;/login-config&gt;
 
   &lt;!-- Security roles referenced by this web application --&gt;
   &lt;security-role&gt;
     &lt;description&gt;
-      The role that is required to log in to the HSS Application
+      The role that is required to log into the HSS
     &lt;/description&gt;
     &lt;role-name&gt;hss&lt;/role-name&gt;
   &lt;/security-role&gt;
-  &lt;!-- Security roles referenced by this web application --&gt;
-  &lt;!--  
-  &lt;security-role&gt;
-    &lt;description&gt;
-      The role that is required to log in to the HSS2 Application
-    &lt;/description&gt;
-    &lt;role-name&gt;hss_admin&lt;/role-name&gt;
-  &lt;/security-role&gt;  
- --&gt;
-	
+
 &lt;/web-app&gt;

Modified: FHoSS/trunk/src-web/pages/ifc/psi.jsp
===================================================================
--- FHoSS/trunk/src-web/pages/ifc/psi.jsp	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src-web/pages/ifc/psi.jsp	2007-02-06 16:48:35 UTC (rev 119)
@@ -57,6 +57,52 @@
 						alt=&quot;Save&quot;&gt;&lt;/p&gt;
 					&lt;% } %&gt;
 				&lt;/html:form&gt;
+				
+			&lt;/tr&gt;	
+			&lt;tr&gt;
+				&lt;td&gt;
+				  &lt;h1&gt;&lt;bean:message key=&quot;psiTempl.title&quot; /&gt;&lt;/h1&gt;
+				&lt;/td&gt;
+			&lt;/tr&gt;
+			&lt;tr&gt;
+			  &lt;td&gt;	
+			    &lt;table class=&quot;as&quot; width=&quot;100%&quot; border=0&gt;    
+				     &lt;tr class=&quot;header&quot;&gt;
+						&lt;td class=&quot;header&quot; width=&quot;80%&quot;&gt;
+							&lt;bean:message key=&quot;psiTempl.head.name&quot; /&gt;
+						&lt;/td&gt;
+						
+						&lt;td class=&quot;header&quot; width=&quot;20%&quot;&gt;
+							&lt;bean:message key=&quot;form.head.action&quot; /&gt;
+						&lt;/td&gt;										            
+					 &lt;/tr&gt;	      
+					&lt;logic:iterate name=&quot;psiForm&quot; property=&quot;psiTempls&quot; id=&quot;psiTempl&quot;
+						type=&quot;de.fhg.fokus.hss.model.PsiTempl&quot; indexId=&quot;ix&quot;&gt;
+	
+						&lt;tr class=&quot;&lt;%= ix.intValue()%2 == 0 ? &quot;even&quot; : &quot;odd&quot; %&gt;&quot;&gt;
+							&lt;td&gt;&lt;bean:write name=&quot;psiTempl&quot; property=&quot;templName&quot; /&gt;&lt;/td&gt;
+							&lt;td align=&quot;center&quot;&gt;
+								&lt;table&gt;
+									&lt;tr&gt;
+										&lt;td&gt;
+										&lt;form method=&quot;post&quot; action=&quot;/hss.web.console/psiTemplShow.do&quot;
+											target=&quot;content&quot; style=&quot;text-align: center&quot;&gt;&lt;input type=&quot;hidden&quot;
+											name=&quot;psiTemplId&quot;
+											value=&quot;&lt;bean:write name=&quot;psiTempl&quot; property=&quot;templId&quot; /&gt;&quot;&gt; &lt;input
+											type=&quot;image&quot; src=&quot;/hss.web.console/images/edit_small.gif&quot;&gt;&lt;/form&gt;
+										&lt;/td&gt;
+									&lt;/tr&gt;
+								&lt;/table&gt;
+							&lt;/td&gt;
+						&lt;/tr&gt;
+					&lt;/logic:iterate&gt;
+				&lt;/table&gt;
+			  &lt;/td&gt;				
+			&lt;/tr&gt;	
+			
+			&lt;tr&gt;
+			  &lt;td&gt;				
+				
 				&lt;logic:notEqual value=&quot;-1&quot; property=&quot;psiId&quot; name=&quot;psiForm&quot;&gt;
 					&lt;jsp:include page=&quot;/pages/tiles/impuSelect.jsp&quot;&gt;
 						&lt;jsp:param name=&quot;formName&quot; value=&quot;psiForm&quot;/&gt;

Modified: FHoSS/trunk/src-web/pages/ifc/psiResult.jsp
===================================================================
--- FHoSS/trunk/src-web/pages/ifc/psiResult.jsp	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src-web/pages/ifc/psiResult.jsp	2007-02-06 16:48:35 UTC (rev 119)
@@ -27,7 +27,7 @@
 		&lt;td valign=&quot;top&quot; bgcolor=&quot;#FFFFFF&quot;&gt;&lt;logic:notEmpty name=&quot;result&quot;&gt;
 			&lt;table class=&quot;as&quot; width=&quot;500&quot;&gt;
 				&lt;tr class=&quot;header&quot;&gt;
-					&lt;td class=&quot;header&quot;&gt;&lt;bean:message key=&quot;ifc.head.ifcName&quot; /&gt;&lt;/td&gt;
+					&lt;td class=&quot;header&quot;&gt;&lt;bean:message key=&quot;psi.head.name&quot; /&gt;&lt;/td&gt;
 					&lt;td class=&quot;header&quot;&gt;&lt;bean:message key=&quot;form.head.action&quot; /&gt;&lt;/td&gt;
 				&lt;/tr&gt;
 				&lt;logic:iterate name=&quot;result&quot; id=&quot;psi&quot;

Modified: FHoSS/trunk/src-web/pages/ifc/psiTempl.jsp
===================================================================
--- FHoSS/trunk/src-web/pages/ifc/psiTempl.jsp	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src-web/pages/ifc/psiTempl.jsp	2007-02-06 16:48:35 UTC (rev 119)
@@ -58,11 +58,55 @@
 				&lt;/html:form&gt; 
 				&lt;/td&gt;
 			&lt;/tr&gt;
-		&lt;/table&gt;
+			
+    &lt;tr bgcolor=&quot;white&quot;&gt; 
+		&lt;td&gt;
+		 &lt;h1&gt;&lt;bean:message key=&quot;as.list&quot; /&gt;&lt;/h1&gt;
+		&lt;/td&gt;
+	&lt;/tr&gt;	
+			
+	&lt;tr bgcolor=&quot;white&quot;&gt;	
+        &lt;td&gt;
+		    &lt;table class=&quot;as&quot; width=&quot;100%&quot; border=&quot;0&quot;&gt;    
+				 &lt;tr class=&quot;header&quot;&gt;
+					&lt;td class=&quot;header&quot; width=&quot;80%&quot;&gt;
+						&lt;bean:message key=&quot;psiTempl.head.apsvr&quot; /&gt;
+					&lt;/td&gt;
+							
+					&lt;td class=&quot;header&quot; width=&quot;20%&quot;&gt;
+						&lt;bean:message key=&quot;form.head.action&quot; /&gt;				
+					&lt;/td&gt;
+																		            
+				 &lt;/tr&gt;		      
+				 &lt;logic:iterate name=&quot;psiTemplForm&quot; property=&quot;apsvrs&quot;
+					id=&quot;apsvr&quot; type=&quot;de.fhg.fokus.hss.model.Apsvr&quot; indexId=&quot;ix&quot;&gt;
+				 &lt;tr class=&quot;&lt;%= ix.intValue()%2 == 0 ? &quot;even&quot; : &quot;odd&quot; %&gt;&quot;&gt;
+					&lt;td&gt;&lt;bean:write name=&quot;apsvr&quot; property=&quot;name&quot;/&gt;&lt;/td&gt;
+					&lt;td align=&quot;center&quot;&gt;
+						&lt;table&gt;
+							&lt;tr&gt;
+								&lt;td&gt;
+								&lt;form method=&quot;post&quot; action=&quot;/hss.web.console/asShow.do&quot;
+									target=&quot;content&quot; style=&quot;text-align: center&quot;&gt;
+								    &lt;input type=&quot;hidden&quot; name=&quot;asId&quot;
+									value=&quot;&lt;bean:write name=&quot;apsvr&quot; property=&quot;apsvrId&quot;/&gt;&quot;&gt;&lt;input
+									type=&quot;image&quot; src=&quot;/hss.web.console/images/edit_small.gif&quot;&gt;
+								&lt;/form&gt;
+								&lt;/td&gt;	
+							&lt;/tr&gt;
+						&lt;/table&gt;
+					&lt;/td&gt;
+				 &lt;/tr&gt;	
+				 &lt;/logic:iterate&gt;
+	        &lt;/table&gt;
+        &lt;/td&gt;  
+    &lt;/tr&gt;  	
+			
+			
+	&lt;/table&gt;
 
-		&lt;/td&gt;
-		&lt;td id=&quot;bound_right&quot;&gt;&lt;/td&gt;
-	&lt;/tr&gt;
+	&lt;/td&gt;
+	&lt;/tr&gt;	
 &lt;/table&gt;
 
 &lt;/body&gt;

Modified: FHoSS/trunk/src-web/pages/ifc/psiTemplResult.jsp
===================================================================
--- FHoSS/trunk/src-web/pages/ifc/psiTemplResult.jsp	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src-web/pages/ifc/psiTemplResult.jsp	2007-02-06 16:48:35 UTC (rev 119)
@@ -27,7 +27,7 @@
 		&lt;td valign=&quot;top&quot; bgcolor=&quot;#FFFFFF&quot;&gt;&lt;logic:notEmpty name=&quot;result&quot;&gt;
 			&lt;table class=&quot;as&quot; width=&quot;500&quot;&gt;
 				&lt;tr class=&quot;header&quot;&gt;
-					&lt;td class=&quot;header&quot;&gt;&lt;bean:message key=&quot;ifc.head.ifcName&quot; /&gt;&lt;/td&gt;
+					&lt;td class=&quot;header&quot;&gt;&lt;bean:message key=&quot;psiTempl.head.name&quot; /&gt;&lt;/td&gt;
 					&lt;td class=&quot;header&quot;&gt;&lt;bean:message key=&quot;form.head.action&quot; /&gt;&lt;/td&gt;
 				&lt;/tr&gt;
 				&lt;logic:iterate name=&quot;result&quot; id=&quot;psiTempl&quot;
@@ -45,12 +45,19 @@
 										value=&quot;&lt;bean:write name=&quot;psiTempl&quot; property=&quot;templId&quot; /&gt;&quot;&gt; &lt;input
 										type=&quot;image&quot; src=&quot;/hss.web.console/images/edit_small.gif&quot;&gt;&lt;/form&gt;
 									&lt;/td&gt;
-									&lt;td&gt;&lt;!-- 
-									&lt;form method=&quot;post&quot; action=&quot;/hss.web.console/psiTemplShow.do&quot;
-										target=&quot;content&quot; style=&quot;text-align: center&quot;&gt;&lt;input type=&quot;hidden&quot;
-										name=&quot;psiTemplId&quot;
-										value=&quot;&lt;bean:write name=&quot;psiTempl&quot; property=&quot;templId&quot; /&gt;&quot;&gt; &lt;input
-										type=&quot;image&quot; src=&quot;/hss.web.console/images/progress_rem.gif&quot;&gt;&lt;/form&gt; --&gt;
+									&lt;td&gt;
+									
+									&lt;% if(request.isUserInRole(SecurityPermissions.SP_PSI)) { %&gt;
+										&lt;td&gt;
+										&lt;form method=&quot;post&quot; action=&quot;/hss.web.console/psiTemplDelete.do&quot;
+											target=&quot;content&quot; style=&quot;text-align: center&quot;&gt;
+											&lt;input type=&quot;hidden&quot; name=&quot;psiTemplId&quot; 
+											   value=&quot;&lt;bean:write name=&quot;psiTempl&quot; property=&quot;templId&quot; /&gt;&quot;&gt; 
+											   &lt;input type=&quot;image&quot; src=&quot;/hss.web.console/images/progress_rem.gif&quot;&gt;
+									    &lt;/form&gt;
+										&lt;/td&gt;
+									&lt;% } %&gt;
+									
 									&lt;/td&gt;
 								&lt;/tr&gt;
 							&lt;/table&gt;
@@ -84,7 +91,7 @@
 
 				%&gt;&lt;/td&gt;
 								&lt;td&gt;&lt;bean:message key=&quot;result.rowsPerPage&quot; /&gt;&lt;br&gt;
-								&lt;html:hidden property=&quot;ifcName&quot;&gt;&lt;/html:hidden&gt; &lt;html:hidden
+								&lt;html:hidden property=&quot;psiName&quot;&gt;&lt;/html:hidden&gt; &lt;html:hidden
 									property=&quot;page&quot;&gt;&lt;/html:hidden&gt; &lt;html:select
 									property=&quot;rowsPerPage&quot;
 									onchange=&quot;javascript:document.psiTemplSearchForm.submit();&quot;&gt;

Modified: FHoSS/trunk/src-web/pages/info/commands.jsp
===================================================================
--- FHoSS/trunk/src-web/pages/info/commands.jsp	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src-web/pages/info/commands.jsp	2007-02-06 16:48:35 UTC (rev 119)
@@ -40,7 +40,7 @@
 			&lt;/tr&gt;
 			&lt;tr class=&quot;formular&quot;&gt;
 				&lt;td&gt;Server running time (in sec)&lt;/td&gt;
-				&lt;% long diff = (int)((System.currentTimeMillis() - de.fhg.fokus.hss.main.HssServer.STARTUP)/1000); %&gt;
+				&lt;% long diff = (int)((System.currentTimeMillis() - de.fhg.fokus.hss.main.HssServer.STARTUP_TIME)/1000); %&gt;
 				&lt;td&gt;&lt;%=diff %&gt;&lt;/td&gt;
 			&lt;/tr&gt;
 			&lt;tr class=&quot;header&quot;&gt;

Modified: FHoSS/trunk/src-web/pages/info/data.jsp
===================================================================
--- FHoSS/trunk/src-web/pages/info/data.jsp	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src-web/pages/info/data.jsp	2007-02-06 16:48:35 UTC (rev 119)
@@ -10,8 +10,8 @@
 &lt;%
 	// This jsp access hibernate directly to collect
 	// information about the hss data content.
-	Session hibernateSession = HibernateUtil.currentSession();
-	
+	Session hibernateSession = HibernateUtil.getCurrentSession();
+	HibernateUtil.beginTransaction();
 %&gt;
 &lt;html&gt;
 &lt;head&gt;

Modified: FHoSS/trunk/src-web/pages/info/logging.jsp
===================================================================
--- FHoSS/trunk/src-web/pages/info/logging.jsp	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src-web/pages/info/logging.jsp	2007-02-06 16:48:35 UTC (rev 119)
@@ -9,16 +9,26 @@
 &lt;%
 	// This jsp access hibernate directly to collect
 	// information about the hss data content.
+	String loglevel = &quot;&quot;;
 	if(request.getParameter(&quot;clear&quot;) != null){
 		LoggerHelper.clear();
 	}
 	if(request.getParameter(&quot;off&quot;) != null){
 		LoggerHelper.off();
 	}
-	if(request.getParameter(&quot;start&quot;) != null){
-		LoggerHelper.init(&quot;debug&quot;);
+	loglevel= request.getParameter(&quot;start&quot;);
+	if (loglevel != null){
+		if(loglevel.equals(&quot;info&quot;))
+		{
+	    	LoggerHelper.STATUS=true;
+		    LoggerHelper.loglevel=&quot;info&quot;;
+		    LoggerHelper.init();
+		}else{
+		    LoggerHelper.STATUS=true;
+		    LoggerHelper.loglevel=&quot;debug&quot;;
+		    LoggerHelper.init();
+		}
 	}
-	
 %&gt;
 &lt;html&gt;
 &lt;head&gt;
@@ -34,23 +44,25 @@
 		&lt;table class=&quot;as&quot; width=&quot;100%&quot; height=&quot;100%&quot; border=&quot;0&quot;&gt;
 			&lt;tr class=&quot;header&quot;&gt;
 				&lt;td height=&quot;10px&quot;&gt;
-					Logging - Current Buffer
+					Logging
 					&lt;a href=&quot;logging.jsp&quot; target=&quot;content&quot;&gt;[REFRESH]&lt;/a&gt;
 					&lt;a href=&quot;logging.jsp?clear=true&quot; target=&quot;content&quot;&gt;[CLEAR]&lt;/a&gt;
 					&lt;% if(LoggerHelper.STATUS == true) { %&gt;
 						&lt;a href=&quot;logging.jsp?off=true&quot; target=&quot;content&quot;&gt;[TURN OFF]&lt;/a&gt;
 					&lt;% } else { %&gt;
-						&lt;a href=&quot;logging.jsp?start=true&quot; target=&quot;content&quot;&gt;[TURN ON]&lt;/a&gt;
+						&lt;a href=&quot;logging.jsp?start=debug&quot; target=&quot;content&quot;&gt;[TURN ON - DEBUG]&lt;/a&gt;
+						&lt;a href=&quot;logging.jsp?start=info&quot; target=&quot;content&quot;&gt;[TURN ON - INFO]&lt;/a&gt;
+						
 					&lt;% } %&gt;
 					
 				&lt;/td&gt;
 			&lt;/tr&gt;
 			&lt;tr class=&quot;formular&quot;&gt;
-				&lt;td&gt;&lt;textarea style=&quot;width:100%;height:100%;&quot;&gt;&lt;%=LoggerHelper.BUFFER.getBuffer().toString()%&gt;&lt;/textarea&gt;&lt;/td&gt;
+			    &lt;td&gt;&lt;textarea style=&quot;width:100%;height:100%;wrap:hard&quot;&gt;&lt;%=LoggerHelper.BUFFER.getBuffer().toString()%&gt;&lt;/textarea&gt;&lt;/td&gt;
 			&lt;/tr&gt;
 		&lt;/table&gt;
 		&lt;/td&gt;
 	&lt;/tr&gt;
 &lt;/table&gt;				
 &lt;/body&gt;
-&lt;/html&gt;
+&lt;/html&gt;
\ No newline at end of file

Modified: FHoSS/trunk/src-web/pages/info/overview.jsp
===================================================================
--- FHoSS/trunk/src-web/pages/info/overview.jsp	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src-web/pages/info/overview.jsp	2007-02-06 16:48:35 UTC (rev 119)
@@ -48,7 +48,8 @@
 &lt;%
 	// This jsp access hibernate directly to collect
 	// information about the hss data content.
-	Session hibernateSession = HibernateUtil.currentSession();
+	Session hibernateSession = HibernateUtil.getCurrentSession();
+	HibernateUtil.beginTransaction();
 	
 %&gt;
 &lt;body&gt;

Modified: FHoSS/trunk/src-web/pages/profiles/dStruct.jsp
===================================================================
--- FHoSS/trunk/src-web/pages/profiles/dStruct.jsp	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src-web/pages/profiles/dStruct.jsp	2007-02-06 16:48:35 UTC (rev 119)
@@ -14,10 +14,11 @@
 &lt;%
 	// This jsp access hibernate directly to collect
 	// information about the hss data content.
-	Session hibernateSession = HibernateUtil.currentSession();
 	String imsuString = request.getParameter(&quot;imsuString&quot;);
 	String impiString = request.getParameter(&quot;impiString&quot;);
-	
+
+	Session hibernateSession = HibernateUtil.getCurrentSession();
+	HibernateUtil.beginTransaction();	
 %&gt;
 &lt;html&gt;
 &lt;head&gt;

Modified: FHoSS/trunk/src-web/pages/profiles/impi.jsp
===================================================================
--- FHoSS/trunk/src-web/pages/profiles/impi.jsp	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src-web/pages/profiles/impi.jsp	2007-02-06 16:48:35 UTC (rev 119)
@@ -57,7 +57,7 @@
 						&lt;/tr&gt;
 						&lt;tr&gt;
 							&lt;td nowrap=&quot;nowrap&quot;&gt;&lt;bean:message key=&quot;impi.head.sCscfName&quot; /&gt;&lt;/td&gt;
-							&lt;td&gt;&lt;html:text styleClass=&quot;inputtext&quot; property=&quot;scscfName&quot; style=&quot;width:325px;&quot;/&gt;&lt;/td&gt;
+							&lt;td&gt;&lt;html:text styleClass=&quot;inputtext_readonly&quot; property=&quot;scscfName&quot; style=&quot;width:325px;&quot; readonly=&quot;true&quot;/&gt;&lt;/td&gt;
 						&lt;/tr&gt;
 						&lt;tr&gt;
 							&lt;td colspan=&quot;2&quot;&gt;
@@ -69,21 +69,12 @@
 							&lt;td valign=&quot;top&quot;&gt;
 								&lt;html:select property=&quot;authScheme&quot;
 									styleClass=&quot;inputtext&quot; size=&quot;1&quot; style=&quot;width:325px;&quot;&gt;
-									&lt;html:option value=&quot;&quot;&gt;Select ...&lt;/html:option&gt;
+									&lt;!-- &lt;html:option value=&quot;&quot;&gt;Select ...&lt;/html:option&gt; --&gt;
 									&lt;html:optionsCollection property=&quot;authSchemes&quot; label=&quot;label&quot; value=&quot;value&quot;/&gt;
 								&lt;/html:select&gt;							
 							&lt;/td&gt;
 						&lt;/tr&gt;
 						&lt;tr&gt;
-							&lt;td nowrap=&quot;nowrap&quot;&gt;&lt;bean:message key=&quot;impi.head.algorithm&quot; /&gt;&lt;/td&gt;
-							&lt;td&gt;
-								&lt;html:select property=&quot;algorithm&quot;
-									styleClass=&quot;inputtext&quot; size=&quot;1&quot; style=&quot;width:325px;&quot;&gt;
-									&lt;html:optionsCollection property=&quot;authAlgos&quot; label=&quot;label&quot; value=&quot;value&quot;/&gt;
-								&lt;/html:select&gt;	
-							&lt;/td&gt;
-						&lt;/tr&gt;
-						&lt;tr&gt;
 							&lt;td nowrap=&quot;nowrap&quot;&gt;&lt;bean:message key=&quot;impi.head.asBytes&quot; /&gt;&lt;/td&gt;
 							&lt;td&gt;
 								&lt;html:radio styleClass=&quot;inputtext&quot; property=&quot;asBytes&quot; onchange=&quot;javascript:changeView();&quot; value=&quot;false&quot; /&gt; yes
@@ -140,23 +131,29 @@
 							&lt;/td&gt;
 						&lt;/tr&gt;
 					&lt;/table&gt;
-					&lt;p style=&quot;text-align:right;&quot;&gt;
 					
+					&lt;b&gt;&lt;bean:message key=&quot;impi.head.guss&quot; /&gt; &lt;/b&gt;
+					&lt;p style=&quot;text-align:left;&quot;&gt;
 					&lt;logic:notEqual value=&quot;-1&quot; property=&quot;impiId&quot; name=&quot;impiForm&quot;&gt;
 						&lt;a href=&quot;gussShow.do?impiId=&lt;bean:write name=&quot;impiForm&quot; property=&quot;impiId&quot; /&gt;&quot;&gt;
-							[&lt;bean:message key=&quot;impi.head.guss&quot; /&gt;]
+							-&gt; Configure 
 						&lt;/a&gt;
-						&lt;a href=&quot;impiShow.do?impiId=&lt;bean:write name=&quot;impiForm&quot; property=&quot;impiId&quot; /&gt;&quot;&gt;
-							[Refresh]
-						&lt;/a&gt;
-					&lt;/logic:notEqual&gt;
-						&lt;% if(request.isUserInRole(SecurityPermissions.SP_IMPI)) { %&gt;
-						&lt;input type=&quot;image&quot;
-							src=&quot;/hss.web.console/images/save_edit.gif&quot; width=&quot;16&quot; height=&quot;16&quot;
-							alt=&quot;Save&quot;&gt;
-						&lt;% } %&gt;
-						&lt;/p&gt;
+					&lt;/logic:notEqual&gt;&lt;/p&gt;
+											
+					&lt;p style=&quot;text-align:right;&quot;&gt;
+					&lt;% if(request.isUserInRole(SecurityPermissions.SP_IMPI)) { %&gt;
+					&lt;input type=&quot;image&quot;
+						src=&quot;/hss.web.console/images/save_edit.gif&quot; width=&quot;16&quot; height=&quot;16&quot;
+						alt=&quot;Save&quot;&gt;
+					&lt;% } %&gt;
+
+					&lt;a href=&quot;impiShow.do?impiId=&lt;bean:write name=&quot;impiForm&quot; property=&quot;impiId&quot; /&gt;&quot;&gt;
+						[Refresh]
+					&lt;/a&gt;
+					&lt;/p&gt;
+						
 				&lt;/html:form&gt; 
+				
 				&lt;logic:notEqual value=&quot;-1&quot; property=&quot;impiId&quot; name=&quot;impiForm&quot;&gt;			
 				&lt;jsp:include page=&quot;/pages/tiles/impuSelect.jsp&quot;&gt;
 					&lt;jsp:param name=&quot;formName&quot; value=&quot;impiForm&quot;/&gt;

Modified: FHoSS/trunk/src-web/pages/profiles/impuResult.jsp
===================================================================
--- FHoSS/trunk/src-web/pages/profiles/impuResult.jsp	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src-web/pages/profiles/impuResult.jsp	2007-02-06 16:48:35 UTC (rev 119)
@@ -38,13 +38,13 @@
 						&lt;td&gt;
 							&lt;%
 								de.fhg.fokus.hss.form.ImpuForm form = new de.fhg.fokus.hss.form.ImpuForm();
-							for(java.util.Iterator it = form.getUserStatusList().iterator(); it.hasNext();){
-								de.fhg.fokus.hss.form.Tupel tupel = (de.fhg.fokus.hss.form.Tupel)it.next();
-								if(tupel.getValue().equals(impu.getUserStatus())){
-									out.print(tupel.getLabel());
-									break;
+								for(java.util.Iterator it = form.getUserStatusList().iterator(); it.hasNext();){
+									de.fhg.fokus.hss.form.Tupel tupel = (de.fhg.fokus.hss.form.Tupel)it.next();
+									if(tupel.getValue().equals(impu.getUserStatus())){
+										out.print(tupel.getLabel());
+										break;
+									}
 								}
-							}
 							%&gt;
 						&lt;/td&gt;
 						&lt;td align=&quot;center&quot;&gt;
@@ -58,11 +58,14 @@
 										type=&quot;image&quot; src=&quot;/hss.web.console/images/edit_small.gif&quot;&gt;&lt;/form&gt;
 									&lt;/td&gt;
 									&lt;td&gt;
+									
+									&lt;% if(request.isUserInRole(SecurityPermissions.SP_IMPU)) { %&gt;									
 									&lt;form method=&quot;post&quot; action=&quot;/hss.web.console/impuDelete.do&quot;
 										target=&quot;content&quot; style=&quot;text-align: center&quot;&gt;&lt;input type=&quot;hidden&quot;
 										name=&quot;impuId&quot;
 										value=&quot;&lt;bean:write name=&quot;impu&quot; property=&quot;impuId&quot; /&gt;&quot;&gt; &lt;input
 										type=&quot;image&quot; src=&quot;/hss.web.console/images/progress_rem.gif&quot;&gt;&lt;/form&gt;
+									&lt;% } %&gt;
 									&lt;/td&gt;
 								&lt;/tr&gt;
 							&lt;/table&gt;

Modified: FHoSS/trunk/src-web/pages/tiles/impuSelect.jsp
===================================================================
--- FHoSS/trunk/src-web/pages/tiles/impuSelect.jsp	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src-web/pages/tiles/impuSelect.jsp	2007-02-06 16:48:35 UTC (rev 119)
@@ -4,6 +4,7 @@
 	prefix=&quot;html&quot;%&gt;
 &lt;%@ taglib uri=&quot;<A HREF="http://jakarta.apache.org/struts/tags-logic">http://jakarta.apache.org/struts/tags-logic</A>&quot;
 	prefix=&quot;logic&quot;%&gt;
+&lt;%@ page import=&quot;de.fhg.fokus.hss.util.SecurityPermissions&quot; %&gt;	
 &lt;h1&gt;&lt;bean:message key=&quot;impu.title&quot; /&gt;&lt;/h1&gt;
 &lt;table class=&quot;as&quot; width=&quot;100%&quot; border=0&gt;
 	&lt;tr class=&quot;header&quot;&gt;
@@ -17,10 +18,15 @@
 			&lt;td&gt;&lt;a
 				href=&quot;/hss.web.console/impuShow.do?impuId=&lt;%=impu.getImpuId()%&gt;&quot;&gt; &lt;img
 				src=&quot;/hss.web.console/images/edit_small.gif&quot; width=&quot;16&quot; height=&quot;16&quot;&gt;
-			&lt;/a&gt; &lt;a
+			&lt;/a&gt; 
+
+			&lt;% if(request.isUserInRole(SecurityPermissions.SP_IMPU)) { %&gt;
+			&lt;a
 				href=&quot;/hss.web.console&lt;%= request.getParameter(&quot;connectTarget&quot;)%&gt;?impuSelectId=&lt;%=impu.getImpuId()%&gt;&amp;&lt;%= request.getParameter(&quot;parentId&quot;)%&gt;=&lt;bean:write name=&quot;&lt;%= request.getParameter(&quot;formName&quot;)%&gt;&quot; property=&quot;&lt;%= request.getParameter(&quot;parentId&quot;)%&gt;&quot; /&gt;&amp;impuSelect=remove&quot;&gt;
 			&lt;img src=&quot;/hss.web.console/images/progress_rem.gif&quot; width=&quot;16&quot;
-				height=&quot;16&quot; alt=&quot;Delete&quot;&gt; &lt;/a&gt;&lt;/td&gt;
+				height=&quot;16&quot; alt=&quot;Delete&quot;&gt; &lt;/a&gt;
+			&lt;% } %&gt;
+			&lt;/td&gt;
 		&lt;/tr&gt;
 	&lt;/logic:iterate&gt;
 	&lt;% if(request.getParameter(&quot;addAllow&quot;).equals(&quot;true&quot;)) { %&gt;

Deleted: FHoSS/trunk/src-web/pages/tiles/navgiator.jsp

Modified: FHoSS/trunk/src-web/pages/tiles/success.jsp
===================================================================
--- FHoSS/trunk/src-web/pages/tiles/success.jsp	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/src-web/pages/tiles/success.jsp	2007-02-06 16:48:35 UTC (rev 119)
@@ -15,7 +15,7 @@
 &lt;table id=&quot;main&quot; height=&quot;100%&quot;&gt;
 	&lt;tr id=&quot;bound_bottom_black&quot;&gt;
 		&lt;td valign=&quot;top&quot; bgcolor=&quot;#FFFFFF&quot;&gt;
-		Action ends successful!
+		Your request was completed successfully!
 		&lt;/td&gt;
 		&lt;td id=&quot;bound_right&quot;&gt;&nbsp;&lt;/td&gt;
 	&lt;/tr&gt;

Modified: FHoSS/trunk/tomcat/webapps/ROOT/index.jsp
===================================================================
--- FHoSS/trunk/tomcat/webapps/ROOT/index.jsp	2007-02-06 15:09:20 UTC (rev 118)
+++ FHoSS/trunk/tomcat/webapps/ROOT/index.jsp	2007-02-06 16:48:35 UTC (rev 119)
@@ -3,6 +3,7 @@
 &lt;html&gt;
     &lt;head&gt;
     &lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=iso-8859-1&quot;&gt;
+
     &lt;title&gt;&lt;%= application.getServerInfo() %&gt;&lt;/title&gt;
     &lt;style type=&quot;text/css&quot;&gt;
       &lt;!--


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000195.html">[OpenIMSCore-HSS] 403 Forbidden : HSS user unknown Error.
</A></li>
	<LI>Next message: <A HREF="000198.html">[OpenIMSCore-HSS] password
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#196">[ date ]</a>
              <a href="thread.html#196">[ thread ]</a>
              <a href="subject.html#196">[ subject ]</a>
              <a href="author.html#196">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/openimscore-hss">More information about the OpenIMSCore-HSS
mailing list</a><br>
</body></html>
